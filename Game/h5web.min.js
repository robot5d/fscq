
function float2int(t){return 0|t}function hexToArgb(t,e,i){return void 0===e&&(e=!0),void 0===i&&(i=null),i||(i=new Vector3D),i.w=e?255&t>>24:0,i.x=255&t>>16,i.y=255&t>>8,i.z=255&t,i}function hexToArgbNum(t,e,i){return void 0===e&&(e=!0),void 0===i&&(i=null),i=hexToArgb(t,e,i),i.scaleBy(1/255),i}function addRaycast(t){var e=Physics.makeBoxShape(new Vector3D(100,100,100)),i=new Vector3D(t.x,t.y,t.z),n=new CANNON.Body({mass:100,shape:e,position:Physics.getPhysicsV3D(i)});n.angularVelocity.set(0,0,.5),{radius:10,directionLocal:new CANNON.Vec3(0,0,-1),suspensionStiffness:30,suspensionRestLength:.3,frictionSlip:5,dampingRelaxation:2.3,dampingCompression:4.4,maxSuspensionForce:1e5,rollInfluence:.01,axleLocal:new CANNON.Vec3(0,1,0),chassisConnectionPointLocal:new CANNON.Vec3(1,1,0),maxSuspensionTravel:.3,customSlidingRotationalSpeed:-30,useCustomSlidingRotationalSpeed:!0}}function addBox(t){var e=new Vector3D(t.x,t.y,t.z),i=new CANNON.Body({mass:100,shape:Physics.makeBoxShape(new Vector3D(100*t.scaleX,100*t.scaleY,100*t.scaleZ)),position:Physics.getPhysicsV3D(e)});Physics.world.addBody(i),i.type=CANNON.Body.DYNAMIC,moveBodyItem.push(i)}function addCylinder(t){var e=new Vector3D(t.x,t.y,t.z),i=new CANNON.Body({mass:100,shape:Physics.makeCylinderShape(100*t.scaleX,100*t.scaleY),position:Physics.getPhysicsV3D(e)});Physics.world.addBody(i),i.type=CANNON.Body.DYNAMIC,moveBodyItem.push(i)}function addBall(t){var e=new Vector3D(t.x,t.y,t.z),i=new CANNON.Body({mass:100,shape:new CANNON.Sphere(t.radius),position:Physics.getPhysicsV3D(e)});Physics.world.addBody(i),i.type=CANNON.Body.DYNAMIC,moveBodyItem.push(i)}function init(){importScripts("Server.js"),server=new Server,server.worker=this}var BaseEvent=function(){function t(t){this.type=t}return t.COMPLETE="complete",t}(),EventDispatcher=function(){function t(){this._eventsMap=null}return t.prototype.addEventListener=function(t,e,i){this._eventsMap||(this._eventsMap={});var n=this._eventsMap[t];n||(n=this._eventsMap[t]=[]);for(var a={listener:e,thisObject:i},o=0;n.length>o;o++){var r=n[o];if(r.listener==e&&r.thisObject==i)return}n.push(a)},t.prototype.removeEventListener=function(t,e,i){for(var n=this._eventsMap[t],a=0;n.length>a;a++){var o=n[a];if(o.listener==e&&o.thisObject==i)return n.splice(a,1),void 0}},t.prototype.dispatchEvent=function(t){var e=this._eventsMap;if(!e)return!0;var i=e[t.type];if(!i)return!0;var n=i.length;if(0==n)return!0;t.target=this;for(var a=0;n>a;a++){var o=i[a];o.listener.call(o.thisObject,t)}},t}(),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},Object3D=function(t){function e(e,i,n){void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0),t.call(this),this._x=e,this._y=i,this._z=n,this._scaleX=1,this._scaleY=1,this._scaleZ=1,this._rotationX=0,this._rotationY=0,this._rotationZ=0,this.posMatrix=new Matrix3D}return __extends(e,t),e.prototype.toString=function(){return"Object3D("+(this._x+"")+","+(this._y+"")+","+(this._z+"")+")"},Object.defineProperty(e.prototype,"x",{get:function(){return this._x},set:function(t){this._x=t,this.updateMatrix()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"y",{get:function(){return this._y},set:function(t){this._y=t,this.updateMatrix()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"z",{get:function(){return this._z},set:function(t){this._z=t,this.updateMatrix()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"scaleX",{get:function(){return this._scaleX},set:function(t){this._scaleX=t,this.updateMatrix()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"scaleY",{get:function(){return this._scaleY},set:function(t){this._scaleY=t,this.updateMatrix()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"scaleZ",{get:function(){return this._scaleZ},set:function(t){this._scaleZ=t,this.updateMatrix()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rotationX",{get:function(){return this._rotationX},set:function(t){this._rotationX=t,this.updateMatrix(),this.updateRotationMatrix()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rotationY",{get:function(){return this._rotationY},set:function(t){this._rotationY=t,this.updateMatrix(),this.updateRotationMatrix()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rotationZ",{get:function(){return this._rotationZ},set:function(t){this._rotationZ=t,this.updateMatrix(),this.updateRotationMatrix()},enumerable:!0,configurable:!0}),e.prototype.updateMatrix=function(){},e.prototype.updateRotationMatrix=function(){},e}(EventDispatcher),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},Camera3D=function(t){function e(){t.call(this),this.distance=500,this.cameraMatrix=new Matrix3D}return __extends(e,t),e.prototype.lookAt=function(t){this.lookAtTarget=t},e.prototype.update=function(){this.lookAtTarget&&(Scene_data.focus3D.x=this.lookAtTarget.x,Scene_data.focus3D.y=this.lookAtTarget.y,Scene_data.focus3D.z=this.lookAtTarget.z)},e}(Object3D),ObjData=function(){function t(){this.vertices=[],this.uvs=[],this.indexs=[],this.lightuvs=[],this.normals=[],this.tangents=[],this.bitangents=[],this.treNum=0}return t}(),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},MeshData=function(t){function e(){t.apply(this,arguments),this.bonetIDAry=[],this.boneWeightAry=[],this.boneNewIDAry=[],this.particleAry=[]}return __extends(e,t),e}(ObjData),BindParticle=function(){function t(t,e){this.url=t,this.socketName=e}return t}(),Context3D=function(){function t(){}return t.prototype.init=function(t){this.renderContext=t.getContext("experimental-webgl")},t.prototype.resetSize=function(t,e){this.renderContext.viewport(0,0,t,e)},t.prototype.uploadBuff3D=function(t){var e=this.renderContext.createBuffer();return this.renderContext.bindBuffer(this.renderContext.ARRAY_BUFFER,e),this.renderContext.bufferData(this.renderContext.ARRAY_BUFFER,new Float32Array(t),this.renderContext.STATIC_DRAW),e},t.prototype.uploadBuff3DByBuffer=function(t,e){this.renderContext.bindBuffer(this.renderContext.ARRAY_BUFFER,t),this.renderContext.bufferData(this.renderContext.ARRAY_BUFFER,new Float32Array(e),this.renderContext.STATIC_DRAW)},t.prototype.uploadIndexBuff3D=function(t){var e=this.renderContext.createBuffer();return this.renderContext.bindBuffer(this.renderContext.ELEMENT_ARRAY_BUFFER,e),this.renderContext.bufferData(this.renderContext.ELEMENT_ARRAY_BUFFER,new Uint16Array(t),this.renderContext.STATIC_DRAW),e},t.prototype.uploadIndexBuff3DByBuffer=function(t,e){this.renderContext.bindBuffer(this.renderContext.ELEMENT_ARRAY_BUFFER,t),this.renderContext.bufferData(this.renderContext.ELEMENT_ARRAY_BUFFER,new Uint16Array(e),this.renderContext.STATIC_DRAW)},t.prototype.update=function(){this.renderContext.bindFramebuffer(this.renderContext.FRAMEBUFFER,null),this.renderContext.clearColor(63/255,63/255,63/255,1),this.renderContext.clearDepth(1),this.renderContext.enable(this.renderContext.DEPTH_TEST),this.renderContext.depthMask(!0),this.renderContext.enable(this.renderContext.BLEND),this.renderContext.frontFace(this.renderContext.CW),this.renderContext.clear(this.renderContext.COLOR_BUFFER_BIT|this.renderContext.DEPTH_BUFFER_BIT),this.renderContext.blendFunc(this.renderContext.SRC_ALPHA,this.renderContext.ONE_MINUS_SRC_ALPHA),this.setBlendParticleFactors(0)},t.prototype.setDepthTest=function(t){t?this.renderContext.enable(this.renderContext.DEPTH_TEST):this.renderContext.disable(this.renderContext.DEPTH_TEST)},t.prototype.setWriteDepth=function(t){this.renderContext.depthMask(t)},t.prototype.setBlendParticleFactors=function(t){switch(t){case 0:this.renderContext.blendFunc(this.renderContext.ONE,this.renderContext.ONE_MINUS_SRC_ALPHA);break;case 1:this.renderContext.blendFunc(this.renderContext.ONE,this.renderContext.ONE);break;case 2:this.renderContext.blendFunc(this.renderContext.DST_COLOR,this.renderContext.ZERO);break;case 3:this.renderContext.blendFunc(this.renderContext.ONE,this.renderContext.ONE_MINUS_SRC_COLOR);break;case 4:this.renderContext.blendFunc(this.renderContext.SRC_ALPHA,this.renderContext.ONE);break;case-1:this.renderContext.blendFunc(this.renderContext.SRC_ALPHA,this.renderContext.ONE_MINUS_SRC_ALPHA)}},t.prototype.setProgram=function(t){this.renderContext.useProgram(t)},t.prototype.setVcMatrix3fv=function(t,e,i){this.renderContext.uniformMatrix3fv(this.renderContext.getUniformLocation(t,e),!1,i)},t.prototype.setVcMatrix4fv=function(t,e,i){this.renderContext.uniformMatrix4fv(this.renderContext.getUniformLocation(t,e),!1,i)},t.prototype.setVc4fv=function(t,e,i){this.renderContext.uniform4fv(this.renderContext.getUniformLocation(t,e),i)},t.prototype.setVc3fv=function(t,e,i){this.renderContext.uniform3fv(this.renderContext.getUniformLocation(t,e),i)},t.prototype.setVc2fv=function(t,e,i){this.renderContext.uniform2fv(this.renderContext.getUniformLocation(t,e),i)},t.prototype.setVa=function(t,e,i){this.renderContext.bindBuffer(this.renderContext.ARRAY_BUFFER,i),this.renderContext.enableVertexAttribArray(t),this.renderContext.vertexAttribPointer(t,e,this.renderContext.FLOAT,!1,0,0)},t.prototype.drawCall=function(t,e){this.renderContext.bindBuffer(this.renderContext.ELEMENT_ARRAY_BUFFER,t),this.renderContext.drawElements(this.renderContext.TRIANGLES,e,this.renderContext.UNSIGNED_SHORT,0)},t.prototype.drawLine=function(t,e){this.renderContext.bindBuffer(this.renderContext.ELEMENT_ARRAY_BUFFER,t),this.renderContext.drawElements(this.renderContext.LINES,e,this.renderContext.UNSIGNED_SHORT,0)},t.prototype.setRenderTexture=function(t,e,i,n){0==n?this.renderContext.activeTexture(this.renderContext.TEXTURE0):1==n?this.renderContext.activeTexture(this.renderContext.TEXTURE1):2==n?this.renderContext.activeTexture(this.renderContext.TEXTURE2):3==n?this.renderContext.activeTexture(this.renderContext.TEXTURE3):4==n?this.renderContext.activeTexture(this.renderContext.TEXTURE4):5==n?this.renderContext.activeTexture(this.renderContext.TEXTURE5):6==n&&this.renderContext.activeTexture(this.renderContext.TEXTURE6),this.renderContext.bindTexture(this.renderContext.TEXTURE_2D,i),this.renderContext.uniform1i(this.renderContext.getUniformLocation(t,e),n)},t.prototype.setRenderTextureCube=function(t,e,i,n){0==n?this.renderContext.activeTexture(this.renderContext.TEXTURE0):1==n?this.renderContext.activeTexture(this.renderContext.TEXTURE1):2==n?this.renderContext.activeTexture(this.renderContext.TEXTURE2):3==n?this.renderContext.activeTexture(this.renderContext.TEXTURE3):4==n?this.renderContext.activeTexture(this.renderContext.TEXTURE4):5==n?this.renderContext.activeTexture(this.renderContext.TEXTURE5):6==n&&this.renderContext.activeTexture(this.renderContext.TEXTURE6),this.renderContext.bindTexture(this.renderContext.TEXTURE_CUBE_MAP,i),this.renderContext.uniform1i(this.renderContext.getUniformLocation(t,e),n)},t.prototype.getTexture=function(t,e,i,n){void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0);var a=this.renderContext.createTexture();this.renderContext.bindTexture(this.renderContext.TEXTURE_2D,a),this.renderContext.texImage2D(this.renderContext.TEXTURE_2D,0,this.renderContext.RGBA,this.renderContext.RGBA,this.renderContext.UNSIGNED_BYTE,t);var o;o=0==i?this.renderContext.LINEAR:this.renderContext.NEAREST;var r;return 0==i?0==n?r=this.renderContext.LINEAR:1==n?r=this.renderContext.LINEAR_MIPMAP_NEAREST:2==n&&(r=this.renderContext.LINEAR_MIPMAP_LINEAR):0==n?r=this.renderContext.NEAREST:1==n?r=this.renderContext.NEAREST_MIPMAP_NEAREST:2==n&&(r=this.renderContext.NEAREST_MIPMAP_LINEAR),this.renderContext.texParameteri(this.renderContext.TEXTURE_2D,this.renderContext.TEXTURE_MAG_FILTER,o),this.renderContext.texParameteri(this.renderContext.TEXTURE_2D,this.renderContext.TEXTURE_MIN_FILTER,r),0==e?(this.renderContext.texParameteri(this.renderContext.TEXTURE_2D,this.renderContext.TEXTURE_WRAP_S,this.renderContext.REPEAT),this.renderContext.texParameteri(this.renderContext.TEXTURE_2D,this.renderContext.TEXTURE_WRAP_T,this.renderContext.REPEAT)):(this.renderContext.texParameteri(this.renderContext.TEXTURE_2D,this.renderContext.TEXTURE_WRAP_S,this.renderContext.CLAMP_TO_EDGE),this.renderContext.texParameteri(this.renderContext.TEXTURE_2D,this.renderContext.TEXTURE_WRAP_T,this.renderContext.CLAMP_TO_EDGE)),0!=n&&this.renderContext.generateMipmap(this.renderContext.TEXTURE_2D),a},t.prototype.creatTexture=function(t,e,i){void 0===i&&(i=0);var n=this.renderContext.createTexture();return this.renderContext.bindTexture(this.renderContext.TEXTURE_2D,n),this.renderContext.texParameteri(this.renderContext.TEXTURE_2D,this.renderContext.TEXTURE_MAG_FILTER,this.renderContext.LINEAR),this.renderContext.texParameteri(this.renderContext.TEXTURE_2D,this.renderContext.TEXTURE_MIN_FILTER,this.renderContext.LINEAR),0==i?(this.renderContext.texParameteri(this.renderContext.TEXTURE_2D,this.renderContext.TEXTURE_WRAP_S,this.renderContext.REPEAT),this.renderContext.texParameteri(this.renderContext.TEXTURE_2D,this.renderContext.TEXTURE_WRAP_T,this.renderContext.REPEAT)):(this.renderContext.texParameteri(this.renderContext.TEXTURE_2D,this.renderContext.TEXTURE_WRAP_S,this.renderContext.CLAMP_TO_EDGE),this.renderContext.texParameteri(this.renderContext.TEXTURE_2D,this.renderContext.TEXTURE_WRAP_T,this.renderContext.CLAMP_TO_EDGE)),this.renderContext.texImage2D(this.renderContext.TEXTURE_2D,0,this.renderContext.RGB,t,e,0,this.renderContext.RGB,this.renderContext.UNSIGNED_BYTE,null),n},t.prototype.createFramebuffer=function(){var t=this.renderContext.createFramebuffer();return this.renderContext.bindFramebuffer(this.renderContext.FRAMEBUFFER,t),t},t}(),Scene_data=function(){function t(){}return Object.defineProperty(t,"viewMatrx3D",{get:function(){return t._viewMatrx3D},set:function(e){t._viewMatrx3D=e},enumerable:!0,configurable:!0}),t.sceneViewHW=500,t.fileRoot="assets/",t.frameTime=1e3/60,t.MAX_NUMBER=1e7,t.user=0,t.verticalScene=!1,t}(),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},Display3D=function(t){function e(){t.call(this),this.sceneVisible=!0,this._onStage=!1}return __extends(e,t),e.prototype.updateMatrix=function(){this.posMatrix.identity(),this.posMatrix.appendScale(this._scaleX,this._scaleY,this._scaleZ),this.posMatrix.appendRotation(this._rotationX,Vector3D.X_AXIS),this.posMatrix.appendRotation(this._rotationY,Vector3D.Y_AXIS),this.posMatrix.appendRotation(this._rotationZ,Vector3D.Z_AXIS),this.posMatrix.appendTranslation(this._x,this._y,this._z)},e.prototype.update=function(){},e.prototype.addStage=function(){this._onStage=!0},e.prototype.removeStage=function(){this._onStage=!1},e}(Object3D),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},Display3DSprite=function(t){function e(){t.call(this),this.time=0,this._rotationMatrix=new Matrix3D,this.lightMapTexture=TextureManager.getInstance().defaultLightMap}return __extends(e,t),e.prototype.setObjUrl=function(t){var e=this;this.objurl=t,ObjDataManager.getInstance().getObjData(Scene_data.fileRoot+t,function(t){e.objData=t,e.material&&(e.objData.tangentBuffer||ObjDataManager.getInstance().creatTBNBuffer(e.objData))})},e.prototype.setPicUrl=function(t){var e=this;this.picUrl=t,TextureManager.getInstance().getTexture(t,function(t){e.baseTexture=t})},e.prototype.setLightMapUrl=function(t){var e=this;if(t&&""!=t){var i=Scene_data.fileRoot+t;TextureManager.getInstance().getTexture(i,function(t){e.lightMapTexture=t})}},e.prototype.setMaterialUrl=function(t){var e=this;this.materialUrl=Scene_data.fileRoot+t;var i=new MaterialShader;MaterialManager.getInstance().getMaterial(this.materialUrl,function(t){e.material=t,e.material.useNormal&&e.objData&&!e.objData.tangentBuffer&&ObjDataManager.getInstance().creatTBNBuffer(e.objData),e.material.usePbr&&(e._rotationData=new Float32Array(9),e.updateRotationMatrix())},null,!0,i.name,i)},Object.defineProperty(e.prototype,"lightProbe",{get:function(){return this._lightProbe},set:function(t){if(this._lightProbe=t,this._lightProbe&&!this.resultSHVec){this.resultSHVec=[];for(var e=[.4444730390920146,-.3834955622240026,-.33124467509627725,.09365654209093091,-.05673310882817577,.2120523322966496,.02945768486978205,-.04965996229802928,-.1136529129285836],i=0;9>i;i++)this.resultSHVec.push(new Vector3D(e[i],e[i],e[i]))}},enumerable:!0,configurable:!0}),e.prototype.update=function(){if(this.sceneVisible){return this.updateMaterial(),void 0}},e.prototype.updateMaterial=function(){this.material&&this.objData&&this.checkMaterialTexture(this.material)&&(this.updateBind(),Scene_data.context3D.setProgram(this.material.program),Scene_data.context3D.setVcMatrix4fv(this.material.program,"viewMatrix3D",Scene_data.viewMatrx3D.m),Scene_data.context3D.setVcMatrix4fv(this.material.program,"camMatrix3D",Scene_data.cam3D.cameraMatrix.m),Scene_data.context3D.setVcMatrix4fv(this.material.program,"posMatrix3D",this.posMatrix.m),this.setBaseMaterialVc(this.material),this.setMaterialVc(this.material),this.setMaterialTexture(this.material),Scene_data.context3D.setVa(0,3,this.objData.vertexBuffer),Scene_data.context3D.setVa(1,2,this.objData.uvBuffer),Scene_data.context3D.setVa(2,2,this.objData.lightUvBuffer),this.material.usePbr&&(Scene_data.context3D.setVa(3,3,this.objData.normalsBuffer),Scene_data.context3D.setVcMatrix3fv(this.material.program,"rotationMatrix3D",this._rotationData)),this.material.useNormal&&(Scene_data.context3D.setVa(4,3,this.objData.tangentBuffer),Scene_data.context3D.setVa(5,3,this.objData.bitangentBuffer)),Scene_data.context3D.drawCall(this.objData.indexBuffer,this.objData.treNum))},e.prototype.setBind=function(t,e){this.bindTarget=t,this.bindSocket=e,this.bindMatrix=new Matrix3D},e.prototype.setGroup=function(t,e,i){this._isInGroup=!0,this._groupPos=t,this._groupRotation=e,this._groupScale=i,this.groupMatrix=new Matrix3D,this.groupRotationMatrix=new Matrix3D,this.groupMatrix.isIdentity=!1,this.groupMatrix.identity(),this.groupMatrix.appendScale(i.x,i.y,i.z),this.groupMatrix.appendRotation(e.x,Vector3D.X_AXIS),this.groupMatrix.appendRotation(e.y,Vector3D.Y_AXIS),this.groupMatrix.appendRotation(e.z,Vector3D.Z_AXIS),this.groupMatrix.appendTranslation(t.x,t.y,t.z),this.groupRotationMatrix.isIdentity=!1,this.groupRotationMatrix.identity(),this.groupRotationMatrix.prependRotation(e.z,Vector3D.Z_AXIS),this.groupRotationMatrix.prependRotation(e.y,Vector3D.Y_AXIS),this.groupRotationMatrix.prependRotation(e.x,Vector3D.X_AXIS)},e.prototype.updateBind=function(){this.bindTarget&&(this.posMatrix.identity(),this._isInGroup&&this.posMatrix.append(this.groupMatrix),this.bindTarget.getSocket(this.bindSocket,this.bindMatrix),this.posMatrix.append(this.bindMatrix),this.bindMatrix.copyTo(this._rotationMatrix),this._rotationMatrix.identityPostion(),this._isInGroup&&this._rotationMatrix.prepend(this.groupRotationMatrix))},e.prototype.setBaseMaterialVc=function(t){var e=0;t.hasTime&&(e=.001*(TimeUtil.getTimer()-this.time)),(t.hasTime||t.usePbr||t.useKill)&&Scene_data.context3D.setVc4fv(t.program,"fc0",[1,0,t.killNum,e]),t.usePbr&&Scene_data.context3D.setVc4fv(t.program,"fc2",[Scene_data.cam3D.x,Scene_data.cam3D.y,Scene_data.cam3D.z,1])},e.prototype.setMaterialVc=function(t){for(var e=t.constList,i=0;e.length>i;i++)Scene_data.context3D.setVc4fv(t.program,e[i].name,e[i].vecNum)},e.prototype.setMaterialTexture=function(t){for(var e=t.texList,i=0;e.length>i;i++)if(e[i].type==TexItem.LIGHTMAP)Scene_data.context3D.setRenderTexture(t.program,e[i].name,this.lightMapTexture,e[i].id);else if(e[i].type==TexItem.LTUMAP&&Scene_data.pubLut)Scene_data.context3D.setRenderTexture(t.program,e[i].name,Scene_data.pubLut,e[i].id);else if(e[i].type==TexItem.CUBEMAP)if(t.useDynamicIBL);else{var n=Math.floor(5*t.roughness);if(Scene_data.skyCubeMap){var a=Scene_data.skyCubeMap[n];Scene_data.context3D.setRenderTextureCube(t.program,e[i].name,a,e[i].id)}}else Scene_data.context3D.setRenderTexture(t.program,e[i].name,e[i].texture,e[i].id)},e.prototype.checkMaterialTexture=function(t){for(var e=t.texList,i=0;e.length>i;i++)if(e[i].type==TexItem.LIGHTMAP){if(!this.lightMapTexture)return!1}else if(e[i].type==TexItem.LTUMAP){if(!Scene_data.pubLut)return!1}else if(e[i].type==TexItem.CUBEMAP){if(t.useDynamicIBL);else if(!Scene_data.skyCubeMap)return!1}else if(!e[i].texture)return!1;return!0},e.prototype.updateRotationMatrix=function(){this._rotationMatrix.identity(),this._rotationMatrix.appendRotation(this._rotationX,Vector3D.X_AXIS),this._rotationMatrix.appendRotation(this._rotationY,Vector3D.Y_AXIS),this._rotationMatrix.appendRotation(this._rotationZ,Vector3D.Z_AXIS),this._rotationData&&this._rotationMatrix.getRotaion(this._rotationData)},e.prototype.setPos=function(t){this.x=t.x,this.y=t.y+10,this.z=t.z},e}(Display3D),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},Display3DSky=function(t){function e(){t.call(this),this.program=ProgrmaManager.getInstance().getProgram(SkyShader.Sky_Shader)}return __extends(e,t),e.prototype.setObjUrl=function(t){var e=this;this.objurl=t,ObjDataManager.getInstance().getObjData(Scene_data.fileRoot+t,function(t){e.objData=t})},e.prototype.setCubeUrl=function(t){var e=this;TextureManager.getInstance().loadCubeTexture(t,function(t){e.cubeTextList=t})},e.prototype.update=function(){Scene_data.context3D.setProgram(this.program),Scene_data.context3D.setVcMatrix4fv(this.program,"viewMatrix3D",Scene_data.viewMatrx3D.m),Scene_data.context3D.setVcMatrix4fv(this.program,"camMatrix3D",Scene_data.cam3D.cameraMatrix.m),Scene_data.context3D.setVcMatrix4fv(this.program,"posMatrix3D",this.posMatrix.m),this.cubeTextList&&Scene_data.context3D.setRenderTextureCube(this.program,"s_texture",this.cubeTextList[0],0),Scene_data.context3D.setVa(0,3,this.objData.vertexBuffer),Scene_data.context3D.setVa(1,3,this.objData.normalsBuffer),Scene_data.context3D.drawCall(this.objData.indexBuffer,this.objData.treNum)},e}(Display3D),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},Display3dMovie=function(t){function e(){t.call(this),this._completeState=0,this._defaultAction="stand",this._curentFrame=0,this._time=0,this._animDic={},this._partDic={},this._preLoadActionDic={},this._waitLoadActionDic={},this.showCapsule=!1,this._enablePhysics=!1}return __extends(e,t),e.prototype.setMeshUrl=function(t){var e=this;this._meshUrl=Scene_data.fileRoot+t,MeshDataManager.getInstance().getMeshData(this._meshUrl,function(t){e._skinMesh=t;for(var i in e._animDic)e.processAnimByMesh(e._animDic[i]);t.loadMaterial(function(t){e.loadMaterialCom(t)}),t.loadParticle(e),e._scaleX=e._scaleY=e._scaleZ=t.fileScale,e.updateMatrix()})},Object.defineProperty(e.prototype,"shadow",{set:function(t){t&&(this._shadow||(this._shadow=ShadowManager.getInstance().addShadow()))},enumerable:!0,configurable:!0}),e.prototype.loadMaterialCom=function(t){t.lightProbe&&(this.lightProbe=!0)},e.prototype.setCollision=function(t,e){this._capsule=new CapsuleVo(t,e),this._physicsBody=Physics.addDynamicCapsulePhysics(new Vector3D(this.x,this.y,this.z),t,e),this._enablePhysics=!0},e.prototype.addPart=function(t,e,i,n){var a=this;void 0===n&&(n=0),this._partDic[t]||(this._partDic[t]=[]);var o=this._partDic[t];if(0==n)LoadManager.getInstance().load(Scene_data.fileRoot+i,LoadManager.BYTE_TYPE,function(t){a.loadPartInfoCom(t,e,o)});else if(1==n){var r=ParticleManager.getInstance().getParticle(i);o.push(r),r.bindTarget=this,r.bindSocket=e,ParticleManager.getInstance().addParticle(r)}},e.prototype.loadPartInfoCom=function(t,e,i){for(var n=new egret.ByteArray(t),a=n.readInt(),o=0;a>o;o++){var r,s=n.readInt(),h=n.readUTF();1==s&&(r=n.readUTF());var c,l,p,u=n.readBoolean();if(u&&(c=new Vector3D(n.readFloat(),n.readFloat(),n.readFloat()),l=new Vector3D(n.readFloat(),n.readFloat(),n.readFloat()),p=new Vector3D(n.readFloat(),n.readFloat(),n.readFloat())),0==s){var d=ParticleManager.getInstance().getParticle(h);i.push(d),d.bindTarget=this,d.bindSocket=e,ParticleManager.getInstance().addParticle(d),u&&d.setGroup(c,l,p)}else if(1==s){var m=new Display3DSprite;m.setObjUrl(h),m.setMaterialUrl(r),i.push(m),m.setBind(this,e),SceneManager.getInstance().addDisplay(m),u&&m.setGroup(c,l,p)}}},e.prototype.getSocket=function(t,e){if(e.identity(),!this._skinMesh||!this._skinMesh.boneSocketDic[t])return e.append(this.posMatrix),void 0;var i,n=this._skinMesh.boneSocketDic[t],a=n.index;i=this.getFrameMatrix(a),e.appendScale(1/this._scaleX,1/this._scaleY,1/this._scaleZ),e.appendRotation(n.rotationX,Vector3D.X_AXIS),e.appendRotation(n.rotationY,Vector3D.Y_AXIS),e.appendRotation(n.rotationZ,Vector3D.Z_AXIS),e.appendTranslation(n.x,n.y,n.z),i&&(e.append(this._skinMesh.bindPosInvertMatrixAry[a]),e.append(i)),e.append(this.posMatrix)},e.prototype.getFrameMatrix=function(t){if(this._animDic[this._curentAction]){var e=this._animDic[this._curentAction];return e.matrixAry[this._curentFrame][t]}if(this._animDic[this._defaultAction]){var e=this._animDic[this._defaultAction];return e.matrixAry[this._curentFrame][t]}return null},e.prototype.addAction=function(t,e,i){void 0===i&&(i=!1),this._preLoadActionDic[t]=e,t==this._defaultAction||t==this._curentAction?this.setAnimUrl(t,e):i&&this.setAnimUrl(t,e)},e.prototype.setAnimUrl=function(t,e){var i=this;this._waitLoadActionDic[t]=!0,AnimManager.getInstance().getAnimData(Scene_data.fileRoot+e,function(e){i._animDic[t]=e,i.processAnimByMesh(e),i._waitLoadActionDic[t]=!1})},e.prototype.play=function(t,e){return void 0===e&&(e=0),this._curentAction!=t?(this._curentAction=t,this._completeState=e,this._time=0,this.updateFrame(0),this._animDic.hasOwnProperty(t)?!0:(!this._waitLoadActionDic[t]&&this._preLoadActionDic[t]&&this.setAnimUrl(t,this._preLoadActionDic[t]),!1)):void 0},e.prototype.processAnimByMesh=function(t){if(this._skinMesh)for(var e=0;t.matrixAry.length>e;e++)for(var i=t.matrixAry[e],n=0;i.length>n;n++)i[n].prepend(this._skinMesh.bindPosMatrixAry[n])},e.prototype.update=function(){if(this._skinMesh){this.lightProbe&&(this.resultSHVec=LightProbeManager.getInstance().getData(new Vector3D(this.x,this.y+50,this.z)));for(var t=0;this._skinMesh.meshAry.length>t;t++)this.updateMaterialMesh(this._skinMesh.meshAry[t]);this.showCapsule&&this.updateShowCapsule()}},e.prototype.updateFrame=function(t){this._time+=t;var e;if(this._curentAction&&this._animDic[this._curentAction])e=this._curentAction;else{if(!this._animDic[this._defaultAction])return;e=this._defaultAction}var i=this._animDic[e];this._curentFrame=float2int(this._time/(2*Scene_data.frameTime)),this._curentFrame>=i.matrixAry.length&&(0==this._completeState?(this._time=0,this._curentFrame=0):1==this._completeState?this._curentFrame=i.matrixAry.length-1:2==this._completeState?this.play(this._defaultAction):3==this._completeState)},e.prototype.updateShowCapsule=function(){this.capsuleLineSprite?(this.capsuleLineSprite.x=this.x,this.capsuleLineSprite.y=this.y+this._capsule.radius,this.capsuleLineSprite.z=this.z,this.capsuleLineSprite.update()):(this.capsuleLineSprite=new LineDisplaySprite,this.capsuleLineSprite.clear(),this.capsuleLineSprite.baseColor=new Vector3D(1,0,0,1),this.drawCylinder(this._capsule.radius,this._capsule.height),this.drawBall(this._capsule.radius),this.capsuleLineSprite.upToGpu())},e.prototype.drawBall=function(t){var e,i,n,a,o,r,s,h=t,c=12;for(o=0;c>=o;o++)for(n=null,a=c/2;c>a;a++)e=new Vector3D(h,0,0),i=new Matrix3D,i.appendRotation(360/c*a,Vector3D.Z_AXIS),e=i.transformVector(e),r=new Matrix3D,r.appendRotation(360/c*o,Vector3D.Y_AXIS),e=r.transformVector(e),n&&this.capsuleLineSprite.makeLineMode(n,e),n=e.clone();for(o=1;4>=o;o++)for(r=new Matrix3D,r.appendRotation(-20*o,Vector3D.Z_AXIS),s=r.transformVector(new Vector3D(h,0,0)),n=null,a=0;c>a;a++)e=s.clone(),i=new Matrix3D,i.appendRotation(360/c*a,Vector3D.Y_AXIS),e=i.transformVector(e),n&&this.capsuleLineSprite.makeLineMode(n,e),a==c-1&&this.capsuleLineSprite.makeLineMode(s,e),n=e.clone()},e.prototype.drawCylinder=function(t,e){var i,n,a,o=t,r=e,s=12;for(a=0;s>a;a++){var h=new Vector3D(o,0,0),c=new Vector3D(o,+r,0),l=new Matrix3D;l.appendRotation(a*(360/s),Vector3D.Y_AXIS);var p=l.transformVector(h),u=l.transformVector(c);this.capsuleLineSprite.makeLineMode(p,u),this.capsuleLineSprite.makeLineMode(u,new Vector3D(0,+r,0)),a==s-1&&(this.capsuleLineSprite.makeLineMode(p,h),this.capsuleLineSprite.makeLineMode(u,c)),(i||n)&&(this.capsuleLineSprite.makeLineMode(p,i),this.capsuleLineSprite.makeLineMode(u,n)),i=p.clone(),n=u.clone()}},e.prototype.updateMaterialMesh=function(t){t.material&&(Scene_data.context3D.setProgram(t.material.program),Scene_data.context3D.setVcMatrix4fv(t.material.program,"viewMatrix3D",Scene_data.viewMatrx3D.m),Scene_data.context3D.setVcMatrix4fv(t.material.program,"camMatrix3D",Scene_data.cam3D.cameraMatrix.m),Scene_data.context3D.setVcMatrix4fv(t.material.program,"posMatrix3D",this.posMatrix.m),Scene_data.context3D.setVcMatrix4fv(t.material.program,"rotationMatrix3D",this._rotationMatrix.m),this.setBaseMaterialVc(t.material),this.setMaterialVc(t.material),this.setMaterialTexture(t.material),Scene_data.context3D.setVa(0,3,t.vertexBuffer),Scene_data.context3D.setVa(1,2,t.uvBuffer),Scene_data.context3D.setVa(2,4,t.boneIdBuffer),Scene_data.context3D.setVa(3,4,t.boneWeightBuffer),t.material.usePbr?(Scene_data.context3D.setVa(4,4,t.normalsBuffer),t.material.useNormal&&(Scene_data.context3D.setVa(5,4,t.tangentBuffer),Scene_data.context3D.setVa(6,4,t.bitangentBuffer))):t.material.lightProbe&&Scene_data.context3D.setVa(4,4,t.normalsBuffer),this.setLightProbeVc(t.material),this.setMeshVc(t),Scene_data.context3D.drawCall(t.indexBuffer,t.treNum))},e.prototype.setLightProbeVc=function(t){if(t.lightProbe)for(var e=0;this.resultSHVec.length>e;e++)Scene_data.context3D.setVc3fv(t.program,"sh["+e+"]",[this.resultSHVec[e].x,this.resultSHVec[e].y,this.resultSHVec[e].z])},e.prototype.setMeshVc=function(t){var e;if(this._animDic[this._curentAction]){var i=this._animDic[this._curentAction];e=i.matrixAry[this._curentFrame]}else{if(!this._animDic[this._defaultAction])return;var i=this._animDic[this._defaultAction];e=i.matrixAry[this._curentFrame]}for(var n=t.boneNewIDAry,a=0;n.length>a;a++)Scene_data.context3D.setVcMatrix4fv(t.material.program,"bone["+a+"]",e[n[a]].m)},e.prototype.setPos=function(e){t.prototype.setPos.call(this,e),this._shadow&&(this._shadow.x=e.x,this._shadow.y=e.y+8,this._shadow.z=e.z)},e}(Display3DSprite),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},Display3dShadow=function(t){function e(){t.call(this),this.shadowList=[],this.objData=new ObjData,this.program=ProgrmaManager.getInstance().getProgram(Display3DShadowShader.Display3DShadowShader)}return __extends(e,t),e.prototype.addShadow=function(t){this.shadowList.push(t),this.applyObjData()},e.prototype.hasIdle=function(){return 30>this.shadowList.length},e.prototype.applyObjData=function(){this.objData.vertices.length=0,this.objData.uvs.length=0,this.objData.indexs.length=0;for(var t=20,e=0;this.shadowList.length>e;e++)this.objData.vertices.push(-t,0,t,t,0,t,t,0,-t,-t,0,-t),this.objData.uvs.push(0,0,e,0,1,e,1,1,e,1,0,e),this.objData.indexs.push(4*e,1+4*e,2+4*e,4*e,2+4*e,3+4*e);
this.objData.treNum=6*this.shadowList.length,this.objData.vertexBuffer?(Scene_data.context3D.uploadBuff3DByBuffer(this.objData.vertexBuffer,this.objData.vertices),Scene_data.context3D.uploadBuff3DByBuffer(this.objData.uvBuffer,this.objData.uvs),Scene_data.context3D.uploadIndexBuff3DByBuffer(this.objData.indexBuffer,this.objData.indexs)):(this.objData.vertexBuffer=Scene_data.context3D.uploadBuff3D(this.objData.vertices),this.objData.uvBuffer=Scene_data.context3D.uploadBuff3D(this.objData.uvs),this.objData.indexBuffer=Scene_data.context3D.uploadIndexBuff3D(this.objData.indexs))},e.prototype.update=function(){Scene_data.context3D.setBlendParticleFactors(0),Scene_data.context3D.setProgram(this.program),Scene_data.context3D.setVcMatrix4fv(this.program,"viewMatrix3D",Scene_data.viewMatrx3D.m),Scene_data.context3D.setVcMatrix4fv(this.program,"camMatrix3D",Scene_data.cam3D.cameraMatrix.m);for(var t=0;this.shadowList.length>t;t++)Scene_data.context3D.setVc3fv(this.program,"pos["+t+"]",this.shadowList[t].data);Scene_data.context3D.setVa(0,3,this.objData.vertexBuffer),Scene_data.context3D.setVa(1,3,this.objData.uvBuffer),Scene_data.context3D.setRenderTexture(this.program,"s_texture",e.texture,0),Scene_data.context3D.drawCall(this.objData.indexBuffer,this.objData.treNum)},e}(Display3D),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},Display3dBg=function(t){function e(){t.call(this),this._scaleData=[1,1],this.program=ProgrmaManager.getInstance().getProgram(UIImageShader.UI_IMG_SHADER),this.initData()}return __extends(e,t),e.prototype.initData=function(){this.objData=new ObjData,this.objData.vertices.push(-1,1,.99,1,1,.99,1,-1,.99,-1,-1,.99),this.objData.uvs.push(0,0,1,0,1,1,0,1),this.objData.indexs.push(0,1,2,0,2,3),this.objData.treNum=6,this.objData.vertexBuffer=Scene_data.context3D.uploadBuff3D(this.objData.vertices),this.objData.uvBuffer=Scene_data.context3D.uploadBuff3D(this.objData.uvs),this.objData.indexBuffer=Scene_data.context3D.uploadIndexBuff3D(this.objData.indexs)},e.prototype.resize=function(){this.appleyPos()},e.prototype.setImgInfo=function(t,e,i){this.setImgUrl(t),this._width=e,this._height=i},e.prototype.setImgUrl=function(t){var e=this;TextureManager.getInstance().getTexture(Scene_data.fileRoot+t,function(t){e.texture=t})},e.prototype.appleyPos=function(){var t=this._width/Scene_data.stageWidth,e=this._height/Scene_data.stageHeight;e>t?(this._scaleData[0]=1,this._scaleData[1]=this._height/Scene_data.stageHeight/t):(this._scaleData[0]=this._width/Scene_data.stageWidth/e,this._scaleData[1]=1)},e.prototype.update=function(){this.appleyPos(),Scene_data.context3D.setBlendParticleFactors(0),Scene_data.context3D.setProgram(this.program),Scene_data.context3D.setVa(0,3,this.objData.vertexBuffer),Scene_data.context3D.setVa(1,2,this.objData.uvBuffer),Scene_data.context3D.setVc2fv(this.program,"scale",this._scaleData),Scene_data.context3D.setRenderTexture(this.program,"s_texture",this.texture,0),Scene_data.context3D.drawCall(this.objData.indexBuffer,this.objData.treNum)},e}(Display3D),Engine=function(){function t(){}return t.init=function(e){Scene_data.canvas3D=e,Scene_data.context3D=new Context3D,Scene_data.context3D.init(e),Scene_data.cam3D=new Camera3D,Scene_data.focus3D=new Object3D,Scene_data.focus3D.x=0,Scene_data.focus3D.y=0,Scene_data.focus3D.z=0,Scene_data.focus3D.rotationY=135,Scene_data.focus3D.rotationX=-45,t.resetSize(),TimeUtil.init(),t.initPbr(),UIManager.getInstance().init(),ServerManager.getInstance().init()},t.initPbr=function(){TextureManager.getInstance().getTexture("assets/brdf_ltu.jpg",function(t){Scene_data.pubLut=t}),TextureManager.getInstance().loadCubeTexture("assets/cube/bb",function(t){Scene_data.skyCubeMap=t}),TextureManager.getInstance().getTexture("assets/shadow.png",function(t){Display3dShadow.texture=t})},t.resetSize=function(){document.body.clientWidth>document.body.clientHeight?(Scene_data.stageWidth=document.body.clientWidth,Scene_data.stageHeight=document.body.clientHeight,Scene_data.verticalScene=!1):(Scene_data.stageWidth=document.body.clientHeight,Scene_data.stageHeight=document.body.clientWidth,Scene_data.verticalScene=!0),Scene_data.canvas3D.width=Scene_data.stageWidth,Scene_data.canvas3D.height=Scene_data.stageHeight,Scene_data.context3D.resetSize(Scene_data.stageWidth,Scene_data.stageHeight),UIManager.getInstance().resize(),Scene_data.viewMatrx3D?Scene_data.viewMatrx3D.identity():Scene_data.viewMatrx3D=new Matrix3D;var t=Scene_data.stageWidth,e=Scene_data.stageHeight;0==Scene_data.user?(Scene_data.sceneViewHW=Math.max(t,e),Scene_data.viewMatrx3D.perspectiveFieldOfViewLH(1,1,500,5e3)):Scene_data.viewMatrx3D.perspectiveFieldOfViewLH(1,1,10,5e3),Scene_data.viewMatrx3D.appendScale(1*2*(Scene_data.sceneViewHW/t),t/e*2*(Scene_data.sceneViewHW/t),1),Scene_data.canvas3D.style.position="absolute",Scene_data.canvas3D.style.left="0px",Scene_data.canvas3D.style.top="0px",Scene_data.canvas3D.style.transform=Scene_data.verticalScene?"matrix(0,1,-1,0,"+Scene_data.stageHeight+",0)":"matrix(1,0,0,1,0,0)",Scene_data.canvas3D.style.transformOrigin="0px 0px 0px"},t.update=function(){Physics.update(),SceneManager.getInstance().update()},t}(),MathClass=function(){function t(){}return t.getCamView=function(t,e){t.update();var i=new Matrix3D;i.appendRotation(-e.rotationX,Vector3D.X_AXIS),i.appendRotation(-e.rotationY,Vector3D.Y_AXIS),i.appendTranslation(e.x,e.y,e.z);var n=i.transformVector(new Vector3D(0,0,-t.distance));return t.x=n.x,t.y=n.y,t.z=n.z,t.rotationX=e.rotationX,t.rotationY=e.rotationY,t.cameraMatrix.identity(),t.cameraMatrix.prependTranslation(0,0,t.distance),t.cameraMatrix.prependRotation(t.rotationX,Vector3D.X_AXIS),t.cameraMatrix.prependRotation(t.rotationY,Vector3D.Y_AXIS),t.cameraMatrix.prependTranslation(-e.x,-e.y,-e.z),t.cameraMatrix.m},t.math_distance=function(t,e,i,n){return Math.sqrt((n-e)*(n-e)+(i-t)*(i-t))},t.MathCam=function(t){var e=new Matrix3D;e.prependRotation(t.rotationX,Vector3D.X_AXIS),e.prependRotation(t.rotationY,Vector3D.Y_AXIS),e.prependTranslation(-t.x,-t.y,-t.z),t.cameraMatrix.identity(),t.cameraMatrix.append(e)},t.GetViewHitBoxData=function(t){var e=Scene_data.cam3D.cameraMatrix.clone();e.invert();var i=Scene_data.viewMatrx3D.m[0],n=Scene_data.viewMatrx3D.m[5];this.viewBoxVecItem?(this.lastViewScale.x!=i||this.lastViewScale.y!=n)&&(this.viewBoxVecItem[0]=new Vector3D(-t/i,-t/n,t),this.viewBoxVecItem[1]=new Vector3D(-t/i,+t/n,t),this.viewBoxVecItem[2]=new Vector3D(+t/i,-t/n,t),this.viewBoxVecItem[3]=new Vector3D(+t/i,+t/n,t),this.viewBoxVecItem[4]=new Vector3D(0,0,0)):(this.lastViewScale=new Vector2D(i,n),this.viewBoxVecItem=[],this.viewBoxVecItem.push(new Vector3D(-t/i,-t/n,t)),this.viewBoxVecItem.push(new Vector3D(-t/i,+t/n,t)),this.viewBoxVecItem.push(new Vector3D(+t/i,-t/n,t)),this.viewBoxVecItem.push(new Vector3D(+t/i,+t/n,t)),this.viewBoxVecItem.push(new Vector3D(0,0,0)))},t}(),Matrix3D=function(){function t(){this.isIdentity=!0;var t=Array.prototype.concat.apply([],arguments);t=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],this.m=new Float32Array(t)}return t.prototype.clone=function(){var e=new t;return e.m[0]=this.m[0],e.m[1]=this.m[1],e.m[2]=this.m[2],e.m[3]=this.m[3],e.m[4]=this.m[4],e.m[5]=this.m[5],e.m[6]=this.m[6],e.m[7]=this.m[7],e.m[8]=this.m[8],e.m[9]=this.m[9],e.m[10]=this.m[10],e.m[11]=this.m[11],e.m[12]=this.m[12],e.m[13]=this.m[13],e.m[14]=this.m[14],e.m[15]=this.m[15],e},t.prototype.copyTo=function(t){t.m[0]=this.m[0],t.m[1]=this.m[1],t.m[2]=this.m[2],t.m[3]=this.m[3],t.m[4]=this.m[4],t.m[5]=this.m[5],t.m[6]=this.m[6],t.m[7]=this.m[7],t.m[8]=this.m[8],t.m[9]=this.m[9],t.m[10]=this.m[10],t.m[11]=this.m[11],t.m[12]=this.m[12],t.m[13]=this.m[13],t.m[14]=this.m[14],t.m[15]=this.m[15]},t.prototype.identity=function(){this.m[0]=1,this.m[1]=0,this.m[2]=0,this.m[3]=0,this.m[4]=0,this.m[5]=1,this.m[6]=0,this.m[7]=0,this.m[8]=0,this.m[9]=0,this.m[10]=1,this.m[11]=0,this.m[12]=0,this.m[13]=0,this.m[14]=0,this.m[15]=1},t.prototype.invert=function(){var t=this.m,e=t[0],i=t[1],n=t[2],a=t[3],o=t[4],r=t[5],s=t[6],h=t[7],c=t[8],l=t[9],p=t[10],u=t[11],d=t[12],m=t[13],f=t[14],y=t[15],v=e*r-i*o,x=e*s-n*o,g=e*h-a*o,_=i*s-n*r,D=i*h-a*r,w=n*h-a*s,b=c*m-l*d,S=c*f-p*d,M=c*y-u*d,C=l*f-p*m,T=l*y-u*m,A=p*y-u*f,I=v*A-x*T+g*C+_*M-D*S+w*b;return I?(I=1/I,this.m[0]=(r*A-s*T+h*C)*I,this.m[1]=(n*T-i*A-a*C)*I,this.m[2]=(m*w-f*D+y*_)*I,this.m[3]=(p*D-l*w-u*_)*I,this.m[4]=(s*M-o*A-h*S)*I,this.m[5]=(e*A-n*M+a*S)*I,this.m[6]=(f*g-d*w-y*x)*I,this.m[7]=(c*w-p*g+u*x)*I,this.m[8]=(o*T-r*M+h*b)*I,this.m[9]=(i*M-e*T-a*b)*I,this.m[10]=(d*D-m*g+y*v)*I,this.m[11]=(l*g-c*D-u*v)*I,this.m[12]=(r*S-o*C-s*b)*I,this.m[13]=(e*C-i*S+n*b)*I,this.m[14]=(m*x-d*_-f*v)*I,this.m[15]=(c*_-l*x+p*v)*I,void 0):null},t.prototype.invertToMatrix=function(t){var e=this.m,i=e[0],n=e[1],a=e[2],o=e[3],r=e[4],s=e[5],h=e[6],c=e[7],l=e[8],p=e[9],u=e[10],d=e[11],m=e[12],f=e[13],y=e[14],v=e[15],x=i*s-n*r,g=i*h-a*r,_=i*c-o*r,D=n*h-a*s,w=n*c-o*s,b=a*c-o*h,S=l*f-p*m,M=l*y-u*m,C=l*v-d*m,T=p*y-u*f,A=p*v-d*f,I=u*v-d*y,E=x*I-g*A+_*T+D*C-w*M+b*S;return E?(E=1/E,t.m[0]=(s*I-h*A+c*T)*E,t.m[1]=(a*A-n*I-o*T)*E,t.m[2]=(f*b-y*w+v*D)*E,t.m[3]=(u*w-p*b-d*D)*E,t.m[4]=(h*C-r*I-c*M)*E,t.m[5]=(i*I-a*C+o*M)*E,t.m[6]=(y*_-m*b-v*g)*E,t.m[7]=(l*b-u*_+d*g)*E,t.m[8]=(r*A-s*C+c*S)*E,t.m[9]=(n*C-i*A-o*S)*E,t.m[10]=(m*w-f*_+v*x)*E,t.m[11]=(p*_-l*w-d*x)*E,t.m[12]=(s*M-r*T-h*S)*E,t.m[13]=(i*T-n*M+a*S)*E,t.m[14]=(f*g-m*D-y*x)*E,t.m[15]=(l*D-p*g+u*x)*E,void 0):null},t.prototype.appendTranslation=function(e,i,n){t.tempM.identity(),t.tempM.prependTranslation(e,i,n),this.append(t.tempM)},t.prototype.prependTranslation=function(t,e,i){var n=this.m;n[12]=n[0]*t+n[4]*e+n[8]*i+n[12],n[13]=n[1]*t+n[5]*e+n[9]*i+n[13],n[14]=n[2]*t+n[6]*e+n[10]*i+n[14],n[15]=n[3]*t+n[7]*e+n[11]*i+n[15]},t.prototype.transformVector=function(t){var e=new Vector3D;return e.x=this.m[0]*t.x+this.m[4]*t.y+this.m[8]*t.z+this.m[12]*t.w,e.y=this.m[1]*t.x+this.m[5]*t.y+this.m[9]*t.z+this.m[13]*t.w,e.z=this.m[2]*t.x+this.m[6]*t.y+this.m[10]*t.z+this.m[14]*t.w,e.w=this.m[3]*t.x+this.m[7]*t.y+this.m[11]*t.z+this.m[15]*t.w,e},t.prototype.append=function(e){t.tempM.m[0]=e.m[0],t.tempM.m[1]=e.m[1],t.tempM.m[2]=e.m[2],t.tempM.m[3]=e.m[3],t.tempM.m[4]=e.m[4],t.tempM.m[5]=e.m[5],t.tempM.m[6]=e.m[6],t.tempM.m[7]=e.m[7],t.tempM.m[8]=e.m[8],t.tempM.m[9]=e.m[9],t.tempM.m[10]=e.m[10],t.tempM.m[11]=e.m[11],t.tempM.m[12]=e.m[12],t.tempM.m[13]=e.m[13],t.tempM.m[14]=e.m[14],t.tempM.m[15]=e.m[15],t.tempM.prepend(this),this.m[0]=t.tempM.m[0],this.m[1]=t.tempM.m[1],this.m[2]=t.tempM.m[2],this.m[3]=t.tempM.m[3],this.m[4]=t.tempM.m[4],this.m[5]=t.tempM.m[5],this.m[6]=t.tempM.m[6],this.m[7]=t.tempM.m[7],this.m[8]=t.tempM.m[8],this.m[9]=t.tempM.m[9],this.m[10]=t.tempM.m[10],this.m[11]=t.tempM.m[11],this.m[12]=t.tempM.m[12],this.m[13]=t.tempM.m[13],this.m[14]=t.tempM.m[14],this.m[15]=t.tempM.m[15]},t.prototype.prepend=function(t){var e=t.m,i=this.m,n=this.m,a=n[0],o=n[1],r=n[2],s=n[3],h=n[4],c=n[5],l=n[6],p=n[7],u=n[8],d=n[9],m=n[10],f=n[11],y=n[12],v=n[13],x=n[14],g=n[15],_=e[0],D=e[1],w=e[2],b=e[3];i[0]=_*a+D*h+w*u+b*y,i[1]=_*o+D*c+w*d+b*v,i[2]=_*r+D*l+w*m+b*x,i[3]=_*s+D*p+w*f+b*g,_=e[4],D=e[5],w=e[6],b=e[7],i[4]=_*a+D*h+w*u+b*y,i[5]=_*o+D*c+w*d+b*v,i[6]=_*r+D*l+w*m+b*x,i[7]=_*s+D*p+w*f+b*g,_=e[8],D=e[9],w=e[10],b=e[11],i[8]=_*a+D*h+w*u+b*y,i[9]=_*o+D*c+w*d+b*v,i[10]=_*r+D*l+w*m+b*x,i[11]=_*s+D*p+w*f+b*g,_=e[12],D=e[13],w=e[14],b=e[15],i[12]=_*a+D*h+w*u+b*y,i[13]=_*o+D*c+w*d+b*v,i[14]=_*r+D*l+w*m+b*x,i[15]=_*s+D*p+w*f+b*g},t.prototype.appendRotation=function(e,i){t.tempM.identity(),t.tempM.prependRotation(e,i),this.append(t.tempM)},t.prototype.tomat3=function(){var t=Array.prototype.concat.apply([],arguments);t=[1,0,0,0,1,0,0,0,1];var e=new Float32Array(t);return e[0]=this.m[0],e[1]=this.m[1],e[2]=this.m[2],e[3]=this.m[4],e[4]=this.m[5],e[5]=this.m[6],e[6]=this.m[8],e[7]=this.m[9],e[8]=this.m[10],e},t.prototype.getRotaion=function(t){t[0]=this.m[0],t[1]=this.m[1],t[2]=this.m[2],t[3]=this.m[4],t[4]=this.m[5],t[5]=this.m[6],t[6]=this.m[8],t[7]=this.m[9],t[8]=this.m[10]},Object.defineProperty(t.prototype,"postion",{get:function(){return new Vector3D(this.m[12],this.m[13],this.m[14])},enumerable:!0,configurable:!0}),t.prototype.identityPostion=function(){this.m[12]=0,this.m[13]=0,this.m[14]=0},Object.defineProperty(t.prototype,"x",{get:function(){return this.m[12]},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return this.m[13]},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"z",{get:function(){return this.m[14]},enumerable:!0,configurable:!0}),t.prototype.prependRotation=function(t,e){var i,n,a,o,r,s,h,c,l,p,u,d,m,f,y,v,x,g,_,D,w,b,S,M,C=this.m,T=this.m,A=e.x,I=e.y,E=e.z,P=Math.sqrt(A*A+I*I+E*E);return 1e-6>Math.abs(P)?null:(P=1/P,A*=P,I*=P,E*=P,i=Math.sin(t*Math.PI/180),n=Math.cos(t*Math.PI/180),a=1-n,o=T[0],r=T[1],s=T[2],h=T[3],c=T[4],l=T[5],p=T[6],u=T[7],d=T[8],m=T[9],f=T[10],y=T[11],v=A*A*a+n,x=I*A*a+E*i,g=E*A*a-I*i,_=A*I*a-E*i,D=I*I*a+n,w=E*I*a+A*i,b=A*E*a+I*i,S=I*E*a-A*i,M=E*E*a+n,C[0]=o*v+c*x+d*g,C[1]=r*v+l*x+m*g,C[2]=s*v+p*x+f*g,C[3]=h*v+u*x+y*g,C[4]=o*_+c*D+d*w,C[5]=r*_+l*D+m*w,C[6]=s*_+p*D+f*w,C[7]=h*_+u*D+y*w,C[8]=o*b+c*S+d*M,C[9]=r*b+l*S+m*M,C[10]=s*b+p*S+f*M,C[11]=h*b+u*S+y*M,T!==C&&(C[12]=T[12],C[13]=T[13],C[14]=T[14],C[15]=T[15]),C)},t.prototype.prependScale=function(t,e,i){var n=this.m,a=this.m;return a[0]=n[0]*t,a[1]=n[1]*t,a[2]=n[2]*t,a[3]=n[3]*t,a[4]=n[4]*e,a[5]=n[5]*e,a[6]=n[6]*e,a[7]=n[7]*e,a[8]=n[8]*i,a[9]=n[9]*i,a[10]=n[10]*i,a[11]=n[11]*i,a[12]=n[12],a[13]=n[13],a[14]=n[14],a[15]=n[15],a},t.prototype.appendScale=function(e,i,n){t.tempM.identity(),t.tempM.prependScale(e,i,n),this.append(t.tempM)},t.prototype.perspectiveFieldOfViewLH=function(t,e,i,n){var a=1/Math.tan(t/2),o=a/e,r=this.m;r[0]=o,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=a,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=n/(n-i),r[11]=1,r[12]=0,r[13]=0,r[14]=i*n/(i-n),r[15]=0},t.prototype.fromVtoV=function(t,e){var i=t.cross(e),n=Math.acos(t.dot(e)),a=new Quaternion;a.fromAxisAngle(i,n),a.toMatrix3D(this)},t.prototype.buildLookAtLH=function(t,e,i){var n=this.m,a=new Vector3D;a.x=e.x-t.x,a.y=e.y-t.y,a.z=e.z-t.z,a.normalize();var o=i.cross(a);o.normalize();var r=a.cross(o);n[0]=o.x,n[1]=r.x,n[2]=a.x,n[3]=0,n[4]=o.y,n[5]=r.y,n[6]=a.y,n[7]=0,n[8]=o.z,n[9]=r.z,n[10]=a.z,n[11]=0,n[12]=-o.dot(t),n[13]=-r.dot(t),n[14]=-a.dot(t),n[15]=1},t.tempM=new t,t}(),Quaternion=function(){function t(t,e,i,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=1),this.x=0,this.y=0,this.z=0,this.w=1,this.x=t,this.y=e,this.z=i,this.w=n}return t.prototype.print=function(){alert(this.x+""+" "+(this.y+"")+" "+(this.z+"")+" "+(this.w+""))},t.prototype.toEulerAngles=function(t){void 0===t&&(t=null),t||(t=new Vector3D);var e=this.x,i=this.y,n=this.z,a=this.w;return t.x=Math.atan2(2*(a*e+i*n),1-2*(e*e+i*i)),t.y=Math.asin(2*(a*i-n*e)),t.z=Math.atan2(2*(a*n+e*i),1-2*(i*i+n*n)),t},t.prototype.toMatrix3D=function(t){void 0===t&&(t=null),t||(t=new Matrix3D);var e=t.m,i=this.x,n=this.y,a=this.z,o=this.w,r=i+i,s=n+n,h=a+a,c=i*r,l=n*r,p=n*s,u=a*r,d=a*s,m=a*h,f=o*r,y=o*s,v=o*h;return e[0]=1-p-m,e[1]=l+v,e[2]=u-y,e[3]=0,e[4]=l-v,e[5]=1-c-m,e[6]=d+f,e[7]=0,e[8]=u+y,e[9]=d-f,e[10]=1-c-p,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,t},t.prototype.fromAxisAngle=function(t,e){var i=Math.sin(e/2),n=Math.cos(e/2);this.x=t.x*i,this.y=t.y*i,this.z=t.z*i,this.w=n,this.normalize()},t.prototype.normalize=function(t){void 0===t&&(t=1);var e=t/Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);this.x*=e,this.y*=e,this.z*=e,this.w*=e},t.prototype.fromMatrix=function(t){var e=[0,0,0,0,0,0,0,0,0];e[0]=t.m[0],e[1]=t.m[1],e[2]=t.m[2],e[3]=t.m[4],e[4]=t.m[5],e[5]=t.m[6],e[6]=t.m[8],e[7]=t.m[9],e[8]=t.m[10];var i,n=e[0]+e[4]+e[8],a=[0,0,0,0];if(n>0)i=Math.sqrt(n+1),a[3]=.5*i,i=.5/i,a[0]=(e[5]-e[7])*i,a[1]=(e[6]-e[2])*i,a[2]=(e[1]-e[3])*i;else{var o=0;e[4]>e[0]&&(o=1),e[8]>e[3*o+o]&&(o=2);var r=(o+1)%3,s=(o+2)%3;i=Math.sqrt(e[3*o+o]-e[3*r+r]-e[3*s+s]+1),a[o]=.5*i,i=.5/i,a[3]=(e[3*r+s]-e[3*s+r])*i,a[r]=(e[3*r+o]+e[3*o+r])*i,a[s]=(e[3*s+o]+e[3*o+s])*i}this.x=a[0],this.y=a[1],this.z=a[2],this.w=a[3]},t.prototype.setMd5W=function(){this.w=1-(this.x*this.x+this.y*this.y+this.z*this.z),this.w=0>this.w?0:-Math.sqrt(this.w)},t}(),Vector3D=function(){function t(t,e,i,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=1),this.x=0,this.y=0,this.z=0,this.w=1,this.x=t,this.y=e,this.z=i,this.w=n}return t.prototype.normalize=function(){var t=this.length;0!=t&&this.scaleBy(1/t)},Object.defineProperty(t.prototype,"length",{get:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},enumerable:!0,configurable:!0}),t.prototype.scaleBy=function(t){this.x*=t,this.y*=t,this.z*=t,this.w*=t},t.prototype.scaleByW=function(){this.x*=this.w,this.y*=this.w,this.z*=this.w},t.prototype.add=function(e){return new t(this.x+e.x,this.y+e.y,this.z+e.z)},t.prototype.subtract=function(e){return new t(this.x-e.x,this.y-e.y,this.z-e.z)},t.prototype.addByNum=function(t,e,i,n){void 0===n&&(n=0),this.x+=t,this.y+=e,this.z+=i,this.w+=n},t.prototype.setTo=function(t,e,i){this.x=t,this.y=e,this.z=i},t.prototype.cross=function(e){return new t(this.y*e.z-this.z*e.y,this.z*e.x-this.x*e.z,this.x*e.y-this.y*e.x)},t.prototype.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},t.prototype.clone=function(){return new t(this.x,this.y,this.z)},t.distance=function(t,e){var i=t.x-e.x,n=t.y-e.y,a=t.z-e.z;return Math.sqrt(i*i+n*n+a*a)},t.prototype.toString=function(){return"Vector3D("+(this.x+"")+","+(this.y+"")+","+(this.z+"")+","+(this.w+"")+")"},t.X_AXIS=new t(1,0,0),t.Y_AXIS=new t(0,1,0),t.Z_AXIS=new t(0,0,1),t}(),Vector2D=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x=0,this.y=0,this.x=t,this.y=e}return t.prototype.normalize=function(){var t=this.length;0!=t&&this.scaleBy(1/t)},Object.defineProperty(t.prototype,"length",{get:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},enumerable:!0,configurable:!0}),t.prototype.scaleBy=function(t){this.x*=t,this.y*=t},t.prototype.toString=function(){return"Vector2D("+(this.x+"")+","+(this.y+"")+")"},t.distance=function(t,e){var i=t.x-e.x,n=t.y-e.y;return Math.sqrt(i*i+n*n)},t}(),Rectangle=function(){function t(t,e,i,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=1),void 0===n&&(n=1),this.x=0,this.y=0,this.width=0,this.height=1,this.x=t,this.y=e,this.width=i,this.height=n}return t}(),Circle=function(){function t(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),this.setData(t,e,i)}return t.prototype.setData=function(t,e,i){this.x=t,this.y=e,this.radius=i},t.prototype.setPos=function(t,e){this.x=t,this.y=e},Object.defineProperty(t.prototype,"x",{get:function(){return this._x},set:function(t){this._x=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return this._y},set:function(t){this._y=t},enumerable:!0,configurable:!0}),t.prototype.setRadius=function(t){this.radius=t},t.prototype.testPoint=function(t){var e=this.x-t.x,i=this.y-t.y;return Math.sqrt(e*e+i*i)<this.radius},t}(),ProgrmaManager=function(){function t(){this._dic={}}return t.getInstance=function(){return this._instance||(this._instance=new t),this._instance},t.prototype.getProgram=function(t){return this._dic[t]?this._dic[t]:(alert("please registe Program=>"+t),null)},t.prototype.registe=function(t,e){this._dic[t]||(e.encode(),this._dic[t]=e.program)},t.prototype.getMaterialProgram=function(t,e,i,n,a){void 0===n&&(n=null),void 0===a&&(a=!1);var o=t+"_"+i.url;if(n){for(var r=0;n.length>r;r++)o+="_"+n[r];o+=""+a}return this._dic[o]?this._dic[o]:(a&&(n=[i.usePbr,i.useNormal,i.hasFresnel,i.useDynamicIBL,i.lightProbe]),e.paramAry=n,e.fragment=i.shaderStr,e.encode(),e.program)},t}(),Shader3D=function(){function t(){this.fragment=this.getFragmentShaderString()}return t.prototype.encode=function(){this.vertex=this.getVertexShaderString();var t=Scene_data.context3D.renderContext;this.program=t.createProgram();var e=t.createShader(t.VERTEX_SHADER),i=t.createShader(t.FRAGMENT_SHADER);t.shaderSource(e,this.vertex),t.shaderSource(i,this.fragment),t.compileShader(e),t.compileShader(i),t.attachShader(this.program,e),t.attachShader(this.program,i),this.binLocation(t),t.linkProgram(this.program);var n=t.getProgramInfoLog(this.program),a=t.getShaderInfoLog(e),o=t.getShaderInfoLog(i);""!=n&&console.log("shader"+n+","+a+","+o)},t.prototype.binLocation=function(){},t.prototype.getVertexShaderString=function(){return""},t.prototype.getFragmentShaderString=function(){return""},t}(),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},BuildShader=function(t){function e(){t.call(this)}return __extends(e,t),e.prototype.binLocation=function(t){t.bindAttribLocation(this.program,0,"v3Position"),t.bindAttribLocation(this.program,1,"v2CubeTexST")},e.prototype.getVertexShaderString=function(){var t="attribute vec3 v3Position;attribute vec2 v2CubeTexST;uniform mat4 viewMatrix3D;uniform mat4 camMatrix3D;uniform mat4 posMatrix3D;varying vec2 v_texCoord;void main(void){   v_texCoord = vec2(v2CubeTexST.x, v2CubeTexST.y);   vec4 vt0= vec4(v3Position, 1.0);   vt0 = posMatrix3D * vt0;   vt0 = camMatrix3D * vt0;   vt0 = viewMatrix3D * vt0;   gl_Position = vt0;}";return t},e.prototype.getFragmentShaderString=function(){var t=" precision mediump float;\nuniform sampler2D s_texture;\nuniform vec4 testconst;uniform vec4 testconst2;varying vec2 v_texCoord;\nvoid main(void)\n{\nvec4 infoUv = texture2D(s_texture, v_texCoord.xy);\nvec4 test = vec4(0,0,0,1);\ntest.xyz = mix(vec3(1,1,1)*0.5,testconst.xyz,0.5);\ninfoUv.xyz = test.xyz * infoUv.xyz;\ngl_FragColor = infoUv;\n}";return t},e.buildShader="BuildShader",e}(Shader3D),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},MaterialShader=function(t){function e(){t.call(this),this.name="Material_shader"}return __extends(e,t),e.prototype.binLocation=function(t){t.bindAttribLocation(this.program,0,"v3Position"),t.bindAttribLocation(this.program,1,"v2CubeTexST"),t.bindAttribLocation(this.program,2,"v2lightuv"),this.paramAry[0]&&t.bindAttribLocation(this.program,3,"v3Normal"),this.paramAry[1]&&(t.bindAttribLocation(this.program,4,"v3Tangent"),t.bindAttribLocation(this.program,5,"v3Bitangent"))},e.prototype.getVertexShaderString=function(){var t=this.paramAry[0],e=this.paramAry[1];this.paramAry[2],this.paramAry[3],this.paramAry[4];var i="attribute vec3 v3Position;\nattribute vec2 v2CubeTexST;\nattribute vec2 v2lightuv;\nvarying vec2 v0;\nvarying vec2 v2;\n";return t&&(i+="attribute vec3 v3Normal;\nvarying vec3 v1;\n",i+=e?"varying mat3 v4;\n":"varying vec3 v4;\n"),e&&(i+="attribute vec3 v3Tangent;\nattribute vec3 v3Bitangent;\n"),i+="uniform mat4 viewMatrix3D;\nuniform mat4 camMatrix3D;\nuniform mat4 posMatrix3D;\nuniform mat3 rotationMatrix3D;\nvoid main(void){\nv0 = vec2(v2CubeTexST.x, v2CubeTexST.y);\nv2 = vec2(v2lightuv.x, v2lightuv.y);\nvec4 vt0= vec4(v3Position, 1.0);\nvt0 = posMatrix3D * vt0;\n",t&&(i+="v1 = vec3(vt0.x,vt0.y,vt0.z);\n"),i+="vt0 = camMatrix3D * vt0;\nvt0 = viewMatrix3D * vt0;\n",t&&(i+=e?"v4 = mat3(rotationMatrix3D * v3Tangent,rotationMatrix3D * v3Bitangent, rotationMatrix3D * v3Normal);\n":"v4 = rotationMatrix3D * v3Normal;\n"),i+="gl_Position = vt0;}"},e.prototype.getFragmentShaderString=function(){var t="uniform sampler2D s_texture1;\nuniform vec4 testconst;varying vec2 v_texCoord;\nvoid main(void)\n{\nvec4 infoUv = texture2D(s_texture, v_texCoord.xy);\ninfoUv.xyz = testconst.xyz * infoUv.xyz;\ngl_FragColor = infoUv;\n}";return t},e}(Shader3D),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},MaterialAnimShader=function(t){function e(){t.call(this),this.name="Material_Anim_shader"}return __extends(e,t),e.prototype.binLocation=function(t){t.bindAttribLocation(this.program,0,"pos"),t.bindAttribLocation(this.program,1,"v2Uv"),t.bindAttribLocation(this.program,2,"boneID"),t.bindAttribLocation(this.program,3,"boneWeight");var e=this.paramAry[0],i=this.paramAry[1],n=this.paramAry[4];e?(t.bindAttribLocation(this.program,4,"normal"),i&&(t.bindAttribLocation(this.program,5,"tangent"),t.bindAttribLocation(this.program,6,"bitangent"))):n&&t.bindAttribLocation(this.program,4,"normal")},e.prototype.getVertexShaderString=function(){var t=this.paramAry[0],e=this.paramAry[1];this.paramAry[2],this.paramAry[3];var i=this.paramAry[4],n="attribute vec4 pos;\nattribute vec2 v2Uv;\nattribute vec4 boneID;\nattribute vec4 boneWeight;\nvarying vec2 v0;\nuniform mat4 bone[25];\nuniform mat4 viewMatrix3D;\nuniform mat4 camMatrix3D;\nuniform mat4 posMatrix3D;\n";return n+=i?"uniform vec3 sh[9];\nvarying vec3 v2;\n":"varying vec2 v2;\n",t?(n+="attribute vec4 normal;\nuniform mat4 rotationMatrix3D;\nvarying vec3 v1;\n",n+=e?"varying mat3 v4;\n":"varying vec3 v4;\n",e&&(n+="attribute vec4 tangent;\nattribute vec4 bitangent;\n")):i&&(n+="attribute vec4 normal;\nuniform mat4 rotationMatrix3D;\n"),n+="void main(void){\nv0 = v2Uv;\nvec4 vt0 = bone[int(boneID.x)] * pos * boneWeight.x;\nvt0 += bone[int(boneID.y)] * pos * boneWeight.y;\nvt0 += bone[int(boneID.z)] * pos * boneWeight.z;\nvt0 += bone[int(boneID.w)] * pos * boneWeight.w;\nvt0 = posMatrix3D * vt0;\n",t&&(n+="v1 = vec3(vt0.x,vt0.y,vt0.z);\n"),n+="vt0 = camMatrix3D * vt0;\nvt0 = viewMatrix3D * vt0;\ngl_Position = vt0;\n",t?n+=e?"vec4 vt2 = bone[int(boneID.x)] * tangent * boneWeight.x;\nvt2 += bone[int(boneID.y)] * tangent * boneWeight.y;\nvt2 += bone[int(boneID.z)] * tangent * boneWeight.z;\nvt2 += bone[int(boneID.w)] * tangent * boneWeight.w;\nvt2 = rotationMatrix3D * vt2;\nvt2.xyz = normalize(vt2.xyz);\nvec4 vt1 = bone[int(boneID.x)] * bitangent * boneWeight.x;\nvt1 += bone[int(boneID.y)] * bitangent * boneWeight.y;\nvt1 += bone[int(boneID.z)] * bitangent * boneWeight.z;\nvt1 += bone[int(boneID.w)] * bitangent * boneWeight.w;\nvt1 = rotationMatrix3D * vt1;\nvt1.xyz = normalize(vt1.xyz);\nvt0 = bone[int(boneID.x)] * normal * boneWeight.x;\nvt0 += bone[int(boneID.y)] * normal * boneWeight.y;\nvt0 += bone[int(boneID.z)] * normal * boneWeight.z;\nvt0 += bone[int(boneID.w)] * normal * boneWeight.w;\nvt0 = rotationMatrix3D * vt0;\nvt0.xyz = normalize(vt0.xyz);\nv4 = mat3(vec3(vt2.x,vt2.y,vt2.z),vec3(vt1.x,vt1.y,vt1.z),vec3(vt0.x,vt0.y,vt0.z));\n":"vt0 = bone[int(boneID.x)] * normal * boneWeight.x;\nvt0 += bone[int(boneID.y)] * normal * boneWeight.y;\nvt0 += bone[int(boneID.z)] * normal * boneWeight.z;\nvt0 += bone[int(boneID.w)] * normal * boneWeight.w;\nvt0 = rotationMatrix3D * vt0;\nvt0.xyz = normalize(vt0.xyz);\nv4 = vec3(vt0.x,vt0.y,vt0.z);\n":i&&(n+="vt0 = bone[int(boneID.x)] * normal * boneWeight.x;\nvt0 += bone[int(boneID.y)] * normal * boneWeight.y;\nvt0 += bone[int(boneID.z)] * normal * boneWeight.z;\nvt0 += bone[int(boneID.w)] * normal * boneWeight.w;\nvt0 = rotationMatrix3D * vt0;\nvt0.xyz = normalize(vt0.xyz);\n"),n+=i?"vec3 lpb = sh[0] * 0.28209479177387814;\nlpb += sh[1] * (vt0.y * -0.4886025119029199);\nlpb += sh[2] * (vt0.z * 0.4886025119029199);\nlpb += sh[3] * (vt0.x * -0.4886025119029199);\nlpb += sh[4] * (vt0.x * vt0.y * 1.0925484305920792);\nlpb += sh[5] * (vt0.z * vt0.y * -1.0925484305920792);\nlpb += sh[6] * ((3.0 * vt0.z * vt0.z - 1.0) * 0.31539156525252005);\nlpb += sh[7] * (vt0.z * vt0.x * -1.0925484305920792);\nlpb += sh[8] * ((vt0.x * vt0.x - vt0.y * vt0.y) * 0.5462742152960396);\nv2 = lpb;\n":"v2 = v2Uv;\n",n+="}"},e.prototype.getFragmentShaderString=function(){var t="uniform sampler2D s_texture1;\nuniform vec4 testconst;varying vec2 v_texCoord;\nvoid main(void)\n{\nvec4 infoUv = texture2D(s_texture, v_texCoord.xy);\ninfoUv.xyz = testconst.xyz * infoUv.xyz;\ngl_FragColor = infoUv;\n}";return t},e}(Shader3D),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},SkyShader=function(t){function e(){t.call(this)}return __extends(e,t),e.prototype.binLocation=function(t){t.bindAttribLocation(this.program,0,"v3Position"),t.bindAttribLocation(this.program,1,"v3Normal")},e.prototype.getVertexShaderString=function(){var t="attribute vec3 v3Position;attribute vec3 v3Normal;uniform mat4 viewMatrix3D;uniform mat4 camMatrix3D;uniform mat4 posMatrix3D;varying vec3 vNormal;void main(void){   vNormal = vec3(v3Normal.x, v3Normal.y,v3Normal.z);   vec4 vt0= vec4(v3Position, 1.0);   vt0 = posMatrix3D * vt0;   vt0 = camMatrix3D * vt0;   vt0 = viewMatrix3D * vt0;   gl_Position = vt0;}";return t},e.prototype.getFragmentShaderString=function(){var t="precision mediump float;\nuniform samplerCube s_texture;\nvarying vec3 vNormal;\nvoid main(void)\n{\nvec4 infoUv = textureCube(s_texture, vNormal);\ngl_FragColor = infoUv;\n}";return t},e.Sky_Shader="SkyShader",e}(Shader3D),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},Display3DShadowShader=function(t){function e(){t.call(this)}return __extends(e,t),e.prototype.binLocation=function(t){t.bindAttribLocation(this.program,0,"v3Pos"),t.bindAttribLocation(this.program,1,"v2uv")},e.prototype.getVertexShaderString=function(){var t="attribute vec3 v3Pos;attribute vec3 v2uv;uniform mat4 viewMatrix3D;uniform mat4 camMatrix3D;uniform vec3 pos[30];varying vec2 v_texCoord;void main(void){   v_texCoord = vec2(v2uv.x, v2uv.y);   vec4 vt0= vec4(v3Pos + pos[int(v2uv.z)], 1.0);   vt0 = camMatrix3D * vt0;   vt0 = viewMatrix3D * vt0;   gl_Position = vt0;}";return t},e.prototype.getFragmentShaderString=function(){var t=" precision mediump float;\nuniform sampler2D s_texture;\nvarying vec2 v_texCoord;\nvoid main(void)\n{\nvec4 infoUv = texture2D(s_texture, v_texCoord.xy);\ninfoUv.xyz *= infoUv.w;\ngl_FragColor = infoUv;\n}";return t},e.Display3DShadowShader="Display3DShadowShader",e}(Shader3D),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},UIShader=function(t){function e(){t.call(this)}return __extends(e,t),e.prototype.binLocation=function(t){t.bindAttribLocation(this.program,0,"v3Pos"),t.bindAttribLocation(this.program,1,"v2uv")},e.prototype.getVertexShaderString=function(){var t="attribute vec3 v3Pos;attribute vec3 v2uv;uniform vec4 ui[30];varying vec2 v_texCoord;void main(void){   v_texCoord = vec2(v2uv.x, v2uv.y);   vec4 data = ui[int(v2uv.z)];   vec3 pos = vec3(0.0,0.0,0.0);   pos.xy = v3Pos.xy * data.zw * 2.0;   pos.x += data.x * 2.0 - 1.0;   pos.y += -data.y * 2.0 + 1.0;   vec4 vt0= vec4(pos, 1.0);   gl_Position = vt0;}";return t},e.prototype.getFragmentShaderString=function(){var t=" precision mediump float;\nuniform sampler2D s_texture;\nvarying vec2 v_texCoord;\nvoid main(void)\n{\nvec4 infoUv = texture2D(s_texture, v_texCoord.xy);\ninfoUv.xyz *= infoUv.w;\ngl_FragColor = infoUv;\n}";return t},e.UI_SHADER="UIShader",e}(Shader3D),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},UIImageShader=function(t){function e(){t.call(this)}return __extends(e,t),e.prototype.binLocation=function(t){t.bindAttribLocation(this.program,0,"v3Pos"),t.bindAttribLocation(this.program,1,"v2uv")},e.prototype.getVertexShaderString=function(){var t="attribute vec3 v3Pos;attribute vec2 v2uv;uniform vec2 scale;varying vec2 v_texCoord;void main(void){   v_texCoord = vec2(v2uv.x, v2uv.y);   vec4 vt0= vec4(v3Pos.x*scale.x,v3Pos.y*scale.y,v3Pos.z,1.0);   gl_Position = vt0;}";
return t},e.prototype.getFragmentShaderString=function(){var t=" precision mediump float;\nuniform sampler2D s_texture;\nvarying vec2 v_texCoord;\nvoid main(void)\n{\nvec4 infoUv = texture2D(s_texture, v_texCoord.xy);\ninfoUv.xyz *= infoUv.w;\ngl_FragColor = infoUv;\n}";return t},e.UI_IMG_SHADER="UI_img_Shader",e}(Shader3D),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},CombineParticle=function(t){function e(){t.call(this),this._maxTime=1e6,this._rotationX=0,this._rotationY=0,this._rotationZ=0,this.sceneVisible=!0,this._displayAry=[],this._time=0,this.bindMatrix=new Matrix3D,this.invertBindMatrix=new Matrix3D,this.bindVecter3d=new Vector3D,this.bindScale=new Vector3D(1,1,1),this.groupMatrix=new Matrix3D,this.groupRotationMatrix=new Matrix3D}return __extends(e,t),Object.defineProperty(e.prototype,"bindTarget",{set:function(t){this._bindTarget=t,this.invertBindMatrix.isIdentity=!1},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"bindSocket",{set:function(t){this._bindSocket=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"x",{set:function(t){this.bindVecter3d.x=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"y",{set:function(t){this.bindVecter3d.y=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"z",{set:function(t){this.bindVecter3d.z=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"scaleX",{set:function(t){this.bindScale.x=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"scaleY",{set:function(t){this.bindScale.y=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"scaleZ",{set:function(t){this.bindScale.z=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rotationX",{set:function(t){this._rotationX=t,this.applyRotation()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rotationY",{set:function(t){this._rotationY=t,this.applyRotation()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rotationZ",{set:function(t){this._rotationZ=t,this.applyRotation()},enumerable:!0,configurable:!0}),e.prototype.applyRotation=function(){this.bindMatrix.identity(),this.bindMatrix.appendRotation(this._rotationX,Vector3D.X_AXIS),this.bindMatrix.appendRotation(this._rotationY,Vector3D.Y_AXIS),this.bindMatrix.appendRotation(this._rotationZ,Vector3D.Z_AXIS),this.bindMatrix.copyTo(this.invertBindMatrix),this.invertBindMatrix.invert(),this.invertBindMatrix.isIdentity=!1},e.prototype.setGroup=function(t,e,i){this._isInGroup=!0,this._groupPos=t,this._groupRotation=e,this._groupScale=i,this.groupMatrix.isIdentity=!1,this.groupMatrix.identity(),this.groupMatrix.appendScale(i.x,i.y,i.z),this.groupMatrix.appendRotation(e.x,Vector3D.X_AXIS),this.groupMatrix.appendRotation(e.y,Vector3D.Y_AXIS),this.groupMatrix.appendRotation(e.z,Vector3D.Z_AXIS),this.groupMatrix.appendTranslation(t.x,t.y,t.z),this.groupRotationMatrix.isIdentity=!1,this.groupRotationMatrix.identity(),this.groupRotationMatrix.prependRotation(e.z,Vector3D.Z_AXIS),this.groupRotationMatrix.prependRotation(e.y,Vector3D.Y_AXIS),this.groupRotationMatrix.prependRotation(e.x,Vector3D.X_AXIS)},e.prototype.setData=function(t){this._sourceComNum=0,this._sourceAllNum=t.length,this._displayAry=[],this._maxTime=0;for(var e=0;t.length>e;e++){var i=t[e].display,n=this.getDisplay3D(i);n.setAllInfo(t[e]),n.setBind(this.bindVecter3d,this.bindMatrix,this.bindScale,this.invertBindMatrix,this.groupMatrix),this._displayAry.push(n),n.timeline.maxFrameNum>this._maxTime&&(this._maxTime=n.timeline.maxFrameNum)}this._maxTime*=Scene_data.frameTime},e.prototype.updateTime=function(t){this._time+=t;for(var e=0;this._displayAry.length>e;e++)this._displayAry[e].updateTime(this._time);this.updateBind(),this._time>=this._maxTime&&this.dispatchEvent(new BaseEvent(BaseEvent.COMPLETE))},e.prototype.updateBind=function(){this._bindTarget&&(this._bindTarget.getSocket(this._bindSocket,this.bindMatrix),this.bindVecter3d.setTo(this.bindMatrix.x,this.bindMatrix.y,this.bindMatrix.z),this.bindMatrix.identityPostion(),this.groupRotationMatrix.isIdentity?this.bindMatrix.invertToMatrix(this.invertBindMatrix):(this.bindMatrix.copyTo(this.invertBindMatrix),this.invertBindMatrix.prepend(this.groupRotationMatrix),this.invertBindMatrix.invert()))},e.prototype.reset=function(){this._time=0;for(var t=0;this._displayAry.length>t;t++)this._displayAry[t].reset()},e.prototype.update=function(){for(var t=0;this._displayAry.length>t;t++)this._displayAry[t].update()},e.prototype.getDisplay3D=function(t){var e,i=t.particleType;switch(i){case 1:e=new Display3DFacetParticle;break;case 18:e=new Display3DBallPartilce;break;case 3:e=new Display3DLocusPartilce;break;case 14:e=new Display3DLocusBallPartilce;break;case 9:e=new Display3DModelObjParticle;break;case 4:e=new Display3DModelPartilce;break;case 7:e=new Display3dModelAnimParticle}return e.visible=!1,e},e}(EventDispatcher),ParticleManager=function(){function t(){this._time=0,this._particleList=[],this.initShader()}return t.getInstance=function(){return this._instance||(this._instance=new t),this._instance},t.prototype.initShader=function(){ProgrmaManager.getInstance().registe(Display3DFacetShader.Display3D_Facet_Shader,new Display3DFacetShader)},t.prototype.getParticle=function(t){var e,i=this;e=new CombineParticle;var n=Scene_data.fileRoot+t;return SceneRes.particleDic[n]?this.onLoadCom(SceneRes.particleDic[n],e):LoadManager.getInstance().load(n,LoadManager.XML_TYPE,function(t,e){i.onLoadCom(t,e)},e),e},t.prototype.update=function(){for(var t=0;this._particleList.length>t;t++)this._particleList[t].sceneVisible&&this._particleList[t].update()},t.prototype.updateTime=function(){for(var t=TimeUtil.getTimer(),e=t-this._time,i=0;this._particleList.length>i;i++)this._particleList[i].sceneVisible&&this._particleList[i].updateTime(e);this._time=t},t.prototype.addParticle=function(t){-1==this._particleList.lastIndexOf(t)&&this._particleList.push(t)},t.prototype.removeParticle=function(t){var e=this._particleList.indexOf(t);-1!=e&&this._particleList.splice(e,1)},t.prototype.onLoadCom=function(t,e){var i=JSON.parse(t);e.setData(i)},t}(),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},Display3DParticle=function(t){function e(){t.call(this),this._width=100,this._height=100,this._originWidthScale=.5,this._originHeightScale=.5,this._eyeDistance=0,this._watchEye=!1,this._isZiZhuan=!1,this.overAllScale=1,this.isInGroup=!1,this.visible=!0,this._rotationMatrix=new Matrix3D,this.modelMatrix=new Matrix3D}return __extends(e,t),e.prototype.setBind=function(t,e,i,n,a){this.bindVecter3d=t,this.bindMatrix=e,this.bindScale=i,this.invertBindMatrix=n,this.groupMatrix=a},e.prototype.updateMatrix=function(){this.bindMatrix&&(this.modelMatrix.identity(),this.groupMatrix.isIdentity||this.posMatrix.append(this.groupMatrix),this.modelMatrix.append(this.posMatrix),this.modelMatrix.append(this.bindMatrix),this.modelMatrix.appendTranslation(this.bindVecter3d.x,this.bindVecter3d.y,this.bindVecter3d.z))},e.prototype.updateTime=function(t){this._time=t-this._beginTime,this.timeline.updateTime(t),this.visible=this.timeline.visible,this.posMatrix.identity(),this.posMatrix.prependScale(.1*this._scaleX*this.bindScale.x,.1*this._scaleY*this.bindScale.y,.1*this._scaleZ*this.bindScale.z),this.timeline.updateMatrix(this.posMatrix,this)},e.prototype.reset=function(){this.timeline.reset(),this.updateTime(0)},e.prototype.clearAllAnim=function(){},e.prototype.update=function(){this.visible&&this.materialParam&&(Scene_data.context3D.setBlendParticleFactors(this._alphaMode),this.materialParam?Scene_data.context3D.setProgram(this.materialParam.program):Scene_data.context3D.setProgram(this.program),this.updateMatrix(),this.setVc(),this.setVa())},e.prototype.setVc=function(){},e.prototype.setVa=function(){},e.prototype.setMaterialVc=function(){if(this.materialParam){for(var t=this.materialParam.dynamicConstList,e=this._time%(Scene_data.frameTime*this._life),i=0;t.length>i;i++)t[i].update(e);this.materialParam.material.hasTime&&(e*=this.materialParam.material.timeSpeed,Scene_data.context3D.setVc4fv(this.materialParam.program,"fc0",[1,0,0,e]));for(var n=this.materialParam.material.constList,i=0;n.length>i;i++)Scene_data.context3D.setVc4fv(this.materialParam.program,"fc"+n[i].id,n[i].vecNum)}},e.prototype.setMaterialTexture=function(){if(this.materialParam){for(var t=this.materialParam.material.texList,e=0;t.length>e;e++)t[e].isDynamic||Scene_data.context3D.setRenderTexture(this.materialParam.program,t[e].name,t[e].texture,t[e].id);for(var i=this.materialParam.dynamicTexList,e=0;i.length>e;e++)Scene_data.context3D.setRenderTexture(this.materialParam.program,i[e].target.name,i[e].texture,i[e].target.id)}},e.prototype.inverBind=function(){this.invertBindMatrix.isIdentity||this._rotationMatrix.prepend(this.invertBindMatrix)},e.prototype.setAllInfo=function(t){this.timeline=new TimeLine,this.timeline.setAllInfo(t.timeline),this._beginTime=this.timeline.beginTime;var e=t.display;this._width=e.width,this._height=e.height,this._widthFixed=e.widthFixed,this._heightFixed=e.heightFixed,this._originWidthScale=e.originWidthScale,this._originHeightScale=e.originHeightScale,this._eyeDistance=e.eyeDistance,this._alphaMode=e.alphaMode,this._uSpeed=e.uSpeed,this._vSpeed=e.vSpeed,this._animLine=0==e.animLine?1:e.animLine,this._animRow=0==e.animRow?1:e.animRow,this._animInterval=0==e.animInterval?1:e.animInterval,this._renderPriority=e.renderPriority,this._distortion=e.distortion,this._isUV=e.isUV,this._isU=e.isU,this._isV=e.isV,this._life=e.life>1e4?Scene_data.MAX_NUMBER:e.life,this._watchEye=e.watchEye,this._ziZhuanAngly=this.getVector3DByObject(e.ziZhuanAngly),!this._ziZhuanAngly||0==this._ziZhuanAngly.x&&0==this._ziZhuanAngly.y&&0==this._ziZhuanAngly.z||(this._isZiZhuan=!0),e.rotationX&&(this.rotationX=e.rotationX),e.rotationY&&(this.rotationY=e.rotationY),e.rotationZ&&(this.rotationZ=e.rotationZ),e.center&&(this.center=this.getVector3DByObject(e.center)),e.overAllScale&&(this.overAllScale=e.overAllScale),this.materialParamData=e.materialParam,this.materialUrl=e.materialUrl},Object.defineProperty(e.prototype,"center",{set:function(t){this._center=t,this.x=t.x,this.y=t.y,this.z=t.z},enumerable:!0,configurable:!0}),e.prototype.getVector3DByObject=function(t){return t?new Vector3D(t.x,t.y,t.z,t.w):null},Object.defineProperty(e.prototype,"widthFixed",{get:function(){return this._widthFixed},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"heightFixed",{get:function(){return this._heightFixed},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"materialUrl",{get:function(){return this._materialUrl},set:function(t){var e=this;this._materialUrl!=t&&(this._materialUrl=t,MaterialManager.getInstance().getMaterial(Scene_data.fileRoot+t,function(t){e.onMaterialLoad(t)}))},enumerable:!0,configurable:!0}),e.prototype.onMaterialLoad=function(t){this.materialParam=new MaterialParam,this.materialParam.setMaterial(t),this.materialParam.setLife(this._life),this.materialParamData&&(this.materialParam.setTextObj(this.materialParamData.texAry),this.materialParam.setConstObj(this.materialParamData.conAry)),MaterialManager.getInstance().loadDynamicTexUtil(this.materialParam),this.regShader()},e.prototype.regShader=function(){},e.prototype.clone=function(){return null},e}(Display3D),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},ParticleData=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e}(ObjData),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},Display3DFacetParticle=function(t){function e(){t.call(this),this._isCycle=!1,this._lifeVisible=!0,this.objData=new ParticleData,this._resultUvVec=Array(2)}return __extends(e,t),e.prototype.update=function(){this._lifeVisible&&t.prototype.update.call(this)},e.prototype.reset=function(){t.prototype.reset.call(this),this._lifeVisible=!0},e.prototype.setVc=function(){this.updateRotaionMatrix(),this.updateUV(),Scene_data.context3D.setVcMatrix4fv(this.materialParam.program,"viewMatrix3D",Scene_data.viewMatrx3D.m),Scene_data.context3D.setVcMatrix4fv(this.materialParam.program,"camMatrix3D",Scene_data.cam3D.cameraMatrix.m),Scene_data.context3D.setVcMatrix4fv(this.materialParam.program,"posMatrix3D",this.modelMatrix.m),Scene_data.context3D.setVcMatrix4fv(this.materialParam.program,"rotationMatrix3D",this._rotationMatrix.m),Scene_data.context3D.setVc2fv(this.materialParam.program,"uvMove",this._resultUvVec),this.setMaterialVc(),!this._isCycle&&this._time/Scene_data.frameTime>this._life-2&&(this._lifeVisible=!1)},e.prototype.setVa=function(){Scene_data.context3D.setVa(0,3,this.objData.vertexBuffer),Scene_data.context3D.setVa(1,2,this.objData.uvBuffer),this.setMaterialTexture(),Scene_data.context3D.drawCall(this.objData.indexBuffer,this.objData.treNum)},e.prototype.updateRotaionMatrix=function(){this._rotationMatrix.identity(),this._watchEye&&(this.timeline.inverAxisRotation(this._rotationMatrix),this._locky||this._lockx||this.inverBind(),this._locky||this._rotationMatrix.prependRotation(-Scene_data.cam3D.rotationY,Vector3D.Y_AXIS),this._lockx||this._rotationMatrix.prependRotation(-Scene_data.cam3D.rotationX,Vector3D.X_AXIS)),this._isZiZhuan&&this.timeline.applySelfRotation(this._rotationMatrix,this._ziZhuanAngly)},e.prototype.updateUV=function(){var t=float2int(this._time/Scene_data.frameTime);t=t>this._maxAnimTime?this._maxAnimTime:t,t=t/this._animInterval%(this._animLine*this._animRow),this._resultUvVec[0]=float2int(t%this._animLine)/this._animLine+this._time/Scene_data.frameTime*this._uSpeed,this._resultUvVec[1]=float2int(t/this._animLine)/this._animRow+this._time/Scene_data.frameTime*this._vSpeed},e.prototype.makeRectangleData=function(t,e,i,n,a,o,r,s,h){void 0===i&&(i=.5),void 0===n&&(n=.5),void 0===a&&(a=!1),void 0===o&&(o=!1),void 0===r&&(r=!1),void 0===s&&(s=1),void 0===h&&(h=1);var c=[],l=[];l.push(-i*t,e-n*e,0),l.push(t-i*t,e-n*e,0),l.push(t-i*t,-n*e,0),l.push(-i*t,-n*e,0);var p=[];if(p.push(new Vector2D(0,0)),p.push(new Vector2D(0,1/h)),p.push(new Vector2D(1/s,1/h)),p.push(new Vector2D(1/s,0)),o)for(var u=0;p.length>u;u++)p[u].x=-p[u].x;if(r)for(var u=0;p.length>u;u++)p[u].y=-p[u].y;a&&p.push(p.shift());for(var u=0;p.length>u;u++)c.push(p[u].x,p[u].y);var d=[];d.push(0,1,2,0,2,3),this.objData.vertexBuffer=Scene_data.context3D.uploadBuff3D(l),this.objData.uvBuffer=Scene_data.context3D.uploadBuff3D(c),this.objData.indexBuffer=Scene_data.context3D.uploadIndexBuff3D(d),this.objData.treNum=d.length},e.prototype.setAllInfo=function(e){this._maxAnimTime=e.display.maxAnimTime,this._isCycle=e.display.isCycle,this._lockx=e.display.lockx,this._locky=e.display.locky,t.prototype.setAllInfo.call(this,e),this.uploadToGpu()},e.prototype.uploadToGpu=function(){this.makeRectangleData(this._width,this._height,this._originWidthScale,this._originHeightScale,this._isUV,this._isU,this._isV,this._animLine,this._animRow)},e.prototype.regShader=function(){this.materialParam.program=ProgrmaManager.getInstance().getMaterialProgram(Display3DFacetShader.Display3D_Facet_Shader,new Display3DFacetShader,this.materialParam.material)},e}(Display3DParticle),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},Display3DFacetShader=function(t){function e(){t.call(this)}return __extends(e,t),e.prototype.binLocation=function(t){t.bindAttribLocation(this.program,0,"v3Position"),t.bindAttribLocation(this.program,1,"v2TexCoord")},e.prototype.getVertexShaderString=function(){var t="attribute vec4 v3Position;\nattribute vec2 v2TexCoord;\nuniform mat4 viewMatrix3D;\nuniform mat4 camMatrix3D;\nuniform mat4 rotationMatrix3D;\nuniform mat4 posMatrix3D;\nuniform vec2 uvMove;\nvarying vec2 v0;\nvoid main(void){\n   v0 = v2TexCoord + uvMove;\n   gl_Position = viewMatrix3D  * camMatrix3D * posMatrix3D * rotationMatrix3D * v3Position;\n}";return t},e.prototype.getFragmentShaderString=function(){var t=" precision mediump float;\nuniform sampler2D tex;\nvarying vec2 v0;\nvoid main(void)\n{\nvec4 infoUv = texture2D(tex, v0.xy);\ngl_FragColor = infoUv;\n}";return t},e.Display3D_Facet_Shader="Display3DFacetShader",e}(Shader3D),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},Display3DBallPartilce=function(t){function e(){t.call(this),this._totalNum=50,this._acceleration=.2,this._toscale=0,this._shootAngly=new Vector3D(1,0,0),this._shootSpeed=0,this._isRandom=!1,this._isSendRandom=!1,this._isSendAngleRandom=!1,this._paticleMaxScale=1,this._paticleMinScale=1,this._addforce=new Vector3D(0,0,0),this._lixinForce=new Vector3D(0,0,0),this._waveform=new Vector3D(0,0,0,0),this._round=new Vector3D,this._is3Dlizi=!1,this._speed=1,this._isLoop=!1,this._basePositon=new Vector3D(0,0,0),this._baseRandomAngle=0,this._shapeType=0,this._playSpeed=1,this._beginScale=0,this.objData=new ParticleBallData}return __extends(e,t),e.prototype.setVa=function(){Scene_data.context3D.setVa(0,3,this.objData.vertexBuffer),Scene_data.context3D.setVa(1,2,this.objData.uvBuffer),Scene_data.context3D.setVa(2,4,this.particleBallData.basePosBuffer),Scene_data.context3D.setVa(3,3,this.particleBallData.beMoveBuffer),this._needSelfRotation&&Scene_data.context3D.setVa(4,2,this.particleBallData.baseRotationBuffer),this._needRandomColor&&Scene_data.context3D.setVa(5,4,this.particleBallData.randomColorBuffer),this.setMaterialTexture(),Scene_data.context3D.drawCall(this.objData.indexBuffer,this.objData.treNum)},e.prototype.setVc=function(){this.updateWatchCaramMatrix(),Scene_data.context3D.setVcMatrix4fv(this.materialParam.program,"viewMatrix",Scene_data.viewMatrx3D.m),Scene_data.context3D.setVcMatrix4fv(this.materialParam.program,"cameraMatrix",Scene_data.cam3D.cameraMatrix.m),Scene_data.context3D.setVcMatrix4fv(this.materialParam.program,"modelMatrix",this.modelMatrix.m),Scene_data.context3D.setVcMatrix4fv(this.materialParam.program,"watheye",this._rotationMatrix.m),this._timeVec[0]=this._time/Scene_data.frameTime*this._playSpeed,Scene_data.context3D.setVc4fv(this.materialParam.program,"time",this._timeVec),this._needAddSpeed&&Scene_data.context3D.setVc3fv(this.materialParam.program,"force",this._addSpeedVec),this._needScale&&(Scene_data.context3D.setVc4fv(this.materialParam.program,"scale",this._scaleVec),Scene_data.context3D.setVc4fv(this.materialParam.program,"scaleCtrl",this._scaleCtrlVec)),this._is3Dlizi&&(this.updateAllRotationMatrix(),this._wordPosVec[0]=this.bindVecter3d.x,this._wordPosVec[1]=this.bindVecter3d.y,this._wordPosVec[2]=this.bindVecter3d.z,this._caramPosVec[0]=Scene_data.cam3D.x,this._caramPosVec[1]=Scene_data.cam3D.y,this._caramPosVec[2]=Scene_data.cam3D.z,Scene_data.context3D.setVcMatrix4fv(this.materialParam.program,"rotationMatrix",this._allRotationMatrix.m),Scene_data.context3D.setVc3fv(this.materialParam.program,"worldPos",this._wordPosVec),Scene_data.context3D.setVc3fv(this.materialParam.program,"camPos",this._caramPosVec)),1==this._uvType?Scene_data.context3D.setVc3fv(this.materialParam.program,"animCtrl",this._animCtrlVec):2==this._uvType&&Scene_data.context3D.setVc2fv(this.materialParam.program,"uvCtrl",this._uvCtrlVec),this.setMaterialVc()},e.prototype.updateWatchCaramMatrix=function(){this._rotationMatrix.identity(),this.facez?this._rotationMatrix.prependRotation(90,Vector3D.X_AXIS):this._is3Dlizi?(this.timeline.inverAxisRotation(this._rotationMatrix),this.inverBind()):this._watchEye&&(this.timeline.inverAxisRotation(this._rotationMatrix),this.inverBind(),this._rotationMatrix.prependRotation(-Scene_data.cam3D.rotationY,Vector3D.Y_AXIS),this._rotationMatrix.prependRotation(-Scene_data.cam3D.rotationX,Vector3D.X_AXIS))},e.prototype.updateAllRotationMatrix=function(){this._allRotationMatrix.identity(),this._allRotationMatrix.prependScale(.1*this.overAllScale*this._scaleX*this.bindScale.x,.1*this.overAllScale*this._scaleY*this.bindScale.y,.1*this.overAllScale*this._scaleZ*this.bindScale.z),this.timeline.inverAxisRotation(this._rotationMatrix),this.isInGroup&&(this._allRotationMatrix.appendRotation(this.groupRotation.x,Vector3D.X_AXIS),this._allRotationMatrix.appendRotation(this.groupRotation.y,Vector3D.Y_AXIS),this._allRotationMatrix.appendRotation(this.groupRotation.z,Vector3D.Z_AXIS)),this.bindMatrix&&this._allRotationMatrix.append(this.bindMatrix)},e.prototype.uploadToGpu=function(){this.initBaseData(),this.initBasePos(),this.initSpeed(),this.initSelfRotaion(),this.pushToGpu()},e.prototype.pushToGpu=function(){this.particleBallData.vertexBuffer=Scene_data.context3D.uploadBuff3D(this.particleBallData.vertices),this.particleBallData.uvBuffer=Scene_data.context3D.uploadBuff3D(this.particleBallData.uvs),this.particleBallData.basePosBuffer=Scene_data.context3D.uploadBuff3D(this.particleBallData.basePos),this.particleBallData.beMoveBuffer=Scene_data.context3D.uploadBuff3D(this.particleBallData.beMove),this.particleBallData.indexBuffer=Scene_data.context3D.uploadIndexBuff3D(this.particleBallData.indexs),this.particleBallData.treNum=this.particleBallData.indexs.length,this._needSelfRotation&&(this.particleBallData.baseRotationBuffer=Scene_data.context3D.uploadBuff3D(this.particleBallData.baseRotation))},e.prototype.initBaseData=function(){for(var t=[],e=[],i=[],n=0;this._totalNum>n;n++)this.makeRectangleData(t,e,this._width,this._height,this._originWidthScale,this._originHeightScale,this._isUV,this._isU,this._isV,this._animLine,this._animRow),i.push(0+4*n,1+4*n,2+4*n,0+4*n,2+4*n,3+4*n);this.particleBallData.vertices=t,this.particleBallData.uvs=e,this.particleBallData.indexs=i},e.prototype.initBasePos=function(){for(var t=[],e=0;this._totalNum>e;e++){var i,n;if(this._isRandom){var a=new Vector3D(this._round.x*this._round.w,this._round.y*this._round.w,this._round.z*this._round.w);this._isEven?this._closeSurface?(i=new Vector3D(0,0,a.z),n=new Matrix3D,n.appendRotation(360*Math.random(),Vector3D.Y_AXIS),i=n.transformVector(i),i.y=2*a.y*Math.random()-a.y):(i=new Vector3D(0,0,2*a.z*Math.random()-a.z),n=new Matrix3D,n.appendRotation(360*Math.random(),Vector3D.Y_AXIS),i=n.transformVector(i),i.y=2*a.y*Math.random()-a.y):this._closeSurface?(i=new Vector3D(0,0,a.z),n=new Matrix3D,this._halfCircle?n.appendRotation(180*-Math.random(),Vector3D.X_AXIS):n.appendRotation(360*Math.random(),Vector3D.X_AXIS),n.appendRotation(360*Math.random(),Vector3D.Y_AXIS),i=n.transformVector(i)):i=this._halfCircle?new Vector3D(2*a.x*Math.random()-a.x,a.y*Math.random(),2*a.z*Math.random()-a.z):new Vector3D(2*a.x*Math.random()-a.x,2*a.y*Math.random()-a.y,2*a.z*Math.random()-a.z)}else i=new Vector3D;i=i.add(this._basePositon);for(var o=0;4>o;o++)t.push(i.x,i.y,i.z,e*this._shootSpeed)}this.particleBallData.basePos=t},e.prototype.initSpeed=function(){for(var t=[],e=0;this._totalNum>e;e++){var i=new Vector3D,n=new Vector3D;if(0!=this._shootAngly.x||0!=this._shootAngly.y||0!=this._shootAngly.z){var a=Math.tan(this._shootAngly.w*Math.PI/180*Math.random()),o=360*Math.PI/180*Math.random();n=new Vector3D(Math.sin(o)*a,Math.cos(o)*a,1);var r=new Matrix3D;r.fromVtoV(new Vector3D(0,0,1),new Vector3D(this._shootAngly.x,this._shootAngly.y,this._shootAngly.z)),n=r.transformVector(n),n.normalize(),i=i.add(n)}(0!=this._lixinForce.x||0!=this._lixinForce.y||0!=this._lixinForce.z)&&(n=new Vector3D(Math.random()>.5?-this._lixinForce.x:this._lixinForce.x,Math.random()>.5?-this._lixinForce.y:this._lixinForce.y,Math.random()>.5?-this._lixinForce.z:this._lixinForce.z),n.normalize(),i=i.add(n)),this._islixinAngly&&(n=this._isEven?new Vector3D(this.particleBallData.basePos[16*e],0,this.particleBallData.basePos[16*e+2]):new Vector3D(this.particleBallData.basePos[16*e],this.particleBallData.basePos[16*e+1],this.particleBallData.basePos[16*e+2]),n.normalize(),i=i.add(n)),i.normalize(),this._isSendRandom?i.scaleBy(this._speed*Math.random()):i.scaleBy(this._speed),this._baseRandomAngle*Math.random()*Math.PI/180;for(var s=0;4>s;s++)t.push(i.x,i.y,i.z)}this.particleBallData.beMove=t},e.prototype.initBaseColor=function(){for(var t=ColorTransition.getInstance().getImageData(this._textureRandomColorInfo),e=t.data,i=[],n=0;this._totalNum>n;n++){var a=4*float2int(128*Math.random()),o=new Vector3D(e[a],e[a+1],e[a+2],e[a+3]);o.scaleBy(1/255),i.push(o.x,o.y,o.z,o.w),i.push(o.x,o.y,o.z,o.w),i.push(o.x,o.y,o.z,o.w),i.push(o.x,o.y,o.z,o.w)}this.particleBallData.randomColor=i,this.particleBallData.randomColorBuffer=Scene_data.context3D.uploadBuff3D(this.particleBallData.randomColor)},e.prototype.initSelfRotaion=function(){var t=0,e=0;if(0==this._ziZhuanAngly.x&&0==this._ziZhuanAngly.y&&0==this._ziZhuanAngly.z&&0==this._ziZhuanAngly.w)return this._needSelfRotation=!1,void 0;this._needSelfRotation=!0;for(var i=[],n=0;this._totalNum>n;)t=this._ziZhuanAngly.x,1==this._ziZhuanAngly.y&&(t*=Math.random()),e=this._ziZhuanAngly.z,1==this._ziZhuanAngly.w?e*=Math.random():-1==this._ziZhuanAngly.w&&(e*=2*Math.random()-1),i.push(t,e),i.push(t,e),i.push(t,e),i.push(t,e),n++;this.particleBallData.baseRotation=i},e.prototype.makeRectangleData=function(t,e,i,n,a,o,r,s,h,c,l){void 0===a&&(a=.5),void 0===o&&(o=.5),void 0===r&&(r=!1),void 0===s&&(s=!1),void 0===h&&(h=!1),void 0===c&&(c=1),void 0===l&&(l=1);var p=Math.random()*(this._particleRandomScale.x-this._particleRandomScale.y)+this._particleRandomScale.y;t.push(-a*i*p,(n-o*n)*p,0),t.push((i-a*i)*p,(n-o*n)*p,0),t.push((i-a*i)*p,-o*n*p,0),t.push(-a*i*p,-o*n*p,0);var u=[];if(u.push(new Vector2D(0,0)),u.push(new Vector2D(0,1/l)),u.push(new Vector2D(1/c,1/l)),u.push(new Vector2D(1/c,0)),s)for(var d=0;u.length>d;d++)u[d].x=-u[d].x;if(h)for(var d=0;u.length>d;d++)u[d].y=-u[d].y;r&&u.push(u.shift());for(var d=0;u.length>d;d++)e.push(u[d].x,u[d].y)},Object.defineProperty(e.prototype,"particleBallData",{get:function(){return this.objData},enumerable:!0,configurable:!0}),e.prototype.setAllInfo=function(e){var i=e.display;this._totalNum=i.totalNum,this._acceleration=i.acceleration,this._toscale=i.toscale,this._shootSpeed=i.shootSpeed,this._isRandom=i.isRandom,this._isSendRandom=i.isSendRandom,this._round=this.getVector3DByObject(i.round),this._is3Dlizi=i.is3Dlizi,this._halfCircle=i.halfCircle,this._shootAngly=this.getVector3DByObject(i.shootAngly),this._speed=i.speed,this._isLoop=i.isLoop,this._isSendAngleRandom=i.isSendAngleRandom,this._waveform=this.getVector3DByObject(i.waveform),this._closeSurface=i.closeSurface,this._isEven=i.isEven,this._paticleMaxScale=i.paticleMaxScale,this._paticleMinScale=i.paticleMinScale,this._basePositon=this.getVector3DByObject(i.basePositon),this._baseRandomAngle=i.baseRandomAngle,this._shapeType=i.shapeType,this._lockX=i.lockX,this._lockY=i.lockY,this._textureRandomColorInfo=i.randomColor,this._addforce=this.getVector3DByObject(i.addforce),this._addforce.scaleByW(),this._lixinForce=this.getVector3DByObject(i.lixinForce),this._islixinAngly=i.islixinAngly,this._particleRandomScale=this.getVector3DByObject(i.particleRandomScale),this._playSpeed=i.playSpeed,this.facez=i.facez,this._beginScale=i.beginScale,0!=this._acceleration||0!=this._addforce.x||0!=this._addforce.y||0!=this._addforce.z?(this._needAddSpeed=!0,this._addSpeedVec=[this._addforce.x,this._addforce.y,this._addforce.z]):this._needAddSpeed=!1,t.prototype.setAllInfo.call(this,e),0!=this._toscale||0!=this._waveform.x||0!=this._waveform.y?(this._needScale=!0,this._scaleVec=[this._toscale,this._waveform.x,this._waveform.y,this._beginScale],this._scaleCtrlVec=[this._widthFixed?0:1,this._heightFixed?0:1,this._paticleMaxScale-1,this._paticleMinScale-1]):this._needScale=!1,this._timeVec=[0,this._acceleration,this._life,this._isLoop?1:-1],this._is3Dlizi&&(this._wordPosVec=[0,0,0],this._caramPosVec=[0,0,0],this._allRotationMatrix=new Matrix3D),this.uploadToGpu()},e.prototype.regShader=function(){if(this.materialParam){1!=this._animRow||1!=this._animLine?(this._uvType=1,this._animCtrlVec=[this._animLine,this._animRow,this._animInterval]):0!=this._uSpeed||0!=this._vSpeed?(this._uvType=2,this._uvCtrlVec=[this._uSpeed,this._vSpeed]):this._uvType=0;var t=this.materialParam.material.hasParticleColor;this._needRandomColor=this.materialParam.material.hasVertexColor,this._needRandomColor&&this.initBaseColor();var e,i;i=t?1:0;var n=this._needRandomColor?1:0,a=this._is3Dlizi?1:0,o=this._needSelfRotation?1:0,r=this._needScale?1:0,s=this._needAddSpeed?1:0;e=[i,n,a,o,r,s,this._uvType],this.materialParam.program=ProgrmaManager.getInstance().getMaterialProgram(Display3DBallShader.Display3D_Ball_Shader,new Display3DBallShader,this.materialParam.material,e)}},e}(Display3DParticle),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},Display3DBallShader=function(t){function e(){t.call(this)}return __extends(e,t),e.prototype.binLocation=function(t){t.bindAttribLocation(this.program,0,"vPosition"),t.bindAttribLocation(this.program,1,"texcoord"),t.bindAttribLocation(this.program,2,"basePos"),t.bindAttribLocation(this.program,3,"speed");var e=this.paramAry[3];e&&t.bindAttribLocation(this.program,4,"rotation");var i=this.paramAry[1];i&&t.bindAttribLocation(this.program,5,"color")},e.prototype.getVertexShaderString=function(){var t,e,i,n,a,o,r,s,h,c,l,p,h,s,u,d,m,f,y,v,x,g,_;u="attribute vec4 vPosition;\nattribute vec2 texcoord;\nattribute vec4 basePos;\nattribute vec3 speed;\nuniform mat4 watheye;\nuniform mat4 viewMatrix;\nuniform mat4 modelMatrix;\nuniform mat4 cameraMatrix;\nuniform vec4 time;\nvarying vec2 v0;\n",g="attribute vec4 color;\nvarying vec4 v2;\n",d="uniform vec4 scale;\nuniform vec4 scaleCtrl;\n",m="attribute vec2 rotation;\n",f="uniform vec3 force;\n",y="uniform mat4 rotationMatrix;\nuniform vec3 worldPos;\nuniform vec3 camPos;\n",v="uniform vec3 animCtrl;\n",x="uniform vec2 uvCtrl;\n",_="varying vec2 v1;\n",t="float ctime = time.x - basePos.w;\nif (time.w > 0.0 && ctime >= 0.0) {\n    ctime = fract(ctime / time.z) * time.z;\n}\nvec4 pos = vPosition;\n",e="float stime = ctime - scale.w;\nstime = max(stime,0.0);\nfloat sf = scale.x * stime;\nif (scale.y != 0.0 && scale.z != 0.0) {\n    sf += sin(scale.y * stime) * scale.z;\n}\nif (sf > scaleCtrl.z) {\n    sf = scaleCtrl.z;\n} else if (sf < scaleCtrl.w) {\n    sf = scaleCtrl.w;\n}\nvec2 sv2 = vec2(scaleCtrl.x * sf, scaleCtrl.y * sf);\nsv2 = sv2 + 1.0;\npos.x *= sv2.x;\npos.y *= sv2.y;\n",i="float angle = rotation.x + rotation.y * ctime;\nvec4 np = vec4(sin(angle), cos(angle), 0, 0);\nnp.z = np.x * pos.y + np.y * pos.x;\nnp.w = np.y * pos.y - np.x * pos.x;\npos.xy = np.zw;\n",n="vec3 addPos = speed * ctime;\nvec3 uspeed = vec3(0,0,0);\nif (ctime < 0.0 || ctime >= time.z) {\n    addPos.y = addPos.y + 100000.0;\n}\n",a="if(time.y != 0.0 && length(speed) != 0.0) {\n    uspeed = vec3(speed.x, speed.y, speed.z);\n    uspeed = normalize(uspeed);\n    uspeed = uspeed * time.y;\n    uspeed.xyz = uspeed.xyz + force.xyz;\n} else {\n    uspeed = vec3(force.x, force.y, force.z);\n}\naddPos.xyz = addPos.xyz + uspeed.xyz * ctime * ctime;\n",o="uspeed = speed + uspeed * ctime * 2.0;\nuspeed = normalize(uspeed);\nvec4 tempMul = rotationMatrix * vec4(uspeed,1.0);\nuspeed.xyz = tempMul.xyz;\nuspeed = normalize(uspeed);\nvec3 cPos = addPos;\ntempMul = rotationMatrix * vec4(cPos,1.0);\ncPos.xyz = tempMul.xyz; \ncPos.xyz = worldPos.xyz + cPos.xyz;\ncPos.xyz = camPos.xyz - cPos.xyz;\ncPos = normalize(cPos);\ncPos = cross(uspeed, cPos);\ncPos = normalize(cPos);\nuspeed = uspeed * pos.x;\ncPos = cPos * pos.y;\npos.xyz = uspeed.xyz + cPos.xyz;\n",r="pos = watheye * pos;\npos.xyz = pos.xyz + basePos.xyz + addPos.xyz;\ngl_Position = viewMatrix * cameraMatrix * modelMatrix * pos;\n",c="v0 = texcoord;\n",l="vec2 uv = texcoord;\nfloat animframe = floor(ctime / animCtrl.z);\nanimframe = animframe / animCtrl.x;\nuv.x += animframe;\nanimframe = floor(animframe);\nuv.y += animframe / animCtrl.y;\nv0.xy = uv.xy;\n",p="vec2 uv = uvCtrl;\nuv.xy = uv.xy * ctime + texcoord.xy;\nv0.xy = uv.xy;\n",h="v2 = color;\n",s="v1 = vec2(ctime/time.z,1.0);\n";
var D=this.paramAry[0],w=this.paramAry[1],b=this.paramAry[2],S=this.paramAry[3],M=this.paramAry[4],C=this.paramAry[5],T=this.paramAry[6],A="",I="";A+=t,I+=u,M&&(A+=e,I+=d),S&&(A+=i,I+=m),A+=n,C&&(A+=a,I+=f),b&&(A+=o,I+=y),A+=r,1==T?(A+=l,I+=v):2==T?(A+=p,I+=x):A+=c,w&&(A+=h,I+=g),D&&(A+=s,I+=_);var E=I+"void main(){\n"+A+"}";return E},e.prototype.getFragmentShaderString=function(){var t=" precision mediump float;\nuniform sampler2D tex;\nvarying vec2 v0;\nvoid main(void)\n{\nvec4 infoUv = texture2D(tex, v0.xy);\ngl_FragColor = infoUv;\n}";return t},e.Display3D_Ball_Shader="Display3DBallShader",e}(Shader3D),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},ParticleBallData=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e}(ParticleData),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},Display3DLocusPartilce=function(t){function e(){t.call(this),this._speed=1,this._isLoop=!1,this.objData=new ParticleData,this._resultUvVec=Array(3)}return __extends(e,t),e.prototype.setVa=function(){Scene_data.context3D.setVa(0,3,this.objData.vertexBuffer),Scene_data.context3D.setVa(1,2,this.objData.uvBuffer),this._watchEye&&Scene_data.context3D.setVa(2,4,this.objData.normalsBuffer),this.setMaterialTexture(),Scene_data.context3D.drawCall(this.objData.indexBuffer,this.objData.treNum)},e.prototype.setVc=function(){this.updateUV(),Scene_data.context3D.setVcMatrix4fv(this.materialParam.program,"viewMatrix3D",Scene_data.viewMatrx3D.m),Scene_data.context3D.setVcMatrix4fv(this.materialParam.program,"camMatrix3D",Scene_data.cam3D.cameraMatrix.m),Scene_data.context3D.setVcMatrix4fv(this.materialParam.program,"posMatrix3D",this.modelMatrix.m),Scene_data.context3D.setVc3fv(this.materialParam.program,"uvMove",this._resultUvVec),this._watchEye&&(this._caramPosVec[0]=Scene_data.cam3D.x,this._caramPosVec[1]=Scene_data.cam3D.y,this._caramPosVec[2]=Scene_data.cam3D.z,Scene_data.context3D.setVc3fv(this.materialParam.program,"camPos",this._caramPosVec)),this._changUv&&Scene_data.context3D.setVc3fv(this.materialParam.program,"isUv",this._uvVec),this.setMaterialVc()},e.prototype.updateUV=function(){var t=this._time/Scene_data.frameTime,e=this._life/100,i=this._speed*t/this._density/10;this._isEnd&&(i=Math.min(1,i)),this._isLoop&&(i%=this._life?e+1:1),this._resultUvVec[0]=i},e.prototype.initUV=function(){var t=this._time/Scene_data.frameTime,e=this._life/100,i=this._speed*t/this._density/10;this._isEnd&&(i=Math.min(1,i));var n;this._isLoop?this._life?(i%=e+1,n=new Vector3D(i,e,-e)):(i%=1,n=new Vector3D(i+1,99,-2)):n=this._life?new Vector3D(i,e,-1):new Vector3D(i,99,-1),this._resultUvVec[0]=n.x,this._resultUvVec[1]=n.y,this._resultUvVec[2]=n.z},e.prototype.uploadToGpu=function(){this.objData.vertexBuffer=Scene_data.context3D.uploadBuff3D(this.objData.vertices),this.objData.uvBuffer=Scene_data.context3D.uploadBuff3D(this.objData.uvs),this._watchEye&&(this.objData.normalsBuffer=Scene_data.context3D.uploadBuff3D(this.objData.normals)),this.objData.indexBuffer=Scene_data.context3D.uploadIndexBuff3D(this.objData.indexs),this.objData.treNum=this.objData.indexs.length},e.prototype.setAllInfo=function(e){var i=e.display;this._isLoop=i.isLoop,this._speed=i.speed,this._density=i.density,this._isEnd=i.isEnd,this.objData.vertices=i.vecData.vec,this.objData.uvs=i.vecData.uvs,this.objData.normals=i.vecData.normals,this.objData.indexs=i.vecData.index,t.prototype.setAllInfo.call(this,e),this.initUV(),this._watchEye&&(this._caramPosVec=[0,0,0]),this._uvVec=[this._isU?-1:1,this._isV?-1:1,this._isUV?1:-1],this.uploadToGpu()},e.prototype.regShader=function(){if(this.materialParam){var t=this._watchEye?1:0,e=0,i=this.materialParam.material.hasParticleColor;this._isU||this._isV||this._isUV?(e=1,this._changUv=!0):this._changUv=!1;var n;n=[t,e,i?1:0],this.materialParam.program=ProgrmaManager.getInstance().getMaterialProgram(Display3DLocusShader.Display3D_Locus_Shader,new Display3DLocusShader,this.materialParam.material,n)}},e}(Display3DParticle),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},Display3DLocusShader=function(t){function e(){t.call(this)}return __extends(e,t),e.prototype.binLocation=function(t){t.bindAttribLocation(this.program,0,"v3Position"),t.bindAttribLocation(this.program,1,"v2TexCoord"),this.paramAry[0]&&t.bindAttribLocation(this.program,2,"v3Normal")},e.prototype.getVertexShaderString=function(){var t="attribute vec4 v3Position;\nattribute vec2 v2TexCoord;\nuniform mat4 viewMatrix3D;\nuniform mat4 camMatrix3D;\nuniform mat4 posMatrix3D;\nuniform vec3 uvMove;\nvarying vec2 v0;\nvarying vec4 v2;\n",e="attribute vec4 v3Normal;\nuniform vec3 camPos;\n",i="uniform vec3 isUv;\n",n="varying vec2 v1;\n",a="   vec2 tempv0 = v2TexCoord;\n   tempv0.x -= uvMove.x;\n",o="   v1 = v2TexCoord;\n",r="   v0 = tempv0;\n",s="   tempv0.xy *= isUv.xy;\n   if(isUv.z >= 0.0){\n   vec2 tempv1 = tempv0;\n   tempv0.y = tempv1.x;\n   tempv0.x = tempv1.y;}\n   v0 = tempv0;\n",h="   float alpha = tempv0.x/uvMove.y;\n   alpha = 1.0 - clamp(abs(alpha),0.0,1.0);\n   float kill = -tempv0.x;\n   kill *= tempv0.x - uvMove.z;\n   v2 = vec4(kill,0.0,0.0,alpha);\n",c="   gl_Position = viewMatrix3D  * camMatrix3D * posMatrix3D * v3Position;\n",l="   vec4 tempPos = posMatrix3D * v3Position;\n   vec3 mulPos = vec3(tempPos.x,tempPos.y,tempPos.z);\n   vec3 normals = vec3(v3Normal.x,v3Normal.y,v3Normal.z);\n   mulPos = normalize(camPos - mulPos);\n   mulPos = cross(mulPos, normals);\n   mulPos = normalize(mulPos);\n   mulPos *= v3Normal.w;\n   tempPos.xyz = mulPos.xyz + v3Position.xyz;\n   gl_Position = viewMatrix3D  * camMatrix3D * posMatrix3D * tempPos;\n",p=this.paramAry[0],u=this.paramAry[1],d=this.paramAry[2],m=t;p&&(m+=e),u&&(m+=i),d&&(m+=n);var f=a+h;d&&(f+=o),f+=u?s:r,f+=p?l:c;var y=m+"void main(void){\n"+f+"}";return y},e.prototype.getFragmentShaderString=function(){var t=" precision mediump float;\nuniform sampler2D tex;\nvarying vec2 v0;\nvoid main(void)\n{\nvec4 infoUv = texture2D(tex, v0.xy);\ngl_FragColor = infoUv;\n}";return t},e.Display3D_Locus_Shader="Display3DLocusShader",e}(Shader3D),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},Display3DLocusBallPartilce=function(t){function e(){t.call(this)}return __extends(e,t),e.prototype.initBasePos=function(){for(var t=[],e=0;this._totalNum>e;e++){var i,n=3*e;if(this._isRandom){var a=new Vector3D(this._round.x*this._round.w,this._round.y*this._round.w,this._round.z*this._round.w);i=new Vector3D(this._posAry[n]+Math.random()*a.x,this._posAry[n+1]+Math.random()*a.y,this._posAry[n+2]+Math.random()*a.z)}else i=new Vector3D(this._posAry[n],this._posAry[n+1],this._posAry[n+2]);i=i.add(this._basePositon);for(var o=0;4>o;o++)t.push(i.x,i.y,i.z,e*this._shootSpeed)}this.particleBallData.basePos=t},e.prototype.initSpeed=function(){for(var t=[],e=0;this._totalNum>e;e++){var i=new Vector3D;if(0==this._tangentSpeed)i.addByNum(this._angleAry[3*e],this._angleAry[3*e+1],this._angleAry[3*e+2]);else if(2==this._tangentSpeed)i.setTo(2*Math.random()-1,2*Math.random()-1,2*Math.random()-1);else{var n=new Vector3D(this._tangentAry[3*e],this._tangentAry[3*e+1],this._tangentAry[3*e+2]);n.scaleBy(this._tangentSpeed),i=i.add(n)}i.normalize(),this._isSendRandom?i.scaleBy(this._speed*Math.random()):i.scaleBy(this._speed);for(var a=0;4>a;a++)t.push(i.x,i.y,i.z)}this.particleBallData.beMove=t},e.prototype.setAllInfo=function(e){var i=e.display;this._tangentSpeed=i.tangentSpeed,this._posAry=i.vecData.pos,this._angleAry=i.vecData.angle,this._tangentAry=i.vecData.tangent,t.prototype.setAllInfo.call(this,e)},e}(Display3DBallPartilce),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},Display3DModelPartilce=function(t){function e(){t.call(this),this.objData=new ParticleData,this._resultUvVec=Array(2)}return __extends(e,t),e.prototype.setVc=function(){this.updateWatchCaramMatrix(),this.updateUV(),Scene_data.context3D.setVcMatrix4fv(this.materialParam.program,"viewMatrix3D",Scene_data.viewMatrx3D.m),Scene_data.context3D.setVcMatrix4fv(this.materialParam.program,"camMatrix3D",Scene_data.cam3D.cameraMatrix.m),Scene_data.context3D.setVcMatrix4fv(this.materialParam.program,"posMatrix3D",this.modelMatrix.m),Scene_data.context3D.setVcMatrix4fv(this.materialParam.program,"rotationMatrix3D",this._rotationMatrix.m),Scene_data.context3D.setVc2fv(this.materialParam.program,"uvMove",this._resultUvVec),this.setMaterialVc()},e.prototype.setVa=function(){Scene_data.context3D.setVa(0,3,this.objData.vertexBuffer),Scene_data.context3D.setVa(1,2,this.objData.uvBuffer),this.setMaterialTexture(),Scene_data.context3D.drawCall(this.objData.indexBuffer,this.objData.treNum)},e.prototype.updateWatchCaramMatrix=function(){this._rotationMatrix.identity(),this._watchEye&&(this.timeline.inverAxisRotation(this._rotationMatrix),this._rotationMatrix.prependRotation(-Scene_data.cam3D.rotationY,Vector3D.Y_AXIS),this._rotationMatrix.prependRotation(-Scene_data.cam3D.rotationX,Vector3D.X_AXIS)),this._isZiZhuan&&this.timeline.applySelfRotation(this._rotationMatrix,this._ziZhuanAngly)},e.prototype.updateUV=function(){this._resultUvVec[0]=this._time/Scene_data.frameTime*this._uSpeed,this._resultUvVec[1]=this._time/Scene_data.frameTime*this._vSpeed},e.prototype.uploadToGpu=function(){this.objData.vertexBuffer=Scene_data.context3D.uploadBuff3D(this.objData.vertices),this.objData.uvBuffer=Scene_data.context3D.uploadBuff3D(this.objData.uvs),this.objData.indexBuffer=Scene_data.context3D.uploadIndexBuff3D(this.objData.indexs),this.objData.treNum=this.objData.indexs.length},e.prototype.setAllInfo=function(e){var i=e.display;this._maxAnimTime=i.maxAnimTime,this.objData.vertices=i.vecData.ves,this.objData.uvs=i.vecData.uvs,this.objData.indexs=i.vecData.indexs,t.prototype.setAllInfo.call(this,e),this.uploadToGpu()},e.prototype.regShader=function(){this.materialParam.program=ProgrmaManager.getInstance().getMaterialProgram(Display3DFacetShader.Display3D_Facet_Shader,new Display3DFacetShader,this.materialParam.material)},e}(Display3DParticle),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},Display3DModelObjParticle=function(t){function e(){t.call(this)}return __extends(e,t),e.prototype.update=function(){this._depthMode&&Scene_data.context3D.setDepthTest(!0),t.prototype.update.call(this),this._depthMode&&Scene_data.context3D.setDepthTest(!1)},e.prototype.setAllInfo=function(e){var i=e.display;this._depthMode=i.depthMode,t.prototype.setAllInfo.call(this,e)},e}(Display3DModelPartilce),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},Display3dModelAnimParticle=function(t){function e(){t.call(this)}return __extends(e,t),e.prototype.updateUV=function(){var t=this._time/Scene_data.frameTime;t=t>this._maxAnimTime?this._maxAnimTime:t,t=t/this._animInterval%(this._animLine*this._animRow),this._resultUvVec[0]=float2int(t%this._animLine)/this._animLine+this._time/Scene_data.frameTime*this._uSpeed,this._resultUvVec[1]=float2int(t/this._animLine)/this._animRow+this._time/Scene_data.frameTime*this._vSpeed},e}(Display3DModelPartilce),KeyFrame=function(){function t(){}return t}(),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},TimeLine=function(t){function e(){t.call(this),this._time=0,this.targetFlag=-1,this.beginTime=0,this.targetFlag=-1,this.visible=!1,this.maxFrameNum=0,this._time=0,this._keyFrameAry=[]}return __extends(e,t),e.prototype.updateMatrix=function(t,e){this._axisMove&&t.prependTranslation(this._axisMove.axis.x*this._axisMove.num,this._axisMove.axis.y*this._axisMove.num,this._axisMove.axis.z*this._axisMove.num),this._axisRotaion&&t.prependRotation(this._axisRotaion.num,this._axisRotaion.axis),t.prependTranslation(e.x,e.y,e.z),this._scaleChange?t.prependScale(e.widthFixed?1:this._scaleChange.num,e.heightFixed?1:this._scaleChange.num,e.widthFixed?1:this._scaleChange.num):this._scaleNosie?t.prependScale(e.widthFixed?1:1+this._scaleNosie.num,e.heightFixed?1:1+this._scaleNosie.num,e.widthFixed?1:1+this._scaleNosie.num):this._scaleAnim&&t.prependScale(e.widthFixed?1:this._scaleAnim.num,e.heightFixed?1:this._scaleAnim.num,e.widthFixed?1:this._scaleAnim.num),t.prependRotation(e.rotationX,Vector3D.X_AXIS),t.prependRotation(e.rotationY,Vector3D.Y_AXIS),t.prependRotation(e.rotationZ,Vector3D.Z_AXIS)},e.prototype.inverAxisRotation=function(t){this._axisRotaion&&t.prependRotation(-this._axisRotaion.num,this._axisRotaion.axis)},e.prototype.applySelfRotation=function(t,e){this._selfRotaion&&t.prependRotation(this._selfRotaion.num,e)},e.prototype.addKeyFrame=function(t){var e=new KeyFrame;return e.frameNum=t,this._keyFrameAry.push(e),e},e.prototype.updateTime=function(t){this._currentKeyFrame&&(this._time=t,this.getTarget(),this._axisRotaion&&this._axisRotaion.update(this._time),this._selfRotaion&&this._selfRotaion.update(this._time),this._axisMove&&this._axisMove.update(this._time),this._scaleChange?this._scaleChange.update(this._time):this._scaleNosie?this._scaleNosie.update(this._time):this._scaleAnim&&this._scaleAnim.update(this._time))},e.prototype.getTarget=function(){for(var t=-1,e=0;this._keyFrameAry.length>e&&this._keyFrameAry[e].frameNum*Scene_data.frameTime<this._time;e++)t=e;t!=this.targetFlag&&(this._currentKeyFrame=this._keyFrameAry[t],this.targetFlag=t,t==this._keyFrameAry.length-1?(this.visible=!1,this._currentKeyFrame=null):(this.visible=!0,this.enterKeyFrame(this._currentKeyFrame.animData,this._currentKeyFrame.frameNum*Scene_data.frameTime,this._currentKeyFrame.baseValue)))},e.prototype.enterKeyFrame=function(t,e,i){if(void 0===e&&(e=0),void 0===i&&(i=null),null!=i){for(var n=0;10>n;n++)if(i[n])switch(n){case 1:this._selfRotaion||(this._selfRotaion=new SelfRotation),this._selfRotaion.num=this._selfRotaion.baseNum=i[n];break;case 2:this._axisRotaion||(this._axisRotaion=new AxisRotaion),this._axisRotaion.num=this._axisRotaion.baseNum=i[n];break;case 6:this._scaleChange||(this._scaleChange=new ScaleChange),this._scaleChange.num=this._scaleChange.baseNum=i[n];break;case 7:this._scaleAnim||(this._scaleAnim=new ScaleAnim),this._scaleAnim.num=this._scaleAnim.baseNum=i[n];break;case 8:this._scaleNosie||(this._scaleNosie=new ScaleNoise),this._scaleNosie.num=this._scaleNosie.baseNum=i[n];break;case 9:this._axisMove||(this._axisMove=new AxisMove),this._axisMove.num=this._axisMove.baseNum=i[n]}if(this._selfRotaion&&(this._selfRotaion.isDeath=!0),this._axisRotaion&&(this._axisRotaion.isDeath=!0),this._scaleChange&&(this._scaleChange.isDeath=!0),this._scaleAnim&&(this._scaleAnim.isDeath=!0),this._scaleNosie&&(this._scaleNosie.isDeath=!0),this._axisMove&&(this._axisMove.isDeath=!0),t)for(var n=0;t.length>n;n++)1==t[n].type?(this._selfRotaion?this._selfRotaion.reset():this._selfRotaion=new SelfRotation,this._selfRotaion.data=t[n].data,this._selfRotaion.baseTime=e):2==t[n].type?(this._axisRotaion?this._axisRotaion.reset():this._axisRotaion=new AxisRotaion,this._axisRotaion.data=t[n].data,this._axisRotaion.baseTime=e):6==t[n].type?(this._scaleChange?this._scaleChange.reset():this._scaleChange=new ScaleChange,this._scaleChange.data=t[n].data,this._scaleChange.baseTime=e):7==t[n].type?(this._scaleAnim?this._scaleAnim.reset():this._scaleAnim=new ScaleAnim,this._scaleAnim.data=t[n].data,this._scaleAnim.baseTime=e):8==t[n].type?(this._scaleNosie?this._scaleNosie.reset():this._scaleNosie=new ScaleNoise,this._scaleNosie.data=t[n].data,this._scaleNosie.baseTime=e):9==t[n].type&&(this._axisMove?this._axisMove.reset():this._axisMove=new AxisMove,this._axisMove.data=t[n].data,this._axisMove.baseTime=e)}},e.prototype.reset=function(){this._time=0,this._currentKeyFrame=this._keyFrameAry[0],this.visible=!1,this.targetFlag=-1},e.prototype.setAllInfo=function(t){for(var e=t,i=0;e.length>i;i++){var n=this.addKeyFrame(e[i].frameNum);n.animData=e[i].animdata,n.baseValue=e[i].baseValue}this.maxFrameNum=e[e.length-1].frameNum,this.beginTime=e[0].frameNum*Scene_data.frameTime,this._currentKeyFrame=e[0]},e.prototype.getMaxFrame=function(){return this._keyFrameAry[this._keyFrameAry.length-1].frameNum},e.prototype.dispose=function(){},e}(EventDispatcher),BaseAnim=function(){function t(){this.baseNum=0,this.num=0,this.time=0,this.speed=0,this.aSpeed=0,this.beginTime=0,this.lastTime=0,this.baseTime=0}return t.prototype.BaseAnim=function(){},t.prototype.update=function(t){this._isDeath||(this.time=t-this.baseTime,this._isActiva?(this.time=this.time-this.beginTime,this.time>this.lastTime&&(this.time=this.lastTime-this.beginTime,this._isDeath=!0),this.coreCalculate()):this.time>=this.beginTime&&(this.time>=this.lastTime?(this.time=this.lastTime-this.beginTime,this.coreCalculate(),this._isDeath=!0):(this.time=this.time-this.beginTime,this.coreCalculate()),this._isActiva=!0))},t.prototype.coreCalculate=function(){this.num=this.speed*this.time+this.aSpeed*this.time*this.time+this.baseNum},t.prototype.reset=function(){this._isActiva=!1,this._isDeath=!1,this.time=0,this.num=0},t.prototype.depthReset=function(){this._isActiva=!1,this._isDeath=!1,this.time=0,this.baseNum=0,this.num=0},Object.defineProperty(t.prototype,"data",{set:function(){},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isDeath",{get:function(){return this._isDeath},set:function(t){this._isDeath=t},enumerable:!0,configurable:!0}),t.prototype.getAllNum=function(t){t=Math.min(t,this.lastTime),t-=this.beginTime;var e=this.speed*t+this.aSpeed*t*t;this.baseNum+=e},t}(),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},AxisMove=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),Object.defineProperty(e.prototype,"data",{set:function(t){this.beginTime=Number(t[0].value),this.lastTime=-1==Number(t[1].value)?Scene_data.MAX_NUMBER:Number(t[1].value);var e=t[2].value.split("|");this.axis=new Vector3D(Number(e[0]),Number(e[1]),Number(e[2])),this.axis.normalize(),this.speed=.1*Number(t[3].value),this.aSpeed=.001*Number(t[4].value)},enumerable:!0,configurable:!0}),e}(BaseAnim),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},AxisRotaion=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),Object.defineProperty(e.prototype,"data",{set:function(t){this.beginTime=Number(t[0].value),this.lastTime=-1==Number(t[1].value)?Scene_data.MAX_NUMBER:Number(t[1].value);var e=(t[2].value+"").split("|");this.axis=new Vector3D(Number(e[0]),Number(e[1]),Number(e[2])),e=(t[3].value+"").split("|"),this.axisPos=new Vector3D(100*Number(e[0]),100*Number(e[1]),100*Number(e[2])),this.speed=.1*Number(t[4].value),this.aSpeed=.1*Number(t[5].value)},enumerable:!0,configurable:!0}),e}(BaseAnim),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},ScaleAnim=function(t){function e(){t.call(this),this.num=1}return __extends(e,t),e.prototype.update=function(t){this._isDeath||(this.time=t-this.baseTime,this._isActiva?(this.coreCalculate(),this.time>this.lastTime&&(this._isDeath=!0)):this.time>=this.beginTime&&(this._isActiva=!0))},e.prototype.coreCalculate=function(){var t=float2int(this.time/Scene_data.frameTime);this.num=t>=this.numAry.length?this.numAry[this.numAry.length-1]:this.numAry[t]},e.prototype.reset=function(){t.prototype.reset.call(this),this.num=1},e.prototype.depthReset=function(){t.prototype.depthReset.call(this),this.num=1},Object.defineProperty(e.prototype,"data",{set:function(t){this.numAry=[],this.beginTime=Number(t[0].value),this.lastTime=-1==Number(t[1].value)?Scene_data.MAX_NUMBER:Number(t[1].value),this.beginScale=Number(t[2].value),this.scaleNum=Number(t[3].value),this.scaleAry=[];for(var e=0,i=4;4+2*this.scaleNum>i;i+=2){var n={};n.value=Number(t[i].value),n.time=Number(t[i+1].value),e+=n.time,n.beginTime=this.beginTime+e,this.scaleAry.push(n)}var a,o=0,r=1;this.scaleAry.length?(a=(this.scaleAry[this.scaleAry.length-1].beginTime+this.scaleAry[this.scaleAry.length-1].time)/Scene_data.frameTime,r=this.scaleAry[0].beginTime,this._currentTarget=this.scaleAry[0]):a=0;var s=0;for(i=0;a>i;i++){var h=Scene_data.frameTime*i;h>=this._currentTarget.beginTime&&(this.beginScale=this._currentTarget.value,o=this._currentTarget.beginTime,s==this.scaleAry.length-1?this._currentTarget=this.scaleAry[this.scaleAry.length-1]:(s++,this._currentTarget=this.scaleAry[s]),r=this._currentTarget.time);var c=(h-o)/r*(this._currentTarget.value-this.beginScale)+this.beginScale;this.numAry.push(c)}this._currentTarget=this.scaleAry[0]},enumerable:!0,configurable:!0}),e.prototype.getAllNum=function(t){t=Math.min(t,this.lastTime+this.beginTime);var e=this.scaleAry[this.scaleAry.length-1];if(t>=e.beginTime+e.time)return this.baseNum=e.value,void 0;for(var i,n=0;this.scaleAry.length>n;n++)t>this.scaleAry[n].this.beginTime&&(this._currentTarget=this.scaleAry[n],this.beginTime=this._currentTarget.this.beginTime,this.beginScale=this._currentTarget.value,i=n);i++,this._currentTarget=this.scaleAry[i],this.baseNum=(this._currentTarget.value-this.beginScale)/this._currentTarget.this.time*(t-this.beginTime)+this.beginScale},e}(BaseAnim),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},ScaleChange=function(t){function e(){t.call(this),this.num=1}return __extends(e,t),e.prototype.coreCalculate=function(){this.num=1+this.speed*this.time+this.baseNum,this.num<this.minNum?this.num=this.minNum:this.num>this.maxNum&&(this.num=this.maxNum)},Object.defineProperty(e.prototype,"data",{set:function(t){this.beginTime=Number(t[0].value),this.lastTime=-1==Number(t[1].value)?Scene_data.MAX_NUMBER:Number(t[1].value),this.speed=.001*Number(t[2].value),this.minNum=.01*Number(t[3].value),this.maxNum=.01*Number(t[4].value)},enumerable:!0,configurable:!0}),e.prototype.getAllNum=function(t){t=Math.min(t,this.lastTime),t-=this.beginTime;var e=this.speed*t;this.baseNum+=e,this.baseNum<this.minNum?this.baseNum=this.minNum:e>this.maxNum&&(this.baseNum=this.maxNum)},e.prototype.reset=function(){this._isActiva=!1,this._isDeath=!1,this.time=0,this.num=1},e.prototype.depthReset=function(){this._isActiva=!1,this._isDeath=!1,this.time=0,this.baseNum=0,this.num=1},e}(BaseAnim),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},ScaleNoise=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.coreCalculate=function(){this.num=this.amplitude+this.amplitude*Math.sin(this.speed*this.time)},Object.defineProperty(e.prototype,"data",{set:function(t){this.beginTime=Number(t[0].value),this.lastTime=-1==Number(t[1].value)?Scene_data.MAX_NUMBER:Number(t[1].value),this.amplitude=Number(t[2].value),this.speed=.01*Number(t[3].value)},enumerable:!0,configurable:!0}),e.prototype.getAllNum=function(t){this.baseNum=this.amplitude+this.amplitude*Math.sin(this.speed*t)},e}(BaseAnim),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},SelfRotation=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),Object.defineProperty(e.prototype,"data",{set:function(t){this.beginTime=Number(t[0].value),this.lastTime=-1==Number(t[1].value)?Scene_data.MAX_NUMBER:Number(t[1].value),this.speed=.1*Number(t[2].value),this.aSpeed=.1*Number(t[3].value)},enumerable:!0,configurable:!0}),e}(BaseAnim),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},InteractiveEvent=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.Down="down",e.Up="Up",e.Move="Move",e.PinchStart="PinchStart",e.Pinch="Pinch",e}(BaseEvent),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},UICompenent=function(t){function e(){t.apply(this,arguments),this._x=0,this._y=0,this._width=0,this._height=0,this.z=0,this.absoluteX=0,this.absoluteY=0,this.absoluteWidth=0,this.absoluteHeight=0,this.renderX=0,this.renderY=0,this.renderWidth=0,this.renderHeight=0}return __extends(e,t),e.prototype.addStage=function(){this.renderData=[0,0,0,0],this.applyAbsolutePoint(),this.uiRender.addRenderUI(this)},e.prototype.applyRenderSize=function(){this.parent&&(this.renderX=this.absoluteX/Scene_data.stageWidth,this.renderY=this.absoluteY/Scene_data.stageHeight,this.renderWidth=this.absoluteWidth/Scene_data.stageWidth,this.renderHeight=this.absoluteHeight/Scene_data.stageHeight,this.renderData[0]=this.renderX,this.renderData[1]=this.renderY,this.renderData[2]=this.renderWidth,this.renderData[3]=this.renderHeight)},e.prototype.applyAbsolutePoint=function(){this.parent&&(this.absoluteX=this._x*UIData.Scale+this.parent.x,this.absoluteY=this._y*UIData.Scale+this.parent.y,this.absoluteWidth=this.width*UIData.Scale,this.absoluteHeight=this.height*UIData.Scale,this.applyRenderSize())},Object.defineProperty(e.prototype,"x",{get:function(){return this._x},set:function(t){this._x=t,this.applyAbsolutePoint()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"y",{get:function(){return this._y},set:function(t){this._y=t,this.applyAbsolutePoint()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"width",{get:function(){return this._width},set:function(t){this._width=t,this.applyAbsolutePoint()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){return this._height},set:function(t){this._height=t,this.applyAbsolutePoint()},enumerable:!0,configurable:!0}),e.prototype.testPoint=function(t,e){return t>this.absoluteX&&this.absoluteX+this.absoluteWidth>t&&e>this.absoluteY&&this.absoluteY+this.absoluteHeight>e?!0:!1},e.prototype.interactiveEvent=function(t){t.type;var e=this._eventsMap;if(!e)return!1;var i=e[t.type];if(!i)return!1;if(!this.testPoint(t.x,t.y))return!1;var n=i.length;if(0==n)return!1;for(var a=0;n>a;a++){var o=i[a];o.listener.call(o.thisObject,t)}return!0},e}(EventDispatcher),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},UIConatiner=function(t){function e(){t.apply(this,arguments),this._left=0,this._right=0,this._center=0,this._xType=0,this._top=0,this._bottom=0,this._middle=0,this._yType=0,this._list=[]}return __extends(e,t),e.prototype.addChild=function(t){this._list.push(t),t.parent=this,t.addStage()},e.prototype.resize=function(){0==this._xType?this._x=this._left*UIData.Scale:1==this._xType?this._x=Scene_data.stageWidth-this._right*UIData.Scale-this.width*UIData.Scale:2==this._xType&&(this._x=this._center*UIData.Scale+Scene_data.stageWidth/2-this.width*UIData.Scale/2),this._y=0==this._yType?this._top*UIData.Scale:Scene_data.stageHeight-this._bottom*UIData.Scale-this.height*UIData.Scale,this.applyChild()},Object.defineProperty(e.prototype,"left",{set:function(t){this._left=t,this._xType=0,this._x=this._left*UIData.Scale,this.applyChild()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"right",{set:function(t){this._right=t,this._xType=1,this._x=Scene_data.stageWidth-this._right*UIData.Scale-this.width*UIData.Scale,this.applyChild()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"center",{set:function(t){this._center=t,this._xType=2,this._x=this._center*UIData.Scale+Scene_data.stageWidth/2-this.width*UIData.Scale/2,this.applyChild()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"top",{set:function(t){this._top=t,this._yType=0,this._y=this._top*UIData.Scale,this.applyChild()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"bottom",{set:function(t){this._bottom=t,this._yType=1,this._y=Scene_data.stageHeight-this._bottom*UIData.Scale-this.height*UIData.Scale,this.applyChild()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"width",{get:function(){if(0!=this._width)return this._width;for(var t=0,e=0;this._list.length>e;e++)t=Math.max(this._list[e].width);return t},set:function(t){this._width=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){if(0!=this._height)return this._height;for(var t=0,e=0;this._list.length>e;e++)t=Math.max(this._list[e].height);return t},set:function(t){this._height=t},enumerable:!0,configurable:!0}),e.prototype.applyChild=function(){for(var t=0;this._list.length>t;t++)this._list[t].applyAbsolutePoint()},e}(UICompenent),UIData=function(){function t(){}return t.setDesignWH=function(t,e){this.designWidth=t,this.designHeight=e,this.Scale=Math.min(Scene_data.stageWidth/t,Scene_data.stageHeight/e)},t.resize=function(){this.Scale=Math.min(Scene_data.stageWidth/this.designWidth,Scene_data.stageHeight/this.designHeight)},t.designWidth=800,t.designHeight=600,t}(),UIRenderComponent=function(){function t(){this.initData()}return t.prototype.initData=function(){this._uiList=[],this.container=new UIConatiner,this.objData=new ObjData,this.program=ProgrmaManager.getInstance().getProgram(UIShader.UI_SHADER)},t.prototype.resize=function(){this.container.resize()},t.prototype.setImgUrl=function(t){var e=this;TextureManager.getInstance().getTexture(Scene_data.fileRoot+t,function(t){e.texture=t})},t.prototype.creatComponent=function(t,e,i,n){var a=new UICompenent;return a.tx=t,a.ty=e,a.tw=i,a.th=n,a.uiRender=this,a},t.prototype.addRenderUI=function(t){this._uiList.push(t),this._uiList.sort(function(t,e){return t.z>e.z?-1:1}),this.applyObjData()},t.prototype.applyObjData=function(){this.objData.vertices.length=0,this.objData.uvs.length=0,this.objData.indexs.length=0;for(var t=0;this._uiList.length>t;t++){var e=this._uiList[t];this.objData.vertices.push(0,0,0,1,0,0,1,-1,0,0,-1,0),this.objData.uvs.push(e.tx,e.ty,t,e.tx+e.tw,e.ty,t,e.tx+e.tw,e.ty+e.th,t,e.tx,e.ty+e.th,t),this.objData.indexs.push(4*t,1+4*t,2+4*t,4*t,2+4*t,3+4*t)}this.objData.treNum=6*this._uiList.length,this.objData.vertexBuffer?(Scene_data.context3D.uploadBuff3DByBuffer(this.objData.vertexBuffer,this.objData.vertices),Scene_data.context3D.uploadBuff3DByBuffer(this.objData.uvBuffer,this.objData.uvs),Scene_data.context3D.uploadIndexBuff3DByBuffer(this.objData.indexBuffer,this.objData.indexs)):(this.objData.vertexBuffer=Scene_data.context3D.uploadBuff3D(this.objData.vertices),this.objData.uvBuffer=Scene_data.context3D.uploadBuff3D(this.objData.uvs),this.objData.indexBuffer=Scene_data.context3D.uploadIndexBuff3D(this.objData.indexs))
},t.prototype.update=function(){if(0!=this._uiList.length){Scene_data.context3D.setBlendParticleFactors(0),Scene_data.context3D.setProgram(this.program);for(var t=0;this._uiList.length>t;t++)Scene_data.context3D.setVc4fv(this.program,"ui["+t+"]",this._uiList[t].renderData);Scene_data.context3D.setVa(0,3,this.objData.vertexBuffer),Scene_data.context3D.setVa(1,3,this.objData.uvBuffer),Scene_data.context3D.setRenderTexture(this.program,"s_texture",this.texture,0),Scene_data.context3D.drawCall(this.objData.indexBuffer,this.objData.treNum)}},t.prototype.interactiveEvent=function(t){for(var e=!1,i=0;this._uiList.length>i;i++)this._uiList[i].interactiveEvent(t)&&(e=!0);return e},t}(),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},UIBackImg=function(t){function e(){t.call(this),this._scaleData=[1,1]}return __extends(e,t),e.prototype.initData=function(){this.objData=new ObjData,this.program=ProgrmaManager.getInstance().getProgram(UIImageShader.UI_IMG_SHADER),this.objData.vertices.push(-1,1,0,1,1,0,1,-1,0,-1,-1,0),this.objData.uvs.push(0,0,1,0,1,1,0,1),this.objData.indexs.push(0,1,2,0,2,3),this.objData.treNum=6,this.objData.vertexBuffer=Scene_data.context3D.uploadBuff3D(this.objData.vertices),this.objData.uvBuffer=Scene_data.context3D.uploadBuff3D(this.objData.uvs),this.objData.indexBuffer=Scene_data.context3D.uploadIndexBuff3D(this.objData.indexs)},e.prototype.resize=function(){this.appleyPos()},e.prototype.setImgInfo=function(t,e,i){this.setImgUrl(t),this._width=e,this._height=i},e.prototype.appleyPos=function(){var t=this._width/Scene_data.stageWidth,e=this._height/Scene_data.stageHeight;e>t?(this._scaleData[0]=1,this._scaleData[1]=this._height/Scene_data.stageHeight/t):(this._scaleData[0]=this._width/Scene_data.stageWidth/e,this._scaleData[1]=1)},e.prototype.update=function(){Scene_data.context3D.setBlendParticleFactors(0),Scene_data.context3D.setProgram(this.program),Scene_data.context3D.setVa(0,3,this.objData.vertexBuffer),Scene_data.context3D.setVa(1,2,this.objData.uvBuffer),Scene_data.context3D.setVc2fv(this.program,"scale",this._scaleData),Scene_data.context3D.setRenderTexture(this.program,"s_texture",this.texture,0),Scene_data.context3D.drawCall(this.objData.indexBuffer,this.objData.treNum)},e.prototype.interactiveEvent=function(){return!1},e}(UIRenderComponent),UIManager=function(){function t(){Scene_data.uiStage=new UIStage,Scene_data.uiBlankStage=new UIStage}return t.getInstance=function(){return this._instance||(this._instance=new t),this._instance},t.prototype.init=function(){ProgrmaManager.getInstance().registe(UIShader.UI_SHADER,new UIShader),ProgrmaManager.getInstance().registe(UIImageShader.UI_IMG_SHADER,new UIImageShader),this._uiList=[],UIData.setDesignWH(800,600)},t.prototype.addUI=function(t){this._uiList.push(t)},t.prototype.removeUI=function(t){var e=this._uiList.indexOf(t);-1!=e&&this._uiList.splice(e,1)},t.prototype.resize=function(){if(this._uiList){UIData.resize();for(var t=0;this._uiList.length>t;t++)this._uiList[t].resize()}},t.prototype.update=function(){for(var t=0;this._uiList.length>t;t++)this._uiList[t].update()},t.prototype.regEvent=function(){var t=this;document.addEventListener(MouseType.MouseDown,function(e){t.onMouse(e)}),document.addEventListener(MouseType.MouseUp,function(e){t.onMouse(e)}),document.addEventListener(MouseType.MouseMove,function(e){t.onMouse(e)}),document.addEventListener(MouseType.TouchStart,function(e){t.onTouch(e)}),document.addEventListener(MouseType.TouchEnd,function(e){t.onTouch(e)}),document.addEventListener(MouseType.TouchMove,function(e){t.onTouch(e)})},t.prototype.onTouch=function(t){this.interactiveEvent(t)},t.prototype.onMouse=function(t){this.interactiveEvent(t)},t.prototype.interactiveEvent=function(t){var e,i=new Vector2D;if(t instanceof MouseEvent)t.type==MouseType.MouseDown?e=new InteractiveEvent(InteractiveEvent.Down):t.type==MouseType.MouseUp?e=new InteractiveEvent(InteractiveEvent.Up):t.type==MouseType.MouseMove?e=new InteractiveEvent(InteractiveEvent.Move):t.type==MouseType.MouseClick,i.x=t.pageX,i.y=t.pageY;else if(t.type==MouseType.TouchStart?t.touches.length>1?(e=new InteractiveEvent(InteractiveEvent.PinchStart),this.lastSwipeDis=MathClass.math_distance(t.touches[0].clientX,t.touches[0].clientY,t.touches[1].clientX,t.touches[1].clientY),this.lastSwipeRot=Math.atan2(t.touches[1].clientY-t.touches[0].clientY,t.touches[1].clientX-t.touches[0].clientX)):e=new InteractiveEvent(InteractiveEvent.Down):t.type==MouseType.TouchEnd?e=new InteractiveEvent(InteractiveEvent.Up):t.type==MouseType.TouchMove?t.touches.length>1?(e=new InteractiveEvent(InteractiveEvent.Pinch),e.data=MathClass.math_distance(t.touches[0].clientX,t.touches[0].clientY,t.touches[1].clientX,t.touches[1].clientY)/this.lastSwipeDis,e.roation=180*(Math.atan2(t.touches[1].clientY-t.touches[0].clientY,t.touches[1].clientX-t.touches[0].clientX)-this.lastSwipeRot)/Math.PI):e=new InteractiveEvent(InteractiveEvent.Move):t.type==MouseType.TouchClick,i.x=t.pageX,i.y=t.pageY,t.touches.length)for(var n=0;t.touches.length>n;n++)i.x=t.touches[n].clientX,i.y=t.touches[n].clientY;Scene_data.verticalScene?(e.x=i.y,e.y=Scene_data.stageHeight-i.x):(e.x=i.x,e.y=i.y);for(var a=!1,n=0;this._uiList.length>n;n++)this._uiList[n].interactiveEvent(e)&&(a=!0);Scene_data.uiStage.interactiveEvent(e),a||Scene_data.uiBlankStage.interactiveEvent(e)},t}(),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},UIStage=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.interactiveEvent=function(t){var e=t.type,i=this._eventsMap;if(i){var n=i[e];if(n){var a=n.length;if(0!=a)for(var o=0;a>o;o++){var r=n[o];r.listener.call(r.thisObject,t)}}}},e}(EventDispatcher),TextureManager=function(){function t(){this._dic={},this._loadDic={},this.initDefaultLightMapTexture()}return t.getInstance=function(){return this._instance||(this._instance=new t),this._instance},t.prototype.getTexture=function(t,e,i,n,a,o){var r=this;if(void 0===i&&(i=0),void 0===n&&(n=null),void 0===a&&(a=0),void 0===o&&(o=0),this._dic[t])return n?e(this._dic[t],n):e(this._dic[t]),void 0;var s=new TextureLoad(e,n,t,i,a,o);if(this._loadDic[t]){var h=this._loadDic[t];return h.push(s),void 0}this._loadDic[t]=[],this._loadDic[t].push(s),SceneRes.imgDic[t]?this.loadTextureCom(SceneRes.imgDic[t],s):LoadManager.getInstance().load(t,LoadManager.IMG_TYPE,function(t,e){r.loadTextureCom(t,e)},s)},t.prototype.loadCubeTexture=function(t,e){var i=new CubemapLoad;i.loadCube(t,function(t){e(t)})},t.prototype.loadTextureCom=function(t,e){for(var i=Scene_data.context3D.getTexture(t,e.wrap,e.filter,e.mipmap),n=this._loadDic[e.url],a=0;n.length>a;a++)n[a].info?n[a].fun(i,n[a].info):n[a].fun(i);delete this._loadDic[e.url],this._dic[e.url]=i},t.prototype.initDefaultLightMapTexture=function(){var t=document.createElement("canvas"),e=t.getContext("2d");t.width=32,t.height=32,e.fillStyle="rgb(51,51,51)",e.fillRect(0,0,32,32),this.defaultLightMap=Scene_data.context3D.getTexture(t)},t}(),TextureLoad=function(){function t(t,e,i,n,a,o){this.fun=t,this.info=e,this.url=i,this.wrap=n,this.filter=a,this.mipmap=o}return t}(),CubemapLoad=function(){function t(){this.ary=Array(6),this.flagNum=0}return t.prototype.loadCube=function(t,e){var i=this;this.fun=e;for(var n=0;6>n;n++){var a=t+"0"+(n+1)+".jpg";LoadManager.getInstance().load(a,LoadManager.IMG_TYPE,function(t,e){i.loadCom(t,e)},{id:n})}},t.prototype.loadCom=function(t,e){var i=t.width/4,n=document.createElement("canvas"),a=n.getContext("2d");n.width=i,n.height=i;var o=Scene_data.context3D.renderContext,r=o.createTexture();o.bindTexture(o.TEXTURE_CUBE_MAP,r),a.drawImage(t,2*i,i,i,i,0,0,i,i),o.texImage2D(o.TEXTURE_CUBE_MAP_POSITIVE_X,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,n),o.texParameteri(o.TEXTURE_CUBE_MAP,o.TEXTURE_MAG_FILTER,o.LINEAR),o.texParameteri(o.TEXTURE_CUBE_MAP,o.TEXTURE_MIN_FILTER,o.LINEAR),a.drawImage(t,0,i,i,i,0,0,i,i),o.texImage2D(o.TEXTURE_CUBE_MAP_NEGATIVE_X,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,n),o.texParameteri(o.TEXTURE_CUBE_MAP,o.TEXTURE_MAG_FILTER,o.LINEAR),o.texParameteri(o.TEXTURE_CUBE_MAP,o.TEXTURE_MIN_FILTER,o.LINEAR),a.drawImage(t,i,0,i,i,0,0,i,i),o.texImage2D(o.TEXTURE_CUBE_MAP_POSITIVE_Y,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,n),o.texParameteri(o.TEXTURE_CUBE_MAP,o.TEXTURE_MAG_FILTER,o.LINEAR),o.texParameteri(o.TEXTURE_CUBE_MAP,o.TEXTURE_MIN_FILTER,o.LINEAR),a.drawImage(t,i,2*i,i,i,0,0,i,i),o.texImage2D(o.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,n),o.texParameteri(o.TEXTURE_CUBE_MAP,o.TEXTURE_MAG_FILTER,o.LINEAR),o.texParameteri(o.TEXTURE_CUBE_MAP,o.TEXTURE_MIN_FILTER,o.LINEAR),a.drawImage(t,i,i,i,i,0,0,i,i),o.texImage2D(o.TEXTURE_CUBE_MAP_POSITIVE_Z,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,n),o.texParameteri(o.TEXTURE_CUBE_MAP,o.TEXTURE_MAG_FILTER,o.LINEAR),o.texParameteri(o.TEXTURE_CUBE_MAP,o.TEXTURE_MIN_FILTER,o.LINEAR),a.drawImage(t,3*i,i,i,i,0,0,i,i),o.texImage2D(o.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,n),o.texParameteri(o.TEXTURE_CUBE_MAP,o.TEXTURE_MAG_FILTER,o.LINEAR),o.texParameteri(o.TEXTURE_CUBE_MAP,o.TEXTURE_MIN_FILTER,o.LINEAR),this.ary[e.id]=r,this.flagNum++,6==this.flagNum&&this.fun(this.ary)},t}(),ConstItem=function(){function t(){this.value=new Vector3D,this.vecNum=[]}return Object.defineProperty(t.prototype,"id",{get:function(){return this._id},set:function(t){this._id=t,this.name="fc"+t},enumerable:!0,configurable:!0}),t.prototype.creat=function(){this.vecNum[0]=this.value.x,this.vecNum[1]=this.value.y,this.vecNum[2]=this.value.z,this.vecNum[3]=this.value.w},t.prototype.setData=function(t){this.id=t.id,this.value=new Vector3D(t.value.x,t.value.y,t.value.z,t.value.w),this.paramName0=t.paramName0,this.param0Type=t.param0Type,this.param0Index=t.param0Index,this.paramName1=t.paramName1,this.param1Type=t.param1Type,this.param1Index=t.param1Index,this.paramName2=t.paramName2,this.param2Type=t.param2Type,this.param2Index=t.param2Index,this.paramName3=t.paramName3,this.param3Type=t.param3Type,this.param3Index=t.param3Index,this.creat()},t.prototype.setDynamic=function(t){this.paramName0==t.paramName?1==this.param0Type?this.vecNum[this.param0Index]=t.currentValue.x:2==this.param0Type?(this.vecNum[this.param0Index]=t.currentValue.x,this.vecNum[this.param0Index+1]=t.currentValue.y):3==this.param0Type?(this.vecNum[this.param0Index]=t.currentValue.x,this.vecNum[this.param0Index+1]=t.currentValue.y,this.vecNum[this.param0Index+2]=t.currentValue.z):4==this.param0Type&&(this.vecNum[this.param0Index]=t.currentValue.x,this.vecNum[this.param0Index+1]=t.currentValue.y,this.vecNum[this.param0Index+2]=t.currentValue.z,this.vecNum[this.param0Index+3]=t.currentValue.w):this.paramName1==t.paramName?1==this.param1Type?this.vecNum[this.param1Index]=t.currentValue.x:2==this.param1Type?(this.vecNum[this.param1Index]=t.currentValue.x,this.vecNum[this.param1Index+1]=t.currentValue.y):3==this.param1Type?(this.vecNum[this.param1Index]=t.currentValue.x,this.vecNum[this.param1Index+1]=t.currentValue.y,this.vecNum[this.param1Index+2]=t.currentValue.z):4==this.param1Type&&(this.vecNum[this.param1Index]=t.currentValue.x,this.vecNum[this.param1Index+1]=t.currentValue.y,this.vecNum[this.param1Index+2]=t.currentValue.z,this.vecNum[this.param1Index+3]=t.currentValue.w):this.paramName2==t.paramName?1==this.param2Type?this.vecNum[this.param2Index]=t.currentValue.x:2==this.param2Type?(this.vecNum[this.param2Index]=t.currentValue.x,this.vecNum[this.param2Index+1]=t.currentValue.y):3==this.param2Type?(this.vecNum[this.param2Index]=t.currentValue.x,this.vecNum[this.param2Index+1]=t.currentValue.y,this.vecNum[this.param2Index+2]=t.currentValue.z):4==this.param2Type&&(this.vecNum[this.param2Index]=t.currentValue.x,this.vecNum[this.param2Index+1]=t.currentValue.y,this.vecNum[this.param2Index+2]=t.currentValue.z,this.vecNum[this.param2Index+3]=t.currentValue.w):this.paramName3==t.paramName&&(1==this.param3Type?this.vecNum[this.param3Index]=t.currentValue.x:2==this.param3Type?(this.vecNum[this.param3Index]=t.currentValue.x,this.vecNum[this.param3Index+1]=t.currentValue.y):3==this.param3Type?(this.vecNum[this.param3Index]=t.currentValue.x,this.vecNum[this.param3Index+1]=t.currentValue.y,this.vecNum[this.param3Index+2]=t.currentValue.z):4==this.param3Type&&(this.vecNum[this.param3Index]=t.currentValue.x,this.vecNum[this.param3Index+1]=t.currentValue.y,this.vecNum[this.param3Index+2]=t.currentValue.z,this.vecNum[this.param3Index+3]=t.currentValue.w))},t}(),TexItem=function(){function t(){}return Object.defineProperty(t.prototype,"id",{get:function(){return this._id},set:function(t){this._id=t,this.name="fs"+t},enumerable:!0,configurable:!0}),t.LIGHTMAP=1,t.LTUMAP=2,t.CUBEMAP=3,t.HEIGHTMAP=4,t.REFRACTIONMAP=5,t}(),Material=function(){function t(){this.texList=[],this.constList=[],this.killNum=0,this.writeZbuffer=!0}return t.prototype.setCompileData=function(t){if(t){if(this.shaderStr=t.shaderStr,this.hasTime=t.hasTime,this.timeSpeed=t.timeSpeed,this.blendMode=t.blendMode,this.backCull=t.backCull,this.killNum=t.killNum,this.hasVertexColor=t.hasVertexColor,this.usePbr=t.usePbr,this.useNormal=t.useNormal,this.roughness=t.roughness,this.writeZbuffer=t.writeZbuffer,this.hasFresnel=t.hasFresnel,this.useDynamicIBL=t.useDynamicIBL,this.normalScale=t.normalScale,this.lightProbe=t.lightProbe,this.useKill=t.useKill,this.hasParticleColor=!1,t.texList){var e=t.texList;this.texList=[];for(var i=0;e.length>i;i++){var n=new TexItem;n.id=e[i].id,n.url=e[i].url,n.isDynamic=e[i].isDynamic,n.paramName=e[i].paramName,n.isMain=e[i].isMain,n.isParticleColor=e[i].isParticleColor,n.type=e[i].type,n.wrap=e[i].wrap,n.filter=e[i].filter,n.mipmap=e[i].mipmap,this.texList.push(n),n.isParticleColor&&(this.hasParticleColor=!0)}}if(t.constList)for(e=t.constList,this.constList=[],i=0;e.length>i;i++){var a=new ConstItem;a.setData(e[i]),this.constList.push(a)}}},t}(),MaterialManager=function(){function t(){this._dic={},this._loadDic={}}return t.getInstance=function(){return this._instance||(this._instance=new t),this._instance},t.prototype.getMaterial=function(t,e,i,n,a,o){var r=this;if(void 0===i&&(i=null),void 0===n&&(n=!1),void 0===a&&(a=null),void 0===o&&(o=null),this._dic[t])return i?e(this._dic[t],i):e(this._dic[t]),void 0;var s=new MaterialLoad(e,i,t,n,a,o);if(this._loadDic[t]){var h=this._loadDic[t];return h.push(s),void 0}this._loadDic[t]=[],this._loadDic[t].push(s),SceneRes.materialDic[t]?this.loadMaterialCom(SceneRes.materialDic[t],s):LoadManager.getInstance().load(t,LoadManager.XML_TYPE,function(t,e){r.loadMaterialCom(t,e)},s)},t.prototype.loadMaterialCom=function(t,e){var i=JSON.parse(t),n=new Material;n.setCompileData(i),n.url=e.url,this.loadMaterial(n),e.autoReg&&(n.program=ProgrmaManager.getInstance().getMaterialProgram(e.regName,e.shader3D,n,null,!0));for(var a=this._loadDic[e.url],o=0;a.length>o;o++)a[o].info?a[o].fun(n,a[o].info):a[o].fun(n);delete this._loadDic[e.url],this._dic[e.url]=n},t.prototype.loadMaterial=function(t){for(var e=t.texList,i=0;e.length>i;i++)e[i].isParticleColor||e[i].isDynamic||0!=e[i].type||TextureManager.getInstance().getTexture(Scene_data.fileRoot+e[i].url,function(t,e){e.texture=t},e[i].wrap,e[i],e[i].filter,e[i].mipmap)},t.prototype.loadDynamicTexUtil=function(t){for(var e=t.dynamicTexList,i=0;e.length>i;i++)e[i].isParticleColor?e[i].creatTextureByCurve():TextureManager.getInstance().getTexture(Scene_data.fileRoot+e[i].url,function(t,e){e.texture=t},0,e[i],0,1)},t}(),MaterialLoad=function(){function t(t,e,i,n,a,o){this.fun=t,this.info=e,this.url=i,this.autoReg=n,this.regName=a,this.shader3D=o}return t}(),MaterialParam=function(){function t(){}return t.prototype.setMaterial=function(t){this.material=t,this.materialUrl=t.url,this.dynamicTexList=[],this.dynamicConstList=[],this.setTexList(),this.setConstList()},t.prototype.setLife=function(t){for(var e=0;this.dynamicTexList.length>e;e++)this.dynamicTexList[e].isParticleColor&&(this.dynamicTexList[e].life=t)},t.prototype.setTexList=function(){for(var t=this.material.texList,e=0;t.length>e;e++){var i;t[e].isParticleColor?(i=new DynamicTexItem,i.target=t[e],i.paramName=t[e].paramName,i.initCurve(4),this.dynamicTexList.push(i),i.isParticleColor=!0):t[e].isDynamic&&(i=new DynamicTexItem,i.target=t[e],i.paramName=t[e].paramName,this.dynamicTexList.push(i))}},t.prototype.setConstList=function(){for(var t=this.material.constList,e=0;t.length>e;e++){var i,n=t[e];0!=n.param0Type&&(i=new DynamicConstItem,i.target=n,i.paramName=n.paramName0,i.indexID=n.param0Index,i.type=n.param0Type,this.dynamicConstList.push(i)),0!=n.param1Type&&(i=new DynamicConstItem,i.target=n,i.paramName=n.paramName1,i.indexID=n.param1Index,i.type=n.param1Type,this.dynamicConstList.push(i)),0!=n.param2Type&&(i=new DynamicConstItem,i.target=n,i.paramName=n.paramName2,i.indexID=n.param2Index,i.type=n.param2Type,this.dynamicConstList.push(i)),0!=n.param3Type&&(i=new DynamicConstItem,i.target=n,i.paramName=n.paramName3,i.indexID=n.param3Index,i.type=n.param3Type,this.dynamicConstList.push(i))}},t.prototype.setTextObj=function(t){for(var e=0;t.length>e;e++)for(var i=t[e],n=0;this.dynamicTexList.length>n;n++)if(this.dynamicTexList[n].paramName==i.paramName){this.dynamicTexList[n].isParticleColor?this.dynamicTexList[n].curve.setData(i.curve):this.dynamicTexList[n].url=i.url;break}},t.prototype.setConstObj=function(t){for(var e=0;t.length>e;e++)for(var i=t[e],n=0;this.dynamicConstList.length>n;n++)if(this.dynamicConstList[n].paramName==i.paramName){this.dynamicConstList[n].curve.setData(i.curve);break}},t}(),DynamicConstItem=function(){function t(){}return t.prototype.update=function(t){this.currentValue=this.curve.getValue(t),this.target.setDynamic(this)},Object.defineProperty(t.prototype,"type",{get:function(){return this._type},set:function(t){this._type=t,this.curve=new Curve,this.curve.type=t},enumerable:!0,configurable:!0}),t}(),DynamicTexItem=function(){function t(){}return t.prototype.initCurve=function(t){this.curve=new Curve,this.curve.type=t},t.prototype.creatTextureByCurve=function(){for(var t=0,e=this.curve.valueVec[0].length-1,i=[],t=0;this.life>t;t++)if(this.curve.begintFrame>t)i.push(255*this.curve.valueVec[0][0],255*this.curve.valueVec[1][0],255*this.curve.valueVec[2][0],255*this.curve.valueVec[3][0]);else if(t>this.curve.maxFrame)0==this.curve.maxFrame&&0>this.curve.begintFrame?i.push(255,255,255,255):i.push(255*this.curve.valueVec[0][e],255*this.curve.valueVec[1][e],255*this.curve.valueVec[2][e],255*this.curve.valueVec[3][e]);else if(0>this.curve.begintFrame)i.push(255,255,255,255);else{var n=t-this.curve.begintFrame;i.push(255*this.curve.valueVec[0][n],255*this.curve.valueVec[1][n],255*this.curve.valueVec[2][n],255*this.curve.valueVec[3][n])}var a=ColorTransition.getInstance().getImageDataByVec(i,this.life);this.texture=Scene_data.context3D.getTexture(a)},Object.defineProperty(t.prototype,"life",{get:function(){return this._life},set:function(t){this._life=t},enumerable:!0,configurable:!0}),t}(),QuadTreeNode=function(){function t(t,e,i,n){this.x=t,this.y=e,this.width=i,this.height=n,this.pointList=[],this.pointList.push(new Vector2D(this.x,this.y)),this.pointList.push(new Vector2D(this.x+this.width,this.y)),this.pointList.push(new Vector2D(this.x+this.width,this.y+this.height)),this.pointList.push(new Vector2D(this.x,this.y+this.height))}return t.prototype.testCircle=function(t){if(this.testResult(t)&&(this.target&&(this.target.sceneVisible=!0),this.sun))for(var e=0;this.sun.length>e;e++)this.sun[e].testCircle(t)},t.prototype.testResult=function(t){for(var e=0;this.pointList.length>e;e++)if(t.testPoint(this.pointList[e]))return!0;if(t.x>this.x&&t.x<this.x+this.width&&t.y>this.y&&t.y<this.y+this.height)return!0;var i=new Vector2D(t.x,t.y);return this.pointToLine(this.pointList[0],this.pointList[1],i)<t.radius?!0:this.pointToLine(this.pointList[1],this.pointList[2],i)<t.radius?!0:this.pointToLine(this.pointList[2],this.pointList[3],i)<t.radius?!0:this.pointToLine(this.pointList[3],this.pointList[0],i)<t.radius?!0:!1},t.prototype.pointToLine=function(t,e,i){var n,a,o,r=0;if(n=Vector2D.distance(t,e),a=Vector2D.distance(t,i),o=Vector2D.distance(e,i),o+a==n)return r=0;if(1e-5>=n)return r=a;if(o*o>=n*n+a*a)return r=a;if(a*a>=n*n+o*o)return r=o;var s=(n+a+o)/2,h=Math.sqrt(s*(s-n)*(s-a)*(s-o));return r=2*h/n},t}(),SceneQuadTree=function(){function t(){this.needUpdata=!1}return t.prototype.init=function(t,e){this._circle=new Circle,this._sceneDic=e,this._rootNode=this.getNode(t)},t.prototype.getNode=function(t){console.log(t.x,t.y,t.width,t.height);var e=new QuadTreeNode(t.x,t.y,t.width,t.height);if(t.data){e.sun||(e.sun=[]);for(var i=0;t.data.length>i;i++){console.log(t.data[i].x,t.data[i].y,t.data[i].width,t.data[i].height);var n,a=new QuadTreeNode(t.data[i].x,t.data[i].y,t.data[i].width,t.data[i].height);1==t.data[i].type?n="build"+t.data[i].id:11==t.data[i].type&&(n="particle"+t.data[i].id),a.target=this._sceneDic[n],e.sun.push(a)}}if(t.sun){e.sun||(e.sun=[]);for(var i=0;t.sun.length>i;i++)e.sun.push(this.getNode(t.sun[i]))}return e},t.prototype.setCircle=function(t,e,i){var n=t-this._circle.x,a=e-this._circle.y;10>Math.sqrt(n*n+a*a)?this.needUpdata=!1:(this._circle.setData(t,e,i),this.needUpdata=!0)},t.prototype.update=function(){this._rootNode.testCircle(this._circle)},t}(),SceneRes=function(){function t(){this.IMG_TYPE=1,this.OBJS_TYPE=2,this.MATERIAL_TYPE=3,this.PARTICLE_TYPE=4,this.SCENE_TYPE=5}return t.prototype.load=function(e,i,n,a){var o=this;this.imgNum=0,this.imgLoadNum=0,this._imgComplete=!1,this._sceneComplete=!1,this._completeFun=i,this._readDataFun=a,t.imgDic={},t.objAry=[],t.materialDic={},t.particleDic={},LoadManager.getInstance().load(e,LoadManager.BYTE_TYPE,function(t){o.loadComplete(t)},null,n)},t.prototype.loadComplete=function(t){var e=this;this._completeFun(),this._byte=new egret.ByteArray(t),setTimeout(function(){e.read()},300)},t.prototype.read=function(){var t=this._byte.readInt();t==this.IMG_TYPE?this.readImg():t==this.OBJS_TYPE?this.readObj():t==this.MATERIAL_TYPE?this.readMaterial():t==this.PARTICLE_TYPE?this.readParticle():t==this.SCENE_TYPE&&this.readScene()},t.prototype.readImg=function(){var e=this;this.imgNum=this._byte.readInt(),this.imgLoadNum=0;for(var i=TimeUtil.getTimer(),n=0;this.imgNum>n;n++){var a=Scene_data.fileRoot+this._byte.readUTF(),o=this._byte.readInt(),r=new egret.ByteArray;r.length=o,this._byte.readBytes(r,0,o);var s=new Blob([r.buffer],{type:"application/octet-binary"}),h=new Image;t.imgDic[a]=h,h.onload=function(){e.loadImg(a,h)},h.src=URL.createObjectURL(s)}console.log("img time",TimeUtil.getTimer()-i),this.read()},t.prototype.loadImg=function(){this.imgLoadNum++,this.imgLoadNum==this.imgNum&&(this._imgComplete=!0,this.allResCom())},t.prototype.readObj=function(){for(var e=this._byte.readInt(),i=TimeUtil.getTimer(),n=0;e>n;n++){var a=Scene_data.fileRoot+this._byte.readUTF(),o=this._byte.readInt(),r=new egret.ByteArray;r.length=o,this._byte.readBytes(r,0,o),ObjDataManager.getInstance().loadObjCom(r.buffer,a),t.objAry.push(a)}console.log("obj time",TimeUtil.getTimer()-i),this.read()},t.prototype.readMaterial=function(){for(var e=this._byte.readInt(),i=TimeUtil.getTimer(),n=0;e>n;n++){var a=Scene_data.fileRoot+this._byte.readUTF(),o=this._byte.readInt(),r=this._byte.readUTFBytes(o);t.materialDic[a]=r}console.log("material time",TimeUtil.getTimer()-i),this.read()},t.prototype.readParticle=function(){for(var e=this._byte.readInt(),i=TimeUtil.getTimer(),n=0;e>n;n++){var a=Scene_data.fileRoot+this._byte.readUTF(),o=this._byte.readInt(),r=this._byte.readUTFBytes(o);t.particleDic[a]=r}console.log("particle time",TimeUtil.getTimer()-i),this.read()},t.prototype.readScene=function(){var t=this._byte.readInt();this._sceneData=this._byte.readUTFBytes(t),this._sceneComplete=!0,this.allResCom()},t.prototype.allResCom=function(){this._sceneComplete&&this._imgComplete&&this._readDataFun(this._sceneData)},t.imgDic={},t.objAry=[],t.materialDic={},t.particleDic={},t}(),SceneManager=function(){function t(){this._displayList=[],this._displayRoleList=[],this._sceneParticleList=[],this._time=TimeUtil.getTimer(),this._sceneLoader=new SceneRes,this._sceneDic={};var t=new BuildShader;ProgrmaManager.getInstance().registe(BuildShader.buildShader,t);var e=new SkyShader;ProgrmaManager.getInstance().registe(SkyShader.Sky_Shader,e),ProgrmaManager.getInstance().registe(LineDisplayShader.LineShader,new LineDisplayShader),this.initScene()}return t.getInstance=function(){return this._instance||(this._instance=new t),this._instance},t.prototype.clearScene=function(){for(var t=0;this._displayList.length>t;t++)this._displayList[t].removeStage();this._displayList.length=0;for(var t=0;this._sceneParticleList.length>t;t++)ParticleManager.getInstance().removeParticle(this._sceneParticleList[t]);this._sceneParticleList.length=0,LightProbeManager.getInstance().clear(),Physics.removeAll()},t.prototype.loadScene=function(t,e,i,n,a){var o=this;void 0===a&&(a=null),this.clearScene(),a&&this.addSceneImgBg(a),Physics.ready=!1,this._ready=!1;var r=Scene_data.fileRoot+t;this._sceneLoader.load(r,e,i,function(t){o.loadSceneConfigCom(t),n()})},t.prototype.addSceneImgBg=function(t){var e=new Display3dBg;e.setImgInfo(t.url,t.width,t.height),this.addDisplay(e)},t.prototype.loadSceneConfigCom=function(t){for(var e=JSON.parse(t),i=e.buildItem,n=0;i.length>n;n++){var a=i[n];if(1==a.type){var o=this.getBuildSprite(a);this.addDisplay(o)}else if(11==a.type){var r=this.getParticleSprite(a);ParticleManager.getInstance().addParticle(r),this._sceneParticleList.push(r)}}LightProbeManager.getInstance().setLightProbeData(e.lightProbeItem),Physics.makeFieldForArr(e.fieldVo.data,2*(e.fieldVo.sizeNum/50)),Physics.makeSceneCollision(e.sceneCollisionItem),Physics.ready=!0,this._ready=!0,e.quadTreeData?(this._sceneQuadTree=new SceneQuadTree,this._sceneQuadTree.init(e.quadTreeData,this._sceneDic)):this._sceneQuadTree=null},Object.defineProperty(t.prototype,"ready",{set:function(){this._ready=!0},enumerable:!0,configurable:!0}),t.prototype.getBuildSprite=function(t){var e=new Display3DSprite;return e.setObjUrl(t.objsurl),e.setMaterialUrl(t.materialurl),e.setLightMapUrl(t.lighturl),e.scaleX=t.scaleX,e.scaleY=t.scaleY,e.scaleZ=t.scaleZ,e.x=t.x,e.y=t.y,e.z=t.z,e.rotationX=t.rotationX,e.rotationY=t.rotationY,e.rotationZ=t.rotationZ,this._sceneDic["build"+t.id]=e,e},t.prototype.getParticleSprite=function(t){var e=ParticleManager.getInstance().getParticle(t.url);return e.scaleX=t.scaleX,e.scaleY=t.scaleY,e.scaleZ=t.scaleZ,e.x=t.x,e.y=t.y,e.z=t.z,e.rotationX=t.rotationX,e.rotationY=t.rotationY,e.rotationZ=t.rotationZ,this._sceneDic["particle"+t.id]=e,e},t.prototype.initScene=function(){},t.prototype.addDisplay=function(t){this._displayList.push(t),t.addStage()},t.prototype.addMovieDisplay=function(t){this._displayRoleList.push(t)},t.prototype.update=function(){if(0==Scene_data.user&&MathClass.getCamView(Scene_data.cam3D,Scene_data.focus3D),this._sceneQuadTree&&(this._sceneQuadTree.setCircle(Scene_data.focus3D.x,Scene_data.focus3D.z,200),this._sceneQuadTree.needUpdata)){for(var t in this._sceneDic)this._sceneDic[t].sceneVisible=!1;this._sceneQuadTree.update()}Scene_data.context3D.update(),Scene_data.context3D.setDepthTest(!0),this._ready&&(this.updateStaticDiplay(),this.updateMovieDisplay(),ParticleManager.getInstance().updateTime(),SkillManager.getInstance().update(),Scene_data.context3D.setWriteDepth(!1),0==Scene_data.user&&ShadowManager.getInstance().update(),ParticleManager.getInstance().update()),Scene_data.context3D.setDepthTest(!1),UIManager.getInstance().update()},t.prototype.updateStaticDiplay=function(){for(var t=0,e=0;this._displayList.length>e;e++)this._displayList[e].update(),this._displayList[e].sceneVisible&&t++;FpsMc.tipStr="drawNum:"+t+"/"+this._displayList.length},t.prototype.updateMovieDisplay=function(){var t=TimeUtil.getTimer(),e=t-this._time;this._time=t;for(var i=0;this._displayRoleList.length>i;i++)this._displayRoleList[i].updateFrame(e),this._displayRoleList[i].update()},t}(),SkillManager=function(){function t(){this._time=0,this._resDic={},this._skillDic={},this._skillAry=[]}return t.getInstance=function(){return this._instance||(this._instance=new t),this._instance},t.prototype.update=function(){for(var t=TimeUtil.getTimer(),e=t-this._time,i=0;this._skillAry.length>i;i++)this._skillAry[i].update(e);this._time=t},t.prototype.preLoadSkill=function(t,e){var i=this;LoadManager.getInstance().load(Scene_data.fileRoot+t,LoadManager.XML_TYPE,function(n){var a=JSON.parse(n);i._resDic[t]=a;for(var o=0;e.length>o;o++)i.getSkill(t,e[o]).isDeath=!0})},t.prototype.getSkill=function(t,e){var i,n=this,a=t+e,o=this._skillDic[a];if(o)for(var r=0;o.length>r;r++)if(i=o[r],i.isDeath)return i.reset(),i.isDeath=!1,i;return i=new Skill,i.name=e,this._resDic[t]?i.setData(this._resDic[t][e]):LoadManager.getInstance().load(Scene_data.fileRoot+t,LoadManager.XML_TYPE,function(e){n.loadResSkillCom(e,i,t)}),i.isDeath=!1,this._skillDic[a]||(this._skillDic[a]=[]),this._skillDic[a].push(i),i},t.prototype.playSkill=function(t){this._skillAry.push(t),t.play()},t.prototype.removeSkill=function(t){var e=this._skillAry.indexOf(t);-1!=e&&this._skillAry.splice(e,1)},t.prototype.loadResSkillCom=function(t,e,i){var n=JSON.parse(t);this._resDic[i]=n,e.setData(n[e.name])},t}(),Skill=function(){function t(){this.isDeath=!0,this.time=0,this.targetFlag=0}return t.prototype.setData=function(t){this.skillVo=new SkillVo,this.skillVo.setData(t),this.setKeyAry()},t.prototype.play=function(){this.skillVo&&this.active&&this.active instanceof Display3dMovie&&this.active.play(this.skillVo.action,2)},t.prototype.setKeyAry=function(){var t=this;if(this.keyAry=[],this.skillVo.types==SkillType.FixEffect)for(var e=0;this.skillVo.keyAry.length>e;e++){var i=new SkillFixEffect;i.setInfo(this.skillVo.keyAry[e]),i.removeCallFun=function(e){t.removeKey(e)},i.active=this.active,this.keyAry.push(i)}},t.prototype.removeKey=function(){this.completeNum++,this.completeNum==this.keyAry.length&&(console.log("播放结束"),this.skillComplete())},t.prototype.skillComplete=function(){SkillManager.getInstance().removeSkill(this),this.isDeath=!0,this.completeFun&&this.completeFun()},t.prototype.reset=function(){this.time=0,this.completeNum=0,this.active=null,this.completeFun=null,this.targetFlag=0},t.prototype.update=function(e){this.time+=e,this.time>t.MaxTime&&(console.log("超时结束"),this.skillComplete()),this.getKeyTarget()},t.prototype.getKeyTarget=function(){if(this.keyAry)for(var t=this.targetFlag;this.keyAry.length>t&&this.keyAry[t].time<this.time;)this.keyAry[t].addToRender(),t++,this.targetFlag=t},t.prototype.configFixEffect=function(t,e){if(void 0===e&&(e=null),this.active=t,this.completeFun=e,this.keyAry)for(var i=0;this.keyAry.length>i;i++)if(this.skillVo.types==SkillType.FixEffect){var n=this.keyAry[i];n.active=t}},t.MaxTime=3e3,t}(),SkillVo=function(){function t(){}return t.prototype.setData=function(t){this.keyAry=[],this.action=t.action,this.types=t.type,this.types==SkillType.FixEffect&&(this.keyAry=this.getFixEffect(t.data))},t.prototype.getFixEffect=function(t){for(var e=[],i=0;t.length>i;i++){var n=new SkillFixEffectKeyVo;n.setData(t[i]),e.push(n)}return e},t}(),SkillType=function(){function t(){}return t.FixEffect=4,t}(),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},SkillKeyVo=function(){function t(){this.frame=0}return t.prototype.setData=function(t){this.frame=t.frame,this.url=t.url},t}(),SkillFixEffectKeyVo=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.setData=function(e){t.prototype.setData.call(this,e),this.pos=new Vector3D(e.pos.x,e.pos.y,e.pos.z),this.rotation=new Vector3D(e.rotation.x,e.rotation.y,e.rotation.z)
},e}(SkillKeyVo),SkillKey=function(){function t(){this.time=0}return t.prototype.addToRender=function(){this.particle&&(this.particle.reset(),ParticleManager.getInstance().addParticle(this.particle))},t.prototype.setInfo=function(t){this.time=t.frame*Scene_data.frameTime,this.particle=ParticleManager.getInstance().getParticle(t.url)},t.prototype.reset=function(){this.time=0,this.particle.reset(),ParticleManager.getInstance().removeParticle(this.particle)},t}(),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},SkillEffect=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.addToRender=function(){t.prototype.addToRender.call(this),this.particle.addEventListener(BaseEvent.COMPLETE,this.onPlayCom,this)},e.prototype.onPlayCom=function(t){void 0===t&&(t=null),this.particle.removeEventListener(BaseEvent.COMPLETE,this.onPlayCom,this),ParticleManager.getInstance().removeParticle(this.particle),this.removeCallFun(this)},e}(SkillKey),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},SkillFixEffect=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.setInfo=function(e){t.prototype.setInfo.call(this,e);var i=e;this.pos=i.pos,this.rotation=i.rotation},e.prototype.addToRender=function(){t.prototype.addToRender.call(this);var e=new Matrix3D;e.appendRotation(this.active.rotationY,Vector3D.Y_AXIS);var i=e.transformVector(this.pos);i.x+=this.active.x,i.y+=this.active.y,i.z+=this.active.z,this.particle.x=i.x,this.particle.y=i.y,this.particle.z=i.z,this.particle.rotationX=this.rotation.x,this.particle.rotationY=this.rotation.y+this.active.rotationY,this.particle.rotationZ=this.rotation.z},e}(SkillEffect),Dictionary=function(){function t(t){this._keys=[],this._values=[];for(var e=0;t.length>e;e++)this[t[e].key]=t[e].value,this._keys.push(t[e].key),this._values.push(t[e].value)}return t.prototype.add=function(t,e){this[t]=e,this._keys.push(t),this._values.push(e)},t.prototype.remove=function(t){var e=this._keys.indexOf(t,0);this._keys.splice(e,1),this._values.splice(e,1),delete this[t]},t.prototype.keys=function(){return this._keys},t.prototype.values=function(){return this._values},t.prototype.containsKey=function(t){return this[t]===void 0?!1:!0},t.prototype.toLookup=function(){return this},t}(),LoadManager=function(){function t(){this._loadThreadList=[],this._waitLoadList=[];for(var t=0;5>t;t++)this._loadThreadList.push(new LoaderThread)}return t.getInstance=function(){return this._instance||(this._instance=new t),this._instance},t.prototype.load=function(t,e,i,n,a){void 0===n&&(n=null),void 0===a&&(a=null);for(var o=new LoadInfo(t,e,i,n,a),r=0;this._loadThreadList.length>r;r++)if(this._loadThreadList[r].idle)return this._loadThreadList[r].load(o),void 0;this._waitLoadList.push(o)},t.prototype.loadWaitList=function(){if(!(0>=this._waitLoadList.length))for(var t=0;this._loadThreadList.length>t;t++)if(this._loadThreadList[t].idle)return this._loadThreadList[t].load(this._waitLoadList.shift()),void 0},t.BYTE_TYPE="BYTE_TYPE",t.IMG_TYPE="IMG_TYPE",t.XML_TYPE="XML_TYPE",t}(),LoaderThread=function(){function t(){var t=this;this._xhr=new XMLHttpRequest,this._xhr.onreadystatechange=function(){200==t._xhr.status&&4==t._xhr.readyState&&t.loadByteXML()},this._xhr.onprogress=function(e){t._loadInfo.progressFun&&t._loadInfo.progressFun(e.loaded/e.total)},this.idle=!0}return t.prototype.load=function(t){var e=this;this._loadInfo=t,this.idle=!1,this._loadInfo.type==LoadManager.BYTE_TYPE?(this._xhr.open("GET",t.url,!0),this._xhr.responseType="arraybuffer",this._xhr.send()):this._loadInfo.type==LoadManager.XML_TYPE?(this._xhr.open("GET",t.url,!0),this._xhr.responseType="text",this._xhr.send()):this._loadInfo.type==LoadManager.IMG_TYPE&&(this._img=new Image,this._img.onload=function(){e.loadImg()},this._img.src=t.url)},t.prototype.loadByteXML=function(){this._loadInfo.info?this._loadInfo.fun(this._xhr.response,this._loadInfo.info):this._loadInfo.fun(this._xhr.response),this.idle=!0,LoadManager.getInstance().loadWaitList()},t.prototype.loadByteImg=function(){var t=new Blob([this._xhr.response],{type:"application/octet-binary"});this._img.src=URL.createObjectURL(t)},t.prototype.loadImg=function(){this._loadInfo.info?this._loadInfo.fun(this._img,this._loadInfo.info):this._loadInfo.fun(this._img),this.idle=!0,LoadManager.getInstance().loadWaitList()},t}(),LoadInfo=function(){function t(t,e,i,n,a){void 0===n&&(n=null),void 0===a&&(a=null),this.url=t,this.type=e,this.fun=i,this.info=n,this.progressFun=a}return t}(),ObjDataManager=function(){function t(){this._dic={},this._loadList={}}return t.getInstance=function(){return this._instance||(this._instance=new t),this._instance},t.prototype.getObjData=function(t,e){var i=this;if(this._dic[t])return e(this._dic[t]),void 0;var n;this._loadList[t]||(this._loadList[t]=[],LoadManager.getInstance().load(t,LoadManager.BYTE_TYPE,function(e){i.loadObjCom(e,t)})),n=this._loadList[t],n.push(e)},t.prototype.loadObjCom=function(t,e){var i=new ObjData,n=new egret.ByteArray(t);n.readUTF();for(var a=n.readInt(),o=0;a>o;o++)i.vertices.push(n.readFloat());for(var r=n.readInt(),o=0;r>o;o++)i.uvs.push(n.readFloat());for(var s=n.readInt(),o=0;s>o;o++)i.lightuvs.push(n.readFloat());for(var h=n.readInt(),o=0;h>o;o++)i.normals.push(n.readFloat());for(var c=n.readInt(),o=0;c>o;o++)i.indexs.push(n.readInt());for(var l=n.readInt(),o=0;l>o;o++)i.tangents.push(n.readFloat());for(var p=n.readInt(),o=0;p>o;o++)i.bitangents.push(n.readFloat());if(n.position<n.length){var u=n.readInt();i.collision=new CollisionItemVo,i.collision.collisionItem=[];for(var o=0;u>o;o++){var d=new CollisionVo;switch(d.name=n.readUTF(),d.type=n.readInt(),d.x=n.readFloat(),d.y=n.readFloat(),d.z=n.readFloat(),d.rotationX=n.readFloat(),d.rotationY=n.readFloat(),d.rotationZ=n.readFloat(),d.type){case CollisionType.Polygon:d.scaleX=n.readFloat(),d.scaleY=n.readFloat(),d.scaleZ=n.readFloat();var m=n.readBoolean();if(m){d.data={},d.data.vertices=[],d.data.indexs=[];for(var f=n.readInt(),y=0;f>y;y++)d.data.vertices.push(n.readFloat());for(var v=n.readInt(),x=0;v>x;x++)d.data.indexs.push(n.readInt())}break;case CollisionType.BOX:d.scaleX=n.readFloat(),d.scaleY=n.readFloat(),d.scaleZ=n.readFloat();break;case CollisionType.Cylinder:d.scaleX=n.readFloat(),d.scaleY=n.readFloat(),d.scaleZ=n.readFloat();break;case CollisionType.Cone:d.scaleX=n.readFloat(),d.scaleY=n.readFloat(),d.scaleZ=n.readFloat();break;case CollisionType.BALL:d.radius=n.readFloat();break;default:}i.collision.collisionItem.push(d)}n.position<n.length&&(i.collision.friction=n.readFloat(),i.collision.restitution=n.readFloat(),i.collision.isField=n.readBoolean())}i.treNum=c,i.vertexBuffer=Scene_data.context3D.uploadBuff3D(i.vertices),i.uvBuffer=Scene_data.context3D.uploadBuff3D(i.uvs),i.lightUvBuffer=Scene_data.context3D.uploadBuff3D(i.lightuvs),i.normalsBuffer=Scene_data.context3D.uploadBuff3D(i.normals),i.indexBuffer=Scene_data.context3D.uploadIndexBuff3D(i.indexs),this._dic[e]=i;var g=this._loadList[e];if(g){for(var o=0;g.length>o;o++)g[o](i);delete this._loadList[e]}return i},t.prototype.creatTBNBuffer=function(t){t.tangentBuffer=Scene_data.context3D.uploadBuff3D(t.tangents),t.bitangentBuffer=Scene_data.context3D.uploadBuff3D(t.bitangents)},t}(),MeshDataManager=function(){function t(){this._dic={}}return t.getInstance=function(){return this._instance||(this._instance=new t),this._instance},t.prototype.getMeshData=function(t,e){var i,n=this;return this._dic[t]?(e(this._dic[t]),void 0):(i=new SkinMesh,LoadManager.getInstance().load(t,LoadManager.BYTE_TYPE,function(e,a){n.loadObjCom(e,a,i),n._dic[t]=i},e),void 0)},t.prototype.loadObjCom=function(t,e,i){var n=new egret.ByteArray(t);i.fileScale=n.readFloat();for(var a=n.readInt(),o=0;a>o;o++){for(var r=new MeshData,s=n.readInt(),h=0;s>h;h++)r.vertices.push(n.readFloat());s=n.readInt();for(var h=0;s>h;h++)r.tangents.push(n.readFloat());s=n.readInt();for(var h=0;s>h;h++)r.bitangents.push(n.readFloat());s=n.readInt();for(var h=0;s>h;h++)r.normals.push(n.readFloat());s=n.readInt();for(var h=0;s>h;h++)r.uvs.push(n.readFloat());s=n.readInt();for(var h=0;s>h;h++)r.bonetIDAry.push(n.readFloat());s=n.readInt();for(var h=0;s>h;h++)r.boneWeightAry.push(n.readFloat());s=n.readInt();for(var h=0;s>h;h++)r.indexs.push(n.readInt());r.treNum=s,s=n.readInt();for(var h=0;s>h;h++)r.boneNewIDAry.push(n.readInt());r.materialUrl=n.readUTF();for(var c=n.readInt(),h=0;c>h;h++){var l=new BindParticle(n.readUTF(),n.readUTF());r.particleAry.push(l)}this.uploadMesh(r),i.addMesh(r)}for(var p=n.readInt(),u=[],h=0;p>h;h++){var d=[n.readFloat(),n.readFloat(),n.readFloat(),n.readFloat(),n.readFloat(),n.readFloat()];u.push(d)}this.getBindPosMatrix(u,i);var m=n.readInt();i.boneSocketDic={};for(var h=0;m>h;h++){var f=new BoneSocketData;f.name=n.readUTF(),f.boneName=n.readUTF(),f.index=n.readInt(),f.x=n.readFloat(),f.y=n.readFloat(),f.z=n.readFloat(),f.rotationX=n.readFloat(),f.rotationY=n.readFloat(),f.rotationZ=n.readFloat(),i.boneSocketDic[f.name]=f}e(i)},t.prototype.getBindPosMatrix=function(t,e){for(var i=[],n=[],a=0;t.length>a;a++){var o=t[a],r=new Quaternion(o[0],o[1],o[2]);r.setMd5W();var s=r.toMatrix3D();s.appendTranslation(o[3],o[4],o[5]),n.push(s.clone()),s.invert(),i.push(s)}e.bindPosMatrixAry=i,e.bindPosInvertMatrixAry=n},t.prototype.uploadMesh=function(t){t.vertexBuffer=Scene_data.context3D.uploadBuff3D(t.vertices),t.uvBuffer=Scene_data.context3D.uploadBuff3D(t.uvs),t.boneIdBuffer=Scene_data.context3D.uploadBuff3D(t.bonetIDAry),t.boneWeightBuffer=Scene_data.context3D.uploadBuff3D(t.boneWeightAry),t.indexBuffer=Scene_data.context3D.uploadIndexBuff3D(t.indexs)},t.prototype.uploadPbrMesh=function(t,e){t.normalsBuffer=Scene_data.context3D.uploadBuff3D(t.normals),e&&(t.tangentBuffer=Scene_data.context3D.uploadBuff3D(t.tangents),t.bitangentBuffer=Scene_data.context3D.uploadBuff3D(t.bitangents))},t.prototype.preLoad=function(t){this.getMeshData(t,function(t){t.loadMaterial()})},t}(),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},AnimManager=function(){function t(){this._dic={}}return t.getInstance=function(){return this._instance||(this._instance=new t),this._instance},t.prototype.getAnimData=function(t,e){var i=this;LoadManager.getInstance().load(t,LoadManager.BYTE_TYPE,function(e,n){i.loadObjCom(e,n,t)},e)},t.prototype.loadObjCom=function(t,e){var i=[],n=[],a=new egret.ByteArray(t),o=new AnimData;o.inLoop=a.readInt();for(var r=a.readInt(),s=0;r>s;s++)o.inter.push(a.readInt());r=a.readInt();for(var s=0;r>s;s++)o.bounds.push(new Vector3D(a.readFloat(),a.readFloat(),a.readFloat()));o.nameHeight=a.readInt(),r=a.readInt();for(var s=0;r>s;s++){var h=new ObjectBone;h.father=a.readInt(),h.changtype=a.readInt(),h.startIndex=a.readInt(),h.tx=a.readFloat(),h.ty=a.readFloat(),h.tz=a.readFloat(),h.qx=a.readFloat(),h.qy=a.readFloat(),h.qz=a.readFloat(),i.push(h)}r=a.readInt();for(var s=0;r>s;s++){var c=a.readInt(),l=[];n.push(l);for(var p=0;c>p;p++)l.push(a.readFloat())}r=a.readInt();for(var s=0;r>s;s++)o.posAry.push(new Vector3D(a.readFloat(),a.readFloat(),a.readFloat()));o.matrixAry=this.processFrame(n,i),e(o)},t.prototype.processFrame=function(t,e){for(var i=[],n=0;t.length>n;n++)i.push(this.frameToBone(t[n],e));return this.setFrameToMatrix(i)},t.prototype.frameToBone=function(t,e){for(var i=[],n=0;e.length>n;n++){var a=new ObjectBaseBone;a.father=e[n].father;var o=0;1&e[n].changtype?(a.tx=t[e[n].startIndex+o],++o):a.tx=e[n].tx,2&e[n].changtype?(a.ty=t[e[n].startIndex+o],++o):a.ty=e[n].ty,4&e[n].changtype?(a.tz=t[e[n].startIndex+o],++o):a.tz=e[n].tz,8&e[n].changtype?(a.qx=t[e[n].startIndex+o],++o):a.qx=e[n].qx,16&e[n].changtype?(a.qy=t[e[n].startIndex+o],++o):a.qy=e[n].qy,32&e[n].changtype?(a.qz=t[e[n].startIndex+o],++o):a.qz=e[n].qz,i.push(a)}return i},t.prototype.setFrameToMatrix=function(t){for(var e=[],i=0;t.length>i;i++){var n=t[i],a=new Quaternion,o=new Matrix3D,r=[];e.push(r);for(var s=0;n.length>s;s++){var h=n[s];a=new Quaternion(h.qx,h.qy,h.qz),a.w=this.getW(a.x,a.y,a.z),-1==h.father?(o=a.toMatrix3D(),o.appendTranslation(h.tx,h.ty,h.tz),o.appendRotation(-90,Vector3D.X_AXIS),r.push(o)):(n[h.father],o=a.toMatrix3D(),o.appendTranslation(h.tx,h.ty,h.tz),o.append(r[h.father]),r.push(o))}for(s=0;r.length>s;s++)r[s].appendScale(-1,1,1)}return e},t.prototype.getW=function(t,e,i){var n=1-(t*t+e*e+i*i);return n=0>n?0:-Math.sqrt(n)},t}(),ObjectBaseBone=function(){function t(){}return t}(),ObjectBone=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e}(ObjectBaseBone),LightProbeManager=function(){function t(){this._defaultVec=[];for(var t=[.4444730390920146,-.3834955622240026,-.33124467509627725,.09365654209093091,-.05673310882817577,.2120523322966496,.02945768486978205,-.04965996229802928,-.1136529129285836],e=0;9>e;e++)this._defaultVec.push(new Vector3D(t[e],t[e],t[e]))}return t.getInstance=function(){return this._instance||(this._instance=new t),this._instance},t.prototype.setLightProbeData=function(t){this._dataAry=t},t.prototype.clear=function(){this._dataAry=null},t.prototype.getData=function(t){if(!this._dataAry)return this._defaultVec;for(var e=0;this._dataAry.length>e;e++){var i=this._dataAry[e];if(this.testPoint(i,t)){var n=i.postion,a=t.subtract(n);return this.getResultData(i.posItem,float2int(a.x/i.betweenNum),float2int(a.z/i.betweenNum),float2int(a.y/i.betweenNum),i.betweenNum,a)}}return this._defaultVec},t.prototype.testPoint=function(t,e){var i=(t.cubeVec.x-1)*t.betweenNum,n=(t.cubeVec.y-1)*t.betweenNum,a=(t.cubeVec.z-1)*t.betweenNum,o=e.x-t.postion.x,r=e.y-t.postion.y,s=e.z-t.postion.z;return o>=0&&i>o&&r>=0&&n>r&&s>=0&&a>s?!0:!1},t.prototype.getResultData=function(t,e,i,n,a,o){var r=[];r.push(new PosItem(t[e][i][n],o)),r.push(new PosItem(t[e+1][i][n],o)),r.push(new PosItem(t[e][i+1][n],o)),r.push(new PosItem(t[e+1][i+1][n],o)),r.push(new PosItem(t[e][i][n+1],o)),r.push(new PosItem(t[e+1][i][n+1],o)),r.push(new PosItem(t[e][i+1][n+1],o)),r.push(new PosItem(t[e+1][i+1][n+1],o));for(var s=0,h=0;r.length>h;h++)s+=r[h].dis;for(h=0;r.length>h;h++)r[h].setBais(s);var c=0;for(h=0;r.length>h;h++)c+=r[h].bais;for(h=0;r.length>h;h++)r[h].bais=r[h].bais/c;var l=[];for(h=0;9>h;h++){for(var p=new Vector3D,u=0;r.length>u;u++){var d=new Vector3D(r[u].vecNum[h].x,r[u].vecNum[h].y,r[u].vecNum[h].z);d.scaleBy(r[u].bais),p=p.add(d)}l.push(p)}return l},t}(),PosItem=function(){function t(t,e){this.pos=new Vector3D(t.x,t.y,t.z),this.vecNum=t.resultSHVec,this.dis=Vector3D.distance(this.pos,e)}return t.prototype.setBais=function(t){this.bais=this.dis/t*(this.dis/t),this.bais=1/this.bais},t}(),egret;(function(t){var e=function(){function t(){}return t.LITTLE_ENDIAN="littleEndian",t.BIG_ENDIAN="bigEndian",t}();t.Endian=e;var i=function(){function t(t){this.BUFFER_EXT_SIZE=0,this.EOF_byte=-1,this.EOF_code_point=-1,this._setArrayBuffer(t||new ArrayBuffer(this.BUFFER_EXT_SIZE)),this.endian=e.BIG_ENDIAN}return t.prototype._setArrayBuffer=function(t){this.write_position=t.byteLength,this.data=new DataView(t),this._position=0},Object.defineProperty(t.prototype,"buffer",{get:function(){return this.data.buffer},set:function(t){this.data=new DataView(t)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"dataView",{get:function(){return this.data},set:function(t){this.data=t,this.write_position=t.byteLength},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"bufferOffset",{get:function(){return this.data.byteOffset},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"position",{get:function(){return this._position},set:function(t){this._position=t,this.write_position=t>this.write_position?t:this.write_position},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"length",{get:function(){return this.write_position},set:function(t){this.validateBuffer(t,!0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"bytesAvailable",{get:function(){return this.data.byteLength-this._position},enumerable:!0,configurable:!0}),t.prototype.clear=function(){this._setArrayBuffer(new ArrayBuffer(this.BUFFER_EXT_SIZE))},t.prototype.readBoolean=function(){return 0!=this.data.getUint8(this.position++)},t.prototype.readByte=function(){return this.data.getInt8(this.position++)},t.prototype.readBytes=function(t,e,i){void 0===e&&(e=0),void 0===i&&(i=0);for(var n=0;i>n;n++)t.data.setUint8(n+e,this.data.getUint8(this.position++))},t.prototype.readDouble=function(){var i=this.data.getFloat64(this.position,this.endian==e.LITTLE_ENDIAN);return this.position+=t.SIZE_OF_FLOAT64,i},t.prototype.readFloat=function(){var i=this.data.getFloat32(this.position,this.endian==e.LITTLE_ENDIAN);return this.position+=t.SIZE_OF_FLOAT32,i},t.prototype.readInt=function(){var i=this.data.getInt32(this.position,this.endian==e.LITTLE_ENDIAN);return this.position+=t.SIZE_OF_INT32,i},t.prototype.readShort=function(){var i=this.data.getInt16(this.position,this.endian==e.LITTLE_ENDIAN);return this.position+=t.SIZE_OF_INT16,i},t.prototype.readUnsignedByte=function(){return this.data.getUint8(this.position++)},t.prototype.readUnsignedInt=function(){var i=this.data.getUint32(this.position,this.endian==e.LITTLE_ENDIAN);return this.position+=t.SIZE_OF_UINT32,i},t.prototype.readUnsignedShort=function(){var i=this.data.getUint16(this.position,this.endian==e.LITTLE_ENDIAN);return this.position+=t.SIZE_OF_UINT16,i},t.prototype.readUTF=function(){var i=this.data.getUint16(this.position,this.endian==e.LITTLE_ENDIAN);return this.position+=t.SIZE_OF_UINT16,i>0?this.readUTFBytes(i):""},t.prototype.readUTFBytes=function(t){var e=new Uint8Array(this.buffer,this.bufferOffset+this.position,t);return this.position+=t,this.decodeUTF8(e)},t.prototype.writeBoolean=function(e){this.validateBuffer(t.SIZE_OF_BOOLEAN),this.data.setUint8(this.position++,e?1:0)},t.prototype.writeByte=function(e){this.validateBuffer(t.SIZE_OF_INT8),this.data.setInt8(this.position++,e)},t.prototype.writeBytes=function(t,e,i){void 0===e&&(e=0),void 0===i&&(i=0);var n;if(!(0>e)&&!(0>i)&&(n=0==i?t.length-e:Math.min(t.length-e,i),n>0)){this.validateBuffer(n);for(var a=new DataView(t.buffer),o=e;n+e>o;o++)this.data.setUint8(this.position++,a.getUint8(o))}},t.prototype.writeDouble=function(i){this.validateBuffer(t.SIZE_OF_FLOAT64),this.data.setFloat64(this.position,i,this.endian==e.LITTLE_ENDIAN),this.position+=t.SIZE_OF_FLOAT64},t.prototype.writeFloat=function(i){this.validateBuffer(t.SIZE_OF_FLOAT32),this.data.setFloat32(this.position,i,this.endian==e.LITTLE_ENDIAN),this.position+=t.SIZE_OF_FLOAT32},t.prototype.writeInt=function(i){this.validateBuffer(t.SIZE_OF_INT32),this.data.setInt32(this.position,i,this.endian==e.LITTLE_ENDIAN),this.position+=t.SIZE_OF_INT32},t.prototype.writeShort=function(i){this.validateBuffer(t.SIZE_OF_INT16),this.data.setInt16(this.position,i,this.endian==e.LITTLE_ENDIAN),this.position+=t.SIZE_OF_INT16},t.prototype.writeUnsignedInt=function(i){this.validateBuffer(t.SIZE_OF_UINT32),this.data.setUint32(this.position,i,this.endian==e.LITTLE_ENDIAN),this.position+=t.SIZE_OF_UINT32},t.prototype.writeUTF=function(i){var n=this.encodeUTF8(i),a=n.length;this.validateBuffer(t.SIZE_OF_UINT16+a),this.data.setUint16(this.position,a,this.endian===e.LITTLE_ENDIAN),this.position+=t.SIZE_OF_UINT16,this._writeUint8Array(n,!1)},t.prototype.writeUTFBytes=function(t){this._writeUint8Array(this.encodeUTF8(t))},t.prototype.toString=function(){return"[ByteArray] length:"+this.length+", bytesAvailable:"+this.bytesAvailable},t.prototype._writeUint8Array=function(t,e){void 0===e&&(e=!0),e&&this.validateBuffer(this.position+t.length);for(var i=0;t.length>i;i++)this.data.setUint8(this.position++,t[i])},t.prototype.validate=function(t){return this.data.byteLength>0&&this._position+t<=this.data.byteLength?!0:void 0},t.prototype.validateBuffer=function(t,e){if(void 0===e&&(e=!1),this.write_position=t>this.write_position?t:this.write_position,t+=this._position,t>this.data.byteLength||e){var i=new Uint8Array(new ArrayBuffer(t+this.BUFFER_EXT_SIZE)),n=Math.min(this.data.buffer.byteLength,t+this.BUFFER_EXT_SIZE);i.set(new Uint8Array(this.data.buffer,0,n)),this.buffer=i.buffer}},t.prototype.encodeUTF8=function(t){for(var e=0,i=this.stringToCodePoints(t),n=[];i.length>e;){var a=i[e++];if(this.inRange(a,55296,57343))this.encoderError(a);else if(this.inRange(a,0,127))n.push(a);else{var o,r;for(this.inRange(a,128,2047)?(o=1,r=192):this.inRange(a,2048,65535)?(o=2,r=224):this.inRange(a,65536,1114111)&&(o=3,r=240),n.push(this.div(a,Math.pow(64,o))+r);o>0;){var s=this.div(a,Math.pow(64,o-1));n.push(128+s%64),o-=1}}}return new Uint8Array(n)},t.prototype.decodeUTF8=function(t){for(var e,i=!1,n=0,a="",o=0,r=0,s=0,h=0;t.length>n;){var c=t[n++];if(c===this.EOF_byte)e=0!==r?this.decoderError(i):this.EOF_code_point;else if(0===r)this.inRange(c,0,127)?e=c:(this.inRange(c,194,223)?(r=1,h=128,o=c-192):this.inRange(c,224,239)?(r=2,h=2048,o=c-224):this.inRange(c,240,244)?(r=3,h=65536,o=c-240):this.decoderError(i),o*=Math.pow(64,r),e=null);else if(this.inRange(c,128,191))if(s+=1,o+=(c-128)*Math.pow(64,r-s),s!==r)e=null;else{var l=o,p=h;o=0,r=0,s=0,h=0,e=this.inRange(l,p,1114111)&&!this.inRange(l,55296,57343)?l:this.decoderError(i,c)}else o=0,r=0,s=0,h=0,n--,e=this.decoderError(i,c);null!==e&&e!==this.EOF_code_point&&(65535>=e?e>0&&(a+=String.fromCharCode(e)):(e-=65536,a+=String.fromCharCode(55296+(1023&e>>10)),a+=String.fromCharCode(56320+(1023&e))))}return a},t.prototype.encoderError=function(){},t.prototype.decoderError=function(t,e){return e||65533},t.prototype.inRange=function(t,e,i){return t>=e&&i>=t},t.prototype.div=function(t,e){return Math.floor(t/e)},t.prototype.stringToCodePoints=function(t){for(var e=[],i=0,n=t.length;t.length>i;){var a=t.charCodeAt(i);if(this.inRange(a,55296,57343))if(this.inRange(a,56320,57343))e.push(65533);else if(i===n-1)e.push(65533);else{var o=t.charCodeAt(i+1);if(this.inRange(o,56320,57343)){var r=1023&a,s=1023&o;i+=1,e.push(65536+(r<<10)+s)}else e.push(65533)}else e.push(a);i+=1}return e},t.SIZE_OF_BOOLEAN=1,t.SIZE_OF_INT8=1,t.SIZE_OF_INT16=2,t.SIZE_OF_INT32=4,t.SIZE_OF_UINT8=1,t.SIZE_OF_UINT16=2,t.SIZE_OF_UINT32=4,t.SIZE_OF_FLOAT32=4,t.SIZE_OF_FLOAT64=8,t}();t.ByteArray=i})(egret||(egret={}));var MouseType=function(){function t(){}return t.MouseDown="mousedown",t.MouseUp="mouseup",t.MouseMove="mousemove",t.MouseClick="mouseclick",t.KeyDown="keydown",t.KeyUp="keyup",t.MouseWheel="mousewheel",t.TouchStart="touchstart",t.TouchMove="touchmove",t.TouchEnd="touchend",t.TouchClick="touchstart",t}(),KeyControl=function(){function t(){this.speedNum=10,this._keyDic={},this._lostMousePos=new Object3D,this._lastFousce=new Object3D,this._isMouseDown=!1}return Object.defineProperty(t,"instance",{get:function(){return this._instance||(this._instance=new t),this._instance},enumerable:!0,configurable:!0}),t.prototype.init=function(){document.addEventListener(MouseType.MouseDown,this.onMouseDown),document.addEventListener(MouseType.MouseUp,this.onMouseUp),document.addEventListener(MouseType.MouseMove,this.onMouseMove),document.addEventListener(MouseType.KeyDown,this.onKeyDown),document.addEventListener(MouseType.KeyUp,this.onKeyUp)},t.prototype.onMouseMove=function(e){var i=t.instance,n=new Object3D;n.x=e.pageX,n.y=e.pageY,i._isMouseDown&&(Scene_data.cam3D.rotationY=i._lastFousce.rotationY-(n.x-i._lostMousePos.x)/10,Scene_data.cam3D.rotationX=i._lastFousce.rotationX-(n.y-i._lostMousePos.y)/10)},t.prototype.onMouseDown=function(e){var i=t.instance;i._isMouseDown=!0,i._lostMousePos.x=e.pageX,i._lostMousePos.y=e.pageY,i._lastFousce.rotationX=Scene_data.cam3D.rotationX,i._lastFousce.rotationY=Scene_data.cam3D.rotationY},t.prototype.onMouseUp=function(){var e=t.instance;e._isMouseDown=!1},t.prototype.update=function(){var t=this._keyDic;t[65]&&this.tureLeft(),t[83]&&this.tureDown(),t[68]&&this.tureRight(),t[87]&&this.tureUp(),t[81]&&(Scene_data.cam3D.y-=this.speedNum),t[69]&&(Scene_data.cam3D.y+=this.speedNum),MathClass.MathCam(Scene_data.cam3D)},t.prototype.tureLeft=function(){var t=new Vector3D(-this.speedNum,0,0,1);new Matrix3D,this.mathFocus3D(t)},t.prototype.tureRight=function(){var t=new Vector3D(this.speedNum,0,0,1);this.mathFocus3D(t)},t.prototype.tureUp=function(){var t=new Vector3D(0,0,this.speedNum,1);this.mathFocus3D(t)},t.prototype.tureDown=function(){var t=new Vector3D(0,0,-this.speedNum,1);this.mathFocus3D(t)},t.prototype.mathFocus3D=function(t){var e=new Matrix3D;e.prependRotation(-Scene_data.cam3D.rotationY,Vector3D.Y_AXIS),e.prependRotation(-Scene_data.cam3D.rotationX,Vector3D.X_AXIS),t=e.transformVector(t),Scene_data.cam3D.x+=t.x,Scene_data.cam3D.y+=t.y,Scene_data.cam3D.z+=t.z},t.prototype.onKeyDown=function(e){var i=t.instance._keyDic;i[e.keyCode]=!0,32==e.keyCode},t.prototype.onKeyUp=function(e){var i=t.instance._keyDic;i[e.keyCode]=!1},t}(),TimeUtil=function(){function t(){}return t.getTimer=function(){return Date.now()-t.START_TIME},t.init=function(){t.START_TIME=Date.now()},t}(),ColorTransition=function(){function t(){this._canvas=document.createElement("canvas"),this._cxt=this._canvas.getContext("2d"),this._gnt=this._cxt.createLinearGradient(0,0,128,0),this._canvas.style.zIndex="1"}return t.getInstance=function(){return this._instance||(this._instance=new t),this._instance},t.prototype.getImageData=function(t){for(var e=t.pos.length,i=new Vector3D,n=0;e>n;n++)hexToArgb(t.color[n],!1,i),this._gnt.addColorStop(t.pos[n]/255,"rgba("+i.x+","+i.y+","+i.z+","+t.alpha[n]+")");return this._cxt.fillStyle=this._gnt,this._cxt.fillRect(0,0,128,2),this._cxt.getImageData(0,0,128,2)},t.prototype.getImageDataByVec=function(t,e){for(var i,n,a=this._cxt.createImageData(64,1),o=0;64>o;o++)i=4*o,n=4*float2int(o/64*e),a.data[i]=t[n],a.data[i+1]=t[n+1],a.data[i+2]=t[n+2],a.data[i+3]=t[n+3];return a},t.prototype.setData=function(){},t}(),Curve=function(){function t(){this.valueV3d=new Vector3D(1,1,1,1)}return t.prototype.getValue=function(t){if(!this.valueVec||-1==this.begintFrame)return this.valueV3d;var e=float2int(t/Scene_data.frameTime-this.begintFrame);return 0>e?e=0:e>this.maxFrame-this.begintFrame&&(e=this.maxFrame-this.begintFrame),1==this.type?this.valueV3d.x=this.valueVec[0][e]:2==this.type?(this.valueV3d.x=this.valueVec[0][e],this.valueV3d.y=this.valueVec[1][e]):3==this.type?(this.valueV3d.x=this.valueVec[0][e],this.valueV3d.y=this.valueVec[1][e],this.valueV3d.z=this.valueVec[2][e]):4==this.type&&(this.valueV3d.x=this.valueVec[0][e],this.valueV3d.y=this.valueVec[1][e],this.valueV3d.z=this.valueVec[2][e],this.valueV3d.w=this.valueVec[3][e],this.valueV3d.scaleBy(this.valueV3d.w)),this.valueV3d},t.prototype.setData=function(t){this.type=t.type,this.maxFrame=t.maxFrame,this.begintFrame=t.items.length?t.items[0].frame:-1,this.valueVec=t.values},t}(),Shadow=function(){function t(){this.data=[0,0,0]}return Object.defineProperty(t.prototype,"x",{get:function(){return this.data[0]},set:function(t){this.data[0]=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return this.data[1]},set:function(t){this.data[1]=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"z",{get:function(){return this.data[2]},set:function(t){this.data[2]=t},enumerable:!0,configurable:!0}),t}(),ShadowManager=function(){function t(){this._displayList=[],ProgrmaManager.getInstance().registe(Display3DShadowShader.Display3DShadowShader,new Display3DShadowShader)}return t.getInstance=function(){return this._instance||(this._instance=new t),this._instance},t.prototype.addShadow=function(){var t=this.getIdleShadow(),e=new Shadow;return t.addShadow(e),e},t.prototype.update=function(){for(var t=0;this._displayList.length>t;t++)this._displayList[t].update()},t.prototype.getIdleShadow=function(){for(var t=0;this._displayList.length>t;t++)if(this._displayList[t].hasIdle)return this._displayList[t];var e=new Display3dShadow;return this._displayList.push(e),e},t}(),AnimData=function(){function t(){this.inLoop=0,this.inter=[],this.bounds=[],this.nameHeight=0,this.posAry=[]}return t}(),SkinMesh=function(){function t(){this.meshAry=[],this.fileScale=1}return t.prototype.addMesh=function(t){this.meshAry.push(t)},t.prototype.loadMaterial=function(t){void 0===t&&(t=null);for(var e=0;this.meshAry.length>e;e++)this.loadMeshDataMaterial(this.meshAry[e],t)},t.prototype.loadMeshDataMaterial=function(t,e){void 0===e&&(e=null);var i=Scene_data.fileRoot+t.materialUrl,n=new MaterialAnimShader;MaterialManager.getInstance().getMaterial(i,function(i){t.material=i,i.usePbr?MeshDataManager.getInstance().uploadPbrMesh(t,i.useNormal):i.lightProbe&&MeshDataManager.getInstance().uploadPbrMesh(t,!1),e&&e(i)},null,!0,n.name,n)},t.prototype.loadParticle=function(t){console.log(t);for(var e=0;this.meshAry.length>e;e++)for(var i=this.meshAry[e].particleAry,n=0;i.length>n;n++){var a=i[n],o=ParticleManager.getInstance().getParticle(a.url);o.bindTarget=t,o.bindSocket=a.socketName,a.particle=o,ParticleManager.getInstance().addParticle(o)}},t}(),BoneSocketData=function(){function t(){}return t}(),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},CollisionVo=function(t){function e(e,i,n){void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0),t.call(this)}return __extends(e,t),e}(Object3D),CollisionItemVo=function(){function t(){}return t}(),CollisionType=function(){function t(){}return t.Polygon=0,t.BOX=1,t.BALL=2,t.Cylinder=3,t.Cone=4,t}(),CapsuleVo=function(){function t(t,e){this.radius=t,this.height=e}return t}(),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},LineDisplayShader=function(t){function e(){t.call(this)}return __extends(e,t),e.prototype.binLocation=function(t){t.bindAttribLocation(this.program,0,"v3Position"),t.bindAttribLocation(this.program,1,"v3Color")},e.prototype.getVertexShaderString=function(){var t="attribute vec3 v3Position;attribute vec3 v3Color;uniform mat4 viewMatrix3D;uniform mat4 camMatrix3D;uniform mat4 posMatrix3D;varying vec4 colorData;void main(void){   vec4 vt0= vec4(v3Position, 1.0);   colorData =vec4(v3Color,1) ;   vt0 = posMatrix3D * vt0;   vt0 = camMatrix3D * vt0;   vt0 = viewMatrix3D * vt0;   gl_Position = vt0;}";return t},e.prototype.getFragmentShaderString=function(){var t=" precision mediump float;\nvarying vec4 colorData;\nvoid main(void)\n{\ngl_FragColor =colorData;\n}";return t},e.LineShader="LineShader",e}(Shader3D),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},LineDisplaySprite=function(t){function e(){t.call(this),this.baseColor=new Vector3D(1,0,0),this.objData=new ObjData,this.program=ProgrmaManager.getInstance().getProgram(LineDisplayShader.LineShader),this.makeLineMode(new Vector3D(0,0,0),new Vector3D(100,0,0),new Vector3D),this.makeLineMode(new Vector3D(0,0,0),new Vector3D(100,0,100),new Vector3D),this.makeLineMode(new Vector3D(100,0,0),new Vector3D(100,0,100),new Vector3D),this.upToGpu()}return __extends(e,t),e.prototype.makeLineMode=function(t,e,i){void 0===i&&(i=null),this.lineVecPos&&this.lineIndex||this.clear(),i&&(this.baseColor=i),this.lineVecPos.push(t.x,t.y,t.z),this.lineVecPos.push(e.x,e.y,e.z),this.lineColor.push(this.baseColor.x,this.baseColor.y,this.baseColor.z),this.lineColor.push(this.baseColor.x,this.baseColor.y,this.baseColor.z),this.lineIndex.push(this.lineIndex.length+0,this.lineIndex.length+1)
},e.prototype.clear=function(){this.lineVecPos=[],this.lineIndex=[],this.lineColor=[],this.objData.indexBuffer&&(this.objData.indexBuffer=null)},e.prototype.upToGpu=function(){this.lineIndex.length&&(this.objData.treNum=this.lineIndex.length,this.objData.vertexBuffer=Scene_data.context3D.uploadBuff3D(this.lineVecPos),this.objData.normalsBuffer=Scene_data.context3D.uploadBuff3D(this.lineColor),this.objData.indexBuffer=Scene_data.context3D.uploadIndexBuff3D(this.lineIndex))},e.prototype.update=function(){this.objData&&this.objData.indexBuffer&&(Scene_data.context3D.setProgram(this.program),Scene_data.context3D.setVcMatrix4fv(this.program,"viewMatrix3D",Scene_data.viewMatrx3D.m),Scene_data.context3D.setVcMatrix4fv(this.program,"camMatrix3D",Scene_data.cam3D.cameraMatrix.m),Scene_data.context3D.setVcMatrix4fv(this.program,"posMatrix3D",this.posMatrix.m),Scene_data.context3D.setVa(0,3,this.objData.vertexBuffer),Scene_data.context3D.setVa(1,3,this.objData.normalsBuffer),Scene_data.context3D.drawLine(this.objData.indexBuffer,this.objData.treNum))},e}(Display3D),GridLineSprite=function(t){function e(){t.call(this),this.makeGridData()}return __extends(e,t),e.prototype.makeGridData=function(){var t=100,e=10,i=t/e;this.clear();var n,a;n=new Vector3D(0,0,+t),a=new Vector3D(0,0,-t),this.makeLineMode(n,a,new Vector3D(0,0,1,1)),n=new Vector3D(+t,0,0),a=new Vector3D(-t,0,0),this.makeLineMode(n,a,new Vector3D(1,0,0,1)),this.baseColor=new Vector3D(128/255,128/255,128/255,1);for(var o=1;e>=o;o++)n=new Vector3D(+o*i,0,+t),a=new Vector3D(+o*i,0,-t),this.makeLineMode(n,a),n=new Vector3D(-o*i,0,+t),a=new Vector3D(-o*i,0,-t),this.makeLineMode(n,a),n=new Vector3D(+t,0,+o*i),a=new Vector3D(-t,0,+o*i),this.makeLineMode(n,a),n=new Vector3D(+t,0,-o*i),a=new Vector3D(-t,0,-o*i),this.makeLineMode(n,a);this.upToGpu()},e}(LineDisplaySprite),Module=function(){function t(){this.processorMap={}}return t.prototype.getModuleName=function(){throw Error("module必须复写命名")},t.prototype.listProcessors=function(){return null},t.prototype.registerProcessors=function(){var t=this.listProcessors();if(null!=t&&t.length>0)for(var e=0;t.length>e;e++)this.registerProcessor(t[e])},t.prototype.registerProcessor=function(t){if(null!=this.processorMap[t.getName()])throw Error("同一Module不能注册两个相同的Processor");this.processorMap[t.getName()]=t,t.registerEvents()},t.registerModule=function(e){if(null!=t.moduleMap[e.getModuleName()])throw Error("不能注册两个相同的Module");t.moduleMap[e.getModuleName()]=e,e.registerProcessors()},t.moduleMap={},t}(),ModuleEventManager=function(){function t(){}return t.addEvents=function(e,i,n){for(var a=0;e.length>a;a++)t._instance.addEventListener(e[a].type,i,n)},t.dispatchEvent=function(e){t._instance.dispatchEvent(e)},t._instance=new EventDispatcher,t}(),Processor=function(){function t(){}return t.prototype.getName=function(){throw Error("process必须复写命名")},t.prototype.receivedModuleEvent=function(){},t.prototype.listenModuleEvents=function(){return null},t.prototype.registerEvents=function(){var t=this.listenModuleEvents();null!=t&&t.length>0&&ModuleEventManager.addEvents(t,this.receivedModuleEvent,this)},t}(),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},BuildDisplay3DShader=function(t){function e(){t.call(this)}return __extends(e,t),e.prototype.binLocation=function(t){t.bindAttribLocation(this.program,0,"v3Pos"),t.bindAttribLocation(this.program,1,"v2uv"),t.bindAttribLocation(this.program,2,"v2uvLight")},e.prototype.getVertexShaderString=function(){var t="attribute vec3 v3Pos;attribute vec2 v2uv;attribute vec2 v2uvLight;uniform mat4 viewMatrix3D;uniform mat4 camMatrix3D;uniform mat4 posMatrix3D;varying vec2 v_texCoord;varying vec2 v_texLight;void main(void){   v_texCoord = vec2(v2uv.x, v2uv.y);   v_texLight = vec2(v2uvLight.x, v2uvLight.y);   vec4 vt0= vec4(v3Pos, 1.0);   vt0 = posMatrix3D * vt0;   vt0 = camMatrix3D * vt0;   vt0 = viewMatrix3D * vt0;   gl_Position = vt0;}";return t},e.prototype.getFragmentShaderString=function(){var t=" precision mediump float;\nuniform sampler2D s_texture;\nuniform sampler2D lightTexture;\nvarying vec2 v_texCoord;\nvarying vec2 v_texLight;\nuniform vec4 mulColorVec;void main(void)\n{\nvec4 infoUv = texture2D(s_texture, v_texCoord.xy);\nvec4 infoLight = texture2D(lightTexture, v_texLight.xy);\nif (infoUv.a <= 0.9) {\n     discard;\n}\nvec4 info= infoUv * infoLight;\ninfo.rgb = info.rgb / 0.2;\ngl_FragColor = infoLight;\n}";return t},e.BuildDisplay3DShader="BuildDisplay3DShader",e}(Shader3D),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},BuildDisplay3DSprite=function(t){function e(){t.call(this),this.isSelect=!1,this.program=ProgrmaManager.getInstance().getProgram(BuildDisplay3DShader.BuildDisplay3DShader)}return __extends(e,t),e.prototype.loadData=function(){this.setObjUrl(this.objurl),this.setPicUrl(this.picUrl),this.setLightPicUrl(this.uidStr)},e.prototype.setLightPicUrl=function(t){var e=this;TextureManager.getInstance().getTexture(t,function(t){e.lightTexture=t})},e.prototype.setObjUrl=function(t){var e=this;this.objurl=t,ObjDataManager.getInstance().getObjData(t,function(t){e.objData=t,e.objData.collision&&!e.objData.collision.isField})},e.prototype.addCollisionBody=function(){this.objData&&this.objData.collision&&!this._bodyMesh&&(this._bodyMesh=Physics.makeBuildBodyMesh(this,this.objData.collision))},e.prototype.updateMatrix=function(){t.prototype.updateMatrix.call(this)},e.prototype.update=function(){this.objData&&(Scene_data.context3D.setProgram(this.program),Scene_data.context3D.setVcMatrix4fv(this.program,"viewMatrix3D",Scene_data.viewMatrx3D.m),Scene_data.context3D.setVcMatrix4fv(this.program,"camMatrix3D",Scene_data.cam3D.cameraMatrix.m),Scene_data.context3D.setVcMatrix4fv(this.program,"posMatrix3D",this.posMatrix.m),this.isSelect?Scene_data.context3D.setVc4fv(this.program,"mulColorVec",[1,0,0,1]):Scene_data.context3D.setVc4fv(this.program,"mulColorVec",[1,1,1,1]),Scene_data.context3D.setVa(0,3,this.objData.vertexBuffer),Scene_data.context3D.setVa(1,2,this.objData.uvBuffer),Scene_data.context3D.setVa(2,2,this.objData.lightUvBuffer),this.baseTexture&&Scene_data.context3D.setRenderTexture(this.program,"s_texture",this.baseTexture,0),this.lightTexture&&Scene_data.context3D.setRenderTexture(this.program,"lightTexture",this.lightTexture,1),Scene_data.context3D.drawCall(this.objData.indexBuffer,this.objData.treNum))},e}(Display3DSprite),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},SelectModelShader=function(t){function e(){t.call(this)}return __extends(e,t),e.prototype.binLocation=function(t){t.bindAttribLocation(this.program,0,"v3Pos")},e.prototype.getVertexShaderString=function(){var t="attribute vec3 v3Pos;uniform mat4 viewMatrix3D;uniform mat4 camMatrix3D;uniform mat4 posMatrix3D;void main(void){   vec4 vt0= vec4(v3Pos, 1.0);   vt0 = posMatrix3D * vt0;   vt0 = camMatrix3D * vt0;   vt0 = viewMatrix3D * vt0;   gl_Position = vt0;}";return t},e.prototype.getFragmentShaderString=function(){var t=" precision mediump float;\nuniform vec4 colorVecId;void main(void)\n{\ngl_FragColor = colorVecId;\n}";return t},e.SelectModelShader="SelectModelShader",e}(Shader3D),SelectModelMath=function(){function t(){}return t.getInstance=function(){return this._instance||(this._instance=new t),this._instance},t.prototype.getMouseHitModel=function(e,i,n){this.mathLookAtCam(e,i),CubeDisplay3DSprite.fboBuffer||(CubeDisplay3DSprite.fboBuffer=Scene_data.context3D.createFramebuffer()),CubeDisplay3DSprite.cubeTexID||(CubeDisplay3DSprite.cubeTexID=Scene_data.context3D.creatTexture(t.viewSize256,t.viewSize256)),this.program||(ProgrmaManager.getInstance().registe(SelectModelShader.SelectModelShader,new SelectModelShader),this.program=ProgrmaManager.getInstance().getProgram(SelectModelShader.SelectModelShader));var a=CubeDisplay3DSprite.fboBuffer,o=Scene_data.context3D.renderContext;o.disable(o.DEPTH_TEST),o.viewport(0,0,t.viewSize256,t.viewSize256),o.bindFramebuffer(o.FRAMEBUFFER,a),o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,CubeDisplay3DSprite.cubeTexID,null),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT),o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,CubeDisplay3DSprite.cubeTexID,null);for(var r=0;n.length>r;r++)this.update(n[r].objData,n[r].posMatrix,r);var s=new Uint8Array(4);return o.readPixels(t.viewSize256/2,t.viewSize256/2,1,1,o.RGBA,o.UNSIGNED_BYTE,s),console.log(s[0]),o.bindFramebuffer(o.FRAMEBUFFER,null),o.enable(o.DEPTH_TEST),Scene_data.context3D.resetSize(Scene_data.stageWidth,Scene_data.stageHeight),n.length>s[0]?n[s[0]]:null},t.prototype.update=function(t,e,i){if(t){Scene_data.context3D.setProgram(this.program);var n=new Matrix3D;n.appendScale(1,1,1e-4),Scene_data.context3D.setVcMatrix4fv(this.program,"viewMatrix3D",n.m),Scene_data.context3D.setVcMatrix4fv(this.program,"camMatrix3D",Scene_data.cam3D.cameraMatrix.m),Scene_data.context3D.setVcMatrix4fv(this.program,"posMatrix3D",e.m);var a=[i/255,0,0,1];Scene_data.context3D.setVc4fv(this.program,"colorVecId",a),Scene_data.context3D.setVa(0,3,t.vertexBuffer),Scene_data.context3D.drawCall(t.indexBuffer,t.treNum)}},t.prototype.mathLookAtCam=function(t,e){new Rectangle(0,0,Scene_data.stageWidth,Scene_data.stageHeight);var i=t-Scene_data.stageWidth/2,n=Scene_data.stageHeight/2-e,a=new Object3D;a.rx=0==i?.01:i/(Scene_data.viewMatrx3D.m[0]/2),a.ry=0==n?.01:n/(Scene_data.viewMatrx3D.m[5]/2),a.rz=2*Scene_data.sceneViewHW,GroundPostion._anti_computing_point(a),a.x+=Scene_data.cam3D.x,a.y+=Scene_data.cam3D.y,a.z+=Scene_data.cam3D.z;var o=new Vector3D(a.x,a.y,a.z),r=new Matrix3D,s=new Vector3D(Scene_data.cam3D.x,Scene_data.cam3D.y,Scene_data.cam3D.z);r.buildLookAtLH(s,o,new Vector3D(0,1,0)),Scene_data.cam3D.cameraMatrix=r.clone()},t.viewSize256=2,t}(),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},CubeDisplay3DShader=function(t){function e(){t.call(this)}return __extends(e,t),e.prototype.binLocation=function(t){t.bindAttribLocation(this.program,0,"v3Pos"),t.bindAttribLocation(this.program,1,"v2uv"),t.bindAttribLocation(this.program,2,"v2uvLight")},e.prototype.getVertexShaderString=function(){var t="attribute vec3 v3Pos;attribute vec2 v2uv;attribute vec2 v2uvLight;uniform mat4 viewMatrix3D;uniform mat4 camMatrix3D;uniform mat4 posMatrix3D;varying vec2 v_texCoord;varying vec2 v_texLight;void main(void){   v_texCoord = vec2(v2uv.x, v2uv.y);   v_texLight = vec2(v2uvLight.x, v2uvLight.y);   vec4 vt0= vec4(v3Pos, 1.0);   vt0 = posMatrix3D * vt0;   vt0 = camMatrix3D * vt0;   vt0 = viewMatrix3D * vt0;   gl_Position = vt0;}";return t},e.prototype.getFragmentShaderString=function(){var t=" precision mediump float;\nuniform sampler2D s_texture;\nuniform sampler2D lightTexture;\nvarying vec2 v_texCoord;\nvarying vec2 v_texLight;\nvoid main(void)\n{\nvec4 infoUv = texture2D(s_texture, v_texCoord.xy);\nvec4 infoLight = texture2D(lightTexture, v_texLight.xy);\nvec4 info= vec4(1,0,0,1);\ngl_FragColor = infoUv;\n}";return t},e.CubeDisplay3DShader="CubeDisplay3DShader",e}(Shader3D),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},CubeDisplay3DSprite=function(t){function e(){t.call(this),this.program=ProgrmaManager.getInstance().getProgram(CubeDisplay3DShader.CubeDisplay3DShader)}return __extends(e,t),e.prototype.loadData=function(){this.setObjUrl(this.objurl),this.setPicUrl(this.picUrl),this.setLightPicUrl(this.uidStr)},e.prototype.setLightPicUrl=function(t){var e=this;TextureManager.getInstance().getTexture(t,function(t){e.lightTexture=t})},e.prototype.setObjUrl=function(t){var e=this;this.objurl=t,ObjDataManager.getInstance().getObjData(t,function(t){e.objData=t})},e.prototype.update=function(){this.objData&&(this.cannonMesh&&(Physics.CollistionToH5BodyMatrix3D(this.cannonMesh,this.posMatrix),this.posMatrix.prependScale(this._scaleX,this._scaleY,this._scaleZ)),Scene_data.context3D.setProgram(this.program),Scene_data.context3D.setVcMatrix4fv(this.program,"viewMatrix3D",Scene_data.viewMatrx3D.m),Scene_data.context3D.setVcMatrix4fv(this.program,"camMatrix3D",Scene_data.cam3D.cameraMatrix.m),Scene_data.context3D.setVcMatrix4fv(this.program,"posMatrix3D",this.posMatrix.m),Scene_data.context3D.setVa(0,3,this.objData.vertexBuffer),Scene_data.context3D.setVa(1,2,this.objData.uvBuffer),Scene_data.context3D.setVa(2,2,this.objData.lightUvBuffer),this.baseTexture&&Scene_data.context3D.setRenderTexture(this.program,"s_texture",this.baseTexture,0),this.lightTexture&&Scene_data.context3D.setRenderTexture(this.program,"lightTexture",this.lightTexture,1),e.cubeTexID&&Scene_data.context3D.setRenderTexture(this.program,"s_texture",e.cubeTexID,0),Scene_data.context3D.drawCall(this.objData.indexBuffer,this.objData.treNum))},e}(Display3DSprite),FieldDisplay3DSprite=function(t){function e(){t.call(this)}return __extends(e,t),e.prototype.update=function(){this.objData&&(Scene_data.context3D.setProgram(this.program),Scene_data.context3D.setVcMatrix4fv(this.program,"viewMatrix3D",Scene_data.viewMatrx3D.m),Scene_data.context3D.setVcMatrix4fv(this.program,"camMatrix3D",Scene_data.cam3D.cameraMatrix.m),Scene_data.context3D.setVcMatrix4fv(this.program,"posMatrix3D",this.posMatrix.m),Scene_data.context3D.setVa(0,3,this.objData.vertexBuffer),Scene_data.context3D.setVa(1,2,this.objData.uvBuffer),Scene_data.context3D.setVa(2,2,this.objData.lightUvBuffer),this.baseTexture&&Scene_data.context3D.setRenderTexture(this.program,"s_texture",this.baseTexture,0),this.lightTexture&&Scene_data.context3D.setRenderTexture(this.program,"lightTexture",this.lightTexture,1),Scene_data.context3D.drawCall(this.objData.indexBuffer,this.objData.treNum))},e}(CubeDisplay3DSprite),ObjectMath=function(){function t(){}return t}(),GroundPostion=function(){function t(){}return t.math_change_point=function(t){var e=t.x-Scene_data.cam3D.x,i=t.y-Scene_data.cam3D.y,n=t.z-Scene_data.cam3D.z,a=new Matrix3D;a.appendRotation(Scene_data.cam3D.rotationY,Vector3D.Y_AXIS),a.appendRotation(Scene_data.cam3D.rotationX,Vector3D.X_AXIS);var o=a.transformVector(new Vector3D(e,i,n));t.rx=o.x,t.ry=o.y,t.rz=o.z},t.getPostion=function(e,i){var n=t.getWoldPostion(e,i),a=Scene_data.cam3D.x+n.x,o=Scene_data.cam3D.z+n.z;return new Vector3D(a,0,o)},t.getWoldPostion=function(t,e){var i=new Object3D(0,0,500),n=new Object3D(-500,0,0),a=new Object3D(500,0,0);this.math_change_point(i),this.math_change_point(n),this.math_change_point(a);var o=this._get_hit_rec(i,n,a,t-Scene_data.stageWidth/2,Scene_data.stageHeight/2-e);return new Vector3D(o.x,0,o.z)},t._get_hit_rec=function(t,e,i,n,a){var o=new Object3D,r=new Object3D,s=new Object3D;o.x=t.rx,o.y=t.ry,o.z=t.rz,r.x=e.rx,r.y=e.ry,r.z=e.rz,s.x=i.rx,s.x=i.rx,s.y=i.ry,s.z=i.rz;var h=this._PanelEquationFromThreePt(o,r,s),c=this._math_intersect(h,n,a);return this._anti_computing_point(c),c},t._anti_computing_point=function(t){var e=t.rx,i=t.ry,n=t.rz,a=new Matrix3D;a.appendRotation(-Scene_data.cam3D.rotationX,Vector3D.X_AXIS),a.appendRotation(-Scene_data.cam3D.rotationY,Vector3D.Y_AXIS);var o=a.transformVector(new Vector3D(e,i,n));t.x=o.x,t.y=o.y,t.z=o.z},t._math_intersect=function(t,e,i){var n=t.a,a=t.b,o=t.c,r=t.d,s=new Object3D,h=0==e?.01:e/(Scene_data.viewMatrx3D.m[0]/2),c=0==i?.01:i/(Scene_data.viewMatrx3D.m[5]/2),l=2*Scene_data.sceneViewHW;return s.rx=-r/(n+a*c/h+o*l/h),s.ry=s.rx/h*c,s.rz=s.rx/h*l,s},t._PanelEquationFromThreePt=function(t,e,i){var n=(e.y-t.y)*(i.z-t.z)-(e.z-t.z)*(i.y-t.y),a=(e.z-t.z)*(i.x-t.x)-(e.x-t.x)*(i.z-t.z),o=(e.x-t.x)*(i.y-t.y)-(e.y-t.y)*(i.x-t.x),r=0-(n*t.x+a*t.y+o*t.z),s=new ObjectMath;return s.a=n,s.b=a,s.c=o,s.d=r,s},t.mathDisplay2Dto3DWorldPos=function(t,e,i){void 0===i&&(i=500);var n=Scene_data.cam3D.cameraMatrix.clone(),a=Scene_data.viewMatrx3D.clone();n.invert(),a.invert();var o=new Vector3D;return o.x=e.x-t.x,o.y=e.y-t.y,o.x=2*o.x/t.width-1,o.y=1-2*o.y/t.height,o.w=i,o.x=o.x*o.w,o.y=o.y*o.w,o=a.transformVector(o),o.z=i,o=n.transformVector(o)},t}(),FpsMc=function(){function t(){this.drawNum=0,this.fpsStr="",this.lastData=new Date}return t.prototype.getStr=function(){var e=new Date,i=e.getTime()-this.lastData.getTime();return i/=1e3,i>1&&(this.fpsStr="Fps:"+(this.drawNum+""),this.drawNum=0,this.lastData=e),t.tipStr?this.fpsStr+"--"+t.tipStr:this.fpsStr},t}(),UiStage=function(){function t(){this.initAngle=0,this.initScale=1,this.oldScale=1,this.camMoveFouce=!0,this.cPos=new Vector2D(150,100)}return t.getInstance=function(){return this._instance||(this._instance=new t),this._instance},t.prototype.init=function(t){this.canvas2D=t,this.fps=new FpsMc,this.canvasUi=this.canvas2D.getContext("2d")},t.prototype.onKeyDown=function(t){85==t.keyCode},t.prototype.onDoubleTap=function(){FpsMc.tipStr="onDoubleTap"},t.prototype.onRotate=function(t){return"rotateend"==t.type?(FpsMc.tipStr="rotateend",this.camMoveFouce=!0,void 0):(this.camMoveFouce=!1,"rotatestart"==t.type&&(this.initAngle=Scene_data.focus3D.rotationY||0),Scene_data.focus3D.rotationY=this.initAngle+t.rotation,FpsMc.tipStr="onRotate",void 0)},t.prototype.onPinch=function(t){return"pinchend"==t.type?(FpsMc.tipStr="rotateend",this.camMoveFouce=!0,void 0):(this.camMoveFouce=!1,"pinchstart"==t.type&&(this.initScale=this.oldScale||1),this.oldScale=this.initScale*t.scale,Scene_data.cam3D.distance=1e3*(2-this.oldScale),FpsMc.tipStr="onPinch",void 0)},t.prototype.onTap=function(){FpsMc.tipStr=null},t.prototype.onSwipe=function(){FpsMc.tipStr="onSwipe"},t.prototype.onPanDownMove=function(t){var e=GroundPostion.getWoldPostion(t.center.x,t.center.y);"panstart"==t.type&&(FpsMc.tipStr="panstart",this.lastHitPos=new Vector3D(e.x,0,e.z),this.lastFoucePos=new Vector3D(Scene_data.focus3D.x,0,Scene_data.focus3D.z)),"panmove"==t.type&&(FpsMc.tipStr="panmove",FpsMc.tipStr=t.center.x+""+":"+(t.center.y+""),Scene_data.focus3D.x=this.lastFoucePos.x-(e.x-this.lastHitPos.x),Scene_data.focus3D.z=this.lastFoucePos.z-(e.z-this.lastHitPos.z)),"panend"==t.type,FpsMc.tipStr=null},t.prototype.addEvents=function(){var t=this;this.mouseDis.on("panstart panmove panend",function(e){t.onPanDownMove(e)}),this.mouseDis.on("rotatestart rotatemove,rotateend",function(e){t.onRotate(e)}),this.mouseDis.on("pinchstart pinchmove,pinchend",function(e){t.onPinch(e)}),this.mouseDis.on("tap",function(e){t.onTap(e)}),this.mouseDis.on("swipe",function(e){t.onSwipe(e)}),this.mouseDis.on("doubletap",function(e){t.onDoubleTap(e)}),document.addEventListener(MouseType.MouseDown,function(e){t.onMouseDown(e)})},t.prototype.onMouseDown=function(t){GroundPostion.getPostion(t.pageX,t.pageY),FpsMc.tipStr=null},t.prototype.upData=function(){return},t.prototype.makeXyzLine=function(){var t=new Vector3D(80,0,0),e=new Vector3D(0,70,0),i=new Vector3D(0,0,80),n=new Matrix3D;n.appendRotation(Scene_data.cam3D.rotationY,Vector3D.Y_AXIS),n.appendRotation(Scene_data.cam3D.rotationX,Vector3D.X_AXIS),t=n.transformVector(t),e=n.transformVector(e),i=n.transformVector(i),this.drawLine(new Vector2D(0,0),new Vector2D(t.x,-t.y),"#ff0000"),this.drawLine(new Vector2D(0,0),new Vector2D(e.x,-e.y),"#00ff00"),this.drawLine(new Vector2D(0,0),new Vector2D(i.x,-i.y),"#0000ff"),this.canvasUi.font="12px Georgia",this.canvasUi.fillStyle="#ff0000",this.canvasUi.fillText("x",t.x+this.cPos.x,-t.y+this.cPos.y),this.canvasUi.fillStyle="#00ff00",this.canvasUi.fillText("y",e.x+this.cPos.x,-e.y+this.cPos.y),this.canvasUi.fillStyle="#0000ff",this.canvasUi.fillText("z",i.x+this.cPos.x,-i.y+this.cPos.y)},t.prototype.drawLine=function(t,e,i){void 0===i&&(i="red"),this.canvasUi.beginPath(),this.canvasUi.lineWidth=2,this.canvasUi.strokeStyle=i,this.canvasUi.moveTo(t.x+this.cPos.x,t.y+this.cPos.y),this.canvasUi.lineTo(e.x+this.cPos.x,e.y+this.cPos.y),this.canvasUi.stroke()},t.prototype.resetSize=function(){1==Scene_data.user&&(this.canvas2D.width=300,this.canvas2D.height=Scene_data.stageHeight),this.cPos=new Vector2D(150,Scene_data.stageHeight-100)},t}(),CannonManager=function(){function t(){}return t.getInstance=function(){return this._instance||(this._instance=new t),this._instance},t.prototype.addGround=function(){Physics.makeGround(new Vector3D(0,0,0))},t.prototype.addHeightfield=function(){for(var t=[],e=50,i=50,n=0;e>n;n++){t.push([]);for(var a=0;i>a;a++){var o=8*Math.sin(2*n/e*Math.PI)*Math.sin(2*a/i*Math.PI)+8;(0===n||n===e-1||0===a||a===i-1)&&(o=10),n>e/2&&(o=0),t[n].push(5*o)}}this.makeFieldForArr(t,20)},t.prototype.makeFieldForArr=function(t,e){void 0===e&&(e=20);var i=t.length,n=t[0].length,a=e;Physics.makeFieldForArr(t,e);var o=new Vector3D(-(i*a/2),0,-(n*a/2)),r=new ObjData;r.vertices=[],r.uvs=[],r.lightuvs=[],r.normals=[],r.indexs=[];for(var s=0;i-1>s;s++)for(var h=0;n-1>h;h++){var c=new Vector2D(s+0,h+0),l=new Vector2D(s+1,h+0),p=new Vector2D(s+1,h+1),u=new Vector2D(s+0,h+1),d=new Vector3D(c.x*a,t[c.x][c.y],c.y*a),m=new Vector3D(l.x*a,t[l.x][l.y],l.y*a),f=new Vector3D(p.x*a,t[p.x][p.y],p.y*a);new Vector3D(u.x*a,t[u.x][u.y],u.y*a),r.vertices.push(d.x,d.y,d.z),r.vertices.push(m.x,m.y,m.z),r.vertices.push(f.x,f.y,f.z),r.uvs.push(0,0),r.uvs.push(0,0),r.uvs.push(0,0),r.lightuvs.push(0,0),r.lightuvs.push(0,0),r.lightuvs.push(0,0);var y=r.indexs.length;r.indexs.push(y+0,y+1,y+2)}r.treNum=r.indexs.length,r.vertexBuffer=Scene_data.context3D.uploadBuff3D(r.vertices),r.uvBuffer=Scene_data.context3D.uploadBuff3D(r.uvs),r.lightUvBuffer=Scene_data.context3D.uploadBuff3D(r.lightuvs),r.indexBuffer=Scene_data.context3D.uploadIndexBuff3D(r.indexs);var v=new FieldDisplay3DSprite;v.uidStr="assets/img/T_Default_Material_Grid_M.jpg",v.picUrl="assets/img/T_Default_Material_Grid_M.jpg",v.loadData(),v.objData=r,v.x=o.x,v.y=o.y,v.z=o.z,SceneManager.getInstance().addDisplay(v)},t.prototype.loadScene=function(t){var e=this;LoadManager.getInstance().load(Scene_data.fileRoot+t,LoadManager.XML_TYPE,function(t){e.loadCarCom(t)},null)},t.prototype.loadCarCom=function(t){for(var e=JSON.parse(t),i=e.buildItem,n=e.groundItem,a=0;i.length>a;a++)if("1"==i[a].type){var o=new BuildDisplay3DSprite;o.uidStr="assets/"+i[a].lighturl,o.objurl="assets/"+i[a].objsurl,o.picUrl="assets/"+i[a].lighturl,o.uidStr="assets/"+i[a].lighturl,o.picUrl="assets/"+i[a].lighturl,o.x=Number(i[a].x),o.y=Number(i[a].y),o.z=Number(i[a].z),o.scaleX=Number(i[a].scaleX),o.scaleY=Number(i[a].scaleY),o.scaleZ=Number(i[a].scaleZ),o.rotationX=Number(i[a].rotationX),o.rotationY=Number(i[a].rotationY),o.rotationZ=Number(i[a].rotationZ),o.loadData(),SceneManager.getInstance().addDisplay(o)}for(var a=0;n&&n.length>a;a++){var o=new BuildDisplay3DSprite;o.uidStr="assets/"+n[a].lighturl,o.objurl="assets/"+n[a].objsurl,o.picUrl="assets/"+n[a].lighturl,o.x=Number(n[a].x),o.y=Number(n[a].y),o.z=Number(n[a].z),o.scaleX=Number(n[a].scaleX),o.scaleY=Number(n[a].scaleY),o.scaleZ=Number(n[a].scaleZ),o.rotationX=Number(n[a].rotationX),o.rotationY=Number(n[a].rotationY),o.rotationZ=Number(n[a].rotationZ),SceneManager.getInstance().addDisplay(o),o.loadData()}},t.prototype.addVisual=function(t){var e=new CollisionDispaly3DSprite;return e.baseColor=new Vector3D(.5*Math.random()+.5,.5*Math.random()+.5,.5*Math.random()+.5,1),e.setBody(t),SceneManager.getInstance().addDisplay(e),Physics.world.addBody(t),e},t}(),TestScene=function(){function t(){this._keyDic={},this.maxFocreNum=0,this.rotationSteer=0,SceneManager.getInstance().ready=!0,Physics.ready=!0,Physics.creatWorld(),Physics.setGravity(Physics.world,new Vector3D(0,-200,0)),Physics.makeGround(new Vector3D(0,0,0)),Physics.world.defaultContactMaterial.friction=.1,ProgrmaManager.getInstance().registe(LineDisplayShader.LineShader,new LineDisplayShader),ProgrmaManager.getInstance().registe(BuildDisplay3DShader.BuildDisplay3DShader,new BuildDisplay3DShader),ProgrmaManager.getInstance().registe(CubeDisplay3DShader.CubeDisplay3DShader,new CubeDisplay3DShader),this.makeScene(),this.addEvents()}return t.getInstance=function(){return this._instance||(this._instance=new t),this._instance},t.prototype.addEvents=function(){var t=this;document.addEventListener(MouseType.KeyDown,function(e){t.onKeyDown(e)}),document.addEventListener(MouseType.KeyUp,function(e){t.onKeyUp(e)}),setInterval(function(){t.upData()},1e3/60)},t.prototype.onKeyDown=function(t){var e=this._keyDic;e[t.keyCode]=!0},t.prototype.onKeyUp=function(t){var e=this._keyDic;e[t.keyCode]=!1},t.prototype.moveCar=function(){var t=this._keyDic;t[37]&&this.tureLeft(),t[40]&&this.tureDown(),t[39]&&this.tureRight(),t[38]&&this.tureUp(),this.rotationSteer+=(0-this.rotationSteer)/20,this.maxFocreNum+=(0-this.maxFocreNum)/20,this.rayCastCar.setWheelForce(this.maxFocreNum,2),this.rayCastCar.setWheelForce(this.maxFocreNum,3),this.rayCastCar.setSteeringValue(this.rotationSteer,0),this.rayCastCar.setSteeringValue(this.rotationSteer,1)},t.prototype.tureLeft=function(){.4>this.rotationSteer&&(this.rotationSteer+=.1)},t.prototype.tureRight=function(){this.rotationSteer>-.4&&(this.rotationSteer-=.1)},t.prototype.tureUp=function(){5e3>this.maxFocreNum&&(this.maxFocreNum+=200)},t.prototype.tureDown=function(){this.maxFocreNum>-5e3&&(this.maxFocreNum-=200)},t.prototype.makeScene=function(){this.rayCastCar=new HeadStockSprite(new Vector3D(100,10,0)),this.tuoGua=new CheShenSprite(new Vector3D(0,10,0));var t=new CANNON.Body({mass:10,shape:Physics.makeSphereShape(10),position:Physics.getPhysicsV3D(new Vector3D(-0,5,-100))});CannonManager.getInstance().addVisual(t)},t.prototype.upData=function(){this.moveCar()},t.prototype.loadScene=function(){CannonManager.getInstance().loadScene("carpart.xml")},t}(),CarDisp=function(){function t(){}return t}(),Raycast=function(){function t(){this._keyDic={},this.maxFocreNum=0,this.rotationSteer=0,Physics.creatWorld(),ProgrmaManager.getInstance().registe(LineDisplayShader.LineShader,new LineDisplayShader),ProgrmaManager.getInstance().registe(BuildDisplay3DShader.BuildDisplay3DShader,new BuildDisplay3DShader),ProgrmaManager.getInstance().registe(CubeDisplay3DShader.CubeDisplay3DShader,new CubeDisplay3DShader),Physics.setGravity(Physics.world,new Vector3D(0,-100,0)),Physics.makeGround(new Vector3D(0,0,0)),Physics.ready=!0,this.bodyItemSprite=[],this.carItem=[],this.addBox(),Physics.world,this.trucksprite=new TruckSprite(new Vector3D(0,10,0)),this.carItem.push(this.trucksprite);var t=new TruckSprite(new Vector3D(-30,10,0));this.carItem.push(t),this.addEvents(),SceneManager.getInstance().ready=!0,CANNON.DistanceConstraint;var e=this.trucksprite.carChassisBody,i=t.carChassisBody,n=15;new CANNON.PointToPointConstraint(e,new CANNON.Vec3(-n,0,0),i,new CANNON.Vec3(+n,0,-0-0))}return t.getInstance=function(){return this._instance||(this._instance=new t),this._instance},t.prototype.addEvents=function(){var t=this;document.addEventListener(MouseType.KeyDown,function(e){t.onKeyDown(e)}),document.addEventListener(MouseType.KeyUp,function(e){t.onKeyUp(e)})},t.prototype.onKeyDown=function(t){var e=this._keyDic;e[t.keyCode]=!0},t.prototype.onKeyUp=function(t){var e=this._keyDic;e[t.keyCode]=!1},t.prototype.moveCar=function(){var t=this._keyDic;t[65]&&this.tureLeft(),t[83]&&this.tureDown(),t[68]&&this.tureRight(),t[87]&&this.tureUp();var e=this.trucksprite.carRigidVehicle;this.rotationSteer+=(0-this.rotationSteer)/20,this.maxFocreNum+=(0-this.maxFocreNum)/20,e.setWheelForce(this.maxFocreNum,2),e.setWheelForce(this.maxFocreNum,3),e.setSteeringValue(this.rotationSteer,0),e.setSteeringValue(this.rotationSteer,1)},t.prototype.tureLeft=function(){.4>this.rotationSteer&&(this.rotationSteer+=.1)},t.prototype.tureRight=function(){this.rotationSteer>-.4&&(this.rotationSteer-=.1)},t.prototype.tureUp=function(){5e3>this.maxFocreNum&&(this.maxFocreNum+=200)},t.prototype.tureDown=function(){this.maxFocreNum>-5e3&&(this.maxFocreNum-=200)},t.prototype.upData=function(){this.moveCar(),Physics.update();for(var t=0;this.bodyItemSprite.length>t;t++){var e=this.bodyItemSprite[t].sprite,i=new Matrix3D;Physics.CollistionToH5BodyMatrix3D(this.bodyItemSprite[t].body,i),e.posMatrix.m=i.m,e.posMatrix.prependScale(e.scaleX,e.scaleY,e.scaleZ)}for(var n=0;this.carItem.length>n;n++)this.carItem[n].upData()},t.prototype.loadScene=function(){var t=this;Scene_data.cam3D.distance=2e3,LoadManager.getInstance().load(Scene_data.fileRoot+"car.xml",LoadManager.XML_TYPE,function(e){t.loadCarCom(e)},null)},t.prototype.clikPos=function(){},t.prototype.addBox=function(){var t=new CarDisp,e=new CollisionDispaly3DSprite;e.x=50,e.y=10,e.z=0,e.scaleX=.05,e.scaleY=.05,e.scaleZ=.05,SceneManager.getInstance().addDisplay(e);var i=new CollisionVo;i.type=CollisionType.BOX,e.setCollsionType(i),t.sprite=e;var n=new Vector3D(e.x,e.y,e.z),a=new CANNON.Body({mass:100,shape:Physics.makeBoxShape(new Vector3D(100*e.scaleX,100*e.scaleY,100*e.scaleZ)),position:Physics.getPhysicsV3D(n)});a.type=CANNON.Body.DYNAMIC,Physics.world.addBody(a),t.body=a,this.bodyItemSprite.push(t),this._boxBody=a},t.prototype.loadCarCom=function(t){for(var e=JSON.parse(t),i=e.buildItem,n=e.groundItem,a=0;i.length>a;a++)if("1"==i[a].type){var o=new BuildDisplay3DSprite;o.uidStr="assets/"+i[a].lighturl,o.objurl="assets/"+i[a].objsurl,o.picUrl="assets/"+i[a].lighturl,o.uidStr="assets/"+i[a].lighturl,o.picUrl="assets/"+i[a].lighturl,o.x=Number(i[a].x),o.y=Number(i[a].y),o.z=Number(i[a].z),o.scaleX=Number(i[a].scaleX),o.scaleY=Number(i[a].scaleY),o.scaleZ=Number(i[a].scaleZ),o.rotationX=Number(i[a].rotationX),o.rotationY=Number(i[a].rotationY),o.rotationZ=Number(i[a].rotationZ),o.loadData(),SceneManager.getInstance().addDisplay(o)}for(var a=0;n&&n.length>a;a++){var o=new BuildDisplay3DSprite;o.uidStr="assets/"+n[a].lighturl,o.objurl="assets/"+n[a].objsurl,o.picUrl="assets/"+n[a].lighturl,o.x=Number(n[a].x),o.y=Number(n[a].y),o.z=Number(n[a].z),o.scaleX=Number(n[a].scaleX),o.scaleY=Number(n[a].scaleY),o.scaleZ=Number(n[a].scaleZ),o.rotationX=Number(n[a].rotationX),o.rotationY=Number(n[a].rotationY),o.rotationZ=Number(n[a].rotationZ),SceneManager.getInstance().addDisplay(o),o.loadData()}},t}(),CastTwo=function(){function t(){return this._keyDic={},this.maxFocreNum=0,this.rotationSteer=0,this.skipNum=0,this.collisionItem=[],SceneManager.getInstance().ready=!0,Physics.ready=!0,Physics.creatWorld(),Physics.setGravity(Physics.world,new Vector3D(0,-980,0)),Physics.makeGround(new Vector3D(0,0,0)),ProgrmaManager.getInstance().registe(LineDisplayShader.LineShader,new LineDisplayShader),ProgrmaManager.getInstance().registe(BuildDisplay3DShader.BuildDisplay3DShader,new BuildDisplay3DShader),ProgrmaManager.getInstance().registe(CubeDisplay3DShader.CubeDisplay3DShader,new CubeDisplay3DShader),this.makeScene(),this.addEvents(),void 0}return t.getInstance=function(){return this._instance||(this._instance=new t),this._instance},t.prototype.addEvents=function(){var t=this;document.addEventListener(MouseType.KeyDown,function(e){t.onKeyDown(e)}),document.addEventListener(MouseType.KeyUp,function(e){t.onKeyUp(e)})},t.prototype.onKeyDown=function(t){var e=this._keyDic;e[t.keyCode]=!0},t.prototype.onKeyUp=function(t){var e=this._keyDic;e[t.keyCode]=!1},t.prototype.moveCar=function(){var t=this._keyDic;t[37]&&this.tureLeft(),t[40]&&this.tureDown(),t[39]&&this.tureRight(),t[38]&&this.tureUp(),this.rotationSteer+=(0-this.rotationSteer)/20,this.maxFocreNum+=(0-this.maxFocreNum)/20,this.rayCastCar.setWheelForce(this.maxFocreNum,2),this.rayCastCar.setWheelForce(this.maxFocreNum,3),this.rayCastCar.setSteeringValue(this.rotationSteer,0),this.rayCastCar.setSteeringValue(this.rotationSteer,1)},t.prototype.tureLeft=function(){.4>this.rotationSteer&&(this.rotationSteer+=.1)
},t.prototype.tureRight=function(){this.rotationSteer>-.4&&(this.rotationSteer-=.1)},t.prototype.tureUp=function(){5e3>this.maxFocreNum&&(this.maxFocreNum+=200)},t.prototype.tureDown=function(){this.maxFocreNum>-5e3&&(this.maxFocreNum-=200)},t.prototype.makeScene=function(){var t=new CANNON.Body({mass:10,shape:Physics.makeBoxShape(new Vector3D(5,5,5)),position:Physics.getPhysicsV3D(new Vector3D(-50,100,0))});CannonManager.getInstance().addVisual(t);var e=new CANNON.Body({mass:10,shape:Physics.makeBoxShape(new Vector3D(5,5,5)),position:Physics.getPhysicsV3D(new Vector3D(50,100,0))});CannonManager.getInstance().addVisual(e),t.type=4,e.type=4,this.ballBody=new CANNON.Body({mass:10,shape:Physics.makeSphereShape(10),position:Physics.getPhysicsV3D(new Vector3D(-0,5,-100))}),CannonManager.getInstance().addVisual(this.ballBody),this.addTempBall(),this.addRigidVechicle(),this.addRaycastVehicle()},t.prototype.addRaycastVehicle=function(){this.rayCastCar=new RayCastSprite(new Vector3D(0,50,0))},t.prototype.addRigidVechicle=function(){var t=new CANNON.Box(new CANNON.Vec3(5,2,1)),e=new CANNON.Body({mass:100});e.addShape(t,new CANNON.Vec3(0,0,0),null);var i=new Matrix3D;i.appendRotation(-0,Vector3D.Y_AXIS);var n=new Quaternion;n.fromMatrix(i),e.position=Physics.getPhysicsV3D(new Vector3D(-200,0,0)),e.quaternion=Physics.H5ToCollisionQuaternion(n);var a=new RigidVehicle({chassisBody:e});a.setMotorSpeed(-10,2),a.setMotorSpeed(-10,3),a.setSteeringValue(-.3,0),a.setSteeringValue(0,1)},t.prototype.addTempBall=function(){Physics.world.gravity.set(0,0,-200),new HingeSprite(new Vector3D(100,10,0));for(var t=0;10>t;t++);var e=new CANNON.Body({mass:1,shape:Physics.makeBoxShape(new Vector3D(20,10,10)),position:Physics.getPhysicsV3D(new Vector3D(200,0,10))});e.type=CANNON.Body.KINEMATIC,CannonManager.getInstance().addVisual(e)},t.prototype.changeBody=function(){if(this.moveBody){var t=new Matrix3D;t.appendRotation(this.skipNum,Vector3D.Y_AXIS),Physics.setMatrix3DToBody(this.moveBody,t)}},t.prototype.linkRope=function(t,e){var i=new CANNON.Body({mass:10,shape:Physics.makeBoxShape(new Vector3D(1,1,1)),position:Physics.getPhysicsV3D(new Vector3D(0,77.0871215252208,0))});CannonManager.getInstance().addVisual(i);var n=new CANNON.Body({mass:10,shape:Physics.makeBoxShape(new Vector3D(1,5,1)),position:Physics.getPhysicsV3D(new Vector3D(0,57.087121525220795,0))});CannonManager.getInstance().addVisual(n),t.linearDamping=.5,t.angularDamping=.5,e.linearDamping=t.linearDamping,e.angularDamping=t.angularDamping,i.linearDamping=t.linearDamping,i.angularDamping=t.angularDamping,n.linearDamping=t.linearDamping,n.angularDamping=t.angularDamping,this.proeA=new CANNON.DistanceConstraint(t,i,55),this.proeB=new CANNON.DistanceConstraint(e,i,55),Physics.world.addConstraint(this.proeA),Physics.world.addConstraint(this.proeB),this.deleLink=new CANNON.PointToPointConstraint(i,new CANNON.Vec3(0,0,-10),n,new CANNON.Vec3(0,0,10)),Physics.world.addConstraint(this.deleLink)},t.prototype.moveLinePore=function(){this.proeA&&(this.proeA.distance=55+Math.abs(10*Math.sin(this.skipNum++*Math.PI/180)),this.proeB.distance=this.proeA.distance),300==this.skipNum},t.prototype.linkLock=function(){for(var t,e=0;7>e;e++){var i=new CANNON.Body({mass:10,shape:Physics.makeBoxShape(new Vector3D(1,1,1)),position:Physics.getPhysicsV3D(new Vector3D(0,100-10*e,0))});CannonManager.getInstance().addVisual(i),i.linearDamping=0,i.angularDamping=.2;var n=5;if(t){var a=new CANNON.PointToPointConstraint(i,new CANNON.Vec3(-0,-3,+n),t,new CANNON.Vec3(-0,-3,-n)),o=new CANNON.PointToPointConstraint(i,new CANNON.Vec3(-0,3,+n),t,new CANNON.Vec3(-0,3,-n));Physics.world.addConstraint(a),Physics.world.addConstraint(o)}t||(i.type=4),t=i}},t.prototype.upData=function(){this.moveLinePore(),this.moveCar(),Physics.update(),this.changeBody()},t.prototype.loadScene=function(){Scene_data.cam3D.distance=2e3,CannonManager.getInstance().loadScene("carpart.xml")},t.prototype.clikPos=function(){},t}(),TruckSprite=function(){function t(t){void 0===t&&(t=null),this.showModel=!0,this.initData(t)}return t.prototype.initData=function(t){t||(t=new Vector3D);var e=Physics.world;this.carWheelSpriteA=this.addCarWheel(),this.carWheelSpriteB=this.addCarWheel(),this.carWheelSpriteC=this.addCarWheel(),this.carWheelSpriteD=this.addCarWheel(),this.addCarBody();var i=new CANNON.Box(new CANNON.Vec3(5,2,1)),n=new CANNON.Body({mass:100});n.addShape(i,new CANNON.Vec3(0,0,0),null);var a=Physics.getPhysicsV3D(t);n.position.set(a.x,a.y,a.z);var o=new Matrix3D;o.appendRotation(-0,Vector3D.Y_AXIS);var r=new Quaternion;r.fromMatrix(o),n.quaternion=Physics.H5ToCollisionQuaternion(r);var s=10,h=new CANNON.RigidVehicle({chassisBody:n}),c=5,l=5.5,p=new CANNON.Sphere(1.5);new CANNON.Vec3(0,0,-1);var u=new CANNON.Body({mass:s});u.quaternion=Physics.H5ToCollisionQuaternion(r),u.addShape(p,null,null),h.addWheel({body:u,position:new CANNON.Vec3(l,c,-1)});var d=new CANNON.Body({mass:s});d.quaternion=Physics.H5ToCollisionQuaternion(r),d.addShape(p,null,null),h.addWheel({body:d,position:new CANNON.Vec3(l,-c,-1)});var m=new CANNON.Body({mass:s});m.quaternion=Physics.H5ToCollisionQuaternion(r),m.addShape(p,null,null),h.addWheel({body:m,position:new CANNON.Vec3(-l,c,-1)});var f=new CANNON.Body({mass:s});f.quaternion=Physics.H5ToCollisionQuaternion(r),f.addShape(p,null,null),h.addWheel({body:f,position:new CANNON.Vec3(-l,-c,-1)}),h.addToWorld(e),this.carChassisBody=n,this.carWheelBodyA=u,this.carWheelBodyB=d,this.carWheelBodyC=m,this.carWheelBodyD=f,this.carRigidVehicle=h,this.addCarmodel()},t.prototype.upData=function(){if(this.carWheelBodyA){var t=new Matrix3D;Physics.CollistionToH5BodyMatrix3D(this.carWheelBodyA,t),this.carWheelSpriteA.posMatrix.m=t.m,this.carWheelSpriteA.posMatrix.prependScale(this.carWheelSpriteA.scaleX,this.carWheelSpriteA.scaleY,this.carWheelSpriteA.scaleZ)}if(this.carWheelBodyB){var t=new Matrix3D;Physics.CollistionToH5BodyMatrix3D(this.carWheelBodyB,t),this.carWheelSpriteB.posMatrix.m=t.m,this.carWheelSpriteB.posMatrix.prependScale(this.carWheelSpriteB.scaleX,this.carWheelSpriteB.scaleY,this.carWheelSpriteB.scaleZ)}if(this.carWheelBodyC){var t=new Matrix3D;Physics.CollistionToH5BodyMatrix3D(this.carWheelBodyC,t),this.carWheelSpriteC.posMatrix.m=t.m,this.carWheelSpriteC.posMatrix.prependScale(this.carWheelSpriteC.scaleX,this.carWheelSpriteC.scaleY,this.carWheelSpriteC.scaleZ)}if(this.carWheelBodyD){var t=new Matrix3D;Physics.CollistionToH5BodyMatrix3D(this.carWheelBodyD,t),this.carWheelSpriteD.posMatrix.m=t.m,this.carWheelSpriteD.posMatrix.prependScale(this.carWheelSpriteD.scaleX,this.carWheelSpriteD.scaleY,this.carWheelSpriteD.scaleZ)}if(this.carChassisBody){var t=new Matrix3D;Physics.CollistionToH5BodyMatrix3D(this.carChassisBody,t),this.carBodySprite.posMatrix.m=t.m,this.carBodySprite.posMatrix.prependScale(this.carBodySprite.scaleX,this.carBodySprite.scaleY,this.carBodySprite.scaleZ)}this.upDataCarSprite()},t.prototype.addCarBody=function(){new CarDisp;var t=new CollisionDispaly3DSprite;t.y=10,t.scaleX=.05,t.scaleY=.01,t.scaleZ=.02,this.showModel&&SceneManager.getInstance().addDisplay(t);var e=new CollisionVo;e.type=CollisionType.BOX,t.setCollsionType(e),this.carBodySprite=t},t.prototype.addCarWheel=function(){new CarDisp;var t=new CollisionDispaly3DSprite;t.y=100,t.scaleX=.02,t.scaleY=.02,t.scaleZ=.02,this.showModel&&SceneManager.getInstance().addDisplay(t);var e=new CollisionVo;return e.type=CollisionType.BALL,t.setCollsionType(e),t},t.prototype.addCarmodel=function(){this.chetouSprite=new CubeDisplay3DSprite,this.chetouSprite.uidStr="assets/xfile/car/img/kache_01.jpg",this.chetouSprite.objurl="assets/xfile/car/h5/kache_chetou_01.xml",this.chetouSprite.picUrl="assets/xfile/car/img/kache_01.jpg",this.chetouSprite.scaleX=.25,this.chetouSprite.scaleY=.25,this.chetouSprite.scaleZ=.25,this.chetouSprite.loadData(),this.showModel||SceneManager.getInstance().addDisplay(this.chetouSprite),this.cheRenA=new CubeDisplay3DSprite,this.cheRenA.uidStr="assets/xfile/car/img/kache_01.jpg",this.cheRenA.objurl="assets/xfile/car/h5/kache_chelun_01.xml",this.cheRenA.picUrl="assets/xfile/car/img/kache_01.jpg",this.cheRenA.scaleX=.25,this.cheRenA.scaleY=.25,this.cheRenA.scaleZ=.25,this.cheRenA.loadData(),this.showModel||SceneManager.getInstance().addDisplay(this.cheRenA),this.cheRenB=new CubeDisplay3DSprite,this.cheRenB.uidStr="assets/xfile/car/img/kache_01.jpg",this.cheRenB.objurl="assets/xfile/car/h5/kache_chelun_01.xml",this.cheRenB.picUrl="assets/xfile/car/img/kache_01.jpg",this.cheRenB.scaleX=.25,this.cheRenB.scaleY=.25,this.cheRenB.scaleZ=.25,this.cheRenB.loadData(),this.showModel||SceneManager.getInstance().addDisplay(this.cheRenB),this.cheRenC=new CubeDisplay3DSprite,this.cheRenC.uidStr="assets/xfile/car/img/kache_01.jpg",this.cheRenC.objurl="assets/xfile/car/h5/kache_chelun_01.xml",this.cheRenC.picUrl="assets/xfile/car/img/kache_01.jpg",this.cheRenC.scaleX=.25,this.cheRenC.scaleY=.25,this.cheRenC.scaleZ=.25,this.cheRenC.loadData(),this.showModel||SceneManager.getInstance().addDisplay(this.cheRenC),this.cheRenD=new CubeDisplay3DSprite,this.cheRenD.uidStr="assets/xfile/car/img/kache_01.jpg",this.cheRenD.objurl="assets/xfile/car/h5/kache_chelun_01.xml",this.cheRenD.picUrl="assets/xfile/car/img/kache_01.jpg",this.cheRenD.scaleX=.25,this.cheRenD.scaleY=.25,this.cheRenD.scaleZ=.25,this.cheRenD.loadData(),this.showModel||SceneManager.getInstance().addDisplay(this.cheRenD)},t.prototype.upDataCarSprite=function(){var t=new Matrix3D;Physics.CollistionToH5BodyMatrix3D(this.carChassisBody,t),this.chetouSprite.posMatrix.m=t.m,this.chetouSprite.posMatrix.prependRotation(180,Vector3D.Y_AXIS),this.chetouSprite.posMatrix.prependTranslation(5,-3,0),this.chetouSprite.posMatrix.prependScale(this.chetouSprite.scaleX,this.chetouSprite.scaleY,this.chetouSprite.scaleZ);var t=new Matrix3D;Physics.CollistionToH5BodyMatrix3D(this.carWheelBodyA,t),this.cheRenA.posMatrix.m=t.m,this.cheRenA.posMatrix.prependScale(this.cheRenA.scaleX,this.cheRenA.scaleY,this.cheRenA.scaleZ);var t=new Matrix3D;Physics.CollistionToH5BodyMatrix3D(this.carWheelBodyB,t),this.cheRenB.posMatrix.m=t.m,this.cheRenB.posMatrix.prependScale(this.cheRenB.scaleX,this.cheRenB.scaleY,this.cheRenB.scaleZ);var t=new Matrix3D;Physics.CollistionToH5BodyMatrix3D(this.carWheelBodyC,t),this.cheRenC.posMatrix.m=t.m,this.cheRenC.posMatrix.prependScale(this.cheRenC.scaleX,this.cheRenC.scaleY,this.cheRenC.scaleZ);var t=new Matrix3D;Physics.CollistionToH5BodyMatrix3D(this.carWheelBodyD,t),this.cheRenD.posMatrix.m=t.m,this.cheRenD.posMatrix.prependScale(this.cheRenD.scaleX,this.cheRenD.scaleY,this.cheRenD.scaleZ)},t}(),HingeSprite=function(){function t(t){void 0===t&&(t=null),this.mass=100,this.carLength=20,this.carWidth=10,this.carWheelSize=3,this.constraints=[],this.initData(t)}return t.prototype.initData=function(t){var e=this,i=new Matrix3D;i.appendRotation(90,Vector3D.X_AXIS);var n=new Quaternion;n.fromMatrix(i);var a=Physics.makeCylinderShape(6,6,10),o=new CANNON.Body({mass:this.mass}),r=new CANNON.Body({mass:this.mass}),s=new CANNON.Body({mass:this.mass}),h=new CANNON.Body({mass:this.mass});Physics.bodyAddShape(o,a,new Vector3D,n),Physics.bodyAddShape(r,a,new Vector3D,n),Physics.bodyAddShape(s,a,new Vector3D,n),Physics.bodyAddShape(h,a,new Vector3D,n);var c=new CANNON.Box(new CANNON.Vec3(this.carLength,this.carWidth-2*this.carWheelSize,5)),l=new CANNON.Body({mass:10*this.mass});l.position=Physics.getPhysicsV3D(t),l.addShape(c);var p=new CANNON.Vec3(0,0,0);o.position=Physics.getPhysicsV3D(new Vector3D(this.carLength,0,this.carWidth).add(t)),r.position=Physics.getPhysicsV3D(new Vector3D(this.carLength,0,-this.carWidth).add(t)),s.position=Physics.getPhysicsV3D(new Vector3D(-this.carLength,0,this.carWidth).add(t)),h.position=Physics.getPhysicsV3D(new Vector3D(-this.carLength,0,-this.carWidth).add(t));var u=new CANNON.Vec3(0,1,0),d=new CANNON.Vec3(0,-1,0),m=new CANNON.Vec3(0,1,0),f=new CANNON.Vec3(0,-1,0);this.constraints.push(new CANNON.HingeConstraint(l,o,{collideConnected:!0,pivotA:new CANNON.Vec3(this.carLength,this.carWidth,0),axisA:m,pivotB:p,axisB:u})),this.constraints.push(new CANNON.HingeConstraint(l,r,{collideConnected:!0,pivotA:new CANNON.Vec3(this.carLength,-this.carWidth,0),axisA:f,pivotB:p,axisB:d})),this.constraints.push(new CANNON.HingeConstraint(l,s,{collideConnected:!0,pivotA:new CANNON.Vec3(-this.carLength,this.carWidth,0),axisA:u,pivotB:p,axisB:u})),this.constraints.push(new CANNON.HingeConstraint(l,h,{collideConnected:!0,pivotA:new CANNON.Vec3(-this.carLength,-this.carWidth,0),axisA:d,pivotB:p,axisB:d}));for(var y=0;this.constraints.length>y;y++)Physics.world.addConstraint(this.constraints[y]);this.bodies=[l,o,r,s,h];for(var y=0;this.bodies.length>y;y++)CannonManager.getInstance().addVisual(this.bodies[y]);setInterval(function(){e.update()},1e3/60),this.toDo(10,3)},t.prototype.toDo=function(){var t=this.constraints[0],e=this.constraints[1],i=this.constraints[2],n=this.constraints[3];t.enableMotor(),e.enableMotor(),i.enableMotor(),n.enableMotor();var a=10;i.setMotorSpeed(-a),n.setMotorSpeed(a)},t.prototype.update=function(){console.log(this.bodies[4].torque)},t}(),RigidVehicle=function(){function t(t){var e=this;void 0===t&&(t={}),this.worldAxis=new CANNON.Vec3(0,0,0),this.torque=new CANNON.Vec3(0,0,0),this.chassisBody=t.chassisBody,this.chassisBody||(new CANNON.Box(Physics.getPhysicsV3D(new Vector3D(5,.5,2))),this.chassisBody=new CANNON.Body({mass:1,shape:Physics.makeBoxShape(new Vector3D(5,.5,2))})),CannonManager.getInstance().addVisual(this.chassisBody),this.constraints=[],this.wheelAxes=[],this.wheelForces=[],this.wheelBodies=[],this.initWheel(),setInterval(function(){e.update()},1e3/60)}return t.prototype.initWheel=function(){var t=5,e=5.5,i=new CANNON.Sphere(1.5),n=new CANNON.Body({mass:1});n.addShape(i,null,null),this.addWheel(n,new Vector3D(e,-1,+t));var a=new CANNON.Body({mass:1});a.addShape(i,null,null),this.addWheel(a,new Vector3D(e,-1,-t));var o=new CANNON.Body({mass:1});o.addShape(i,null,null),this.addWheel(o,new Vector3D(-e,-1,+t));var r=new CANNON.Body({mass:1});r.addShape(i,null,null),this.addWheel(r,new Vector3D(-e,-1,-t))},t.prototype.addWheel=function(t,e){var i=new CANNON.Vec3(0,1,0),n=new CANNON.Vec3(0,0,0);this.chassisBody.pointToWorldFrame(Physics.getPhysicsV3D(e),n),t.position.set(n.x,n.y,n.z);var a=i;this.wheelAxes.push(a);var o=new CANNON.HingeConstraint(this.chassisBody,t,{pivotA:Physics.getPhysicsV3D(e),axisA:a,pivotB:new CANNON.Vec3(0,0,0),axisB:a,collideConnected:!1});this.constraints.push(o),this.wheelBodies.push(t),this.wheelForces.push(0),Physics.world.addConstraint(o),CannonManager.getInstance().addVisual(t)},t.prototype.setWheelForce=function(t,e){this.wheelForces[e]=t},t.prototype.disableMotor=function(t){var e=this.constraints[t];e.disableMotor()},t.prototype.setMotorSpeed=function(t,e){var i=this.constraints[e];i.enableMotor(),i.setMotorSpeed(t)},t.prototype.setSteeringValue=function(t,e){var i=this.wheelAxes[e],n=Math.cos(t),a=Math.sin(t),o=i.x,r=i.y;this.constraints[e].axisA.set(n*o-a*r,a*o+n*r,0)},t.prototype.getWheelSpeed=function(t){var e=this.wheelAxes[t],i=this.wheelBodies[t],n=i.angularVelocity;return this.chassisBody.vectorToWorldFrame(e,this.worldAxis),n.dot(this.worldAxis)},t.prototype.applyWheelForce=function(t,e){var i=this.torque,n=this.wheelAxes[e],a=this.wheelBodies[e],o=a.torque;n.scale(t,i),a.vectorToWorldFrame(i,i),o.vadd(i,o)},t.prototype.update=function(){for(var t=this.wheelForces,e=0;t.length>e;e++)this.applyWheelForce(t[e],e)},t}(),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},RayCastSprite=function(){function t(t){void 0===t&&(t=null),this.size=2,this.frontWheelPos=.9,this.rearWheelPos=-1.3,this.initData(t)}return t.prototype.initData=function(t){var e=this,i=Physics.world,n=10*this.size,a=new CANNON.Box(new CANNON.Vec3(2*n,1*n,.2*n));this.chassisBody=new CANNON.Body({mass:100}),this.chassisBody.addShape(a),this.chassisBody.position=Physics.getPhysicsV3D(t),CannonManager.getInstance().addVisual(this.chassisBody).visible=!1;var o={radius:.4*n,directionLocal:new CANNON.Vec3(0,0,-1),suspensionStiffness:500,suspensionRestLength:.3,frictionSlip:5,dampingRelaxation:2.3,dampingCompression:4.4,maxSuspensionForce:1e5,rollInfluence:.01,axleLocal:new CANNON.Vec3(0,1,0),chassisConnectionPointLocal:new CANNON.Vec3(1,1,0),maxSuspensionTravel:.3,customSlidingRotationalSpeed:-30,useCustomSlidingRotationalSpeed:!0};this.vehicle=new CANNON.RaycastVehicle({chassisBody:this.chassisBody}),o.chassisConnectionPointLocal.set(this.frontWheelPos*n,1*n,0),this.vehicle.addWheel(o),o.chassisConnectionPointLocal.set(this.frontWheelPos*n,-1*n,0),this.vehicle.addWheel(o),o.chassisConnectionPointLocal.set(this.rearWheelPos*n,1*n,0),this.vehicle.addWheel(o),o.chassisConnectionPointLocal.set(this.rearWheelPos*n,-1*n,0),this.vehicle.addWheel(o),this.vehicle.addToWorld(i),this.wheelBodies=[];for(var r=0;this.vehicle.wheelInfos.length>r;r++){var s=this.vehicle.wheelInfos[r],h=new CANNON.Cylinder(s.radius,s.radius,s.radius/2,20),c=new CANNON.Body({mass:0});c.type=CANNON.Body.KINEMATIC,c.collisionFilterGroup=0;var l=new CANNON.Quaternion(0,0,0,1);l.setFromAxisAngle(new CANNON.Vec3(1,0,0),Math.PI/2),c.addShape(h,new CANNON.Vec3(0,0,0),l),this.wheelBodies.push(c),CannonManager.getInstance().addVisual(c).visible=!1}i.addEventListener("postStep",function(){e.upData()})},t.prototype.upData=function(){for(var t=0;this.vehicle.wheelInfos.length>t;t++){this.vehicle.updateWheelTransform(t);var e=this.vehicle.wheelInfos[t].worldTransform,i=this.wheelBodies[t];i.position.copy(e.position),i.quaternion.copy(e.quaternion)}},t.prototype.setWheelForce=function(t,e){this.vehicle.applyEngineForce(-t,e)},t.prototype.setSteeringValue=function(t,e){this.vehicle.setSteeringValue(t,e)},t}(),HeadStockSprite=function(t){function e(e){void 0===e&&(e=null),t.call(this,e),this.showModel=!1,this.modelUrl="xfile/car/h5/kache_chetou_01.xml",this.addCarmodel()}return __extends(e,t),e.prototype.upData=function(){t.prototype.upData.call(this);var e=new Matrix3D;Physics.CollistionToH5BodyMatrix3D(this.chassisBody,e),this.chetouSprite.posMatrix.m=e.m,this.chetouSprite.posMatrix.prependRotation(180,Vector3D.Y_AXIS),this.chetouSprite.posMatrix.prependTranslation(12*this.size,-4*this.size,0),this.chetouSprite.posMatrix.prependScale(this.chetouSprite.scaleX,this.chetouSprite.scaleY,this.chetouSprite.scaleZ);for(var i=0;this.wheelSpriteItem.length>i;i++){var n=this.wheelBodies[i],a=this.wheelSpriteItem[i],e=new Matrix3D;Physics.CollistionToH5BodyMatrix3D(n,e),a.posMatrix.m=e.m,a.posMatrix.prependScale(a.scaleX,a.scaleY,a.scaleZ)}},e.prototype.addCarmodel=function(){var t=.5*this.size;this.chetouSprite=new CubeDisplay3DSprite,this.chetouSprite.uidStr="assets/xfile/car/img/kache_01.jpg",this.chetouSprite.objurl="assets/"+this.modelUrl,this.chetouSprite.picUrl="assets/xfile/car/img/kache_01.jpg",this.chetouSprite.scaleX=t,this.chetouSprite.scaleY=t,this.chetouSprite.scaleZ=t,this.chetouSprite.loadData(),this.showModel||SceneManager.getInstance().addDisplay(this.chetouSprite),this.cheRenA=new CubeDisplay3DSprite,this.cheRenA.uidStr="assets/xfile/car/img/kache_01.jpg",this.cheRenA.objurl="assets/xfile/car/h5/kache_chelun_01.xml",this.cheRenA.picUrl="assets/xfile/car/img/kache_01.jpg",this.cheRenA.scaleX=t,this.cheRenA.scaleY=t,this.cheRenA.scaleZ=t,this.cheRenA.loadData(),this.showModel||SceneManager.getInstance().addDisplay(this.cheRenA),this.cheRenB=new CubeDisplay3DSprite,this.cheRenB.uidStr="assets/xfile/car/img/kache_01.jpg",this.cheRenB.objurl="assets/xfile/car/h5/kache_chelun_01.xml",this.cheRenB.picUrl="assets/xfile/car/img/kache_01.jpg",this.cheRenB.scaleX=t,this.cheRenB.scaleY=t,this.cheRenB.scaleZ=t,this.cheRenB.loadData(),this.showModel||SceneManager.getInstance().addDisplay(this.cheRenB),this.cheRenC=new CubeDisplay3DSprite,this.cheRenC.uidStr="assets/xfile/car/img/kache_01.jpg",this.cheRenC.objurl="assets/xfile/car/h5/kache_chelun_01.xml",this.cheRenC.picUrl="assets/xfile/car/img/kache_01.jpg",this.cheRenC.scaleX=t,this.cheRenC.scaleY=t,this.cheRenC.scaleZ=t,this.cheRenC.loadData(),this.showModel||SceneManager.getInstance().addDisplay(this.cheRenC),this.cheRenD=new CubeDisplay3DSprite,this.cheRenD.uidStr="assets/xfile/car/img/kache_01.jpg",this.cheRenD.objurl="assets/xfile/car/h5/kache_chelun_01.xml",this.cheRenD.picUrl="assets/xfile/car/img/kache_01.jpg",this.cheRenD.scaleX=t,this.cheRenD.scaleY=t,this.cheRenD.scaleZ=t,this.cheRenD.loadData(),this.showModel||SceneManager.getInstance().addDisplay(this.cheRenD),this.wheelSpriteItem=[],this.wheelSpriteItem.push(this.cheRenA),this.wheelSpriteItem.push(this.cheRenB),this.wheelSpriteItem.push(this.cheRenC),this.wheelSpriteItem.push(this.cheRenD)},e}(RayCastSprite),CheShenSprite=function(t){function e(e){void 0===e&&(e=null),t.call(this,e)}return __extends(e,t),e.prototype.addCarmodel=function(){this.modelUrl="xfile/car/h5/kache_cheshen_01.xml",t.prototype.addCarmodel.call(this)},e}(HeadStockSprite),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},ViewMatrx3DSprite=function(t){function e(){t.call(this),SceneManager.getInstance().addDisplay(this)}return __extends(e,t),e.getInstance=function(){return this._instance||(this._instance=new e),this._instance},e.prototype.update=function(){this.body&&Physics.CollistionToH5BodyMatrix3D(this.body,this.posMatrix),this.x=Scene_data.focus3D.x,this.y=Scene_data.focus3D.y+5,this.z=Scene_data.focus3D.z,t.prototype.update.call(this)},e.prototype.drawCircle=function(t){var e,i=36;this.clear(),this.baseColor=new Vector3D(0,1,1,1);for(var n=0;i>n;n++){var a=new Matrix3D;a.appendRotation(n*(360/i),Vector3D.Y_AXIS);var o=a.transformVector(new Vector3D(t,0,0));e&&this.makeLineMode(e,o),e=o}this.upToGpu()},e.prototype.draw=function(){return this.drawCircle(100),void 0},e.prototype.makePolygonObjData=function(t){var e=new LineDisplaySprite;e.clear(),e.baseColor=new Vector3D(0,1,1,1);for(var i,n,a,o,r,s,h=0;t.indexs.length/3>h;h++)i=t.indexs[3*h+0],n=t.indexs[3*h+1],a=t.indexs[3*h+2],o=new Vector3D(t.vertices[3*i+0],t.vertices[3*i+1],t.vertices[3*i+2]),r=new Vector3D(t.vertices[3*n+0],t.vertices[3*n+1],t.vertices[3*n+2]),s=new Vector3D(t.vertices[3*a+0],t.vertices[3*a+1],t.vertices[3*a+2]),e.makeLineMode(o,r),e.makeLineMode(r,s),e.makeLineMode(s,o);return e.upToGpu(),e.objData},e}(LineDisplaySprite);(function(t,e,i,n){"use strict";function a(t,e,i){return setTimeout(l(t,i),e)}function o(t,e,i){return Array.isArray(t)?(r(t,i[e],i),!0):!1}function r(t,e,i){var a;if(t)if(t.forEach)t.forEach(e,i);else if(t.length!==n)for(a=0;t.length>a;)e.call(i,t[a],a,t),a++;else for(a in t)t.hasOwnProperty(a)&&e.call(i,t[a],a,t)}function s(t,e,i){for(var a=Object.keys(e),o=0;a.length>o;)(!i||i&&t[a[o]]===n)&&(t[a[o]]=e[a[o]]),o++;return t}function h(t,e){return s(t,e,!0)}function c(t,e,i){var n,a=e.prototype;n=t.prototype=Object.create(a),n.constructor=t,n._super=a,i&&s(n,i)}function l(t,e){return function(){return t.apply(e,arguments)}}function p(t,e){return typeof t==le?t.apply(e?e[0]||n:n,e):t}function u(t,e){return t===n?e:t}function d(t,e,i){r(v(e),function(e){t.addEventListener(e,i,!1)})}function m(t,e,i){r(v(e),function(e){t.removeEventListener(e,i,!1)})}function f(t,e){for(;t;){if(t==e)return!0;t=t.parentNode}return!1}function y(t,e){return t.indexOf(e)>-1}function v(t){return t.trim().split(/\s+/g)}function x(t,e,i){if(t.indexOf&&!i)return t.indexOf(e);for(var n=0;t.length>n;){if(i&&t[n][i]==e||!i&&t[n]===e)return n;n++}return-1}function g(t){return Array.prototype.slice.call(t,0)}function _(t,e,i){for(var n=[],a=[],o=0;t.length>o;){var r=e?t[o][e]:t[o];0>x(a,r)&&n.push(t[o]),a[o]=r,o++}return i&&(n=e?n.sort(function(t,i){return t[e]>i[e]}):n.sort()),n}function D(t,e){for(var i,a,o=e[0].toUpperCase()+e.slice(1),r=0;he.length>r;){if(i=he[r],a=i?i+o:e,a in t)return a;r++}return n}function w(){return me++}function b(t){var e=t.ownerDocument;return e.defaultView||e.parentWindow}function S(t,e){var i=this;this.manager=t,this.callback=e,this.element=t.element,this.target=t.options.inputTarget,this.domHandler=function(e){p(t.options.enable,[t])&&i.handler(e)},this.init()}function M(t){var e,i=t.options.inputClass;return e=i?i:ve?O:xe?U:ye?W:F,new e(t,C)}function C(t,e,i){var n=i.pointers.length,a=i.changedPointers.length,o=e&Se&&0===n-a,r=e&(Ce|Te)&&0===n-a;i.isFirst=!!o,i.isFinal=!!r,o&&(t.session={}),i.eventType=e,T(t,i),t.emit("hammer.input",i),t.recognize(i),t.session.prevInput=i}function T(t,e){var i=t.session,n=e.pointers,a=n.length;i.firstInput||(i.firstInput=E(e)),a>1&&!i.firstMultiple?i.firstMultiple=E(e):1===a&&(i.firstMultiple=!1);var o=i.firstInput,r=i.firstMultiple,s=r?r.center:o.center,h=e.center=P(n);e.timeStamp=de(),e.deltaTime=e.timeStamp-o.timeStamp,e.angle=R(s,h),e.distance=V(s,h),A(i,e),e.offsetDirection=N(e.deltaX,e.deltaY),e.scale=r?z(r.pointers,n):1,e.rotation=r?L(r.pointers,n):0,I(i,e);var c=t.element;f(e.srcEvent.target,c)&&(c=e.srcEvent.target),e.target=c}function A(t,e){var i=e.center,n=t.offsetDelta||{},a=t.prevDelta||{},o=t.prevInput||{};(e.eventType===Se||o.eventType===Ce)&&(a=t.prevDelta={x:o.deltaX||0,y:o.deltaY||0},n=t.offsetDelta={x:i.x,y:i.y}),e.deltaX=a.x+(i.x-n.x),e.deltaY=a.y+(i.y-n.y)}function I(t,e){var i,a,o,r,s=t.lastInterval||e,h=e.timeStamp-s.timeStamp;if(e.eventType!=Te&&(h>be||s.velocity===n)){var c=s.deltaX-e.deltaX,l=s.deltaY-e.deltaY,p=B(h,c,l);a=p.x,o=p.y,i=ue(p.x)>ue(p.y)?p.x:p.y,r=N(c,l),t.lastInterval=e}else i=s.velocity,a=s.velocityX,o=s.velocityY,r=s.direction;e.velocity=i,e.velocityX=a,e.velocityY=o,e.direction=r}function E(t){for(var e=[],i=0;t.pointers.length>i;)e[i]={clientX:pe(t.pointers[i].clientX),clientY:pe(t.pointers[i].clientY)},i++;return{timeStamp:de(),pointers:e,center:P(e),deltaX:t.deltaX,deltaY:t.deltaY}}function P(t){var e=t.length;if(1===e)return{x:pe(t[0].clientX),y:pe(t[0].clientY)};for(var i=0,n=0,a=0;e>a;)i+=t[a].clientX,n+=t[a].clientY,a++;return{x:pe(i/e),y:pe(n/e)}}function B(t,e,i){return{x:e/t||0,y:i/t||0}}function N(t,e){return t===e?Ae:ue(t)>=ue(e)?t>0?Ie:Ee:e>0?Pe:Be}function V(t,e,i){i||(i=Le);var n=e[i[0]]-t[i[0]],a=e[i[1]]-t[i[1]];return Math.sqrt(n*n+a*a)}function R(t,e,i){i||(i=Le);var n=e[i[0]]-t[i[0]],a=e[i[1]]-t[i[1]];return 180*Math.atan2(a,n)/Math.PI}function L(t,e){return R(e[1],e[0],ze)-R(t[1],t[0],ze)}function z(t,e){return V(e[0],e[1],ze)/V(t[0],t[1],ze)}function F(){this.evEl=Oe,this.evWin=ke,this.allow=!0,this.pressed=!1,S.apply(this,arguments)}function O(){this.evEl=Xe,this.evWin=We,S.apply(this,arguments),this.store=this.manager.session.pointerEvents=[]}function k(){this.evTarget=Ye,this.evWin=Ge,this.started=!1,S.apply(this,arguments)}function j(t,e){var i=g(t.touches),n=g(t.changedTouches);return e&(Ce|Te)&&(i=_(i.concat(n),"identifier",!0)),[i,n]}function U(){this.evTarget=Ze,this.targetIds={},S.apply(this,arguments)}function X(t,e){var i=g(t.touches),a=this.targetIds;if(e&(Se|Me)&&1===i.length)return a[i[0].identifier]=!0,[i,i];var o,r,s=g(t.changedTouches),h=[],c=this.target;if(r=i.filter(function(t){return f(t.target,c)}),e===Se)for(o=0;r.length>o;)a[r[o].identifier]=!0,o++;for(o=0;s.length>o;)a[s[o].identifier]&&h.push(s[o]),e&(Ce|Te)&&delete a[s[o].identifier],o++;return h.length?[_(r.concat(h),"identifier",!0),h]:n}function W(){S.apply(this,arguments);var t=l(this.handler,this);this.touch=new U(this.manager,t),this.mouse=new F(this.manager,t)}function q(t,e){this.manager=t,this.set(e)}function Y(t){if(y(t,ei))return ei;var e=y(t,ii),i=y(t,ni);return e&&i?ii+" "+ni:e||i?e?ii:ni:y(t,ti)?ti:$e}function G(t){this.id=w(),this.manager=null,this.options=h(t||{},this.defaults),this.options.enable=u(this.options.enable,!0),this.state=ai,this.simultaneous={},this.requireFail=[]}function H(t){return t&ci?"cancel":t&si?"end":t&ri?"move":t&oi?"start":""}function Z(t){return t==Be?"down":t==Pe?"up":t==Ie?"left":t==Ee?"right":""}function K(t,e){var i=e.manager;return i?i.get(t):t}function Q(){G.apply(this,arguments)}function J(){Q.apply(this,arguments),this.pX=null,this.pY=null}function $(){Q.apply(this,arguments)}function te(){G.apply(this,arguments),this._timer=null,this._input=null}function ee(){Q.apply(this,arguments)}function ie(){Q.apply(this,arguments)}function ne(){G.apply(this,arguments),this.pTime=!1,this.pCenter=!1,this._timer=null,this._input=null,this.count=0}function ae(t,e){return e=e||{},e.recognizers=u(e.recognizers,ae.defaults.preset),new oe(t,e)}function oe(t,e){e=e||{},this.options=h(e,ae.defaults),this.options.inputTarget=this.options.inputTarget||t,this.handlers={},this.session={},this.recognizers=[],this.element=t,this.input=M(this),this.touchAction=new q(this,this.options.touchAction),re(this,!0),r(e.recognizers,function(t){var e=this.add(new t[0](t[1]));t[2]&&e.recognizeWith(t[2]),t[3]&&e.requireFailure(t[3])},this)}function re(t,e){var i=t.element;r(t.options.cssProps,function(t,n){i.style[D(i.style,n)]=e?t:""})}function se(t,i){var n=e.createEvent("Event");n.initEvent(t,!0,!0),n.gesture=i,i.target.dispatchEvent(n)}var he=["","webkit","moz","MS","ms","o"],ce=e.createElement("div"),le="function",pe=Math.round,ue=Math.abs,de=Date.now,me=1,fe=/mobile|tablet|ip(ad|hone|od)|android/i,ye="ontouchstart"in t,ve=D(t,"PointerEvent")!==n,xe=ye&&fe.test(navigator.userAgent),ge="touch",_e="pen",De="mouse",we="kinect",be=25,Se=1,Me=2,Ce=4,Te=8,Ae=1,Ie=2,Ee=4,Pe=8,Be=16,Ne=Ie|Ee,Ve=Pe|Be,Re=Ne|Ve,Le=["x","y"],ze=["clientX","clientY"];S.prototype={handler:function(){},init:function(){this.evEl&&d(this.element,this.evEl,this.domHandler),this.evTarget&&d(this.target,this.evTarget,this.domHandler),this.evWin&&d(b(this.element),this.evWin,this.domHandler)},destroy:function(){this.evEl&&m(this.element,this.evEl,this.domHandler),this.evTarget&&m(this.target,this.evTarget,this.domHandler),this.evWin&&m(b(this.element),this.evWin,this.domHandler)}};var Fe={mousedown:Se,mousemove:Me,mouseup:Ce},Oe="mousedown",ke="mousemove mouseup";c(F,S,{handler:function(t){var e=Fe[t.type];e&Se&&0===t.button&&(this.pressed=!0),e&Me&&1!==t.which&&(e=Ce),this.pressed&&this.allow&&(e&Ce&&(this.pressed=!1),this.callback(this.manager,e,{pointers:[t],changedPointers:[t],pointerType:De,srcEvent:t}))}});var je={pointerdown:Se,pointermove:Me,pointerup:Ce,pointercancel:Te,pointerout:Te},Ue={2:ge,3:_e,4:De,5:we},Xe="pointerdown",We="pointermove pointerup pointercancel";t.MSPointerEvent&&(Xe="MSPointerDown",We="MSPointerMove MSPointerUp MSPointerCancel"),c(O,S,{handler:function(t){var e=this.store,i=!1,n=t.type.toLowerCase().replace("ms",""),a=je[n],o=Ue[t.pointerType]||t.pointerType,r=o==ge,s=x(e,t.pointerId,"pointerId");a&Se&&(0===t.button||r)?0>s&&(e.push(t),s=e.length-1):a&(Ce|Te)&&(i=!0),0>s||(e[s]=t,this.callback(this.manager,a,{pointers:e,changedPointers:[t],pointerType:o,srcEvent:t}),i&&e.splice(s,1))}});var qe={touchstart:Se,touchmove:Me,touchend:Ce,touchcancel:Te},Ye="touchstart",Ge="touchstart touchmove touchend touchcancel";c(k,S,{handler:function(t){var e=qe[t.type];if(e===Se&&(this.started=!0),this.started){var i=j.call(this,t,e);e&(Ce|Te)&&0===i[0].length-i[1].length&&(this.started=!1),this.callback(this.manager,e,{pointers:i[0],changedPointers:i[1],pointerType:ge,srcEvent:t})}}});var He={touchstart:Se,touchmove:Me,touchend:Ce,touchcancel:Te},Ze="touchstart touchmove touchend touchcancel";c(U,S,{handler:function(t){var e=He[t.type],i=X.call(this,t,e);i&&this.callback(this.manager,e,{pointers:i[0],changedPointers:i[1],pointerType:ge,srcEvent:t})}}),c(W,S,{handler:function(t,e,i){var n=i.pointerType==ge,a=i.pointerType==De;if(n)this.mouse.allow=!1;else if(a&&!this.mouse.allow)return;e&(Ce|Te)&&(this.mouse.allow=!0),this.callback(t,e,i)},destroy:function(){this.touch.destroy(),this.mouse.destroy()}});var Ke=D(ce.style,"touchAction"),Qe=Ke!==n,Je="compute",$e="auto",ti="manipulation",ei="none",ii="pan-x",ni="pan-y";
q.prototype={set:function(t){t==Je&&(t=this.compute()),Qe&&(this.manager.element.style[Ke]=t),this.actions=t.toLowerCase().trim()},update:function(){this.set(this.manager.options.touchAction)},compute:function(){var t=[];return r(this.manager.recognizers,function(e){p(e.options.enable,[e])&&(t=t.concat(e.getTouchAction()))}),Y(t.join(" "))},preventDefaults:function(t){if(!Qe){var e=t.srcEvent,i=t.offsetDirection;if(this.manager.session.prevented)return e.preventDefault(),n;var a=this.actions,o=y(a,ei),r=y(a,ni),s=y(a,ii);return o||r&&i&Ne||s&&i&Ve?this.preventSrc(e):n}},preventSrc:function(t){this.manager.session.prevented=!0,t.preventDefault()}};var ai=1,oi=2,ri=4,si=8,hi=si,ci=16,li=32;G.prototype={defaults:{},set:function(t){return s(this.options,t),this.manager&&this.manager.touchAction.update(),this},recognizeWith:function(t){if(o(t,"recognizeWith",this))return this;var e=this.simultaneous;return t=K(t,this),e[t.id]||(e[t.id]=t,t.recognizeWith(this)),this},dropRecognizeWith:function(t){return o(t,"dropRecognizeWith",this)?this:(t=K(t,this),delete this.simultaneous[t.id],this)},requireFailure:function(t){if(o(t,"requireFailure",this))return this;var e=this.requireFail;return t=K(t,this),-1===x(e,t)&&(e.push(t),t.requireFailure(this)),this},dropRequireFailure:function(t){if(o(t,"dropRequireFailure",this))return this;t=K(t,this);var e=x(this.requireFail,t);return e>-1&&this.requireFail.splice(e,1),this},hasRequireFailures:function(){return this.requireFail.length>0},canRecognizeWith:function(t){return!!this.simultaneous[t.id]},emit:function(t){function e(e){i.manager.emit(i.options.event+(e?H(n):""),t)}var i=this,n=this.state;si>n&&e(!0),e(),n>=si&&e(!0)},tryEmit:function(t){return this.canEmit()?this.emit(t):(this.state=li,n)},canEmit:function(){for(var t=0;this.requireFail.length>t;){if(!(this.requireFail[t].state&(li|ai)))return!1;t++}return!0},recognize:function(t){var e=s({},t);return p(this.options.enable,[this,e])?(this.state&(hi|ci|li)&&(this.state=ai),this.state=this.process(e),this.state&(oi|ri|si|ci)&&this.tryEmit(e),n):(this.reset(),this.state=li,n)},process:function(){},getTouchAction:function(){},reset:function(){}},c(Q,G,{defaults:{pointers:1},attrTest:function(t){var e=this.options.pointers;return 0===e||t.pointers.length===e},process:function(t){var e=this.state,i=t.eventType,n=e&(oi|ri),a=this.attrTest(t);return n&&(i&Te||!a)?e|ci:n||a?i&Ce?e|si:e&oi?e|ri:oi:li}}),c(J,Q,{defaults:{event:"pan",threshold:10,pointers:1,direction:Re},getTouchAction:function(){var t=this.options.direction,e=[];return t&Ne&&e.push(ni),t&Ve&&e.push(ii),e},directionTest:function(t){var e=this.options,i=!0,n=t.distance,a=t.direction,o=t.deltaX,r=t.deltaY;return a&e.direction||(e.direction&Ne?(a=0===o?Ae:0>o?Ie:Ee,i=o!=this.pX,n=Math.abs(t.deltaX)):(a=0===r?Ae:0>r?Pe:Be,i=r!=this.pY,n=Math.abs(t.deltaY))),t.direction=a,i&&n>e.threshold&&a&e.direction},attrTest:function(t){return Q.prototype.attrTest.call(this,t)&&(this.state&oi||!(this.state&oi)&&this.directionTest(t))},emit:function(t){this.pX=t.deltaX,this.pY=t.deltaY;var e=Z(t.direction);e&&this.manager.emit(this.options.event+e,t),this._super.emit.call(this,t)}}),c($,Q,{defaults:{event:"pinch",threshold:0,pointers:2},getTouchAction:function(){return[ei]},attrTest:function(t){return this._super.attrTest.call(this,t)&&(Math.abs(t.scale-1)>this.options.threshold||this.state&oi)},emit:function(t){if(this._super.emit.call(this,t),1!==t.scale){var e=1>t.scale?"in":"out";this.manager.emit(this.options.event+e,t)}}}),c(te,G,{defaults:{event:"press",pointers:1,time:500,threshold:5},getTouchAction:function(){return[$e]},process:function(t){var e=this.options,i=t.pointers.length===e.pointers,n=t.distance<e.threshold,o=t.deltaTime>e.time;if(this._input=t,!n||!i||t.eventType&(Ce|Te)&&!o)this.reset();else if(t.eventType&Se)this.reset(),this._timer=a(function(){this.state=hi,this.tryEmit()},e.time,this);else if(t.eventType&Ce)return hi;return li},reset:function(){clearTimeout(this._timer)},emit:function(t){this.state===hi&&(t&&t.eventType&Ce?this.manager.emit(this.options.event+"up",t):(this._input.timeStamp=de(),this.manager.emit(this.options.event,this._input)))}}),c(ee,Q,{defaults:{event:"rotate",threshold:0,pointers:2},getTouchAction:function(){return[ei]},attrTest:function(t){return this._super.attrTest.call(this,t)&&(Math.abs(t.rotation)>this.options.threshold||this.state&oi)}}),c(ie,Q,{defaults:{event:"swipe",threshold:10,velocity:.65,direction:Ne|Ve,pointers:1},getTouchAction:function(){return J.prototype.getTouchAction.call(this)},attrTest:function(t){var e,i=this.options.direction;return i&(Ne|Ve)?e=t.velocity:i&Ne?e=t.velocityX:i&Ve&&(e=t.velocityY),this._super.attrTest.call(this,t)&&i&t.direction&&t.distance>this.options.threshold&&ue(e)>this.options.velocity&&t.eventType&Ce},emit:function(t){var e=Z(t.direction);e&&this.manager.emit(this.options.event+e,t),this.manager.emit(this.options.event,t)}}),c(ne,G,{defaults:{event:"tap",pointers:1,taps:1,interval:300,time:250,threshold:2,posThreshold:10},getTouchAction:function(){return[ti]},process:function(t){var e=this.options,i=t.pointers.length===e.pointers,n=t.distance<e.threshold,o=t.deltaTime<e.time;if(this.reset(),t.eventType&Se&&0===this.count)return this.failTimeout();if(n&&o&&i){if(t.eventType!=Ce)return this.failTimeout();var r=this.pTime?t.timeStamp-this.pTime<e.interval:!0,s=!this.pCenter||V(this.pCenter,t.center)<e.posThreshold;this.pTime=t.timeStamp,this.pCenter=t.center,s&&r?this.count+=1:this.count=1,this._input=t;var h=this.count%e.taps;if(0===h)return this.hasRequireFailures()?(this._timer=a(function(){this.state=hi,this.tryEmit()},e.interval,this),oi):hi}return li},failTimeout:function(){return this._timer=a(function(){this.state=li},this.options.interval,this),li},reset:function(){clearTimeout(this._timer)},emit:function(){this.state==hi&&(this._input.tapCount=this.count,this.manager.emit(this.options.event,this._input))}}),ae.VERSION="2.0.4",ae.defaults={domEvents:!1,touchAction:Je,enable:!0,inputTarget:null,inputClass:null,preset:[[ee,{enable:!1}],[$,{enable:!1},["rotate"]],[ie,{direction:Ne}],[J,{direction:Ne},["swipe"]],[ne],[ne,{event:"doubletap",taps:2},["tap"]],[te]],cssProps:{userSelect:"none",touchSelect:"none",touchCallout:"none",contentZooming:"none",userDrag:"none",tapHighlightColor:"rgba(0,0,0,0)"}};var pi=1,ui=2;oe.prototype={set:function(t){return s(this.options,t),t.touchAction&&this.touchAction.update(),t.inputTarget&&(this.input.destroy(),this.input.target=t.inputTarget,this.input.init()),this},stop:function(t){this.session.stopped=t?ui:pi},recognize:function(t){var e=this.session;if(!e.stopped){this.touchAction.preventDefaults(t);var i,n=this.recognizers,a=e.curRecognizer;(!a||a&&a.state&hi)&&(a=e.curRecognizer=null);for(var o=0;n.length>o;)i=n[o],e.stopped===ui||a&&i!=a&&!i.canRecognizeWith(a)?i.reset():i.recognize(t),!a&&i.state&(oi|ri|si)&&(a=e.curRecognizer=i),o++}},get:function(t){if(t instanceof G)return t;for(var e=this.recognizers,i=0;e.length>i;i++)if(e[i].options.event==t)return e[i];return null},add:function(t){if(o(t,"add",this))return this;var e=this.get(t.options.event);return e&&this.remove(e),this.recognizers.push(t),t.manager=this,this.touchAction.update(),t},remove:function(t){if(o(t,"remove",this))return this;var e=this.recognizers;return t=this.get(t),e.splice(x(e,t),1),this.touchAction.update(),this},on:function(t,e){var i=this.handlers;return r(v(t),function(t){i[t]=i[t]||[],i[t].push(e)}),this},off:function(t,e){var i=this.handlers;return r(v(t),function(t){e?i[t].splice(x(i[t],e),1):delete i[t]}),this},emit:function(t,e){this.options.domEvents&&se(t,e);var i=this.handlers[t]&&this.handlers[t].slice();if(i&&i.length){e.type=t,e.preventDefault=function(){e.srcEvent.preventDefault()};for(var n=0;i.length>n;)i[n](e),n++}},destroy:function(){this.element&&re(this,!1),this.handlers={},this.session={},this.input.destroy(),this.element=null}},s(ae,{INPUT_START:Se,INPUT_MOVE:Me,INPUT_END:Ce,INPUT_CANCEL:Te,STATE_POSSIBLE:ai,STATE_BEGAN:oi,STATE_CHANGED:ri,STATE_ENDED:si,STATE_RECOGNIZED:hi,STATE_CANCELLED:ci,STATE_FAILED:li,DIRECTION_NONE:Ae,DIRECTION_LEFT:Ie,DIRECTION_RIGHT:Ee,DIRECTION_UP:Pe,DIRECTION_DOWN:Be,DIRECTION_HORIZONTAL:Ne,DIRECTION_VERTICAL:Ve,DIRECTION_ALL:Re,Manager:oe,Input:S,TouchAction:q,TouchInput:U,MouseInput:F,PointerEventInput:O,TouchMouseInput:W,SingleTouchInput:k,Recognizer:G,AttrRecognizer:Q,Tap:ne,Pan:J,Swipe:ie,Pinch:$,Rotate:ee,Press:te,on:d,off:m,each:r,merge:h,extend:s,inherit:c,bindFn:l,prefixed:D}),typeof define==le&&define.amd?define(function(){return ae}):"undefined"!=typeof module&&module.exports?module.exports=ae:t[i]=ae})(window,document,"Hammer"),!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else{var e;"undefined"!=typeof window?e=window:"undefined"!=typeof global?e=global:"undefined"!=typeof self&&(e=self),e.CANNON=t()}}(function(){return function t(e,i,n){function a(r,s){if(!i[r]){if(!e[r]){var h="function"==typeof require&&require;if(!s&&h)return h(r,!0);if(o)return o(r,!0);throw Error("Cannot find module '"+r+"'")}var c=i[r]={exports:{}};e[r][0].call(c.exports,function(t){var i=e[r][1][t];return a(i?i:t)},c,c.exports,t,e,i,n)}return i[r].exports}for(var o="function"==typeof require&&require,r=0;n.length>r;r++)a(n[r]);return a}({1:[function(t,e){e.exports={name:"cannon",version:"0.6.2",description:"A lightweight 3D physics engine written in JavaScript.",homepage:"https://github.com/schteppe/cannon.js",author:"Stefan Hedman <schteppe@gmail.com> (http://steffe.se)",keywords:["cannon.js","cannon","physics","engine","3d"],main:"./build/cannon.js",engines:{node:"*"},repository:{type:"git",url:"https://github.com/schteppe/cannon.js.git"},bugs:{url:"https://github.com/schteppe/cannon.js/issues"},licenses:[{type:"MIT"}],devDependencies:{jshint:"latest","uglify-js":"latest",nodeunit:"^0.9.0",grunt:"~0.4.0","grunt-contrib-jshint":"~0.1.1","grunt-contrib-nodeunit":"^0.4.1","grunt-contrib-concat":"~0.1.3","grunt-contrib-uglify":"^0.5.1","grunt-browserify":"^2.1.4","grunt-contrib-yuidoc":"^0.5.2",browserify:"*"},dependencies:{}}},{}],2:[function(t,e){e.exports={version:t("../package.json").version,AABB:t("./collision/AABB"),ArrayCollisionMatrix:t("./collision/ArrayCollisionMatrix"),Body:t("./objects/Body"),Box:t("./shapes/Box"),Broadphase:t("./collision/Broadphase"),Constraint:t("./constraints/Constraint"),ContactEquation:t("./equations/ContactEquation"),Narrowphase:t("./world/Narrowphase"),ConeTwistConstraint:t("./constraints/ConeTwistConstraint"),ContactMaterial:t("./material/ContactMaterial"),ConvexPolyhedron:t("./shapes/ConvexPolyhedron"),Cylinder:t("./shapes/Cylinder"),DistanceConstraint:t("./constraints/DistanceConstraint"),Equation:t("./equations/Equation"),EventTarget:t("./utils/EventTarget"),FrictionEquation:t("./equations/FrictionEquation"),GSSolver:t("./solver/GSSolver"),GridBroadphase:t("./collision/GridBroadphase"),Heightfield:t("./shapes/Heightfield"),HingeConstraint:t("./constraints/HingeConstraint"),LockConstraint:t("./constraints/LockConstraint"),Mat3:t("./math/Mat3"),Material:t("./material/Material"),NaiveBroadphase:t("./collision/NaiveBroadphase"),ObjectCollisionMatrix:t("./collision/ObjectCollisionMatrix"),Pool:t("./utils/Pool"),Particle:t("./shapes/Particle"),Plane:t("./shapes/Plane"),PointToPointConstraint:t("./constraints/PointToPointConstraint"),Quaternion:t("./math/Quaternion"),Ray:t("./collision/Ray"),RaycastVehicle:t("./objects/RaycastVehicle"),RaycastResult:t("./collision/RaycastResult"),RigidVehicle:t("./objects/RigidVehicle"),RotationalEquation:t("./equations/RotationalEquation"),RotationalMotorEquation:t("./equations/RotationalMotorEquation"),SAPBroadphase:t("./collision/SAPBroadphase"),SPHSystem:t("./objects/SPHSystem"),Shape:t("./shapes/Shape"),Solver:t("./solver/Solver"),Sphere:t("./shapes/Sphere"),SplitSolver:t("./solver/SplitSolver"),Spring:t("./objects/Spring"),Trimesh:t("./shapes/Trimesh"),Vec3:t("./math/Vec3"),Vec3Pool:t("./utils/Vec3Pool"),World:t("./world/World")}},{"../package.json":1,"./collision/AABB":3,"./collision/ArrayCollisionMatrix":4,"./collision/Broadphase":5,"./collision/GridBroadphase":6,"./collision/NaiveBroadphase":7,"./collision/ObjectCollisionMatrix":8,"./collision/Ray":9,"./collision/RaycastResult":10,"./collision/SAPBroadphase":11,"./constraints/ConeTwistConstraint":12,"./constraints/Constraint":13,"./constraints/DistanceConstraint":14,"./constraints/HingeConstraint":15,"./constraints/LockConstraint":16,"./constraints/PointToPointConstraint":17,"./equations/ContactEquation":19,"./equations/Equation":20,"./equations/FrictionEquation":21,"./equations/RotationalEquation":22,"./equations/RotationalMotorEquation":23,"./material/ContactMaterial":24,"./material/Material":25,"./math/Mat3":27,"./math/Quaternion":28,"./math/Vec3":30,"./objects/Body":31,"./objects/RaycastVehicle":32,"./objects/RigidVehicle":33,"./objects/SPHSystem":34,"./objects/Spring":35,"./shapes/Box":37,"./shapes/ConvexPolyhedron":38,"./shapes/Cylinder":39,"./shapes/Heightfield":40,"./shapes/Particle":41,"./shapes/Plane":42,"./shapes/Shape":43,"./shapes/Sphere":44,"./shapes/Trimesh":45,"./solver/GSSolver":46,"./solver/Solver":47,"./solver/SplitSolver":48,"./utils/EventTarget":49,"./utils/Pool":51,"./utils/Vec3Pool":54,"./world/Narrowphase":55,"./world/World":56}],3:[function(t,e){function i(t){t=t||{},this.lowerBound=new n,t.lowerBound&&this.lowerBound.copy(t.lowerBound),this.upperBound=new n,t.upperBound&&this.upperBound.copy(t.upperBound)}var n=t("../math/Vec3");t("../utils/Utils"),e.exports=i;var a=new n;i.prototype.setFromPoints=function(t,e,i,n){var o=this.lowerBound,r=this.upperBound,s=i;o.copy(t[0]),s&&s.vmult(o,o),r.copy(o);for(var h=1;t.length>h;h++){var c=t[h];s&&(s.vmult(c,a),c=a),c.x>r.x&&(r.x=c.x),c.x<o.x&&(o.x=c.x),c.y>r.y&&(r.y=c.y),c.y<o.y&&(o.y=c.y),c.z>r.z&&(r.z=c.z),c.z<o.z&&(o.z=c.z)}return e&&(e.vadd(o,o),e.vadd(r,r)),n&&(o.x-=n,o.y-=n,o.z-=n,r.x+=n,r.y+=n,r.z+=n),this},i.prototype.copy=function(t){return this.lowerBound.copy(t.lowerBound),this.upperBound.copy(t.upperBound),this},i.prototype.clone=function(){return(new i).copy(this)},i.prototype.extend=function(t){var e=t.lowerBound.x;this.lowerBound.x>e&&(this.lowerBound.x=e);var i=t.upperBound.x;i>this.upperBound.x&&(this.upperBound.x=i);var e=t.lowerBound.y;this.lowerBound.y>e&&(this.lowerBound.y=e);var i=t.upperBound.y;i>this.upperBound.y&&(this.upperBound.y=i);var e=t.lowerBound.z;this.lowerBound.z>e&&(this.lowerBound.z=e);var i=t.upperBound.z;i>this.upperBound.z&&(this.upperBound.z=i)},i.prototype.overlaps=function(t){var e=this.lowerBound,i=this.upperBound,n=t.lowerBound,a=t.upperBound;return(n.x<=i.x&&i.x<=a.x||e.x<=a.x&&a.x<=i.x)&&(n.y<=i.y&&i.y<=a.y||e.y<=a.y&&a.y<=i.y)&&(n.z<=i.z&&i.z<=a.z||e.z<=a.z&&a.z<=i.z)},i.prototype.contains=function(t){var e=this.lowerBound,i=this.upperBound,n=t.lowerBound,a=t.upperBound;return e.x<=n.x&&i.x>=a.x&&e.y<=n.y&&i.y>=a.y&&e.z<=n.z&&i.z>=a.z},i.prototype.getCorners=function(t,e,i,n,a,o,r,s){var h=this.lowerBound,c=this.upperBound;t.copy(h),e.set(c.x,h.y,h.z),i.set(c.x,c.y,h.z),n.set(h.x,c.y,c.z),a.set(c.x,h.y,h.z),o.set(h.x,c.y,h.z),r.set(h.x,h.y,c.z),s.copy(c)};var o=[new n,new n,new n,new n,new n,new n,new n,new n];i.prototype.toLocalFrame=function(t,e){var i=o,n=i[0],a=i[1],r=i[2],s=i[3],h=i[4],c=i[5],l=i[6],p=i[7];this.getCorners(n,a,r,s,h,c,l,p);for(var u=0;8!==u;u++){var d=i[u];t.pointToLocal(d,d)}return e.setFromPoints(i)},i.prototype.toWorldFrame=function(t,e){var i=o,n=i[0],a=i[1],r=i[2],s=i[3],h=i[4],c=i[5],l=i[6],p=i[7];this.getCorners(n,a,r,s,h,c,l,p);for(var u=0;8!==u;u++){var d=i[u];t.pointToWorld(d,d)}return e.setFromPoints(i)}},{"../math/Vec3":30,"../utils/Utils":53}],4:[function(t,e){function i(){this.matrix=[]}e.exports=i,i.prototype.get=function(t,e){if(t=t.index,e=e.index,e>t){var i=e;e=t,t=i}return this.matrix[(t*(t+1)>>1)+e-1]},i.prototype.set=function(t,e,i){if(t=t.index,e=e.index,e>t){var n=e;e=t,t=n}this.matrix[(t*(t+1)>>1)+e-1]=i?1:0},i.prototype.reset=function(){for(var t=0,e=this.matrix.length;t!==e;t++)this.matrix[t]=0},i.prototype.setNumObjects=function(t){this.matrix.length=t*(t-1)>>1}},{}],5:[function(t,e){function i(){this.world=null,this.useBoundingBoxes=!1,this.dirty=!0}var n=t("../objects/Body"),a=t("../math/Vec3"),o=t("../math/Quaternion");t("../shapes/Shape"),t("../shapes/Plane"),e.exports=i,i.prototype.collisionPairs=function(){throw Error("collisionPairs not implemented for this BroadPhase class!")};var r=n.STATIC|n.KINEMATIC;i.prototype.needBroadphaseCollision=function(t,e){return 0===(t.collisionFilterGroup&e.collisionFilterMask)||0===(e.collisionFilterGroup&t.collisionFilterMask)?!1:0===(t.type&r)&&t.sleepState!==n.SLEEPING||0===(e.type&r)&&e.sleepState!==n.SLEEPING?!0:!1},i.prototype.intersectionTest=function(t,e,i,n){this.useBoundingBoxes?this.doBoundingBoxBroadphase(t,e,i,n):this.doBoundingSphereBroadphase(t,e,i,n)};var s=new a;new a,new o,new a,i.prototype.doBoundingSphereBroadphase=function(t,e,i,n){var a=s;e.position.vsub(t.position,a);var o=Math.pow(t.boundingRadius+e.boundingRadius,2),r=a.norm2();o>r&&(i.push(t),n.push(e))},i.prototype.doBoundingBoxBroadphase=function(t,e,i,n){t.aabbNeedsUpdate&&t.computeAABB(),e.aabbNeedsUpdate&&e.computeAABB(),t.aabb.overlaps(e.aabb)&&(i.push(t),n.push(e))};var h={keys:[]},c=[],l=[];i.prototype.makePairsUnique=function(t,e){for(var i=h,n=c,a=l,o=t.length,r=0;r!==o;r++)n[r]=t[r],a[r]=e[r];t.length=0,e.length=0;for(var r=0;r!==o;r++){var s=n[r].id,p=a[r].id,u=p>s?s+","+p:p+","+s;i[u]=r,i.keys.push(u)}for(var r=0;r!==i.keys.length;r++){var u=i.keys.pop(),d=i[u];t.push(n[d]),e.push(a[d]),delete i[u]}},i.prototype.setWorld=function(){};var p=new a;i.boundingSphereCheck=function(t,e){var i=p;return t.position.vsub(e.position,i),Math.pow(t.shape.boundingSphereRadius+e.shape.boundingSphereRadius,2)>i.norm2()},i.prototype.aabbQuery=function(){return console.warn(".aabbQuery is not implemented in this Broadphase subclass."),[]}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Plane":42,"../shapes/Shape":43}],6:[function(t,e){function i(t,e,i,o,r){n.apply(this),this.nx=i||10,this.ny=o||10,this.nz=r||10,this.aabbMin=t||new a(100,100,100),this.aabbMax=e||new a(-100,-100,-100);var s=this.nx*this.ny*this.nz;if(0>=s)throw"GridBroadphase: Each dimension's n must be >0";this.bins=[],this.binLengths=[],this.bins.length=s,this.binLengths.length=s;for(var h=0;s>h;h++)this.bins[h]=[],this.binLengths[h]=0}e.exports=i;var n=t("./Broadphase"),a=t("../math/Vec3"),o=t("../shapes/Shape");i.prototype=new n,i.prototype.constructor=i;var r=new a;new a,i.prototype.collisionPairs=function(t,e,i){function n(t,e,i,n,a,o,r){var s=0|(t-g)*w,h=0|(e-_)*b,c=0|(i-D)*S,y=L((n-g)*w),v=L((a-_)*b),x=L((o-D)*S);0>s?s=0:s>=l&&(s=l-1),0>h?h=0:h>=p&&(h=p-1),0>c?c=0:c>=u&&(c=u-1),0>y?y=0:y>=l&&(y=l-1),0>v?v=0:v>=p&&(v=p-1),0>x?x=0:x>=u&&(x=u-1),s*=d,h*=m,c*=f,y*=d,v*=m,x*=f;for(var M=s;y>=M;M+=d)for(var C=h;v>=C;C+=m)for(var T=c;x>=T;T+=f){var A=M+C+T;B[A][N[A]++]=r}}var a=t.numObjects(),s=t.bodies,h=this.aabbMax,c=this.aabbMin,l=this.nx,p=this.ny,u=this.nz,d=p*u,m=u,f=1,y=h.x,v=h.y,x=h.z,g=c.x,_=c.y,D=c.z,w=l/(y-g),b=p/(v-_),S=u/(x-D),M=(y-g)/l,C=(v-_)/p,T=(x-D)/u,A=.5*Math.sqrt(M*M+C*C+T*T),I=o.types,E=I.SPHERE,P=I.PLANE;I.BOX,I.COMPOUND,I.CONVEXPOLYHEDRON;for(var B=this.bins,N=this.binLengths,V=this.bins.length,R=0;R!==V;R++)N[R]=0;for(var L=Math.ceil,c=Math.min,h=Math.max,R=0;R!==a;R++){var z=s[R],F=z.shape;switch(F.type){case E:var O=z.position.x,k=z.position.y,j=z.position.z,U=F.radius;n(O-U,k-U,j-U,O+U,k+U,j+U,z);break;case P:F.worldNormalNeedsUpdate&&F.computeWorldNormal(z.quaternion);var X=F.worldNormal,W=g+.5*M-z.position.x,q=_+.5*C-z.position.y,Y=D+.5*T-z.position.z,G=r;G.set(W,q,Y);for(var H=0,Z=0;H!==l;H++,Z+=d,G.y=q,G.x+=M)for(var K=0,Q=0;K!==p;K++,Q+=m,G.z=Y,G.y+=C)for(var J=0,$=0;J!==u;J++,$+=f,G.z+=T)if(A>G.dot(X)){var te=Z+Q+$;B[te][N[te]++]=z}break;default:z.aabbNeedsUpdate&&z.computeAABB(),n(z.aabb.lowerBound.x,z.aabb.lowerBound.y,z.aabb.lowerBound.z,z.aabb.upperBound.x,z.aabb.upperBound.y,z.aabb.upperBound.z,z)}}for(var R=0;R!==V;R++){var ee=N[R];if(ee>1)for(var ie=B[R],H=0;H!==ee;H++)for(var z=ie[H],K=0;K!==H;K++){var ne=ie[K];this.needBroadphaseCollision(z,ne)&&this.intersectionTest(z,ne,e,i)}}this.makePairsUnique(e,i)}},{"../math/Vec3":30,"../shapes/Shape":43,"./Broadphase":5}],7:[function(t,e){function i(){n.apply(this)}e.exports=i;var n=t("./Broadphase"),a=t("./AABB");i.prototype=new n,i.prototype.constructor=i,i.prototype.collisionPairs=function(t,e,i){var n,a,o,r,s=t.bodies,h=s.length;for(n=0;n!==h;n++)for(a=0;a!==n;a++)o=s[n],r=s[a],this.needBroadphaseCollision(o,r)&&this.intersectionTest(o,r,e,i)},new a,i.prototype.aabbQuery=function(t,e,i){i=i||[];for(var n=0;t.bodies.length>n;n++){var a=t.bodies[n];a.aabbNeedsUpdate&&a.computeAABB(),a.aabb.overlaps(e)&&i.push(a)}return i}},{"./AABB":3,"./Broadphase":5}],8:[function(t,e){function i(){this.matrix={}}e.exports=i,i.prototype.get=function(t,e){if(t=t.id,e=e.id,e>t){var i=e;e=t,t=i}return t+"-"+e in this.matrix},i.prototype.set=function(t,e,i){if(t=t.id,e=e.id,e>t){var n=e;e=t,t=n}i?this.matrix[t+"-"+e]=!0:delete this.matrix[t+"-"+e]},i.prototype.reset=function(){this.matrix={}},i.prototype.setNumObjects=function(){}},{}],9:[function(t,e){function i(t,e){this.from=t?t.clone():new o,this.to=e?e.clone():new o,this._direction=new o,this.precision=1e-4,this.checkCollisionResponse=!0,this.skipBackfaces=!1,this.collisionFilterMask=-1,this.collisionFilterGroup=-1,this.mode=i.ANY,this.result=new h,this.hasHit=!1,this.callback=function(){}}function n(t,e,i,n){n.vsub(e,V),i.vsub(e,d),t.vsub(e,m);var a,o,r=V.dot(V),s=V.dot(d),h=V.dot(m),c=d.dot(d),l=d.dot(m);return(a=c*h-s*l)>=0&&(o=r*l-s*h)>=0&&r*c-s*s>a+o}function a(t,e,i){i.vsub(t,V);var n=V.dot(e);e.mult(n,R),R.vadd(t,R);var a=i.distanceTo(R);return a}e.exports=i;var o=t("../math/Vec3"),r=t("../math/Quaternion"),s=t("../math/Transform");t("../shapes/ConvexPolyhedron"),t("../shapes/Box");var h=t("../collision/RaycastResult"),c=t("../shapes/Shape"),l=t("../collision/AABB");i.prototype.constructor=i,i.CLOSEST=1,i.ANY=2,i.ALL=4;var p=new l,u=[];i.prototype.intersectWorld=function(t,e){return this.mode=e.mode||i.ANY,this.result=e.result||new h,this.skipBackfaces=!!e.skipBackfaces,this.collisionFilterMask=e.collisionFilterMask!==void 0?e.collisionFilterMask:-1,this.collisionFilterGroup=e.collisionFilterGroup!==void 0?e.collisionFilterGroup:-1,e.from&&this.from.copy(e.from),e.to&&this.to.copy(e.to),this.callback=e.callback||function(){},this.hasHit=!1,this.result.reset(),this._updateDirection(),this.getAABB(p),u.length=0,t.broadphase.aabbQuery(t,p,u),this.intersectBodies(u),this.hasHit};var d=new o,m=new o;i.pointInTriangle=n;var f=new o,y=new r;i.prototype.intersectBody=function(t,e){e&&(this.result=e,this._updateDirection());var i=this.checkCollisionResponse;if((!i||t.collisionResponse)&&0!==(this.collisionFilterGroup&t.collisionFilterMask)&&0!==(t.collisionFilterGroup&this.collisionFilterMask))for(var n=f,a=y,o=0,r=t.shapes.length;r>o;o++){var s=t.shapes[o];if((!i||s.collisionResponse)&&(t.quaternion.mult(t.shapeOrientations[o],a),t.quaternion.vmult(t.shapeOffsets[o],n),n.vadd(t.position,n),this.intersectShape(s,a,n,t),this.result._shouldStop))break}},i.prototype.intersectBodies=function(t,e){e&&(this.result=e,this._updateDirection());for(var i=0,n=t.length;!this.result._shouldStop&&n>i;i++)this.intersectBody(t[i])},i.prototype._updateDirection=function(){this.to.vsub(this.from,this._direction),this._direction.normalize()},i.prototype.intersectShape=function(t,e,i,n){var o=this.from,r=a(o,this._direction,i);if(!(r>t.boundingSphereRadius)){var s=this[t.type];s&&s.call(this,t,e,i,n)}},new o,new o;var v=new o,x=new o,g=new o,_=new o;new o,new h,i.prototype.intersectBox=function(t,e,i,n){return this.intersectConvex(t.convexPolyhedronRepresentation,e,i,n)},i.prototype[c.types.BOX]=i.prototype.intersectBox,i.prototype.intersectPlane=function(t,e,i,n){var a=this.from,r=this.to,s=this._direction,h=new o(0,0,1);e.vmult(h,h);var c=new o;a.vsub(i,c);var l=c.dot(h);r.vsub(i,c);var p=c.dot(h);if(!(l*p>0||l>a.distanceTo(r))){var u=h.dot(s);if(!(Math.abs(u)<this.precision)){var d=new o,m=new o,f=new o;a.vsub(i,d);var y=-h.dot(d)/u;s.scale(y,m),a.vadd(m,f),this.reportIntersection(h,f,t,n,-1)}}},i.prototype[c.types.PLANE]=i.prototype.intersectPlane,i.prototype.getAABB=function(t){var e=this.to,i=this.from;t.lowerBound.x=Math.min(e.x,i.x),t.lowerBound.y=Math.min(e.y,i.y),t.lowerBound.z=Math.min(e.z,i.z),t.upperBound.x=Math.max(e.x,i.x),t.upperBound.y=Math.max(e.y,i.y),t.upperBound.z=Math.max(e.z,i.z)};var D={faceList:[0]};i.prototype.intersectHeightfield=function(t,e,n,a){var r=(t.data,t.elementSize,new o),h=new i(this.from,this.to);s.pointToLocalFrame(n,e,h.from,h.from),s.pointToLocalFrame(n,e,h.to,h.to);var c=[],l=null,p=null,u=null,d=null,m=t.getIndexOfPosition(h.from.x,h.from.y,c,!1);if(m&&(l=c[0],p=c[1],u=c[0],d=c[1]),m=t.getIndexOfPosition(h.to.x,h.to.y,c,!1),m&&((null===l||l>c[0])&&(l=c[0]),(null===u||c[0]>u)&&(u=c[0]),(null===p||p>c[1])&&(p=c[1]),(null===d||c[1]>d)&&(d=c[1])),null!==l){var f=[];t.getRectMinMax(l,p,u,d,f),f[0],f[1];for(var y=l;u>=y;y++)for(var v=p;d>=v;v++){if(this.result._shouldStop)return;if(t.getConvexTrianglePillar(y,v,!1),s.pointToWorldFrame(n,e,t.pillarOffset,r),this.intersectConvex(t.pillarConvex,e,r,a,D),this.result._shouldStop)return;t.getConvexTrianglePillar(y,v,!0),s.pointToWorldFrame(n,e,t.pillarOffset,r),this.intersectConvex(t.pillarConvex,e,r,a,D)}}},i.prototype[c.types.HEIGHTFIELD]=i.prototype.intersectHeightfield;var w=new o,b=new o;i.prototype.intersectSphere=function(t,e,i,n){var a=this.from,o=this.to,r=t.radius,s=Math.pow(o.x-a.x,2)+Math.pow(o.y-a.y,2)+Math.pow(o.z-a.z,2),h=2*((o.x-a.x)*(a.x-i.x)+(o.y-a.y)*(a.y-i.y)+(o.z-a.z)*(a.z-i.z)),c=Math.pow(a.x-i.x,2)+Math.pow(a.y-i.y,2)+Math.pow(a.z-i.z,2)-Math.pow(r,2),l=Math.pow(h,2)-4*s*c,p=w,u=b;if(!(0>l))if(0===l)a.lerp(o,l,p),p.vsub(i,u),u.normalize(),this.reportIntersection(u,p,t,n,-1);else{var d=(-h-Math.sqrt(l))/(2*s),m=(-h+Math.sqrt(l))/(2*s);if(d>=0&&1>=d&&(a.lerp(o,d,p),p.vsub(i,u),u.normalize(),this.reportIntersection(u,p,t,n,-1)),this.result._shouldStop)return;m>=0&&1>=m&&(a.lerp(o,m,p),p.vsub(i,u),u.normalize(),this.reportIntersection(u,p,t,n,-1))}},i.prototype[c.types.SPHERE]=i.prototype.intersectSphere;var S=new o,M=(new o,new o,new o);i.prototype.intersectConvex=function(t,e,i,a,o){for(var r=S,s=M,h=o&&o.faceList||null,c=t.faces,l=t.vertices,p=t.faceNormals,u=this._direction,d=this.from,m=this.to,f=d.distanceTo(m),y=h?h.length:c.length,D=this.result,w=0;!D._shouldStop&&y>w;w++){var b=h?h[w]:w,C=c[b],T=p[b],A=e,I=i;s.copy(l[C[0]]),A.vmult(s,s),s.vadd(I,s),s.vsub(d,s),A.vmult(T,r);var E=u.dot(r);if(!(Math.abs(E)<this.precision)){var P=r.dot(s)/E;if(!(0>P)){u.mult(P,v),v.vadd(d,v),x.copy(l[C[0]]),A.vmult(x,x),I.vadd(x,x);for(var B=1;!D._shouldStop&&C.length-1>B;B++){g.copy(l[C[B]]),_.copy(l[C[B+1]]),A.vmult(g,g),A.vmult(_,_),I.vadd(g,g),I.vadd(_,_);var N=v.distanceTo(d);!n(v,x,g,_)&&!n(v,g,x,_)||N>f||this.reportIntersection(r,v,t,a,b)}}}}},i.prototype[c.types.CONVEXPOLYHEDRON]=i.prototype.intersectConvex;var C=new o,T=new o,A=new o,I=new o,E=new o,P=new o,B=(new l,[]),N=new s;i.prototype.intersectTrimesh=function(t,e,i,a,o){var r=C,h=B,c=N,l=M,p=T,u=A,d=I,m=P,f=E;o&&o.faceList||null;var y=t.indices;t.vertices,t.faceNormals;var D=this.from,w=this.to,b=this._direction;c.position.copy(i),c.quaternion.copy(e),s.vectorToLocalFrame(i,e,b,p),s.pointToLocalFrame(i,e,D,u),s.pointToLocalFrame(i,e,w,d);var S=u.distanceSquared(d);t.tree.rayQuery(this,c,h);for(var V=0,R=h.length;!this.result._shouldStop&&V!==R;V++){var L=h[V];t.getNormal(L,r),t.getVertex(y[3*L],x),x.vsub(u,l);var z=p.dot(r),F=r.dot(l)/z;if(!(0>F)){p.scale(F,v),v.vadd(u,v),t.getVertex(y[3*L+1],g),t.getVertex(y[3*L+2],_);var O=v.distanceSquared(u);!n(v,g,x,_)&&!n(v,x,g,_)||O>S||(s.vectorToWorldFrame(e,r,f),s.pointToWorldFrame(i,e,v,m),this.reportIntersection(f,m,t,a,L))}}h.length=0},i.prototype[c.types.TRIMESH]=i.prototype.intersectTrimesh,i.prototype.reportIntersection=function(t,e,n,a,o){var r=this.from,s=this.to,h=r.distanceTo(e),c=this.result;if(!(this.skipBackfaces&&t.dot(this._direction)>0))switch(c.hitFaceIndex=o!==void 0?o:-1,this.mode){case i.ALL:this.hasHit=!0,c.set(r,s,t,e,n,a,h),c.hasHit=!0,this.callback(c);break;case i.CLOSEST:(c.distance>h||!c.hasHit)&&(this.hasHit=!0,c.hasHit=!0,c.set(r,s,t,e,n,a,h));break;case i.ANY:this.hasHit=!0,c.hasHit=!0,c.set(r,s,t,e,n,a,h),c._shouldStop=!0}};var V=new o,R=new o},{"../collision/AABB":3,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/Box":37,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43}],10:[function(t,e){function i(){this.rayFromWorld=new n,this.rayToWorld=new n,this.hitNormalWorld=new n,this.hitPointWorld=new n,this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1}var n=t("../math/Vec3");e.exports=i,i.prototype.reset=function(){this.rayFromWorld.setZero(),this.rayToWorld.setZero(),this.hitNormalWorld.setZero(),this.hitPointWorld.setZero(),this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1},i.prototype.abort=function(){this._shouldStop=!0},i.prototype.set=function(t,e,i,n,a,o,r){this.rayFromWorld.copy(t),this.rayToWorld.copy(e),this.hitNormalWorld.copy(i),this.hitPointWorld.copy(n),this.shape=a,this.body=o,this.distance=r}},{"../math/Vec3":30}],11:[function(t,e){function i(t){n.apply(this),this.axisList=[],this.world=null,this.axisIndex=0;var e=this.axisList;this._addBodyHandler=function(t){e.push(t.body)},this._removeBodyHandler=function(t){var i=e.indexOf(t.body);-1!==i&&e.splice(i,1)},t&&this.setWorld(t)}t("../shapes/Shape");var n=t("../collision/Broadphase");e.exports=i,i.prototype=new n,i.prototype.setWorld=function(t){this.axisList.length=0;for(var e=0;t.bodies.length>e;e++)this.axisList.push(t.bodies[e]);t.removeEventListener("addBody",this._addBodyHandler),t.removeEventListener("removeBody",this._removeBodyHandler),t.addEventListener("addBody",this._addBodyHandler),t.addEventListener("removeBody",this._removeBodyHandler),this.world=t,this.dirty=!0},i.insertionSortX=function(t){for(var e=1,i=t.length;i>e;e++){for(var n=t[e],a=e-1;a>=0&&!(t[a].aabb.lowerBound.x<=n.aabb.lowerBound.x);a--)t[a+1]=t[a];t[a+1]=n}return t},i.insertionSortY=function(t){for(var e=1,i=t.length;i>e;e++){for(var n=t[e],a=e-1;a>=0&&!(t[a].aabb.lowerBound.y<=n.aabb.lowerBound.y);a--)t[a+1]=t[a];t[a+1]=n}return t},i.insertionSortZ=function(t){for(var e=1,i=t.length;i>e;e++){for(var n=t[e],a=e-1;a>=0&&!(t[a].aabb.lowerBound.z<=n.aabb.lowerBound.z);a--)t[a+1]=t[a];t[a+1]=n}return t},i.prototype.collisionPairs=function(t,e,n){var a,o,r=this.axisList,s=r.length,h=this.axisIndex;for(this.dirty&&(this.sortList(),this.dirty=!1),a=0;a!==s;a++){var c=r[a];for(o=a+1;s>o;o++){var l=r[o];if(this.needBroadphaseCollision(c,l)){if(!i.checkBounds(c,l,h))break;this.intersectionTest(c,l,e,n)}}}},i.prototype.sortList=function(){for(var t=this.axisList,e=this.axisIndex,n=t.length,a=0;a!==n;a++){var o=t[a];o.aabbNeedsUpdate&&o.computeAABB()}0===e?i.insertionSortX(t):1===e?i.insertionSortY(t):2===e&&i.insertionSortZ(t)},i.checkBounds=function(t,e,i){var n,a;0===i?(n=t.position.x,a=e.position.x):1===i?(n=t.position.y,a=e.position.y):2===i&&(n=t.position.z,a=e.position.z);var o=t.boundingRadius,r=e.boundingRadius,s=n+o,h=a-r;return s>h},i.prototype.autoDetectAxis=function(){for(var t=0,e=0,i=0,n=0,a=0,o=0,r=this.axisList,s=r.length,h=1/s,c=0;c!==s;c++){var l=r[c],p=l.position.x;t+=p,e+=p*p;var u=l.position.y;i+=u,n+=u*u;var d=l.position.z;a+=d,o+=d*d}var m=e-t*t*h,f=n-i*i*h,y=o-a*a*h;this.axisIndex=m>f?m>y?0:2:f>y?1:2},i.prototype.aabbQuery=function(t,e,i){i=i||[],this.dirty&&(this.sortList(),this.dirty=!1);var n=this.axisIndex,a="x";1===n&&(a="y"),2===n&&(a="z");
var o=this.axisList;e.lowerBound[a],e.upperBound[a];for(var r=0;o.length>r;r++){var s=o[r];s.aabbNeedsUpdate&&s.computeAABB(),s.aabb.overlaps(e)&&i.push(s)}return i}},{"../collision/Broadphase":5,"../shapes/Shape":43}],12:[function(t,e){function i(t,e,i){i=i||{};var s=i.maxForce!==void 0?i.maxForce:1e6,h=i.pivotA?i.pivotA.clone():new r,c=i.pivotB?i.pivotB.clone():new r;this.axisA=i.axisA?i.axisA.clone():new r,this.axisB=i.axisB?i.axisB.clone():new r,n.call(this,t,h,e,c,s),this.collideConnected=!!i.collideConnected,this.angle=i.angle!==void 0?i.angle:0;var l=this.coneEquation=new a(t,e,i),p=this.twistEquation=new o(t,e,i);this.twistAngle=i.twistAngle!==void 0?i.twistAngle:0,l.maxForce=0,l.minForce=-s,p.maxForce=0,p.minForce=-s,this.equations.push(l,p)}e.exports=i,t("./Constraint");var n=t("./PointToPointConstraint"),a=t("../equations/ConeEquation"),o=t("../equations/RotationalEquation");t("../equations/ContactEquation");var r=t("../math/Vec3");i.prototype=new n,i.constructor=i,new r,new r,i.prototype.update=function(){var t=this.bodyA,e=this.bodyB,i=this.coneEquation,a=this.twistEquation;n.prototype.update.call(this),t.vectorToWorldFrame(this.axisA,i.axisA),e.vectorToWorldFrame(this.axisB,i.axisB),this.axisA.tangents(a.axisA,a.axisA),t.vectorToWorldFrame(a.axisA,a.axisA),this.axisB.tangents(a.axisB,a.axisB),e.vectorToWorldFrame(a.axisB,a.axisB),i.angle=this.angle,a.maxAngle=this.twistAngle}},{"../equations/ConeEquation":18,"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],13:[function(t,e){function i(t,e,a){a=n.defaults(a,{collideConnected:!0,wakeUpBodies:!0}),this.equations=[],this.bodyA=t,this.bodyB=e,this.id=i.idCounter++,this.collideConnected=a.collideConnected,a.wakeUpBodies&&(t&&t.wakeUp(),e&&e.wakeUp())}e.exports=i;var n=t("../utils/Utils");i.prototype.update=function(){throw Error("method update() not implmemented in this Constraint subclass!")},i.prototype.enable=function(){for(var t=this.equations,e=0;t.length>e;e++)t[e].enabled=!0},i.prototype.disable=function(){for(var t=this.equations,e=0;t.length>e;e++)t[e].enabled=!1},i.idCounter=0},{"../utils/Utils":53}],14:[function(t,e){function i(t,e,i,o){n.call(this,t,e),i===void 0&&(i=t.position.distanceTo(e.position)),o===void 0&&(o=1e6),this.distance=i;var r=this.distanceEquation=new a(t,e);this.equations.push(r),r.minForce=-o,r.maxForce=o}e.exports=i;var n=t("./Constraint"),a=t("../equations/ContactEquation");i.prototype=new n,i.prototype.update=function(){var t=this.bodyA,e=this.bodyB,i=this.distanceEquation,n=.5*this.distance,a=i.ni;e.position.vsub(t.position,a),a.normalize(),a.mult(n,i.ri),a.mult(-n,i.rj)}},{"../equations/ContactEquation":19,"./Constraint":13}],15:[function(t,e){function i(t,e,i){i=i||{};var s=i.maxForce!==void 0?i.maxForce:1e6,h=i.pivotA?i.pivotA.clone():new r,c=i.pivotB?i.pivotB.clone():new r;n.call(this,t,h,e,c,s);var l=this.axisA=i.axisA?i.axisA.clone():new r(1,0,0);l.normalize();var p=this.axisB=i.axisB?i.axisB.clone():new r(1,0,0);p.normalize();var u=this.rotationalEquation1=new a(t,e,i),d=this.rotationalEquation2=new a(t,e,i),m=this.motorEquation=new o(t,e,s);m.enabled=!1,this.equations.push(u,d,m)}e.exports=i,t("./Constraint");var n=t("./PointToPointConstraint"),a=t("../equations/RotationalEquation"),o=t("../equations/RotationalMotorEquation");t("../equations/ContactEquation");var r=t("../math/Vec3");i.prototype=new n,i.constructor=i,i.prototype.enableMotor=function(){this.motorEquation.enabled=!0},i.prototype.disableMotor=function(){this.motorEquation.enabled=!1},i.prototype.setMotorSpeed=function(t){this.motorEquation.targetVelocity=t},i.prototype.setMotorMaxForce=function(t){this.motorEquation.maxForce=t,this.motorEquation.minForce=-t};var s=new r,h=new r;i.prototype.update=function(){var t=this.bodyA,e=this.bodyB,i=this.motorEquation,a=this.rotationalEquation1,o=this.rotationalEquation2,r=s,c=h,l=this.axisA,p=this.axisB;n.prototype.update.call(this),t.quaternion.vmult(l,r),e.quaternion.vmult(p,c),r.tangents(a.axisA,o.axisA),a.axisB.copy(c),o.axisB.copy(c),this.motorEquation.enabled&&(t.quaternion.vmult(this.axisA,i.axisA),e.quaternion.vmult(this.axisB,i.axisB))}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],16:[function(t,e){function i(t,e,i){i=i||{};var r=i.maxForce!==void 0?i.maxForce:1e6,s=new o,h=new o,c=new o;t.position.vadd(e.position,c),c.scale(.5,c),e.pointToLocalFrame(c,h),t.pointToLocalFrame(c,s),n.call(this,t,s,e,h,r);var l=this.rotationalEquation1=new a(t,e,i),p=this.rotationalEquation2=new a(t,e,i),u=this.rotationalEquation3=new a(t,e,i);this.equations.push(l,p,u)}e.exports=i,t("./Constraint");var n=t("./PointToPointConstraint"),a=t("../equations/RotationalEquation");t("../equations/RotationalMotorEquation"),t("../equations/ContactEquation");var o=t("../math/Vec3");i.prototype=new n,i.constructor=i;{new o,new o}i.prototype.update=function(){var t=this.bodyA,e=this.bodyB,i=(this.motorEquation,this.rotationalEquation1),a=this.rotationalEquation2,r=this.rotationalEquation3;n.prototype.update.call(this),t.vectorToWorldFrame(o.UNIT_X,i.axisA),e.vectorToWorldFrame(o.UNIT_Y,i.axisB),t.vectorToWorldFrame(o.UNIT_Y,a.axisA),e.vectorToWorldFrame(o.UNIT_Z,a.axisB),t.vectorToWorldFrame(o.UNIT_Z,r.axisA),e.vectorToWorldFrame(o.UNIT_X,r.axisB)}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],17:[function(t,e){function i(t,e,i,r,s){n.call(this,t,i),s=s!==void 0?s:1e6,this.pivotA=e?e.clone():new o,this.pivotB=r?r.clone():new o;var h=this.equationX=new a(t,i),c=this.equationY=new a(t,i),l=this.equationZ=new a(t,i);this.equations.push(h,c,l),h.minForce=c.minForce=l.minForce=-s,h.maxForce=c.maxForce=l.maxForce=s,h.ni.set(1,0,0),c.ni.set(0,1,0),l.ni.set(0,0,1)}e.exports=i;var n=t("./Constraint"),a=t("../equations/ContactEquation"),o=t("../math/Vec3");i.prototype=new n,i.prototype.update=function(){var t=this.bodyA,e=this.bodyB,i=this.equationX,n=this.equationY,a=this.equationZ;t.quaternion.vmult(this.pivotA,i.ri),e.quaternion.vmult(this.pivotB,i.rj),n.ri.copy(i.ri),n.rj.copy(i.rj),a.ri.copy(i.ri),a.rj.copy(i.rj)}},{"../equations/ContactEquation":19,"../math/Vec3":30,"./Constraint":13}],18:[function(t,e){function i(t,e,i){i=i||{};var o=i.maxForce!==void 0?i.maxForce:1e6;a.call(this,t,e,-o,o),this.axisA=i.axisA?i.axisA.clone():new n(1,0,0),this.axisB=i.axisB?i.axisB.clone():new n(0,1,0),this.angle=i.angle!==void 0?i.angle:0}e.exports=i;var n=t("../math/Vec3");t("../math/Mat3");var a=t("./Equation");i.prototype=new a,i.prototype.constructor=i;var o=new n,r=new n;i.prototype.computeB=function(t){var e=this.a,i=this.b,n=this.axisA,a=this.axisB,s=o,h=r,c=this.jacobianElementA,l=this.jacobianElementB;n.cross(a,s),a.cross(n,h),c.rotational.copy(h),l.rotational.copy(s);var p=Math.cos(this.angle)-n.dot(a),u=this.computeGW(),d=this.computeGiMf(),m=-p*e-u*i-t*d;return m}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],19:[function(t,e){function i(t,e,i){i=i!==void 0?i:1e6,n.call(this,t,e,0,i),this.restitution=0,this.ri=new a,this.rj=new a,this.ni=new a}e.exports=i;var n=t("./Equation"),a=t("../math/Vec3");t("../math/Mat3"),i.prototype=new n,i.prototype.constructor=i;var o=new a,r=new a,s=new a;i.prototype.computeB=function(t){var e=this.a,i=this.b,n=this.bi,a=this.bj,h=this.ri,c=this.rj,l=o,p=r,u=n.velocity,d=n.angularVelocity,m=(n.force,n.torque,a.velocity),f=a.angularVelocity,y=(a.force,a.torque,s),v=this.jacobianElementA,x=this.jacobianElementB,g=this.ni;h.cross(g,l),c.cross(g,p),g.negate(v.spatial),l.negate(v.rotational),x.spatial.copy(g),x.rotational.copy(p),y.copy(a.position),y.vadd(c,y),y.vsub(n.position,y),y.vsub(h,y);var _=g.dot(y),D=this.restitution+1,w=D*m.dot(g)-D*u.dot(g)+f.dot(p)-d.dot(l),b=this.computeGiMf(),S=-_*e-w*i-t*b;return S};var h=new a,c=new a,l=new a,p=new a,u=new a;i.prototype.getImpactVelocityAlongNormal=function(){var t=h,e=c,i=l,n=p,a=u;return this.bi.position.vadd(this.ri,i),this.bj.position.vadd(this.rj,n),this.bi.getVelocityAtWorldPoint(i,t),this.bj.getVelocityAtWorldPoint(n,e),t.vsub(e,a),this.ni.dot(a)}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],20:[function(t,e){function i(t,e,a,o){this.id=i.id++,this.minForce=a===void 0?-1e6:a,this.maxForce=o===void 0?1e6:o,this.bi=t,this.bj=e,this.a=0,this.b=0,this.eps=0,this.jacobianElementA=new n,this.jacobianElementB=new n,this.enabled=!0,this.setSpookParams(1e7,4,1/60)}e.exports=i;var n=t("../math/JacobianElement"),a=t("../math/Vec3");i.prototype.constructor=i,i.id=0,i.prototype.setSpookParams=function(t,e,i){var n=e,a=t,o=i;this.a=4/(o*(1+4*n)),this.b=4*n/(1+4*n),this.eps=4/(o*o*a*(1+4*n))},i.prototype.computeB=function(t,e,i){var n=this.computeGW(),a=this.computeGq(),o=this.computeGiMf();return-a*t-n*e-o*i},i.prototype.computeGq=function(){var t=this.jacobianElementA,e=this.jacobianElementB,i=this.bi,n=this.bj,a=i.position,o=n.position;return t.spatial.dot(a)+e.spatial.dot(o)};var o=new a;i.prototype.computeGW=function(){var t=this.jacobianElementA,e=this.jacobianElementB,i=this.bi,n=this.bj,a=i.velocity,r=n.velocity,s=i.angularVelocity||o,h=n.angularVelocity||o;return t.multiplyVectors(a,s)+e.multiplyVectors(r,h)},i.prototype.computeGWlambda=function(){var t=this.jacobianElementA,e=this.jacobianElementB,i=this.bi,n=this.bj,a=i.vlambda,r=n.vlambda,s=i.wlambda||o,h=n.wlambda||o;return t.multiplyVectors(a,s)+e.multiplyVectors(r,h)};var r=new a,s=new a,h=new a,c=new a;i.prototype.computeGiMf=function(){var t=this.jacobianElementA,e=this.jacobianElementB,i=this.bi,n=this.bj,a=i.force,o=i.torque,l=n.force,p=n.torque,u=i.invMassSolve,d=n.invMassSolve;return i.invInertiaWorldSolve?i.invInertiaWorldSolve.vmult(o,h):h.set(0,0,0),n.invInertiaWorldSolve?n.invInertiaWorldSolve.vmult(p,c):c.set(0,0,0),a.mult(u,r),l.mult(d,s),t.multiplyVectors(r,h)+e.multiplyVectors(s,c)};var l=new a;i.prototype.computeGiMGt=function(){var t=this.jacobianElementA,e=this.jacobianElementB,i=this.bi,n=this.bj,a=i.invMassSolve,o=n.invMassSolve,r=i.invInertiaWorldSolve,s=n.invInertiaWorldSolve,h=a+o;return r&&(r.vmult(t.rotational,l),h+=l.dot(t.rotational)),s&&(s.vmult(e.rotational,l),h+=l.dot(e.rotational)),h};var p=new a;new a,new a,new a,new a,new a,i.prototype.addToWlambda=function(t){var e=this.jacobianElementA,i=this.jacobianElementB,n=this.bi,a=this.bj,o=p;e.spatial.mult(n.invMassSolve*t,o),1==n.gameType&&2==a.gameType&&(o.x=0,o.y=0),n.vlambda.vadd(o,n.vlambda),i.spatial.mult(a.invMassSolve*t,o),a.vlambda.vadd(o,a.vlambda),n.invInertiaWorldSolve&&(n.invInertiaWorldSolve.vmult(e.rotational,o),o.mult(t,o),n.wlambda.vadd(o,n.wlambda)),a.invInertiaWorldSolve&&(a.invInertiaWorldSolve.vmult(i.rotational,o),o.mult(t,o),a.wlambda.vadd(o,a.wlambda))},i.prototype.computeC=function(){return this.computeGiMGt()+this.eps}},{"../math/JacobianElement":26,"../math/Vec3":30}],21:[function(t,e){function i(t,e,i){n.call(this,t,e,-i,i),this.ri=new a,this.rj=new a,this.t=new a}e.exports=i;var n=t("./Equation"),a=t("../math/Vec3");t("../math/Mat3"),i.prototype=new n,i.prototype.constructor=i;var o=new a,r=new a;i.prototype.computeB=function(t){var e=(this.a,this.b),i=(this.bi,this.bj,this.ri),n=this.rj,a=o,s=r,h=this.t;i.cross(h,a),n.cross(h,s);var c=this.jacobianElementA,l=this.jacobianElementB;h.negate(c.spatial),a.negate(c.rotational),l.spatial.copy(h),l.rotational.copy(s);var p=this.computeGW(),u=this.computeGiMf(),d=-p*e-t*u;return d}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],22:[function(t,e){function i(t,e,i){i=i||{};var o=i.maxForce!==void 0?i.maxForce:1e6;a.call(this,t,e,-o,o),this.axisA=i.axisA?i.axisA.clone():new n(1,0,0),this.axisB=i.axisB?i.axisB.clone():new n(0,1,0),this.maxAngle=Math.PI/2}e.exports=i;var n=t("../math/Vec3");t("../math/Mat3");var a=t("./Equation");i.prototype=new a,i.prototype.constructor=i;var o=new n,r=new n;i.prototype.computeB=function(t){var e=this.a,i=this.b,n=this.axisA,a=this.axisB,s=o,h=r,c=this.jacobianElementA,l=this.jacobianElementB;n.cross(a,s),a.cross(n,h),c.rotational.copy(h),l.rotational.copy(s);var p=Math.cos(this.maxAngle)-n.dot(a),u=this.computeGW(),d=this.computeGiMf(),m=-p*e-u*i-t*d;return m}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],23:[function(t,e){function i(t,e,i){i=i!==void 0?i:1e6,a.call(this,t,e,-i,i),this.axisA=new n,this.axisB=new n,this.targetVelocity=0}e.exports=i;var n=t("../math/Vec3");t("../math/Mat3");var a=t("./Equation");i.prototype=new a,i.prototype.constructor=i,i.prototype.computeB=function(t){var e=(this.a,this.b),i=(this.bi,this.bj,this.axisA),n=this.axisB,a=this.jacobianElementA,o=this.jacobianElementB;a.rotational.copy(i),n.negate(o.rotational);var r=this.computeGW()-this.targetVelocity,s=this.computeGiMf(),h=-r*e-t*s;return h}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],24:[function(t,e){function i(t,e,a){a=n.defaults(a,{friction:.3,restitution:.3,contactEquationStiffness:1e7,contactEquationRelaxation:3,frictionEquationStiffness:1e7,frictionEquationRelaxation:3}),this.id=i.idCounter++,this.materials=[t,e],this.friction=a.friction,this.restitution=a.restitution,this.contactEquationStiffness=a.contactEquationStiffness,this.contactEquationRelaxation=a.contactEquationRelaxation,this.frictionEquationStiffness=a.frictionEquationStiffness,this.frictionEquationRelaxation=a.frictionEquationRelaxation}var n=t("../utils/Utils");e.exports=i,i.idCounter=0},{"../utils/Utils":53}],25:[function(t,e){function i(t){var e="";t=t||{},"string"==typeof t?(e=t,t={}):"object"==typeof t&&(e=""),this.name=e,this.id=i.idCounter++,this.friction=t.friction!==void 0?t.friction:-1,this.restitution=t.restitution!==void 0?t.restitution:-1}e.exports=i,i.idCounter=0},{}],26:[function(t,e){function i(){this.spatial=new n,this.rotational=new n}e.exports=i;var n=t("./Vec3");i.prototype.multiplyElement=function(t){return t.spatial.dot(this.spatial)+t.rotational.dot(this.rotational)},i.prototype.multiplyVectors=function(t,e){return t.dot(this.spatial)+e.dot(this.rotational)}},{"./Vec3":30}],27:[function(t,e){function i(t){this.elements=t?t:[0,0,0,0,0,0,0,0,0]}e.exports=i;var n=t("./Vec3");i.prototype.identity=function(){var t=this.elements;t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1},i.prototype.setZero=function(){var t=this.elements;t[0]=0,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=0,t[6]=0,t[7]=0,t[8]=0},i.prototype.setTrace=function(t){var e=this.elements;e[0]=t.x,e[4]=t.y,e[8]=t.z},i.prototype.getTrace=function(t){var t=t||new n,e=this.elements;t.x=e[0],t.y=e[4],t.z=e[8]},i.prototype.vmult=function(t,e){e=e||new n;var i=this.elements,a=t.x,o=t.y,r=t.z;return e.x=i[0]*a+i[1]*o+i[2]*r,e.y=i[3]*a+i[4]*o+i[5]*r,e.z=i[6]*a+i[7]*o+i[8]*r,e},i.prototype.smult=function(t){for(var e=0;this.elements.length>e;e++)this.elements[e]*=t},i.prototype.mmult=function(t,e){for(var n=e||new i,a=0;3>a;a++)for(var o=0;3>o;o++){for(var r=0,s=0;3>s;s++)r+=t.elements[a+3*s]*this.elements[s+3*o];n.elements[a+3*o]=r}return n},i.prototype.scale=function(t,e){e=e||new i;for(var n=this.elements,a=e.elements,o=0;3!==o;o++)a[3*o+0]=t.x*n[3*o+0],a[3*o+1]=t.y*n[3*o+1],a[3*o+2]=t.z*n[3*o+2];return e},i.prototype.solve=function(t,e){e=e||new n;for(var i=3,a=4,o=[],r=0;i*a>r;r++)o.push(0);var r,s;for(r=0;3>r;r++)for(s=0;3>s;s++)o[r+a*s]=this.elements[r+3*s];o[3]=t.x,o[7]=t.y,o[11]=t.z;var h,c,l=3,p=l,u=4;do{if(r=p-l,0===o[r+a*r])for(s=r+1;p>s;s++)if(0!==o[r+a*s]){h=u;do c=u-h,o[c+a*r]+=o[c+a*s];while(--h);break}if(0!==o[r+a*r])for(s=r+1;p>s;s++){var d=o[r+a*s]/o[r+a*r];h=u;do c=u-h,o[c+a*s]=r>=c?0:o[c+a*s]-o[c+a*r]*d;while(--h)}}while(--l);if(e.z=o[2*a+3]/o[2*a+2],e.y=(o[1*a+3]-o[1*a+2]*e.z)/o[1*a+1],e.x=(o[0*a+3]-o[0*a+2]*e.z-o[0*a+1]*e.y)/o[0*a+0],isNaN(e.x)||isNaN(e.y)||isNaN(e.z)||1/0===e.x||1/0===e.y||1/0===e.z)throw"Could not solve equation! Got x=["+(""+e)+"], b=["+(""+t)+"], A=["+(""+this)+"]";return e},i.prototype.e=function(t,e,i){return void 0===i?this.elements[e+3*t]:(this.elements[e+3*t]=i,void 0)},i.prototype.copy=function(t){for(var e=0;t.elements.length>e;e++)this.elements[e]=t.elements[e];return this},i.prototype.toString=function(){for(var t="",e=",",i=0;9>i;i++)t+=this.elements[i]+e;return t},i.prototype.reverse=function(t){t=t||new i;for(var e=3,n=6,a=[],o=0;e*n>o;o++)a.push(0);var o,r;for(o=0;3>o;o++)for(r=0;3>r;r++)a[o+n*r]=this.elements[o+3*r];a[3]=1,a[9]=0,a[15]=0,a[4]=0,a[10]=1,a[16]=0,a[5]=0,a[11]=0,a[17]=1;var s,h,c=3,l=c,p=n;do{if(o=l-c,0===a[o+n*o])for(r=o+1;l>r;r++)if(0!==a[o+n*r]){s=p;do h=p-s,a[h+n*o]+=a[h+n*r];while(--s);break}if(0!==a[o+n*o])for(r=o+1;l>r;r++){var u=a[o+n*r]/a[o+n*o];s=p;do h=p-s,a[h+n*r]=o>=h?0:a[h+n*r]-a[h+n*o]*u;while(--s)}}while(--c);o=2;do{r=o-1;do{var u=a[o+n*r]/a[o+n*o];s=n;do h=n-s,a[h+n*r]=a[h+n*r]-a[h+n*o]*u;while(--s)}while(r--)}while(--o);o=2;do{var u=1/a[o+n*o];s=n;do h=n-s,a[h+n*o]=a[h+n*o]*u;while(--s)}while(o--);o=2;do{r=2;do{if(h=a[e+r+n*o],isNaN(h)||1/0===h)throw"Could not reverse! A=["+(""+this)+"]";t.e(o,r,h)}while(r--)}while(o--);return t},i.prototype.setRotationFromQuaternion=function(t){var e=t.x,i=t.y,n=t.z,a=t.w,o=e+e,r=i+i,s=n+n,h=e*o,c=e*r,l=e*s,p=i*r,u=i*s,d=n*s,m=a*o,f=a*r,y=a*s,v=this.elements;return v[0]=1-(p+d),v[1]=c-y,v[2]=l+f,v[3]=c+y,v[4]=1-(h+d),v[5]=u-m,v[6]=l-f,v[7]=u+m,v[8]=1-(h+p),this},i.prototype.transpose=function(t){t=t||new i;for(var e=t.elements,n=this.elements,a=0;3!==a;a++)for(var o=0;3!==o;o++)e[3*a+o]=n[3*o+a];return t}},{"./Vec3":30}],28:[function(t,e){function i(t,e,i,n){this.x=void 0!==t?t:0,this.y=void 0!==e?e:0,this.z=void 0!==i?i:0,this.w=void 0!==n?n:1}e.exports=i;var n=t("./Vec3");i.prototype.set=function(t,e,i,n){this.x=t,this.y=e,this.z=i,this.w=n},i.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},i.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]},i.prototype.setFromAxisAngle=function(t,e){var i=Math.sin(.5*e);this.x=t.x*i,this.y=t.y*i,this.z=t.z*i,this.w=Math.cos(.5*e)},i.prototype.toAxisAngle=function(t){t=t||new n,this.normalize();var e=2*Math.acos(this.w),i=Math.sqrt(1-this.w*this.w);return.001>i?(t.x=this.x,t.y=this.y,t.z=this.z):(t.x=this.x/i,t.y=this.y/i,t.z=this.z/i),[t,e]};var a=new n,o=new n;i.prototype.setFromVectors=function(t,e){if(t.isAntiparallelTo(e)){var i=a,n=o;t.tangents(i,n),this.setFromAxisAngle(i,Math.PI)}else{var r=t.cross(e);this.x=r.x,this.y=r.y,this.z=r.z,this.w=Math.sqrt(Math.pow(t.norm(),2)*Math.pow(e.norm(),2))+t.dot(e),this.normalize()}};var r=new n,s=new n,h=new n;i.prototype.mult=function(t,e){e=e||new i;var n=this.w,a=r,o=s,c=h;return a.set(this.x,this.y,this.z),o.set(t.x,t.y,t.z),e.w=n*t.w-a.dot(o),a.cross(o,c),e.x=n*o.x+t.w*a.x+c.x,e.y=n*o.y+t.w*a.y+c.y,e.z=n*o.z+t.w*a.z+c.z,e},i.prototype.inverse=function(t){var e=this.x,n=this.y,a=this.z,o=this.w;t=t||new i,this.conjugate(t);var r=1/(e*e+n*n+a*a+o*o);return t.x*=r,t.y*=r,t.z*=r,t.w*=r,t},i.prototype.conjugate=function(t){return t=t||new i,t.x=-this.x,t.y=-this.y,t.z=-this.z,t.w=this.w,t},i.prototype.normalize=function(){var t=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);0===t?(this.x=0,this.y=0,this.z=0,this.w=0):(t=1/t,this.x*=t,this.y*=t,this.z*=t,this.w*=t)},i.prototype.normalizeFast=function(){var t=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;0===t?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=t,this.y*=t,this.z*=t,this.w*=t)},i.prototype.vmult=function(t,e){e=e||new n;var i=t.x,a=t.y,o=t.z,r=this.x,s=this.y,h=this.z,c=this.w,l=c*i+s*o-h*a,p=c*a+h*i-r*o,u=c*o+r*a-s*i,d=-r*i-s*a-h*o;return e.x=l*c+d*-r+p*-h-u*-s,e.y=p*c+d*-s+u*-r-l*-h,e.z=u*c+d*-h+l*-s-p*-r,e},i.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this},i.prototype.toEuler=function(t,e){e=e||"YZX";var i,n,a,o=this.x,r=this.y,s=this.z,h=this.w;switch(e){case"YZX":var c=o*r+s*h;if(c>.499&&(i=2*Math.atan2(o,h),n=Math.PI/2,a=0),-.499>c&&(i=-2*Math.atan2(o,h),n=-Math.PI/2,a=0),isNaN(i)){var l=o*o,p=r*r,u=s*s;i=Math.atan2(2*r*h-2*o*s,1-2*p-2*u),n=Math.asin(2*c),a=Math.atan2(2*o*h-2*r*s,1-2*l-2*u)}break;default:throw Error("Euler order "+e+" not supported yet.")}t.y=i,t.z=n,t.x=a},i.prototype.setFromEuler=function(t,e,i,n){n=n||"XYZ";var a=Math.cos(t/2),o=Math.cos(e/2),r=Math.cos(i/2),s=Math.sin(t/2),h=Math.sin(e/2),c=Math.sin(i/2);return"XYZ"===n?(this.x=s*o*r+a*h*c,this.y=a*h*r-s*o*c,this.z=a*o*c+s*h*r,this.w=a*o*r-s*h*c):"YXZ"===n?(this.x=s*o*r+a*h*c,this.y=a*h*r-s*o*c,this.z=a*o*c-s*h*r,this.w=a*o*r+s*h*c):"ZXY"===n?(this.x=s*o*r-a*h*c,this.y=a*h*r+s*o*c,this.z=a*o*c+s*h*r,this.w=a*o*r-s*h*c):"ZYX"===n?(this.x=s*o*r-a*h*c,this.y=a*h*r+s*o*c,this.z=a*o*c-s*h*r,this.w=a*o*r+s*h*c):"YZX"===n?(this.x=s*o*r+a*h*c,this.y=a*h*r+s*o*c,this.z=a*o*c-s*h*r,this.w=a*o*r-s*h*c):"XZY"===n&&(this.x=s*o*r-a*h*c,this.y=a*h*r-s*o*c,this.z=a*o*c+s*h*r,this.w=a*o*r+s*h*c),this},i.prototype.clone=function(){return new i(this.x,this.y,this.z,this.w)}},{"./Vec3":30}],29:[function(t,e){function i(t){t=t||{},this.position=new n,t.position&&this.position.copy(t.position),this.quaternion=new a,t.quaternion&&this.quaternion.copy(t.quaternion)}var n=t("./Vec3"),a=t("./Quaternion");e.exports=i;var o=new a;i.pointToLocalFrame=function(t,e,i,a){var a=a||new n;return i.vsub(t,a),e.conjugate(o),o.vmult(a,a),a},i.prototype.pointToLocal=function(t,e){return i.pointToLocalFrame(this.position,this.quaternion,t,e)},i.pointToWorldFrame=function(t,e,i,a){var a=a||new n;return e.vmult(i,a),a.vadd(t,a),a},i.prototype.pointToWorld=function(t,e){return i.pointToWorldFrame(this.position,this.quaternion,t,e)},i.prototype.vectorToWorldFrame=function(t,e){var e=e||new n;return this.quaternion.vmult(t,e),e},i.vectorToWorldFrame=function(t,e,i){return t.vmult(e,i),i},i.vectorToLocalFrame=function(t,e,i,a){var a=a||new n;return e.w*=-1,e.vmult(i,a),e.w*=-1,a}},{"./Quaternion":28,"./Vec3":30}],30:[function(t,e){function i(t,e,i){this.x=t||0,this.y=e||0,this.z=i||0}e.exports=i;var n=t("./Mat3");i.ZERO=new i(0,0,0),i.UNIT_X=new i(1,0,0),i.UNIT_Y=new i(0,1,0),i.UNIT_Z=new i(0,0,1),i.prototype.cross=function(t,e){var n=t.x,a=t.y,o=t.z,r=this.x,s=this.y,h=this.z;return e=e||new i,e.x=s*o-h*a,e.y=h*n-r*o,e.z=r*a-s*n,e},i.prototype.set=function(t,e,i){return this.x=t,this.y=e,this.z=i,this},i.prototype.setZero=function(){this.x=this.y=this.z=0},i.prototype.vadd=function(t,e){return e?(e.x=t.x+this.x,e.y=t.y+this.y,e.z=t.z+this.z,void 0):new i(this.x+t.x,this.y+t.y,this.z+t.z)},i.prototype.vsub=function(t,e){return e?(e.x=this.x-t.x,e.y=this.y-t.y,e.z=this.z-t.z,void 0):new i(this.x-t.x,this.y-t.y,this.z-t.z)},i.prototype.crossmat=function(){return new n([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])},i.prototype.normalize=function(){var t=this.x,e=this.y,i=this.z,n=Math.sqrt(t*t+e*e+i*i);if(n>0){var a=1/n;this.x*=a,this.y*=a,this.z*=a}else this.x=0,this.y=0,this.z=0;return n},i.prototype.unit=function(t){t=t||new i;var e=this.x,n=this.y,a=this.z,o=Math.sqrt(e*e+n*n+a*a);return o>0?(o=1/o,t.x=e*o,t.y=n*o,t.z=a*o):(t.x=1,t.y=0,t.z=0),t},i.prototype.norm=function(){var t=this.x,e=this.y,i=this.z;return Math.sqrt(t*t+e*e+i*i)},i.prototype.length=i.prototype.norm,i.prototype.norm2=function(){return this.dot(this)},i.prototype.lengthSquared=i.prototype.norm2,i.prototype.distanceTo=function(t){var e=this.x,i=this.y,n=this.z,a=t.x,o=t.y,r=t.z;return Math.sqrt((a-e)*(a-e)+(o-i)*(o-i)+(r-n)*(r-n))},i.prototype.distanceSquared=function(t){var e=this.x,i=this.y,n=this.z,a=t.x,o=t.y,r=t.z;return(a-e)*(a-e)+(o-i)*(o-i)+(r-n)*(r-n)},i.prototype.mult=function(t,e){e=e||new i;var n=this.x,a=this.y,o=this.z;return e.x=t*n,e.y=t*a,e.z=t*o,e},i.prototype.scale=i.prototype.mult,i.prototype.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},i.prototype.isZero=function(){return 0===this.x&&0===this.y&&0===this.z},i.prototype.negate=function(t){return t=t||new i,t.x=-this.x,t.y=-this.y,t.z=-this.z,t};var a=new i,o=new i;i.prototype.tangents=function(t,e){var i=this.norm();if(i>0){var n=a,r=1/i;n.set(this.x*r,this.y*r,this.z*r);var s=o;.9>Math.abs(n.x)?(s.set(1,0,0),n.cross(s,t)):(s.set(0,1,0),n.cross(s,t)),n.cross(t,e)}else t.set(1,0,0),e.set(0,1,0)},i.prototype.toString=function(){return this.x+","+this.y+","+this.z},i.prototype.toArray=function(){return[this.x,this.y,this.z]},i.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},i.prototype.lerp=function(t,e,i){var n=this.x,a=this.y,o=this.z;i.x=n+(t.x-n)*e,i.y=a+(t.y-a)*e,i.z=o+(t.z-o)*e},i.prototype.almostEquals=function(t,e){return void 0===e&&(e=1e-6),Math.abs(this.x-t.x)>e||Math.abs(this.y-t.y)>e||Math.abs(this.z-t.z)>e?!1:!0},i.prototype.almostZero=function(t){return void 0===t&&(t=1e-6),Math.abs(this.x)>t||Math.abs(this.y)>t||Math.abs(this.z)>t?!1:!0};var r=new i;i.prototype.isAntiparallelTo=function(t,e){return this.negate(r),r.almostEquals(t,e)},i.prototype.clone=function(){return new i(this.x,this.y,this.z)}},{"./Mat3":27}],31:[function(t,e){function i(t){t=t||{},n.apply(this),this.id=i.idCounter++,this.name="",this.gameType=0,this.world=null,this.preStep=null,this.postStep=null,this.vlambda=new a,this.collisionFilterGroup="number"==typeof t.collisionFilterGroup?t.collisionFilterGroup:1,this.collisionFilterMask="number"==typeof t.collisionFilterMask?t.collisionFilterMask:1,this.collisionResponse=!0,this.position=new a,t.position&&this.position.copy(t.position),this.previousPosition=new a,this.initPosition=new a,this.velocity=new a,t.velocity&&this.velocity.copy(t.velocity),this.initVelocity=new a,this.force=new a;var e="number"==typeof t.mass?t.mass:0;this.mass=e,this.invMass=e>0?1/e:0,this.material=t.material||null,this.linearDamping="number"==typeof t.linearDamping?t.linearDamping:.01,this.type=0>=e?i.STATIC:i.DYNAMIC,typeof t.type==typeof i.STATIC&&(this.type=t.type),this.allowSleep=t.allowSleep!==void 0?t.allowSleep:!0,this.sleepState=0,this.sleepSpeedLimit=t.sleepSpeedLimit!==void 0?t.sleepSpeedLimit:.1,this.sleepTimeLimit=t.sleepTimeLimit!==void 0?t.sleepTimeLimit:1,this.timeLastSleepy=0,this._wakeUpAfterNarrowphase=!1,this.torque=new a,this.quaternion=new r,t.quaternion&&this.quaternion.copy(t.quaternion),this.initQuaternion=new r,this.angularVelocity=new a,t.angularVelocity&&this.angularVelocity.copy(t.angularVelocity),this.initAngularVelocity=new a,this.interpolatedPosition=new a,this.interpolatedQuaternion=new r,this.shapes=[],this.shapeOffsets=[],this.shapeOrientations=[],this.inertia=new a,this.invInertia=new a,this.invInertiaWorld=new o,this.invMassSolve=0,this.invInertiaSolve=new a,this.invInertiaWorldSolve=new o,this.fixedRotation=t.fixedRotation!==void 0?t.fixedRotation:!1,this.angularDamping=t.angularDamping!==void 0?t.angularDamping:.01,this.aabb=new s,this.aabbNeedsUpdate=!0,this.wlambda=new a,t.shape&&this.addShape(t.shape),this.updateMassProperties()}e.exports=i;var n=t("../utils/EventTarget");t("../shapes/Shape");var a=t("../math/Vec3"),o=t("../math/Mat3"),r=t("../math/Quaternion");t("../material/Material");var s=t("../collision/AABB"),h=t("../shapes/Box");i.prototype=new n,i.prototype.constructor=i,i.DYNAMIC=1,i.STATIC=2,i.KINEMATIC=4,i.AWAKE=0,i.SLEEPY=1,i.SLEEPING=2,i.idCounter=0,i.prototype.wakeUp=function(){var t=this.sleepState;this.sleepState=0,t===i.SLEEPING&&this.dispatchEvent({type:"wakeup"})},i.prototype.sleep=function(){this.sleepState=i.SLEEPING,this.velocity.set(0,0,0),this.angularVelocity.set(0,0,0)},i.sleepyEvent={type:"sleepy"},i.sleepEvent={type:"sleep"},i.prototype.sleepTick=function(t){if(this.allowSleep){var e=this.sleepState,n=this.velocity.norm2()+this.angularVelocity.norm2(),a=Math.pow(this.sleepSpeedLimit,2);e===i.AWAKE&&a>n?(this.sleepState=i.SLEEPY,this.timeLastSleepy=t,this.dispatchEvent(i.sleepyEvent)):e===i.SLEEPY&&n>a?this.wakeUp():e===i.SLEEPY&&t-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleep(),this.dispatchEvent(i.sleepEvent))}},i.prototype.updateSolveMassProperties=function(){this.sleepState===i.SLEEPING||this.type===i.KINEMATIC?(this.invMassSolve=0,this.invInertiaSolve.setZero(),this.invInertiaWorldSolve.setZero()):(this.invMassSolve=this.invMass,this.invInertiaSolve.copy(this.invInertia),this.invInertiaWorldSolve.copy(this.invInertiaWorld))},i.prototype.pointToLocalFrame=function(t,e){var e=e||new a;return t.vsub(this.position,e),this.quaternion.conjugate().vmult(e,e),e},i.prototype.vectorToLocalFrame=function(t,e){var e=e||new a;return this.quaternion.conjugate().vmult(t,e),e},i.prototype.pointToWorldFrame=function(t,e){var e=e||new a;return this.quaternion.vmult(t,e),e.vadd(this.position,e),e},i.prototype.vectorToWorldFrame=function(t,e){var e=e||new a;return this.quaternion.vmult(t,e),e};var c=new a,l=new r;i.prototype.addShape=function(t,e,i){var n=new a,o=new r;return e&&n.copy(e),i&&o.copy(i),this.shapes.push(t),this.shapeOffsets.push(n),this.shapeOrientations.push(o),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0,this},i.prototype.updateBoundingRadius=function(){for(var t=this.shapes,e=this.shapeOffsets,i=t.length,n=0,a=0;a!==i;a++){var o=t[a];o.updateBoundingSphereRadius();var r=e[a].norm(),s=o.boundingSphereRadius;r+s>n&&(n=r+s)}this.boundingRadius=n};var p=new s;i.prototype.computeAABB=function(){for(var t=this.shapes,e=this.shapeOffsets,i=this.shapeOrientations,n=t.length,a=c,o=l,r=this.quaternion,s=this.aabb,h=p,u=0;u!==n;u++){var d=t[u];i[u].mult(r,o),o.vmult(e[u],a),a.vadd(this.position,a),d.calculateWorldAABB(a,o,h.lowerBound,h.upperBound),0===u?s.copy(h):s.extend(h)}this.aabbNeedsUpdate=!1};{var u=new o,d=new o;new o}i.prototype.updateInertiaWorld=function(t){var e=this.invInertia;if(e.x!==e.y||e.y!==e.z||t){var i=u,n=d;i.setRotationFromQuaternion(this.quaternion),i.transpose(n),i.scale(e,i),i.mmult(n,this.invInertiaWorld)}else;};var m=new a,f=new a;i.prototype.applyForce=function(t,e){if(this.type===i.DYNAMIC){var n=m;e.vsub(this.position,n);var a=f;n.cross(t,a),this.force.vadd(t,this.force),this.torque.vadd(a,this.torque)}};var y=new a,v=new a;i.prototype.applyLocalForce=function(t,e){if(this.type===i.DYNAMIC){var n=y,a=v;this.vectorToWorldFrame(t,n),this.pointToWorldFrame(e,a),this.applyForce(n,a)}};var x=new a,g=new a,_=new a;i.prototype.applyImpulse=function(t,e){if(this.type===i.DYNAMIC){var n=x;e.vsub(this.position,n);var a=g;a.copy(t),a.mult(this.invMass,a),this.velocity.vadd(a,this.velocity);var o=_;n.cross(t,o),this.invInertiaWorld.vmult(o,o),this.angularVelocity.vadd(o,this.angularVelocity)}};var D=new a,w=new a;i.prototype.applyLocalImpulse=function(t,e){if(this.type===i.DYNAMIC){var n=D,a=w;this.vectorToWorldFrame(t,n),this.pointToWorldFrame(e,a),this.applyImpulse(n,a)}};var b=new a;i.prototype.updateMassProperties=function(){var t=b;this.invMass=this.mass>0?1/this.mass:0;var e=this.inertia,i=this.fixedRotation;this.computeAABB(),t.set((this.aabb.upperBound.x-this.aabb.lowerBound.x)/2,(this.aabb.upperBound.y-this.aabb.lowerBound.y)/2,(this.aabb.upperBound.z-this.aabb.lowerBound.z)/2),h.calculateInertia(t,this.mass,e),this.invInertia.set(e.x>0&&!i?1/e.x:0,e.y>0&&!i?1/e.y:0,e.z>0&&!i?1/e.z:0),this.updateInertiaWorld(!0)},i.prototype.getVelocityAtWorldPoint=function(t,e){var i=new a;return t.vsub(this.position,i),this.angularVelocity.cross(i,e),this.velocity.vadd(e,e),e}},{"../collision/AABB":3,"../material/Material":25,"../math/Mat3":27,"../math/Quaternion":28,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Shape":43,"../utils/EventTarget":49}],32:[function(t,e){function i(t){this.chassisBody=t.chassisBody,this.wheelInfos=[],this.sliding=!1,this.world=null,this.indexRightAxis=t.indexRightAxis!==void 0?t.indexRightAxis:1,this.indexForwardAxis=t.indexForwardAxis!==void 0?t.indexForwardAxis:0,this.indexUpAxis=t.indexUpAxis!==void 0?t.indexUpAxis:2}function n(t,e,i,n,o){var r=0,s=i,h=_,c=D,l=w;t.getVelocityAtWorldPoint(s,h),e.getVelocityAtWorldPoint(s,c),h.vsub(c,l);var p=n.dot(l),u=a(t,i,n),d=a(e,i,n),m=1,f=m/(u+d);return r=-p*f,r>o&&(r=o),-o>r&&(r=-o),r
}function a(t,e,i){var n=b,a=S,o=M,r=C;return e.vsub(t.position,n),n.cross(i,a),t.invInertiaWorld.vmult(a,r),r.cross(n,o),t.invMass+i.dot(o)}function o(t,e,i,n,a,o){var r=a.norm2();if(r>1.1)return 0;var s=T,h=A,c=I;t.getVelocityAtWorldPoint(e,s),i.getVelocityAtWorldPoint(n,h),s.vsub(h,c);var l=a.dot(c),p=.2,u=1/(t.invMass+i.invMass),o=-p*l*u;return o}t("./Body");var r=t("../math/Vec3"),s=t("../math/Quaternion");t("../collision/RaycastResult");var h=t("../collision/Ray"),c=t("../objects/WheelInfo");e.exports=i,new r,new r,new r;var l=new r,p=new r,u=new r;new h,i.prototype.addWheel=function(t){t=t||{};var e=new c(t),i=this.wheelInfos.length;return this.wheelInfos.push(e),i},i.prototype.setSteeringValue=function(t,e){var i=this.wheelInfos[e];i.steering=t},new r,i.prototype.applyEngineForce=function(t,e){this.wheelInfos[e].engineForce=t},i.prototype.setBrake=function(t,e){this.wheelInfos[e].brake=t},i.prototype.addToWorld=function(t){this.constraints,t.add(this.chassisBody);var e=this;this.preStepCallback=function(){e.updateVehicle(t.dt)},t.addEventListener("preStep",this.preStepCallback),this.world=t},i.prototype.getVehicleAxisWorld=function(t,e){e.set(0===t?1:0,1===t?1:0,2===t?1:0),this.chassisBody.vectorToWorldFrame(e,e)},i.prototype.updateVehicle=function(t){for(var e=this.wheelInfos,i=e.length,n=this.chassisBody,a=0;i>a;a++)this.updateWheelTransform(a);this.currentVehicleSpeedKmHour=3.6*n.velocity.norm();var o=new r;this.getVehicleAxisWorld(this.indexForwardAxis,o),0>o.dot(n.velocity)&&(this.currentVehicleSpeedKmHour*=-1);for(var a=0;i>a;a++)this.castRay(e[a]);this.updateSuspension(t);for(var s=new r,h=new r,a=0;i>a;a++){var c=e[a],l=c.suspensionForce;l>c.maxSuspensionForce&&(l=c.maxSuspensionForce),c.raycastResult.hitNormalWorld.scale(l*t,s),c.raycastResult.hitPointWorld.vsub(n.position,h),n.applyImpulse(s,c.raycastResult.hitPointWorld)}this.updateFriction(t);var p=new r,u=new r,d=new r;for(a=0;i>a;a++){var c=e[a];n.getVelocityAtWorldPoint(c.chassisConnectionPointWorld,d);var m=1;switch(this.indexUpAxis){case 1:m=-1}if(c.isInContact){this.getVehicleAxisWorld(this.indexForwardAxis,u);var f=u.dot(c.raycastResult.hitNormalWorld);c.raycastResult.hitNormalWorld.scale(f,p),u.vsub(p,u);var y=u.dot(d);c.deltaRotation=m*y*t/c.radius}!c.sliding&&c.isInContact||0===c.engineForce||!c.useCustomSlidingRotationalSpeed||(c.deltaRotation=(c.engineForce>0?1:-1)*c.customSlidingRotationalSpeed*t),Math.abs(c.brake)>Math.abs(c.engineForce)&&(c.deltaRotation=0),c.rotation+=c.deltaRotation,c.deltaRotation*=.99}},i.prototype.updateSuspension=function(){for(var t=this.chassisBody,e=t.mass,i=this.wheelInfos,n=i.length,a=0;n>a;a++){var o=i[a];if(o.isInContact){var r,s=o.suspensionRestLength,h=o.suspensionLength,c=s-h;r=o.suspensionStiffness*c*o.clippedInvContactDotSuspension;var l,p=o.suspensionRelativeVelocity;l=0>p?o.dampingCompression:o.dampingRelaxation,r-=l*p,o.suspensionForce=r*e,0>o.suspensionForce&&(o.suspensionForce=0)}else o.suspensionForce=0}},i.prototype.removeFromWorld=function(t){this.constraints,t.remove(this.chassisBody),t.removeEventListener("preStep",this.preStepCallback),this.world=null};var d=new r,m=new r;i.prototype.castRay=function(t){var e=d,i=m;this.updateWheelTransformWorld(t);var n=this.chassisBody,a=-1,o=t.suspensionRestLength+t.radius;t.directionWorld.scale(o,e);var s=t.chassisConnectionPointWorld;s.vadd(e,i);var h=t.raycastResult;h.reset();var c=n.collisionResponse;n.collisionResponse=!1,this.world.rayTest(s,i,h),n.collisionResponse=c;var l=h.body;if(t.raycastResult.groundObject=0,l){a=h.distance,t.raycastResult.hitNormalWorld=h.hitNormalWorld,t.isInContact=!0;var p=h.distance;t.suspensionLength=p-t.radius;var u=t.suspensionRestLength-t.maxSuspensionTravel,f=t.suspensionRestLength+t.maxSuspensionTravel;u>t.suspensionLength&&(t.suspensionLength=u),t.suspensionLength>f&&(t.suspensionLength=f,t.raycastResult.reset());var y=t.raycastResult.hitNormalWorld.dot(t.directionWorld),v=new r;n.getVelocityAtWorldPoint(t.raycastResult.hitPointWorld,v);var x=t.raycastResult.hitNormalWorld.dot(v);if(y>=-.1)t.suspensionRelativeVelocity=0,t.clippedInvContactDotSuspension=10;else{var g=-1/y;t.suspensionRelativeVelocity=x*g,t.clippedInvContactDotSuspension=g}}else t.suspensionLength=t.suspensionRestLength+0*t.maxSuspensionTravel,t.suspensionRelativeVelocity=0,t.directionWorld.scale(-1,t.raycastResult.hitNormalWorld),t.clippedInvContactDotSuspension=1;return a},i.prototype.updateWheelTransformWorld=function(t){t.isInContact=!1;var e=this.chassisBody;e.pointToWorldFrame(t.chassisConnectionPointLocal,t.chassisConnectionPointWorld),e.vectorToWorldFrame(t.directionLocal,t.directionWorld),e.vectorToWorldFrame(t.axleLocal,t.axleWorld)},i.prototype.updateWheelTransform=function(t){var e=l,i=p,n=u,a=this.wheelInfos[t];this.updateWheelTransformWorld(a),a.directionLocal.scale(-1,e),i.copy(a.axleLocal),e.cross(i,n),n.normalize(),i.normalize();var o=a.steering,r=new s;r.setFromAxisAngle(e,o);var h=new s;h.setFromAxisAngle(i,a.rotation);var c=a.worldTransform.quaternion;this.chassisBody.quaternion.mult(r,c),c.mult(h,c),c.normalize();var d=a.worldTransform.position;d.copy(a.directionWorld),d.scale(a.suspensionLength,d),d.vadd(a.chassisConnectionPointWorld,d)};var f=[new r(1,0,0),new r(0,1,0),new r(0,0,1)];i.prototype.getWheelTransformWorld=function(t){return this.wheelInfos[t].worldTransform};var y=new r,v=[],x=[],g=1;i.prototype.updateFriction=function(t){for(var e=y,i=this.wheelInfos,a=i.length,s=this.chassisBody,h=x,c=v,l=0,p=0;a>p;p++){var u=i[p],d=u.raycastResult.body;d&&l++,u.sideImpulse=0,u.forwardImpulse=0,h[p]||(h[p]=new r),c[p]||(c[p]=new r)}for(var p=0;a>p;p++){var u=i[p],d=u.raycastResult.body;if(d){var m=c[p],_=this.getWheelTransformWorld(p);_.vectorToWorldFrame(f[this.indexRightAxis],m);var D=u.raycastResult.hitNormalWorld,w=m.dot(D);D.scale(w,e),m.vsub(e,m),m.normalize(),D.cross(m,h[p]),h[p].normalize(),u.sideImpulse=o(s,u.raycastResult.hitPointWorld,d,u.raycastResult.hitPointWorld,m),u.sideImpulse*=g}}var b=1,S=.5;this.sliding=!1;for(var p=0;a>p;p++){var u=i[p],d=u.raycastResult.body,M=0;if(u.slipInfo=1,d){var C=0,T=u.brake?u.brake:C;M=n(s,d,u.raycastResult.hitPointWorld,h[p],T),M+=u.engineForce*t;var A=T/M;u.slipInfo*=A}if(u.forwardImpulse=0,u.skidInfo=1,d){u.skidInfo=1;var I=u.suspensionForce*t*u.frictionSlip,E=I,P=I*E;u.forwardImpulse=M;var B=u.forwardImpulse*S,N=u.sideImpulse*b,V=B*B+N*N;if(u.sliding=!1,V>P){this.sliding=!0,u.sliding=!0;var A=I/Math.sqrt(V);u.skidInfo*=A}}}if(this.sliding)for(var p=0;a>p;p++){var u=i[p];0!==u.sideImpulse&&1>u.skidInfo&&(u.forwardImpulse*=u.skidInfo,u.sideImpulse*=u.skidInfo)}for(var p=0;a>p;p++){var u=i[p],R=new r;if(R.copy(u.raycastResult.hitPointWorld),0!==u.forwardImpulse){var L=new r;h[p].scale(u.forwardImpulse,L),s.applyImpulse(L,R)}if(0!==u.sideImpulse){var d=u.raycastResult.body,z=new r;z.copy(u.raycastResult.hitPointWorld);var F=new r;c[p].scale(u.sideImpulse,F),s.pointToLocalFrame(R,R),R["xyz"[this.indexUpAxis]]*=u.rollInfluence,s.pointToWorldFrame(R,R),s.applyImpulse(F,R),F.scale(-1,F),d.applyImpulse(F,z)}}};var _=new r,D=new r,w=new r,b=new r,S=new r,M=new r,C=new r,T=new r,A=new r,I=new r},{"../collision/Ray":9,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Vec3":30,"../objects/WheelInfo":36,"./Body":31}],33:[function(t,e){function i(t){if(this.wheelBodies=[],this.coordinateSystem=t.coordinateSystem===void 0?new r(1,2,3):t.coordinateSystem.clone(),this.chassisBody=t.chassisBody,!this.chassisBody){var e=new o(new r(5,2,.5));this.chassisBody=new n(1,e)}this.constraints=[],this.wheelAxes=[],this.wheelForces=[]}var n=t("./Body"),a=t("../shapes/Sphere"),o=t("../shapes/Box"),r=t("../math/Vec3"),s=t("../constraints/HingeConstraint");e.exports=i,i.prototype.addWheel=function(t){t=t||{};var e=t.body;e||(e=new n(1,new a(1.2))),this.wheelBodies.push(e),this.wheelForces.push(0),new r;var i=t.position!==void 0?t.position.clone():new r,o=new r;this.chassisBody.pointToWorldFrame(i,o),e.position.set(o.x,o.y,o.z);var h=t.axis!==void 0?t.axis.clone():new r(0,1,0);this.wheelAxes.push(h);var c=new s(this.chassisBody,e,{pivotA:i,axisA:h,pivotB:r.ZERO,axisB:h,collideConnected:!1});return this.constraints.push(c),this.wheelBodies.length-1},i.prototype.setSteeringValue=function(t,e){var i=this.wheelAxes[e],n=Math.cos(t),a=Math.sin(t),o=i.x,r=i.y;this.constraints[e].axisA.set(n*o-a*r,a*o+n*r,0)},i.prototype.setMotorSpeed=function(t,e){var i=this.constraints[e];i.enableMotor(),i.motorTargetVelocity=t},i.prototype.disableMotor=function(t){var e=this.constraints[t];e.disableMotor()};var h=new r;i.prototype.setWheelForce=function(t,e){this.wheelForces[e]=t},i.prototype.applyWheelForce=function(t,e){var i=this.wheelAxes[e],n=this.wheelBodies[e],a=n.torque;i.scale(t,h),n.vectorToWorldFrame(h,h),a.vadd(h,a)},i.prototype.addToWorld=function(t){for(var e=this.constraints,i=this.wheelBodies.concat([this.chassisBody]),n=0;i.length>n;n++)t.add(i[n]);for(var n=0;e.length>n;n++)t.addConstraint(e[n]);t.addEventListener("preStep",this._update.bind(this))},i.prototype._update=function(){for(var t=this.wheelForces,e=0;t.length>e;e++)this.applyWheelForce(t[e],e)},i.prototype.removeFromWorld=function(t){for(var e=this.constraints,i=this.wheelBodies.concat([this.chassisBody]),n=0;i.length>n;n++)t.remove(i[n]);for(var n=0;e.length>n;n++)t.removeConstraint(e[n])};var c=new r;i.prototype.getWheelSpeed=function(t){var e=this.wheelAxes[t],i=this.wheelBodies[t],n=i.angularVelocity;return this.chassisBody.vectorToWorldFrame(e,c),n.dot(c)}},{"../constraints/HingeConstraint":15,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Sphere":44,"./Body":31}],34:[function(t,e){function i(){this.particles=[],this.density=1,this.smoothingRadius=1,this.speedOfSound=1,this.viscosity=.01,this.eps=1e-6,this.pressures=[],this.densities=[],this.neighbors=[]}e.exports=i,t("../shapes/Shape");var n=t("../math/Vec3");t("../math/Quaternion"),t("../shapes/Particle"),t("../objects/Body"),t("../material/Material"),i.prototype.add=function(t){this.particles.push(t),this.neighbors.length<this.particles.length&&this.neighbors.push([])},i.prototype.remove=function(t){var e=this.particles.indexOf(t);-1!==e&&(this.particles.splice(e,1),this.neighbors.length>this.particles.length&&this.neighbors.pop())};var a=new n;i.prototype.getNeighbors=function(t,e){for(var i=this.particles.length,n=t.id,o=this.smoothingRadius*this.smoothingRadius,r=a,s=0;s!==i;s++){var h=this.particles[s];h.position.vsub(t.position,r),n!==h.id&&o>r.norm2()&&e.push(h)}};var o=new n,r=new n,s=new n,h=new n,c=new n,l=new n;i.prototype.update=function(){for(var t=this.particles.length,e=o,i=this.speedOfSound,n=this.eps,a=0;a!==t;a++){var p=this.particles[a],u=this.neighbors[a];u.length=0,this.getNeighbors(p,u),u.push(this.particles[a]);for(var d=u.length,m=0,f=0;f!==d;f++){p.position.vsub(u[f].position,e);var y=e.norm(),v=this.w(y);m+=u[f].mass*v}this.densities[a]=m,this.pressures[a]=i*i*(this.densities[a]-this.density)}for(var x=r,g=s,_=h,D=c,w=l,a=0;a!==t;a++){var b=this.particles[a];x.set(0,0,0),g.set(0,0,0);for(var S,M,u=this.neighbors[a],d=u.length,f=0;f!==d;f++){var C=u[f];b.position.vsub(C.position,D);var T=D.norm();S=-C.mass*(this.pressures[a]/(this.densities[a]*this.densities[a]+n)+this.pressures[f]/(this.densities[f]*this.densities[f]+n)),this.gradw(D,_),_.mult(S,_),x.vadd(_,x),C.velocity.vsub(b.velocity,w),w.mult(1/(1e-4+this.densities[a]*this.densities[f])*this.viscosity*C.mass,w),M=this.nablaw(T),w.mult(M,w),g.vadd(w,g)}g.mult(b.mass,g),x.mult(b.mass,x),b.force.vadd(g,b.force),b.force.vadd(x,b.force)}},i.prototype.w=function(t){var e=this.smoothingRadius;return 315/(64*Math.PI*Math.pow(e,9))*Math.pow(e*e-t*t,3)},i.prototype.gradw=function(t,e){var i=t.norm(),n=this.smoothingRadius;t.mult(945/(32*Math.PI*Math.pow(n,9))*Math.pow(n*n-i*i,2),e)},i.prototype.nablaw=function(t){var e=this.smoothingRadius,i=945/(32*Math.PI*Math.pow(e,9))*(e*e-t*t)*(7*t*t-3*e*e);return i}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Particle":41,"../shapes/Shape":43}],35:[function(t,e){function i(t,e,i){i=i||{},this.restLength="number"==typeof i.restLength?i.restLength:1,this.stiffness=i.stiffness||100,this.damping=i.damping||1,this.bodyA=t,this.bodyB=e,this.localAnchorA=new n,this.localAnchorB=new n,i.localAnchorA&&this.localAnchorA.copy(i.localAnchorA),i.localAnchorB&&this.localAnchorB.copy(i.localAnchorB),i.worldAnchorA&&this.setWorldAnchorA(i.worldAnchorA),i.worldAnchorB&&this.setWorldAnchorB(i.worldAnchorB)}var n=t("../math/Vec3");e.exports=i,i.prototype.setWorldAnchorA=function(t){this.bodyA.pointToLocalFrame(t,this.localAnchorA)},i.prototype.setWorldAnchorB=function(t){this.bodyB.pointToLocalFrame(t,this.localAnchorB)},i.prototype.getWorldAnchorA=function(t){this.bodyA.pointToWorldFrame(this.localAnchorA,t)},i.prototype.getWorldAnchorB=function(t){this.bodyB.pointToWorldFrame(this.localAnchorB,t)};var a=new n,o=new n,r=new n,s=new n,h=new n,c=new n,l=new n,p=new n,u=new n,d=new n,m=new n;i.prototype.applyForce=function(){var t=this.stiffness,e=this.damping,i=this.restLength,n=this.bodyA,f=this.bodyB,y=a,v=o,x=r,g=s,_=m,D=h,w=c,b=l,S=p,M=u,C=d;this.getWorldAnchorA(D),this.getWorldAnchorB(w),D.vsub(n.position,b),w.vsub(f.position,S),w.vsub(D,y);var T=y.norm();v.copy(y),v.normalize(),f.velocity.vsub(n.velocity,x),f.angularVelocity.cross(S,_),x.vadd(_,x),n.angularVelocity.cross(b,_),x.vsub(_,x),v.mult(-t*(T-i)-e*x.dot(v),g),n.force.vsub(g,n.force),f.force.vadd(g,f.force),b.cross(g,M),S.cross(g,C),n.torque.vsub(M,n.torque),f.torque.vadd(C,f.torque)}},{"../math/Vec3":30}],36:[function(t,e){function i(t){t=r.defaults(t,{chassisConnectionPointLocal:new n,chassisConnectionPointWorld:new n,directionLocal:new n,directionWorld:new n,axleLocal:new n,axleWorld:new n,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:1e4,steering:0,rotation:0,deltaRotation:0,rollInfluence:.01,maxSuspensionForce:Number.MAX_VALUE,isFrontWheel:!0,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:!1,customSlidingRotationalSpeed:-.1}),this.maxSuspensionTravel=t.maxSuspensionTravel,this.customSlidingRotationalSpeed=t.customSlidingRotationalSpeed,this.useCustomSlidingRotationalSpeed=t.useCustomSlidingRotationalSpeed,this.sliding=!1,this.chassisConnectionPointLocal=t.chassisConnectionPointLocal.clone(),this.chassisConnectionPointWorld=t.chassisConnectionPointWorld.clone(),this.directionLocal=t.directionLocal.clone(),this.directionWorld=t.directionWorld.clone(),this.axleLocal=t.axleLocal.clone(),this.axleWorld=t.axleWorld.clone(),this.suspensionRestLength=t.suspensionRestLength,this.suspensionMaxLength=t.suspensionMaxLength,this.radius=t.radius,this.suspensionStiffness=t.suspensionStiffness,this.dampingCompression=t.dampingCompression,this.dampingRelaxation=t.dampingRelaxation,this.frictionSlip=t.frictionSlip,this.steering=0,this.rotation=0,this.deltaRotation=0,this.rollInfluence=t.rollInfluence,this.maxSuspensionForce=t.maxSuspensionForce,this.engineForce=0,this.brake=0,this.isFrontWheel=t.isFrontWheel,this.clippedInvContactDotSuspension=1,this.suspensionRelativeVelocity=0,this.suspensionForce=0,this.skidInfo=0,this.suspensionLength=0,this.sideImpulse=0,this.forwardImpulse=0,this.raycastResult=new o,this.worldTransform=new a,this.isInContact=!1}var n=t("../math/Vec3"),a=t("../math/Transform"),o=t("../collision/RaycastResult"),r=t("../utils/Utils");e.exports=i;var s=new n,h=new n,s=new n;i.prototype.updateWheel=function(t){var e=this.raycastResult;if(this.isInContact){var i=e.hitNormalWorld.dot(e.directionWorld);e.hitPointWorld.vsub(t.position,h),t.getVelocityAtWorldPoint(h,s);var n=e.hitNormalWorld.dot(s);if(i>=-.1)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=10;else{var a=-1/i;this.suspensionRelativeVelocity=n*a,this.clippedInvContactDotSuspension=a}}else e.suspensionLength=this.suspensionRestLength,this.suspensionRelativeVelocity=0,e.directionWorld.scale(-1,e.hitNormalWorld),this.clippedInvContactDotSuspension=1}},{"../collision/RaycastResult":10,"../math/Transform":29,"../math/Vec3":30,"../utils/Utils":53}],37:[function(t,e){function i(t){n.call(this),this.type=n.types.BOX,this.halfExtents=t,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation(),this.updateBoundingSphereRadius()}e.exports=i;var n=t("./Shape"),a=t("../math/Vec3"),o=t("./ConvexPolyhedron");i.prototype=new n,i.prototype.constructor=i,i.prototype.updateConvexPolyhedronRepresentation=function(){var t=this.halfExtents.x,e=this.halfExtents.y,i=this.halfExtents.z,n=a,r=[new n(-t,-e,-i),new n(t,-e,-i),new n(t,e,-i),new n(-t,e,-i),new n(-t,-e,i),new n(t,-e,i),new n(t,e,i),new n(-t,e,i)],s=[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]];[new n(0,0,1),new n(0,1,0),new n(1,0,0)];var h=new o(r,s);this.convexPolyhedronRepresentation=h,h.material=this.material},i.prototype.calculateLocalInertia=function(t,e){return e=e||new a,i.calculateInertia(this.halfExtents,t,e),e},i.calculateInertia=function(t,e,i){var n=t;i.x=1/12*e*(2*2*n.y*n.y+2*2*n.z*n.z),i.y=1/12*e*(2*2*n.x*n.x+2*2*n.z*n.z),i.z=1/12*e*(2*2*n.y*n.y+2*2*n.x*n.x)},i.prototype.getSideNormals=function(t,e){var i=t,n=this.halfExtents;if(i[0].set(n.x,0,0),i[1].set(0,n.y,0),i[2].set(0,0,n.z),i[3].set(-n.x,0,0),i[4].set(0,-n.y,0),i[5].set(0,0,-n.z),void 0!==e)for(var a=0;a!==i.length;a++)e.vmult(i[a],i[a]);return i},i.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z},i.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.norm()};var r=new a;new a,i.prototype.forEachWorldCorner=function(t,e,i){for(var n=this.halfExtents,a=[[n.x,n.y,n.z],[-n.x,n.y,n.z],[-n.x,-n.y,n.z],[-n.x,-n.y,-n.z],[n.x,-n.y,-n.z],[n.x,n.y,-n.z],[-n.x,n.y,-n.z],[n.x,-n.y,n.z]],o=0;a.length>o;o++)r.set(a[o][0],a[o][1],a[o][2]),e.vmult(r,r),t.vadd(r,r),i(r.x,r.y,r.z)};var s=[new a,new a,new a,new a,new a,new a,new a,new a];i.prototype.calculateWorldAABB=function(t,e,i,n){var a=this.halfExtents;s[0].set(a.x,a.y,a.z),s[1].set(-a.x,a.y,a.z),s[2].set(-a.x,-a.y,a.z),s[3].set(-a.x,-a.y,-a.z),s[4].set(a.x,-a.y,-a.z),s[5].set(a.x,a.y,-a.z),s[6].set(-a.x,a.y,-a.z),s[7].set(a.x,-a.y,a.z);var o=s[0];e.vmult(o,o),t.vadd(o,o),n.copy(o),i.copy(o);for(var r=1;8>r;r++){var o=s[r];e.vmult(o,o),t.vadd(o,o);var h=o.x,c=o.y,l=o.z;h>n.x&&(n.x=h),c>n.y&&(n.y=c),l>n.z&&(n.z=l),i.x>h&&(i.x=h),i.y>c&&(i.y=c),i.z>l&&(i.z=l)}}},{"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],38:[function(t,e){function i(t,e,i){n.call(this),this.type=n.types.CONVEXPOLYHEDRON,this.vertices=t||[],this.worldVertices=[],this.worldVerticesNeedsUpdate=!0,this.faces=e||[],this.faceNormals=[],this.computeNormals(),this.worldFaceNormalsNeedsUpdate=!0,this.worldFaceNormals=[],this.uniqueEdges=[],this.uniqueAxes=i?i.slice():null,this.computeEdges(),this.updateBoundingSphereRadius()}e.exports=i;var n=t("./Shape"),a=t("../math/Vec3");t("../math/Quaternion");var o=t("../math/Transform");i.prototype=new n,i.prototype.constructor=i;var r=new a;i.prototype.computeEdges=function(){var t=this.faces,e=this.vertices;e.length;var i=this.uniqueEdges;i.length=0;for(var n=r,a=0;a!==t.length;a++)for(var o=t[a],s=o.length,h=0;h!==s;h++){var c=(h+1)%s;e[o[h]].vsub(e[o[c]],n),n.normalize();for(var l=!1,p=0;p!==i.length;p++)if(i[p].almostEquals(n)||i[p].almostEquals(n)){l=!0;break}l||i.push(n.clone())}},i.prototype.computeNormals=function(){this.faceNormals.length=this.faces.length;for(var t=0;this.faces.length>t;t++){for(var e=0;this.faces[t].length>e;e++)if(!this.vertices[this.faces[t][e]])throw Error("Vertex "+this.faces[t][e]+" not found!");var i=this.faceNormals[t]||new a;this.getFaceNormal(t,i),i.negate(i),this.faceNormals[t]=i;var n=this.vertices[this.faces[t][0]];0>i.dot(n)}};var s=new a,h=new a;i.computeNormal=function(t,e,i,n){e.vsub(t,h),i.vsub(e,s),s.cross(h,n),n.isZero()||n.normalize()},i.prototype.getFaceNormal=function(t,e){var n=this.faces[t],a=this.vertices[n[0]],o=this.vertices[n[1]],r=this.vertices[n[2]];return i.computeNormal(a,o,r,e)};var c=new a;i.prototype.clipAgainstHull=function(t,e,i,n,o,r,s,h,l){for(var p=c,u=-1,d=-Number.MAX_VALUE,m=0;i.faces.length>m;m++){p.copy(i.faceNormals[m]),o.vmult(p,p);var f=p.dot(r);f>d&&(d=f,u=m)}for(var y=[],v=i.faces[u],x=v.length,g=0;x>g;g++){var _=i.vertices[v[g]],D=new a;D.copy(_),o.vmult(D,D),n.vadd(D,D),y.push(D)}u>=0&&this.clipFaceAgainstHull(r,t,e,y,s,h,l)};var l=new a,p=new a,u=new a,d=new a,m=new a,f=new a;i.prototype.findSeparatingAxis=function(t,e,i,n,a,o,r,s){var h=l,c=p,y=u,v=d,x=m,g=f,_=Number.MAX_VALUE,D=this,w=0;if(D.uniqueAxes)for(var b=0;b!==D.uniqueAxes.length;b++){i.vmult(D.uniqueAxes[b],h);var S=D.testSepAxis(h,t,e,i,n,a);if(S===!1)return!1;_>S&&(_=S,o.copy(h))}else for(var M=r?r.length:D.faces.length,b=0;M>b;b++){var C=r?r[b]:b;h.copy(D.faceNormals[C]),i.vmult(h,h);var S=D.testSepAxis(h,t,e,i,n,a);if(S===!1)return!1;_>S&&(_=S,o.copy(h))}if(t.uniqueAxes)for(var b=0;b!==t.uniqueAxes.length;b++){a.vmult(t.uniqueAxes[b],c),w++;var S=D.testSepAxis(c,t,e,i,n,a);if(S===!1)return!1;_>S&&(_=S,o.copy(c))}else for(var T=s?s.length:t.faces.length,b=0;T>b;b++){var C=s?s[b]:b;c.copy(t.faceNormals[C]),a.vmult(c,c),w++;var S=D.testSepAxis(c,t,e,i,n,a);if(S===!1)return!1;_>S&&(_=S,o.copy(c))}for(var A=0;A!==D.uniqueEdges.length;A++){i.vmult(D.uniqueEdges[A],v);for(var I=0;I!==t.uniqueEdges.length;I++)if(a.vmult(t.uniqueEdges[I],x),v.cross(x,g),!g.almostZero()){g.normalize();var E=D.testSepAxis(g,t,e,i,n,a);if(E===!1)return!1;_>E&&(_=E,o.copy(g))}}return n.vsub(e,y),y.dot(o)>0&&o.negate(o),!0};var y=[],v=[];i.prototype.testSepAxis=function(t,e,n,a,o,r){var s=this;i.project(s,t,n,a,y),i.project(e,t,o,r,v);var h=y[0],c=y[1],l=v[0],p=v[1];if(p>h||c>l)return!1;var u=h-p,d=l-c,m=d>u?u:d;return m};var x=new a,g=new a;i.prototype.calculateLocalInertia=function(t,e){this.computeLocalAABB(x,g);var i=g.x-x.x,n=g.y-x.y,a=g.z-x.z;e.x=1/12*t*(2*2*n*n+2*2*a*a),e.y=1/12*t*(2*2*i*i+2*2*a*a),e.z=1/12*t*(2*2*n*n+2*2*i*i)},i.prototype.getPlaneConstantOfFace=function(t){var e=this.faces[t],i=this.faceNormals[t],n=this.vertices[e[0]],a=-i.dot(n);return a};var _=new a,D=new a,w=new a,b=new a,S=new a,M=new a,C=new a,T=new a;i.prototype.clipFaceAgainstHull=function(t,e,i,n,a,o,r){for(var s=_,h=D,c=w,l=b,p=S,u=M,d=C,m=T,f=this,y=[],v=n,x=y,g=-1,A=Number.MAX_VALUE,I=0;f.faces.length>I;I++){s.copy(f.faceNormals[I]),i.vmult(s,s);var E=s.dot(t);A>E&&(A=E,g=I)}if(!(0>g)){var P=f.faces[g];P.connectedFaces=[];for(var B=0;f.faces.length>B;B++)for(var N=0;f.faces[B].length>N;N++)-1!==P.indexOf(f.faces[B][N])&&B!==g&&-1===P.connectedFaces.indexOf(B)&&P.connectedFaces.push(B);v.length;for(var V=P.length,R=0;V>R;R++){var L=f.vertices[P[R]],z=f.vertices[P[(R+1)%V]];L.vsub(z,h),c.copy(h),i.vmult(c,c),e.vadd(c,c),l.copy(this.faceNormals[g]),i.vmult(l,l),e.vadd(l,l),c.cross(l,p),p.negate(p),u.copy(L),i.vmult(u,u),e.vadd(u,u);var F,O=(-u.dot(p),P.connectedFaces[R]);d.copy(this.faceNormals[O]);var k=this.getPlaneConstantOfFace(O);m.copy(d),i.vmult(m,m);var F=k-m.dot(e);for(this.clipFaceAgainstPlane(v,x,m,F);v.length;)v.shift();for(;x.length;)v.push(x.shift())}d.copy(this.faceNormals[g]);var k=this.getPlaneConstantOfFace(g);m.copy(d),i.vmult(m,m);for(var F=k-m.dot(e),B=0;v.length>B;B++){var j=m.dot(v[B])+F;if(a>=j&&(console.log("clamped: depth="+j+" to minDist="+(a+"")),j=a),o>=j){var U=v[B];if(0>=j){var X={point:U,normal:m,depth:j};r.push(X)}}}}},i.prototype.clipFaceAgainstPlane=function(t,e,i,n){var o,r,s=t.length;if(2>s)return e;var h=t[t.length-1],c=t[0];o=i.dot(h)+n;for(var l=0;s>l;l++){if(c=t[l],r=i.dot(c)+n,0>o)if(0>r){var p=new a;p.copy(c),e.push(p)}else{var p=new a;h.lerp(c,o/(o-r),p),e.push(p)}else if(0>r){var p=new a;h.lerp(c,o/(o-r),p),e.push(p),e.push(c)}h=c,o=r}return e},i.prototype.computeWorldVertices=function(t,e){for(var i=this.vertices.length;i>this.worldVertices.length;)this.worldVertices.push(new a);for(var n=this.vertices,o=this.worldVertices,r=0;r!==i;r++)e.vmult(n[r],o[r]),t.vadd(o[r],o[r]);this.worldVerticesNeedsUpdate=!1};{new a}i.prototype.computeLocalAABB=function(t,e){var i=this.vertices.length,n=this.vertices;t.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),e.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var a=0;i>a;a++){var o=n[a];o.x<t.x?t.x=o.x:o.x>e.x&&(e.x=o.x),o.y<t.y?t.y=o.y:o.y>e.y&&(e.y=o.y),o.z<t.z?t.z=o.z:o.z>e.z&&(e.z=o.z)}},i.prototype.computeWorldFaceNormals=function(t){for(var e=this.faceNormals.length;e>this.worldFaceNormals.length;)this.worldFaceNormals.push(new a);for(var i=this.faceNormals,n=this.worldFaceNormals,o=0;o!==e;o++)t.vmult(i[o],n[o]);this.worldFaceNormalsNeedsUpdate=!1},i.prototype.updateBoundingSphereRadius=function(){for(var t=0,e=this.vertices,i=0,n=e.length;i!==n;i++){var a=e[i].norm2();a>t&&(t=a)}this.boundingSphereRadius=Math.sqrt(t)};var A=new a;i.prototype.calculateWorldAABB=function(t,e,i,n){for(var a,o,r,s,h,c,l=this.vertices.length,p=this.vertices,u=0;l>u;u++){A.copy(p[u]),e.vmult(A,A),t.vadd(A,A);var d=A;a>d.x||void 0===a?a=d.x:(d.x>s||void 0===s)&&(s=d.x),o>d.y||void 0===o?o=d.y:(d.y>h||void 0===h)&&(h=d.y),r>d.z||void 0===r?r=d.z:(d.z>c||void 0===c)&&(c=d.z)}i.set(a,o,r),n.set(s,h,c)},i.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},i.prototype.getAveragePointLocal=function(t){t=t||new a;for(var e=this.vertices.length,i=this.vertices,n=0;e>n;n++)t.vadd(i[n],t);return t.mult(1/e,t),t},i.prototype.transformAllPoints=function(t,e){var i=this.vertices.length,n=this.vertices;if(e){for(var a=0;i>a;a++){var o=n[a];e.vmult(o,o)}for(var a=0;this.faceNormals.length>a;a++){var o=this.faceNormals[a];e.vmult(o,o)}}if(t)for(var a=0;i>a;a++){var o=n[a];o.vadd(t,o)}};var I=new a,E=new a,P=new a;i.prototype.pointIsInside=function(t){var e=this.vertices.length,i=this.vertices,n=this.faces,a=this.faceNormals,o=null,r=this.faces.length,s=I;this.getAveragePointLocal(s);for(var h=0;r>h;h++){this.faces[h].length;var e=a[h],c=i[n[h][0]],l=E;t.vsub(c,l);var p=e.dot(l),u=P;s.vsub(c,u);var d=e.dot(u);if(0>p&&d>0||p>0&&0>d)return!1}return o?1:-1};var B=(new a,new a),N=new a;i.project=function(t,e,i,n,a){var r=t.vertices.length,s=B,h=0,c=0,l=N,p=t.vertices;l.setZero(),o.vectorToLocalFrame(i,n,e,s),o.pointToLocalFrame(i,n,l,l);var u=l.dot(s);c=h=p[0].dot(s);for(var d=1;r>d;d++){var m=p[d].dot(s);m>h&&(h=m),c>m&&(c=m)}if(c-=u,h-=u,c>h){var f=c;c=h,h=f}a[0]=h,a[1]=c}},{"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"./Shape":43}],39:[function(t,e){function i(t,e,i,r){var s=r,h=[],c=[],l=[],p=[],u=[],d=Math.cos,m=Math.sin;h.push(new a(e*d(0),e*m(0),.5*-i)),p.push(0),h.push(new a(t*d(0),t*m(0),.5*i)),u.push(1);for(var f=0;s>f;f++){var y=2*Math.PI/s*(f+1),v=2*Math.PI/s*(f+.5);s-1>f?(h.push(new a(e*d(y),e*m(y),.5*-i)),p.push(2*f+2),h.push(new a(t*d(y),t*m(y),.5*i)),u.push(2*f+3),l.push([2*f+2,2*f+3,2*f+1,2*f])):l.push([0,1,2*f+1,2*f]),(1===s%2||s/2>f)&&c.push(new a(d(v),m(v),0))}l.push(u),c.push(new a(0,0,1));for(var x=[],f=0;p.length>f;f++)x.push(p[p.length-f-1]);l.push(x),this.type=n.types.CONVEXPOLYHEDRON,o.call(this,h,l,c)}e.exports=i;var n=t("./Shape"),a=t("../math/Vec3");t("../math/Quaternion");var o=t("./ConvexPolyhedron");i.prototype=new o},{"../math/Quaternion":28,"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],40:[function(t,e){function i(t,e){e=r.defaults(e,{maxValue:null,minValue:null,elementSize:1}),this.data=t,this.maxValue=e.maxValue,this.minValue=e.minValue,this.elementSize=e.elementSize,null===e.minValue&&this.updateMinValue(),null===e.maxValue&&this.updateMaxValue(),this.cacheEnabled=!0,n.call(this),this.pillarConvex=new a,this.pillarOffset=new o,this.type=n.types.HEIGHTFIELD,this.updateBoundingSphereRadius(),this._cachedPillars={}}var n=t("./Shape"),a=t("./ConvexPolyhedron"),o=t("../math/Vec3"),r=t("../utils/Utils");e.exports=i,i.prototype=new n,i.prototype.update=function(){this._cachedPillars={}},i.prototype.updateMinValue=function(){for(var t=this.data,e=t[0][0],i=0;i!==t.length;i++)for(var n=0;n!==t[i].length;n++){var a=t[i][n];e>a&&(e=a)}this.minValue=e},i.prototype.updateMaxValue=function(){for(var t=this.data,e=t[0][0],i=0;i!==t.length;i++)for(var n=0;n!==t[i].length;n++){var a=t[i][n];a>e&&(e=a)}this.maxValue=e},i.prototype.setHeightValueAtIndex=function(t,e,i){var n=this.data;n[t][e]=i,this.clearCachedConvexTrianglePillar(t,e,!1),t>0&&(this.clearCachedConvexTrianglePillar(t-1,e,!0),this.clearCachedConvexTrianglePillar(t-1,e,!1)),e>0&&(this.clearCachedConvexTrianglePillar(t,e-1,!0),this.clearCachedConvexTrianglePillar(t,e-1,!1)),e>0&&t>0&&this.clearCachedConvexTrianglePillar(t-1,e-1,!0)},i.prototype.getRectMinMax=function(t,e,i,n,a){a=a||[];for(var o=this.data,r=this.minValue,s=t;i>=s;s++)for(var h=e;n>=h;h++){var c=o[s][h];c>r&&(r=c)}a[0]=this.minValue,a[1]=r},i.prototype.getIndexOfPosition=function(t,e,i,n){var a=this.elementSize,o=this.data,r=Math.floor(t/a),s=Math.floor(e/a);return i[0]=r,i[1]=s,n&&(0>r&&(r=0),0>s&&(s=0),r>=o.length-1&&(r=o.length-1),s>=o[0].length-1&&(s=o[0].length-1)),0>r||0>s||r>=o.length-1||s>=o[0].length-1?!1:!0},i.prototype.getHeightAt=function(t,e,i){var n=[];this.getIndexOfPosition(t,e,n,i);var a=[];return this.getRectMinMax(n[0],n[1]+1,n[0],n[1]+1,a),(a[0]+a[1])/2},i.prototype.getCacheConvexTrianglePillarKey=function(t,e,i){return t+"_"+e+"_"+(i?1:0)},i.prototype.getCachedConvexTrianglePillar=function(t,e,i){return this._cachedPillars[this.getCacheConvexTrianglePillarKey(t,e,i)]},i.prototype.setCachedConvexTrianglePillar=function(t,e,i,n,a){this._cachedPillars[this.getCacheConvexTrianglePillarKey(t,e,i)]={convex:n,offset:a}},i.prototype.clearCachedConvexTrianglePillar=function(t,e,i){delete this._cachedPillars[this.getCacheConvexTrianglePillarKey(t,e,i)]},i.prototype.getConvexTrianglePillar=function(t,e,i){var n=this.pillarConvex,r=this.pillarOffset;if(this.cacheEnabled){var s=this.getCachedConvexTrianglePillar(t,e,i);if(s)return this.pillarConvex=s.convex,this.pillarOffset=s.offset,void 0;n=new a,r=new o,this.pillarConvex=n,this.pillarOffset=r}var s=this.data,h=this.elementSize,c=n.faces;n.vertices.length=6;for(var l=0;6>l;l++)n.vertices[l]||(n.vertices[l]=new o);c.length=5;for(var l=0;5>l;l++)c[l]||(c[l]=[]);var p=n.vertices,u=(Math.min(s[t][e],s[t+1][e],s[t][e+1],s[t+1][e+1])-this.minValue)/2+this.minValue;i?(r.set((t+.75)*h,(e+.75)*h,u),p[0].set(.25*h,.25*h,s[t+1][e+1]-u),p[1].set(-.75*h,.25*h,s[t][e+1]-u),p[2].set(.25*h,-.75*h,s[t+1][e]-u),p[3].set(.25*h,.25*h,-u-1),p[4].set(-.75*h,.25*h,-u-1),p[5].set(.25*h,-.75*h,-u-1),c[0][0]=0,c[0][1]=1,c[0][2]=2,c[1][0]=5,c[1][1]=4,c[1][2]=3,c[2][0]=2,c[2][1]=5,c[2][2]=3,c[2][3]=0,c[3][0]=3,c[3][1]=4,c[3][2]=1,c[3][3]=0,c[4][0]=1,c[4][1]=4,c[4][2]=5,c[4][3]=2):(r.set((t+.25)*h,(e+.25)*h,u),p[0].set(-.25*h,-.25*h,s[t][e]-u),p[1].set(.75*h,-.25*h,s[t+1][e]-u),p[2].set(-.25*h,.75*h,s[t][e+1]-u),p[3].set(-.25*h,-.25*h,-u-1),p[4].set(.75*h,-.25*h,-u-1),p[5].set(-.25*h,.75*h,-u-1),c[0][0]=0,c[0][1]=1,c[0][2]=2,c[1][0]=5,c[1][1]=4,c[1][2]=3,c[2][0]=0,c[2][1]=2,c[2][2]=5,c[2][3]=3,c[3][0]=1,c[3][1]=0,c[3][2]=3,c[3][3]=4,c[4][0]=4,c[4][1]=5,c[4][2]=2,c[4][3]=1),n.computeNormals(),n.computeEdges(),n.updateBoundingSphereRadius(),this.setCachedConvexTrianglePillar(t,e,i,n,r)},i.prototype.calculateLocalInertia=function(t,e){return e=e||new o,e.set(0,0,0),e},i.prototype.volume=function(){return Number.MAX_VALUE},i.prototype.calculateWorldAABB=function(t,e,i,n){i.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),n.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},i.prototype.updateBoundingSphereRadius=function(){var t=this.data,e=this.elementSize;this.boundingSphereRadius=new o(t.length*e,t[0].length*e,Math.max(Math.abs(this.maxValue),Math.abs(this.minValue))).norm()}},{"../math/Vec3":30,"../utils/Utils":53,"./ConvexPolyhedron":38,"./Shape":43}],41:[function(t,e){function i(){n.call(this),this.type=n.types.PARTICLE
}e.exports=i;var n=t("./Shape"),a=t("../math/Vec3");i.prototype=new n,i.prototype.constructor=i,i.prototype.calculateLocalInertia=function(t,e){return e=e||new a,e.set(0,0,0),e},i.prototype.volume=function(){return 0},i.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=0},i.prototype.calculateWorldAABB=function(t,e,i,n){i.copy(t),n.copy(t)}},{"../math/Vec3":30,"./Shape":43}],42:[function(t,e){function i(){n.call(this),this.type=n.types.PLANE,this.worldNormal=new a,this.worldNormalNeedsUpdate=!0,this.boundingSphereRadius=Number.MAX_VALUE}e.exports=i;var n=t("./Shape"),a=t("../math/Vec3");i.prototype=new n,i.prototype.constructor=i,i.prototype.computeWorldNormal=function(t){var e=this.worldNormal;e.set(0,0,1),t.vmult(e,e),this.worldNormalNeedsUpdate=!1},i.prototype.calculateLocalInertia=function(t,e){return e=e||new a},i.prototype.volume=function(){return Number.MAX_VALUE};var o=new a;i.prototype.calculateWorldAABB=function(t,e,i,n){o.set(0,0,1),e.vmult(o,o);var a=Number.MAX_VALUE;i.set(-a,-a,-a),n.set(a,a,a),1===o.x&&(n.x=t.x),1===o.y&&(n.y=t.y),1===o.z&&(n.z=t.z),-1===o.x&&(i.x=t.x),-1===o.y&&(i.y=t.y),-1===o.z&&(i.z=t.z)},i.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=Number.MAX_VALUE}},{"../math/Vec3":30,"./Shape":43}],43:[function(t,e){function i(){this.id=i.idCounter++,this.type=0,this.boundingSphereRadius=0,this.collisionResponse=!0,this.material=null}e.exports=i;var i=t("./Shape");t("../math/Vec3"),t("../math/Quaternion"),t("../material/Material"),i.prototype.constructor=i,i.prototype.updateBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type},i.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type},i.prototype.calculateLocalInertia=function(){throw"calculateLocalInertia() not implemented for shape type "+this.type},i.idCounter=0,i.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"./Shape":43}],44:[function(t,e){function i(t){if(n.call(this),this.radius=void 0!==t?Number(t):1,this.type=n.types.SPHERE,0>this.radius)throw Error("The sphere radius cannot be negative.");this.updateBoundingSphereRadius()}e.exports=i;var n=t("./Shape"),a=t("../math/Vec3");i.prototype=new n,i.prototype.constructor=i,i.prototype.calculateLocalInertia=function(t,e){e=e||new a;var i=2*t*this.radius*this.radius/5;return e.x=i,e.y=i,e.z=i,e},i.prototype.volume=function(){return 4*Math.PI*this.radius/3},i.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.radius},i.prototype.calculateWorldAABB=function(t,e,i,n){for(var a=this.radius,o=["x","y","z"],r=0;o.length>r;r++){var s=o[r];i[s]=t[s]-a,n[s]=t[s]+a}}},{"../math/Vec3":30,"./Shape":43}],45:[function(t,e){function i(t,e){n.call(this),this.type=n.types.TRIMESH,this.vertices=new Float32Array(t),this.indices=new Int16Array(e),this.normals=new Float32Array(e.length),this.aabb=new r,this.edges=null,this.scale=new a(1,1,1),this.tree=new s,this.updateEdges(),this.updateNormals(),this.updateAABB(),this.updateBoundingSphereRadius(),this.updateTree()}e.exports=i;var n=t("./Shape"),a=t("../math/Vec3");t("../math/Quaternion");var o=t("../math/Transform"),r=t("../collision/AABB"),s=t("../utils/Octree");i.prototype=new n,i.prototype.constructor=i;var h=new a;i.prototype.updateTree=function(){var t=this.tree;t.reset(),t.aabb.copy(this.aabb);var e=this.scale;t.aabb.lowerBound.x*=1/e.x,t.aabb.lowerBound.y*=1/e.y,t.aabb.lowerBound.z*=1/e.z,t.aabb.upperBound.x*=1/e.x,t.aabb.upperBound.y*=1/e.y,t.aabb.upperBound.z*=1/e.z;for(var i=new r,n=new a,o=new a,s=new a,h=[n,o,s],c=0;this.indices.length/3>c;c++){var l=3*c;this._getUnscaledVertex(this.indices[l],n),this._getUnscaledVertex(this.indices[l+1],o),this._getUnscaledVertex(this.indices[l+2],s),i.setFromPoints(h),t.insert(i,c)}t.removeEmptyNodes()};var c=new r;i.prototype.getTrianglesInAABB=function(t,e){c.copy(t);var i=this.scale,n=i.x,a=i.y,o=i.z,r=c.lowerBound,s=c.upperBound;return r.x/=n,r.y/=a,r.z/=o,s.x/=n,s.y/=a,s.z/=o,this.tree.aabbQuery(c,e)},i.prototype.setScale=function(t){var e=this.scale.x===this.scale.y===this.scale.z,i=t.x===t.y===t.z;e&&i||this.updateNormals(),this.scale.copy(t),this.updateAABB(),this.updateBoundingSphereRadius()},i.prototype.updateNormals=function(){for(var t=h,e=this.normals,n=0;this.indices.length/3>n;n++){var a=3*n,o=this.indices[a],r=this.indices[a+1],s=this.indices[a+2];this.getVertex(o,m),this.getVertex(r,f),this.getVertex(s,y),i.computeNormal(f,m,y,t),e[a]=t.x,e[a+1]=t.y,e[a+2]=t.z}},i.prototype.updateEdges=function(){for(var t={},e=function(){var e=o>a?a+"_"+o:o+"_"+a;t[e]=!0},i=0;this.indices.length/3>i;i++){var n=3*i,a=this.indices[n],o=this.indices[n+1],r=this.indices[n+2];e(a,o),e(o,r),e(r,a)}var s=Object.keys(t);this.edges=new Int16Array(2*s.length);for(var i=0;s.length>i;i++){var h=s[i].split("_");this.edges[2*i]=parseInt(h[0],10),this.edges[2*i+1]=parseInt(h[1],10)}},i.prototype.getEdgeVertex=function(t,e,i){var n=this.edges[2*t+(e?1:0)];this.getVertex(n,i)};var l=new a,p=new a;i.prototype.getEdgeVector=function(t,e){var i=l,n=p;this.getEdgeVertex(t,0,i),this.getEdgeVertex(t,1,n),n.vsub(i,e)};var u=new a,d=new a;i.computeNormal=function(t,e,i,n){e.vsub(t,d),i.vsub(e,u),u.cross(d,n),n.isZero()||n.normalize()};var m=new a,f=new a,y=new a;i.prototype.getVertex=function(t,e){var i=this.scale;return this._getUnscaledVertex(t,e),e.x*=i.x,e.y*=i.y,e.z*=i.z,e},i.prototype._getUnscaledVertex=function(t,e){var i=3*t,n=this.vertices;return e.set(n[i],n[i+1],n[i+2])},i.prototype.getWorldVertex=function(t,e,i,n){return this.getVertex(t,n),o.pointToWorldFrame(e,i,n,n),n},i.prototype.getTriangleVertices=function(t,e,i,n){var a=3*t;this.getVertex(this.indices[a],e),this.getVertex(this.indices[a+1],i),this.getVertex(this.indices[a+2],n)},i.prototype.getNormal=function(t,e){var i=3*t;return e.set(this.normals[i],this.normals[i+1],this.normals[i+2])};var v=new r;i.prototype.calculateLocalInertia=function(t,e){this.computeLocalAABB(v);var i=v.upperBound.x-v.lowerBound.x,n=v.upperBound.y-v.lowerBound.y,a=v.upperBound.z-v.lowerBound.z;return e.set(1/12*t*(2*2*n*n+2*2*a*a),1/12*t*(2*2*i*i+2*2*a*a),1/12*t*(2*2*n*n+2*2*i*i))};var x=new a;i.prototype.computeLocalAABB=function(t){var e=t.lowerBound,i=t.upperBound,n=this.vertices.length,a=(this.vertices,x);this.getVertex(0,a),e.copy(a),i.copy(a);for(var o=0;o!==n;o++)this.getVertex(o,a),a.x<e.x?e.x=a.x:a.x>i.x&&(i.x=a.x),a.y<e.y?e.y=a.y:a.y>i.y&&(i.y=a.y),a.z<e.z?e.z=a.z:a.z>i.z&&(i.z=a.z)},i.prototype.updateAABB=function(){this.computeLocalAABB(this.aabb)},i.prototype.updateBoundingSphereRadius=function(){for(var t=0,e=this.vertices,i=new a,n=0,o=e.length/3;n!==o;n++){this.getVertex(n,i);var r=i.norm2();r>t&&(t=r)}this.boundingSphereRadius=Math.sqrt(t)},new a;var g=new o,_=new r;i.prototype.calculateWorldAABB=function(t,e,i,n){var a=g,o=_;a.position=t,a.quaternion=e,this.aabb.toWorldFrame(a,o),i.copy(o.lowerBound),n.copy(o.upperBound)},i.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},i.createTorus=function(t,e,n,a,o){t=t||1,e=e||.5,n=n||8,a=a||6,o=o||2*Math.PI;for(var r=[],s=[],h=0;n>=h;h++)for(var c=0;a>=c;c++){var l=c/a*o,p=2*h/n*Math.PI,u=(t+e*Math.cos(p))*Math.cos(l),d=(t+e*Math.cos(p))*Math.sin(l),m=e*Math.sin(p);r.push(u,d,m)}for(var h=1;n>=h;h++)for(var c=1;a>=c;c++){var f=(a+1)*h+c-1,y=(a+1)*(h-1)+c-1,v=(a+1)*(h-1)+c,x=(a+1)*h+c;s.push(f,y,x),s.push(y,v,x)}return new i(r,s)}},{"../collision/AABB":3,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../utils/Octree":50,"./Shape":43}],46:[function(t,e){function i(){n.call(this),this.iterations=10,this.tolerance=1e-7}e.exports=i,t("../math/Vec3"),t("../math/Quaternion");var n=t("./Solver");i.prototype=new n;var a=[],o=[],r=[];i.prototype.solve=function(t,e){var i,n,s,h,c,l,p=0,u=this.iterations,d=this.tolerance*this.tolerance,m=this.equations,f=m.length,y=e.bodies,v=y.length,x=t;if(0!==f)for(var g=0;g!==v;g++)y[g].updateSolveMassProperties();var _=o,D=r,w=a;_.length=f,D.length=f,w.length=f;for(var g=0;g!==f;g++){var b=m[g];w[g]=0,D[g]=b.computeB(x),_[g]=1/b.computeC()}if(0!==f){for(var g=0;g!==v;g++){var S=y[g],M=S.vlambda,C=S.wlambda;M.set(0,0,0),C&&C.set(0,0,0)}for(p=0;p!==u;p++){h=0;for(var T=0;T!==f;T++){var b=m[T];i=D[T],n=_[T],l=w[T],c=b.computeGWlambda(),s=n*(i-c-b.eps*l),b.minForce>l+s?s=b.minForce-l:l+s>b.maxForce&&(s=b.maxForce-l),w[T]+=s,h+=s>0?s:-s,b.addToWlambda(s)}if(d>h*h)break}for(var g=0;g!==v;g++){var S=y[g],A=S.velocity,I=S.angularVelocity;A.vadd(S.vlambda,A),I&&I.vadd(S.wlambda,I)}}return p}},{"../math/Quaternion":28,"../math/Vec3":30,"./Solver":47}],47:[function(t,e){function i(){this.equations=[]}e.exports=i,i.prototype.solve=function(){return 0},i.prototype.addEquation=function(t){t.enabled&&this.equations.push(t)},i.prototype.removeEquation=function(t){var e=this.equations,i=e.indexOf(t);-1!==i&&e.splice(i,1)},i.prototype.removeAllEquations=function(){this.equations.length=0}},{}],48:[function(t,e){function i(t){for(s.call(this),this.iterations=10,this.tolerance=1e-7,this.subsolver=t,this.nodes=[],this.nodePool=[];128>this.nodePool.length;)this.nodePool.push(this.createNode())}function n(t){for(var e=t.length,i=0;i!==e;i++){var n=t[i];if(!(n.visited||n.body.type&u))return n}return!1}function a(t,e,i,a){for(d.push(t),t.visited=!0,e(t,i,a);d.length;)for(var o,r=d.pop();o=n(r.children);)o.visited=!0,e(o,i,a),d.push(o)}function o(t,e,i){e.push(t.body);for(var n=t.eqs.length,a=0;a!==n;a++){var o=t.eqs[a];-1===i.indexOf(o)&&i.push(o)}}function r(t,e){return e.id-t.id}e.exports=i,t("../math/Vec3"),t("../math/Quaternion");var s=t("./Solver"),h=t("../objects/Body");i.prototype=new s;var c=[],l=[],p={bodies:[]},u=h.STATIC,d=[];i.prototype.createNode=function(){return{body:null,children:[],eqs:[],visited:!1}},i.prototype.solve=function(t,e){for(var i=c,s=this.nodePool,h=e.bodies,u=this.equations,d=u.length,m=h.length,f=this.subsolver;m>s.length;)s.push(this.createNode());i.length=m;for(var y=0;m>y;y++)i[y]=s[y];for(var y=0;y!==m;y++){var v=i[y];v.body=h[y],v.children.length=0,v.eqs.length=0,v.visited=!1}for(var x=0;x!==d;x++){var g=u[x],y=h.indexOf(g.bi),_=h.indexOf(g.bj),D=i[y],w=i[_];D.children.push(w),D.eqs.push(g),w.children.push(D),w.eqs.push(g)}var b,S=0,M=l;f.tolerance=this.tolerance,f.iterations=this.iterations;for(var C=p;b=n(i);){M.length=0,C.bodies.length=0,a(b,o,C.bodies,M);var T=M.length;M=M.sort(r);for(var y=0;y!==T;y++)f.addEquation(M[y]);f.solve(t,C),f.removeAllEquations(),S++}return S}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"./Solver":47}],49:[function(t,e){var i=function(){};e.exports=i,i.prototype={constructor:i,addEventListener:function(t,e){void 0===this._listeners&&(this._listeners={});var i=this._listeners;return void 0===i[t]&&(i[t]=[]),-1===i[t].indexOf(e)&&i[t].push(e),this},hasEventListener:function(t,e){if(void 0===this._listeners)return!1;var i=this._listeners;return void 0!==i[t]&&-1!==i[t].indexOf(e)?!0:!1},removeEventListener:function(t,e){if(void 0===this._listeners)return this;var i=this._listeners;if(void 0===i[t])return this;var n=i[t].indexOf(e);return-1!==n&&i[t].splice(n,1),this},dispatchEvent:function(t){if(void 0===this._listeners)return this;var e=this._listeners,i=e[t.type];if(void 0!==i){t.target=this;for(var n=0,a=i.length;a>n;n++)i[n].call(this,t)}return this}}},{}],50:[function(t,e){function i(t){t=t||{},this.root=t.root||null,this.aabb=t.aabb?t.aabb.clone():new a,this.data=[],this.children=[]}function n(t,e){e=e||{},e.root=null,e.aabb=t,i.call(this,e),this.maxDepth=e.maxDepth!==void 0?e.maxDepth:8}var a=t("../collision/AABB"),o=t("../math/Vec3");e.exports=n,n.prototype=new i,i.prototype.reset=function(){this.children.length=this.data.length=0},i.prototype.insert=function(t,e,i){var n=this.data;if(i=i||0,!this.aabb.contains(t))return!1;var a=this.children;if((this.maxDepth||this.root.maxDepth)>i){var o=!1;a.length||(this.subdivide(),o=!0);for(var r=0;8!==r;r++)if(a[r].insert(t,e,i+1))return!0;o&&(a.length=0)}return n.push(e),!0};var r=new o;i.prototype.subdivide=function(){var t=this.aabb,e=t.lowerBound,n=t.upperBound,s=this.children;s.push(new i({aabb:new a({lowerBound:new o(0,0,0)})}),new i({aabb:new a({lowerBound:new o(1,0,0)})}),new i({aabb:new a({lowerBound:new o(1,1,0)})}),new i({aabb:new a({lowerBound:new o(1,1,1)})}),new i({aabb:new a({lowerBound:new o(0,1,1)})}),new i({aabb:new a({lowerBound:new o(0,0,1)})}),new i({aabb:new a({lowerBound:new o(1,0,1)})}),new i({aabb:new a({lowerBound:new o(0,1,0)})})),n.vsub(e,r),r.scale(.5,r);for(var h=this.root||this,c=0;8!==c;c++){var l=s[c];l.root=h;var p=l.aabb.lowerBound;p.x*=r.x,p.y*=r.y,p.z*=r.z,p.vadd(e,p),p.vadd(r,l.aabb.upperBound)}},i.prototype.aabbQuery=function(t,e){this.data,this.children;for(var i=[this];i.length;){var n=i.pop();n.aabb.overlaps(t)&&Array.prototype.push.apply(e,n.data),Array.prototype.push.apply(i,n.children)}return e};var s=new a;i.prototype.rayQuery=function(t,e,i){return t.getAABB(s),s.toLocalFrame(e,s),this.aabbQuery(s,i),i},i.prototype.removeEmptyNodes=function(){for(var t=[this];t.length;){for(var e=t.pop(),i=e.children.length-1;i>=0;i--)e.children[i].data.length||e.children.splice(i,1);Array.prototype.push.apply(t,e.children)}}},{"../collision/AABB":3,"../math/Vec3":30}],51:[function(t,e){function i(){this.objects=[],this.type=Object}e.exports=i,i.prototype.release=function(){for(var t=arguments.length,e=0;e!==t;e++)this.objects.push(arguments[e])},i.prototype.get=function(){return 0===this.objects.length?this.constructObject():this.objects.pop()},i.prototype.constructObject=function(){throw Error("constructObject() not implemented in this Pool subclass yet!")}},{}],52:[function(t,e){function i(){this.data={keys:[]}}e.exports=i,i.prototype.get=function(t,e){if(t>e){var i=e;e=t,t=i}return this.data[t+"-"+e]},i.prototype.set=function(t,e,i){if(t>e){var n=e;e=t,t=n}var a=t+"-"+e;this.get(t,e)||this.data.keys.push(a),this.data[a]=i},i.prototype.reset=function(){for(var t=this.data,e=t.keys;e.length>0;){var i=e.pop();delete t[i]}}},{}],53:[function(t,e){function i(){}e.exports=i,i.defaults=function(t,e){t=t||{};for(var i in e)i in t||(t[i]=e[i]);return t}},{}],54:[function(t,e){function i(){a.call(this),this.type=n}e.exports=i;var n=t("../math/Vec3"),a=t("./Pool");i.prototype=new a,i.prototype.constructObject=function(){return new n}},{"../math/Vec3":30,"./Pool":51}],55:[function(t,e){function i(t){this.contactPointPool=[],this.frictionEquationPool=[],this.result=[],this.frictionResult=[],this.v3pool=new l,this.world=t,this.currentContactMaterial=null,this.enableFrictionReduction=!1}function n(t,e,i){for(var n=null,a=t.length,o=0;o!==a;o++){var r=t[o],s=k;t[(o+1)%a].vsub(r,s);var h=j;s.cross(e,h);var c=U;i.vsub(r,c);var l=h.dot(c);if(!(null===n||l>0&&n===!0||0>=l&&n===!1))return!1;null===n&&(n=l>0)}return!0}e.exports=i;var a=t("../collision/AABB"),o=t("../shapes/Shape"),r=t("../collision/Ray"),s=t("../math/Vec3"),h=t("../math/Transform");t("../shapes/ConvexPolyhedron");var c=t("../math/Quaternion");t("../solver/Solver");var l=t("../utils/Vec3Pool"),p=t("../equations/ContactEquation"),u=t("../equations/FrictionEquation");i.prototype.createContactEquation=function(t,e,i,n,a,o){var r;this.contactPointPool.length?(r=this.contactPointPool.pop(),r.bi=t,r.bj=e):r=new p(t,e),r.enabled=t.collisionResponse&&e.collisionResponse&&i.collisionResponse&&n.collisionResponse;var s=this.currentContactMaterial;r.restitution=s.restitution,r.setSpookParams(s.contactEquationStiffness,s.contactEquationRelaxation,this.world.dt);var h=i.material||t.material,c=n.material||e.material;return h&&c&&h.restitution>=0&&c.restitution>=0&&(r.restitution=h.restitution*c.restitution),r.si=a||i,r.sj=o||n,r},i.prototype.createFrictionEquationsFromContact=function(t,e){var i=t.bi,n=t.bj,a=t.si,o=t.sj,r=this.world,s=this.currentContactMaterial,h=s.friction,c=a.material||i.material,l=o.material||n.material;if(c&&l&&c.friction>=0&&l.friction>=0&&(h=c.friction*l.friction),h>0){var p=h*r.gravity.length(),d=i.invMass+n.invMass;d>0&&(d=1/d);var m=this.frictionEquationPool,f=m.length?m.pop():new u(i,n,p*d),y=m.length?m.pop():new u(i,n,p*d);return f.bi=y.bi=i,f.bj=y.bj=n,f.minForce=y.minForce=-p*d,f.maxForce=y.maxForce=p*d,f.ri.copy(t.ri),f.rj.copy(t.rj),y.ri.copy(t.ri),y.rj.copy(t.rj),t.ni.tangents(f.t,y.t),f.setSpookParams(s.frictionEquationStiffness,s.frictionEquationRelaxation,r.dt),y.setSpookParams(s.frictionEquationStiffness,s.frictionEquationRelaxation,r.dt),f.enabled=y.enabled=t.enabled,e.push(f,y),!0}return!1};var d=new s,m=new s,f=new s;i.prototype.createFrictionFromAverage=function(t){var e=this.result[this.result.length-1];if(this.createFrictionEquationsFromContact(e,this.frictionResult)&&1!==t){var i=this.frictionResult[this.frictionResult.length-2],n=this.frictionResult[this.frictionResult.length-1];d.setZero(),m.setZero(),f.setZero();var a=e.bi;e.bj;for(var o=0;o!==t;o++)e=this.result[this.result.length-1-o],e.bodyA!==a?(d.vadd(e.ni,d),m.vadd(e.ri,m),f.vadd(e.rj,f)):(d.vsub(e.ni,d),m.vadd(e.rj,m),f.vadd(e.ri,f));var r=1/t;m.scale(r,i.ri),f.scale(r,i.rj),n.ri.copy(i.ri),n.rj.copy(i.rj),d.normalize(),d.tangents(i.t,n.t)}};var y=new s,v=new s,x=new c,g=new c;i.prototype.getContacts=function(t,e,i,n,a,o,r){this.contactPointPool=a,this.frictionEquationPool=r,this.result=n,this.frictionResult=o;for(var s=x,h=g,c=y,l=v,p=0,u=t.length;p!==u;p++){var d=t[p],m=e[p],f=null;d.material&&m.material&&(f=i.getContactMaterial(d.material,m.material)||null);for(var _=0;d.shapes.length>_;_++){d.quaternion.mult(d.shapeOrientations[_],s),d.quaternion.vmult(d.shapeOffsets[_],c),c.vadd(d.position,c);for(var D=d.shapes[_],w=0;m.shapes.length>w;w++){m.quaternion.mult(m.shapeOrientations[w],h),m.quaternion.vmult(m.shapeOffsets[w],l),l.vadd(m.position,l);var b=m.shapes[w];if(!(c.distanceTo(l)>D.boundingSphereRadius+b.boundingSphereRadius)){var S=null;D.material&&b.material&&(S=i.getContactMaterial(D.material,b.material)||null),this.currentContactMaterial=S||f||i.defaultContactMaterial;var M=this[D.type|b.type];M&&(D.type<b.type?M.call(this,D,b,c,l,s,h,d,m,D,b):M.call(this,b,D,l,c,h,s,m,d,D,b))}}}}},i.prototype[o.types.BOX|o.types.BOX]=i.prototype.boxBox=function(t,e,i,n,a,o,r,s){t.convexPolyhedronRepresentation.material=t.material,e.convexPolyhedronRepresentation.material=e.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexConvex(t.convexPolyhedronRepresentation,e.convexPolyhedronRepresentation,i,n,a,o,r,s,t,e)},i.prototype[o.types.BOX|o.types.CONVEXPOLYHEDRON]=i.prototype.boxConvex=function(t,e,i,n,a,o,r,s){t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexConvex(t.convexPolyhedronRepresentation,e,i,n,a,o,r,s,t,e)},i.prototype[o.types.BOX|o.types.PARTICLE]=i.prototype.boxParticle=function(t,e,i,n,a,o,r,s){t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexParticle(t.convexPolyhedronRepresentation,e,i,n,a,o,r,s,t,e)},i.prototype[o.types.SPHERE]=i.prototype.sphereSphere=function(t,e,i,n,a,o,r,s){var h=this.createContactEquation(r,s,t,e);n.vsub(i,h.ni),h.ni.normalize(),h.ri.copy(h.ni),h.rj.copy(h.ni),h.ri.mult(t.radius,h.ri),h.rj.mult(-e.radius,h.rj),h.ri.vadd(i,h.ri),h.ri.vsub(r.position,h.ri),h.rj.vadd(n,h.rj),h.rj.vsub(s.position,h.rj),this.result.push(h),this.createFrictionEquationsFromContact(h,this.frictionResult)};var _=new s,D=new s,w=new s;i.prototype[o.types.PLANE|o.types.TRIMESH]=i.prototype.planeTrimesh=function(t,e,i,n,a,o,r,c){var l=new s,p=_;p.set(0,0,1),a.vmult(p,p);for(var u=0;e.vertices.length/3>u;u++){e.getVertex(u,l);var d=new s;d.copy(l),h.pointToWorldFrame(n,o,d,l);var m=D;l.vsub(i,m);var f=p.dot(m);if(0>=f){var y=this.createContactEquation(r,c,t,e);y.ni.copy(p);var v=w;p.scale(m.dot(p),v),l.vsub(v,v),y.ri.copy(v),y.ri.vsub(r.position,y.ri),y.rj.copy(l),y.rj.vsub(c.position,y.rj),this.result.push(y),this.createFrictionEquationsFromContact(y,this.frictionResult)}}};var b=new s,S=new s;new s;var M=new s,C=new s,T=new s,A=new s,I=new s,E=new s,P=new s,B=new s,N=new s,V=new s,R=new s,L=new a,z=[];i.prototype[o.types.SPHERE|o.types.TRIMESH]=i.prototype.sphereTrimesh=function(t,e,i,n,a,o,s,c){var l=T,p=A,u=I,d=E,m=P,f=B,y=L,v=C,x=S,g=z;h.pointToLocalFrame(n,o,i,m);var _=t.radius;y.lowerBound.set(m.x-_,m.y-_,m.z-_),y.upperBound.set(m.x+_,m.y+_,m.z+_),e.getTrianglesInAABB(y,g);for(var D=M,w=t.radius*t.radius,F=0;g.length>F;F++)for(var O=0;3>O;O++)if(e.getVertex(e.indices[3*g[F]+O],D),D.vsub(m,x),w>=x.norm2()){v.copy(D),h.pointToWorldFrame(n,o,v,D),D.vsub(i,x);var k=this.createContactEquation(s,c,t,e);k.ni.copy(x),k.ni.normalize(),k.ri.copy(k.ni),k.ri.scale(t.radius,k.ri),k.ri.vadd(i,k.ri),k.ri.vsub(s.position,k.ri),k.rj.copy(D),k.rj.vsub(c.position,k.rj),this.result.push(k),this.createFrictionEquationsFromContact(k,this.frictionResult)}for(var F=0;g.length>F;F++)for(var O=0;3>O;O++){e.getVertex(e.indices[3*g[F]+O],l),e.getVertex(e.indices[3*g[F]+(O+1)%3],p),p.vsub(l,u),m.vsub(p,f);var j=f.dot(u);m.vsub(l,f);var U=f.dot(u);if(U>0&&0>j){m.vsub(l,f),d.copy(u),d.normalize(),U=f.dot(d),d.scale(U,f),f.vadd(l,f);var X=f.distanceTo(m);if(t.radius>X){var k=this.createContactEquation(s,c,t,e);f.vsub(m,k.ni),k.ni.normalize(),k.ni.scale(t.radius,k.ri),h.pointToWorldFrame(n,o,f,f),f.vsub(c.position,k.rj),h.vectorToWorldFrame(o,k.ni,k.ni),h.vectorToWorldFrame(o,k.ri,k.ri),this.result.push(k),this.createFrictionEquationsFromContact(k,this.frictionResult)}}}for(var W=N,q=V,Y=R,G=b,F=0,H=g.length;F!==H;F++){e.getTriangleVertices(g[F],W,q,Y),e.getNormal(g[F],G),m.vsub(W,f);var X=f.dot(G);if(G.scale(X,f),m.vsub(f,f),X=f.distanceTo(m),r.pointInTriangle(f,W,q,Y)&&t.radius>X){var k=this.createContactEquation(s,c,t,e);f.vsub(m,k.ni),k.ni.normalize(),k.ni.scale(t.radius,k.ri),h.pointToWorldFrame(n,o,f,f),f.vsub(c.position,k.rj),h.vectorToWorldFrame(o,k.ni,k.ni),h.vectorToWorldFrame(o,k.ri,k.ri),this.result.push(k),this.createFrictionEquationsFromContact(k,this.frictionResult)}}g.length=0};var F=new s,O=new s;i.prototype[o.types.SPHERE|o.types.PLANE]=i.prototype.spherePlane=function(t,e,i,n,a,o,r,s){var h=this.createContactEquation(r,s,t,e);if(h.ni.set(0,0,1),o.vmult(h.ni,h.ni),h.ni.negate(h.ni),h.ni.normalize(),h.ni.mult(t.radius,h.ri),i.vsub(n,F),h.ni.mult(h.ni.dot(F),O),F.vsub(O,h.rj),-F.dot(h.ni)<=t.radius){var c=h.ri,l=h.rj;c.vadd(i,c),c.vsub(r.position,c),l.vadd(n,l),l.vsub(s.position,l),this.result.push(h),this.createFrictionEquationsFromContact(h,this.frictionResult)}};var k=new s,j=new s,U=new s,X=new s,W=new s,q=new s,Y=new s,G=[new s,new s,new s,new s,new s,new s],H=new s,Z=new s,K=new s,Q=new s;i.prototype[o.types.SPHERE|o.types.BOX]=i.prototype.sphereBox=function(t,e,i,n,a,o,r,s){var h=this.v3pool,c=G;i.vsub(n,X),e.getSideNormals(c,o);for(var l=t.radius,p=!1,u=Z,d=K,m=Q,f=null,y=0,v=0,x=0,g=null,_=0,D=c.length;_!==D&&p===!1;_++){var w=W;w.copy(c[_]);var b=w.norm();w.normalize();var S=X.dot(w);if(b+l>S&&S>0){var M=q,C=Y;M.copy(c[(_+1)%3]),C.copy(c[(_+2)%3]);var T=M.norm(),A=C.norm();M.normalize(),C.normalize();var I=X.dot(M),E=X.dot(C);if(T>I&&I>-T&&A>E&&E>-A){var P=Math.abs(S-b-l);(null===g||g>P)&&(g=P,v=I,x=E,f=b,u.copy(w),d.copy(M),m.copy(C),y++)}}}if(y){p=!0;var B=this.createContactEquation(r,s,t,e);u.mult(-l,B.ri),B.ni.copy(u),B.ni.negate(B.ni),u.mult(f,u),d.mult(v,d),u.vadd(d,u),m.mult(x,m),u.vadd(m,B.rj),B.ri.vadd(i,B.ri),B.ri.vsub(r.position,B.ri),B.rj.vadd(n,B.rj),B.rj.vsub(s.position,B.rj),this.result.push(B),this.createFrictionEquationsFromContact(B,this.frictionResult)}for(var N=h.get(),V=H,R=0;2!==R&&!p;R++)for(var L=0;2!==L&&!p;L++)for(var z=0;2!==z&&!p;z++)if(N.set(0,0,0),R?N.vadd(c[0],N):N.vsub(c[0],N),L?N.vadd(c[1],N):N.vsub(c[1],N),z?N.vadd(c[2],N):N.vsub(c[2],N),n.vadd(N,V),V.vsub(i,V),l*l>V.norm2()){p=!0;var B=this.createContactEquation(r,s,t,e);B.ri.copy(V),B.ri.normalize(),B.ni.copy(B.ri),B.ri.mult(l,B.ri),B.rj.copy(N),B.ri.vadd(i,B.ri),B.ri.vsub(r.position,B.ri),B.rj.vadd(n,B.rj),B.rj.vsub(s.position,B.rj),this.result.push(B),this.createFrictionEquationsFromContact(B,this.frictionResult)}h.release(N),N=null;for(var F=h.get(),O=h.get(),B=h.get(),k=h.get(),P=h.get(),j=c.length,R=0;R!==j&&!p;R++)for(var L=0;L!==j&&!p;L++)if(R%3!==L%3){c[L].cross(c[R],F),F.normalize(),c[R].vadd(c[L],O),B.copy(i),B.vsub(O,B),B.vsub(n,B);var U=B.dot(F);F.mult(U,k);for(var z=0;z===R%3||z===L%3;)z++;P.copy(i),P.vsub(k,P),P.vsub(O,P),P.vsub(n,P);var J=Math.abs(U),$=P.norm();if(c[z].norm()>J&&l>$){p=!0;var te=this.createContactEquation(r,s,t,e);O.vadd(k,te.rj),te.rj.copy(te.rj),P.negate(te.ni),te.ni.normalize(),te.ri.copy(te.rj),te.ri.vadd(n,te.ri),te.ri.vsub(i,te.ri),te.ri.normalize(),te.ri.mult(l,te.ri),te.ri.vadd(i,te.ri),te.ri.vsub(r.position,te.ri),te.rj.vadd(n,te.rj),te.rj.vsub(s.position,te.rj),this.result.push(te),this.createFrictionEquationsFromContact(te,this.frictionResult)}}h.release(F,O,B,k,P)};var J=new s,$=new s,te=new s,ee=new s,ie=new s,ne=new s,ae=new s,oe=new s,re=new s,se=new s;i.prototype[o.types.SPHERE|o.types.CONVEXPOLYHEDRON]=i.prototype.sphereConvex=function(t,e,i,a,o,r,s,h){var c=this.v3pool;i.vsub(a,J);for(var l=e.faceNormals,p=e.faces,u=e.vertices,d=t.radius,m=0;m!==u.length;m++){var f=u[m],y=ie;r.vmult(f,y),a.vadd(y,y);var v=ee;if(y.vsub(i,v),d*d>v.norm2()){g=!0;var x=this.createContactEquation(s,h,t,e);return x.ri.copy(v),x.ri.normalize(),x.ni.copy(x.ri),x.ri.mult(d,x.ri),y.vsub(a,x.rj),x.ri.vadd(i,x.ri),x.ri.vsub(s.position,x.ri),x.rj.vadd(a,x.rj),x.rj.vsub(h.position,x.rj),this.result.push(x),this.createFrictionEquationsFromContact(x,this.frictionResult),void 0}}for(var g=!1,m=0,_=p.length;m!==_&&g===!1;m++){var D=l[m],w=p[m],b=ne;r.vmult(D,b);var S=ae;r.vmult(u[w[0]],S),S.vadd(a,S);var M=oe;b.mult(-d,M),i.vadd(M,M);var C=re;M.vsub(S,C);var T=C.dot(b),A=se;if(i.vsub(S,A),0>T&&A.dot(b)>0){for(var I=[],E=0,P=w.length;E!==P;E++){var B=c.get();r.vmult(u[w[E]],B),a.vadd(B,B),I.push(B)}if(n(I,b,i)){g=!0;var x=this.createContactEquation(s,h,t,e);b.mult(-d,x.ri),b.negate(x.ni);var N=c.get();b.mult(-T,N);var V=c.get();b.mult(-d,V),i.vsub(a,x.rj),x.rj.vadd(V,x.rj),x.rj.vadd(N,x.rj),x.rj.vadd(a,x.rj),x.rj.vsub(h.position,x.rj),x.ri.vadd(i,x.ri),x.ri.vsub(s.position,x.ri),c.release(N),c.release(V),this.result.push(x),this.createFrictionEquationsFromContact(x,this.frictionResult);for(var E=0,R=I.length;E!==R;E++)c.release(I[E]);return}for(var E=0;E!==w.length;E++){var L=c.get(),z=c.get();r.vmult(u[w[(E+1)%w.length]],L),r.vmult(u[w[(E+2)%w.length]],z),a.vadd(L,L),a.vadd(z,z);var F=$;z.vsub(L,F);var O=te;F.unit(O);var k=c.get(),j=c.get();i.vsub(L,j);var U=j.dot(O);O.mult(U,k),k.vadd(L,k);var X=c.get();if(k.vsub(i,X),U>0&&F.norm2()>U*U&&d*d>X.norm2()){var x=this.createContactEquation(s,h,t,e);k.vsub(a,x.rj),k.vsub(i,x.ni),x.ni.normalize(),x.ni.mult(d,x.ri),x.rj.vadd(a,x.rj),x.rj.vsub(h.position,x.rj),x.ri.vadd(i,x.ri),x.ri.vsub(s.position,x.ri),this.result.push(x),this.createFrictionEquationsFromContact(x,this.frictionResult);for(var E=0,R=I.length;E!==R;E++)c.release(I[E]);return c.release(L),c.release(z),c.release(k),c.release(X),c.release(j),void 0}c.release(L),c.release(z),c.release(k),c.release(X),c.release(j)}for(var E=0,R=I.length;E!==R;E++)c.release(I[E])}}},new s,new s,i.prototype[o.types.PLANE|o.types.BOX]=i.prototype.planeBox=function(t,e,i,n,a,o,r,s){e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.planeConvex(t,e.convexPolyhedronRepresentation,i,n,a,o,r,s)};var he=new s,ce=new s,le=new s,pe=new s;i.prototype[o.types.PLANE|o.types.CONVEXPOLYHEDRON]=i.prototype.planeConvex=function(t,e,i,n,a,o,r,s){var h=he,c=ce;c.set(0,0,1),a.vmult(c,c);for(var l=0,p=le,u=0;u!==e.vertices.length;u++){h.copy(e.vertices[u]),o.vmult(h,h),n.vadd(h,h),h.vsub(i,p);var d=c.dot(p);if(0>=d){var m=this.createContactEquation(r,s,t,e),f=pe;c.mult(c.dot(p),f),h.vsub(f,f),f.vsub(i,m.ri),m.ni.copy(c),h.vsub(n,m.rj),m.ri.vadd(i,m.ri),m.ri.vsub(r.position,m.ri),m.rj.vadd(n,m.rj),m.rj.vsub(s.position,m.rj),this.result.push(m),l++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(m,this.frictionResult)}}this.enableFrictionReduction&&l&&this.createFrictionFromAverage(l)};var ue=new s,de=new s;i.prototype[o.types.CONVEXPOLYHEDRON]=i.prototype.convexConvex=function(t,e,i,n,a,o,r,s,h,c,l,p){var u=ue;if(!(i.distanceTo(n)>t.boundingSphereRadius+e.boundingSphereRadius)&&t.findSeparatingAxis(e,i,a,n,o,u,l,p)){var d=[],m=de;t.clipAgainstHull(i,a,e,n,o,u,-100,100,d);for(var f=0,y=0;y!==d.length;y++){var v=this.createContactEquation(r,s,t,e,h,c),x=v.ri,g=v.rj;u.negate(v.ni),d[y].normal.negate(m),m.mult(d[y].depth,m),d[y].point.vadd(m,x),g.copy(d[y].point),x.vsub(i,x),g.vsub(n,g),x.vadd(i,x),x.vsub(r.position,x),g.vadd(n,g),g.vsub(s.position,g),this.result.push(v),f++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(v,this.frictionResult)}this.enableFrictionReduction&&f&&this.createFrictionFromAverage(f)}};var me=new s,fe=new s,ye=new s;i.prototype[o.types.PLANE|o.types.PARTICLE]=i.prototype.planeParticle=function(t,e,i,n,a,o,r,s){var h=me;h.set(0,0,1),r.quaternion.vmult(h,h);var c=fe;n.vsub(r.position,c);var l=h.dot(c);if(0>=l){var p=this.createContactEquation(s,r,e,t);p.ni.copy(h),p.ni.negate(p.ni),p.ri.set(0,0,0);var u=ye;h.mult(h.dot(n),u),n.vsub(u,u),p.rj.copy(u),this.result.push(p),this.createFrictionEquationsFromContact(p,this.frictionResult)}};var ve=new s;i.prototype[o.types.PARTICLE|o.types.SPHERE]=i.prototype.sphereParticle=function(t,e,i,n,a,o,r,s){var h=ve;h.set(0,0,1),n.vsub(i,h);var c=h.norm2();if(t.radius*t.radius>=c){var l=this.createContactEquation(s,r,e,t);h.normalize(),l.rj.copy(h),l.rj.mult(t.radius,l.rj),l.ni.copy(h),l.ni.negate(l.ni),l.ri.set(0,0,0),this.result.push(l),this.createFrictionEquationsFromContact(l,this.frictionResult)}};var xe=new c,ge=new s;new s;var _e=new s,De=new s,we=new s;i.prototype[o.types.PARTICLE|o.types.CONVEXPOLYHEDRON]=i.prototype.convexParticle=function(t,e,i,n,a,o,r,s){var h=-1,c=_e,l=we,p=null,u=0,d=ge;if(d.copy(n),d.vsub(i,d),a.conjugate(xe),xe.vmult(d,d),t.pointIsInside(d)){t.worldVerticesNeedsUpdate&&t.computeWorldVertices(i,a),t.worldFaceNormalsNeedsUpdate&&t.computeWorldFaceNormals(a);for(var m=0,f=t.faces.length;m!==f;m++){var y=[t.worldVertices[t.faces[m][0]]],v=t.worldFaceNormals[m];n.vsub(y[0],De);var x=-v.dot(De);(null===p||Math.abs(x)<Math.abs(p))&&(p=x,h=m,c.copy(v),u++)}if(-1!==h){var g=this.createContactEquation(s,r,e,t);c.mult(p,l),l.vadd(n,l),l.vsub(i,l),g.rj.copy(l),c.negate(g.ni),g.ri.set(0,0,0);var _=g.ri,D=g.rj;_.vadd(n,_),_.vsub(s.position,_),D.vadd(i,D),D.vsub(r.position,D),this.result.push(g),this.createFrictionEquationsFromContact(g,this.frictionResult)}else console.warn("Point found inside convex, but did not find penetrating face!")}},i.prototype[o.types.BOX|o.types.HEIGHTFIELD]=i.prototype.boxHeightfield=function(t,e,i,n,a,o,r,s){t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexHeightfield(t.convexPolyhedronRepresentation,e,i,n,a,o,r,s)};var be=new s,Se=new s,Me=[0];i.prototype[o.types.CONVEXPOLYHEDRON|o.types.HEIGHTFIELD]=i.prototype.convexHeightfield=function(t,e,i,n,a,o,r,s){var c=e.data,l=e.elementSize,p=t.boundingSphereRadius,u=Se,d=Me,m=be;h.pointToLocalFrame(n,o,i,m);var f=Math.floor((m.x-p)/l)-1,y=Math.ceil((m.x+p)/l)+1,v=Math.floor((m.y-p)/l)-1,x=Math.ceil((m.y+p)/l)+1;if(!(0>y||0>x||f>c.length||v>c[0].length)){0>f&&(f=0),0>y&&(y=0),0>v&&(v=0),0>x&&(x=0),f>=c.length&&(f=c.length-1),y>=c.length&&(y=c.length-1),x>=c[0].length&&(x=c[0].length-1),v>=c[0].length&&(v=c[0].length-1);var g=[];e.getRectMinMax(f,v,y,x,g);var _=g[0],D=g[1];
if(!(m.z-p>D||_>m.z+p))for(var w=f;y>w;w++)for(var b=v;x>b;b++)e.getConvexTrianglePillar(w,b,!1),h.pointToWorldFrame(n,o,e.pillarOffset,u),i.distanceTo(u)<e.pillarConvex.boundingSphereRadius+t.boundingSphereRadius&&this.convexConvex(t,e.pillarConvex,i,u,a,o,r,s,null,null,d,null),e.getConvexTrianglePillar(w,b,!0),h.pointToWorldFrame(n,o,e.pillarOffset,u),i.distanceTo(u)<e.pillarConvex.boundingSphereRadius+t.boundingSphereRadius&&this.convexConvex(t,e.pillarConvex,i,u,a,o,r,s,null,null,d,null)}};var Ce=new s,Te=new s;i.prototype[o.types.SPHERE|o.types.HEIGHTFIELD]=i.prototype.sphereHeightfield=function(t,e,i,n,a,o,r,s){var c=e.data,l=t.radius,p=e.elementSize,u=Te,d=Ce;h.pointToLocalFrame(n,o,i,d);var m=Math.floor((d.x-l)/p)-1,f=Math.ceil((d.x+l)/p)+1,y=Math.floor((d.y-l)/p)-1,v=Math.ceil((d.y+l)/p)+1;if(!(0>f||0>v||m>c.length||v>c[0].length)){0>m&&(m=0),0>f&&(f=0),0>y&&(y=0),0>v&&(v=0),m>=c.length&&(m=c.length-1),f>=c.length&&(f=c.length-1),v>=c[0].length&&(v=c[0].length-1),y>=c[0].length&&(y=c[0].length-1);var x=[];e.getRectMinMax(m,y,f,v,x);var g=x[0],_=x[1];if(!(d.z-l>_||g>d.z+l))for(var D=this.result,w=m;f>w;w++)for(var b=y;v>b;b++){var S=D.length;e.getConvexTrianglePillar(w,b,!1),h.pointToWorldFrame(n,o,e.pillarOffset,u),i.distanceTo(u)<e.pillarConvex.boundingSphereRadius+t.boundingSphereRadius&&this.sphereConvex(t,e.pillarConvex,i,u,a,o,r,s),e.getConvexTrianglePillar(w,b,!0),h.pointToWorldFrame(n,o,e.pillarOffset,u),i.distanceTo(u)<e.pillarConvex.boundingSphereRadius+t.boundingSphereRadius&&this.sphereConvex(t,e.pillarConvex,i,u,a,o,r,s);var M=D.length-S;if(M>2)return}}}},{"../collision/AABB":3,"../collision/Ray":9,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43,"../solver/Solver":47,"../utils/Vec3Pool":54}],56:[function(t,e){function i(){h.apply(this),this.dt=-1,this.allowSleep=!1,this.contacts=[],this.frictionEquations=[],this.quatNormalizeSkip=0,this.quatNormalizeFast=!1,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.nextId=0,this.gravity=new a,this.broadphase=new v,this.bodies=[],this.solver=new r,this.constraints=[],this.narrowphase=new s(this),this.collisionMatrix=new c,this.collisionMatrixPrevious=new c,this.materials=[],this.contactmaterials=[],this.contactMaterialTable=new d,this.defaultMaterial=new l("default"),this.defaultContactMaterial=new p(this.defaultMaterial,this.defaultMaterial,{friction:.3,restitution:0}),this.doProfiling=!1,this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,narrowphase:0},this.subsystems=[],this.addBodyEvent={type:"addBody",body:null},this.removeBodyEvent={type:"removeBody",body:null}}e.exports=i;var n=t("../shapes/Shape"),a=t("../math/Vec3"),o=t("../math/Quaternion"),r=t("../solver/GSSolver");t("../utils/Vec3Pool"),t("../equations/ContactEquation"),t("../equations/FrictionEquation");var s=t("./Narrowphase"),h=t("../utils/EventTarget"),c=t("../collision/ArrayCollisionMatrix"),l=t("../material/Material"),p=t("../material/ContactMaterial"),u=t("../objects/Body"),d=t("../utils/TupleDictionary"),m=t("../collision/RaycastResult"),f=t("../collision/AABB"),y=t("../collision/Ray"),v=t("../collision/NaiveBroadphase");i.prototype=new h,new f;var x=new y;if(i.prototype.getContactMaterial=function(t,e){return this.contactMaterialTable.get(t.id,e.id)},i.prototype.numObjects=function(){return this.bodies.length},i.prototype.collisionMatrixTick=function(){var t=this.collisionMatrixPrevious;this.collisionMatrixPrevious=this.collisionMatrix,this.collisionMatrix=t,this.collisionMatrix.reset()},i.prototype.add=i.prototype.addBody=function(t){-1===this.bodies.indexOf(t)&&(t.index=this.bodies.length,this.bodies.push(t),t.world=this,t.initPosition.copy(t.position),t.initVelocity.copy(t.velocity),t.timeLastSleepy=this.time,t instanceof u&&(t.initAngularVelocity.copy(t.angularVelocity),t.initQuaternion.copy(t.quaternion)),this.collisionMatrix.setNumObjects(this.bodies.length),this.addBodyEvent.body=t,this.dispatchEvent(this.addBodyEvent))},i.prototype.addConstraint=function(t){this.constraints.push(t)},i.prototype.removeConstraint=function(t){var e=this.constraints.indexOf(t);-1!==e&&this.constraints.splice(e,1)},i.prototype.rayTest=function(t,e,i){i instanceof m?this.raycastClosest(t,e,{skipBackfaces:!0},i):this.raycastAll(t,e,{skipBackfaces:!0},i)},i.prototype.raycastAll=function(t,e,i,n){return i.mode=y.ALL,i.from=t,i.to=e,i.callback=n,x.intersectWorld(this,i)},i.prototype.raycastAny=function(t,e,i,n){return i.mode=y.ANY,i.from=t,i.to=e,i.result=n,x.intersectWorld(this,i)},i.prototype.raycastClosest=function(t,e,i,n){return i.mode=y.CLOSEST,i.from=t,i.to=e,i.result=n,x.intersectWorld(this,i)},i.prototype.remove=function(t){t.world=null;var e=this.bodies.length-1,i=this.bodies,n=i.indexOf(t);if(-1!==n){i.splice(n,1);for(var a=0;a!==i.length;a++)i[a].index=a;this.collisionMatrix.setNumObjects(e),this.removeBodyEvent.body=t,this.dispatchEvent(this.removeBodyEvent)}},i.prototype.removeBody=i.prototype.remove,i.prototype.addMaterial=function(t){this.materials.push(t)},i.prototype.addContactMaterial=function(t){this.contactmaterials.push(t),this.contactMaterialTable.set(t.materials[0].id,t.materials[1].id,t)},"undefined"==typeof performance&&(performance={}),!performance.now){var g=Date.now();performance.timing&&performance.timing.navigationStart&&(g=performance.timing.navigationStart),performance.now=function(){return Date.now()-g}}var _=new a;i.prototype.step=function(t,e,i){if(i=i||10,e=e||0,0===e)this.internalStep(t),this.time+=t;else{var n=Math.floor((this.time+e)/t)-Math.floor(this.time/t);n=Math.min(n,i);for(var a=performance.now(),o=0;o!==n&&(this.internalStep(t),!(performance.now()-a>1e3*t));o++);this.time+=e;for(var r=this.time%t,s=r/t,h=_,c=this.bodies,l=0;l!==c.length;l++){var p=c[l];p.type!==u.STATIC&&p.sleepState!==u.SLEEPING?(p.position.vsub(p.previousPosition,h),h.scale(s,h),p.position.vadd(h,p.interpolatedPosition)):(p.interpolatedPosition.copy(p.position),p.interpolatedQuaternion.copy(p.quaternion))}}};var D={type:"postStep"},w={type:"preStep"},b={type:"collide",body:null,contact:null},S=[],M=[],C=[],T=[],A=(new a,new a,new a,new a,new a,new a,new a,new a,new a,new o,new o),I=new o,E=new a;i.prototype.internalStep=function(t){this.dt=t;var e,i=this.contacts,a=C,o=T,r=this.numObjects(),s=this.bodies,h=this.solver,c=this.gravity,l=this.doProfiling,p=this.profile,d=u.DYNAMIC,m=this.constraints,f=M,y=(c.norm(),c.x),v=c.y,x=c.z,g=0;for(l&&(e=performance.now()),g=0;g!==r;g++){var _=s[g];if(_.type&d){var P=_.force,B=_.mass;P.x+=B*y,P.y+=B*v,P.z+=B*x}}for(var g=0,N=this.subsystems.length;g!==N;g++)this.subsystems[g].update();l&&(e=performance.now()),a.length=0,o.length=0,this.broadphase.collisionPairs(this,a,o),l&&(p.broadphase=performance.now()-e);var V=m.length;for(g=0;g!==V;g++){var R=m[g];if(!R.collideConnected)for(var L=a.length-1;L>=0;L-=1)(R.bodyA===a[L]&&R.bodyB===o[L]||R.bodyB===a[L]&&R.bodyA===o[L])&&(a.splice(L,1),o.splice(L,1))}this.collisionMatrixTick(),l&&(e=performance.now());var z=S,F=i.length;for(g=0;g!==F;g++)z.push(i[g]);i.length=0;var O=this.frictionEquations.length;for(g=0;g!==O;g++)f.push(this.frictionEquations[g]);this.frictionEquations.length=0,this.narrowphase.getContacts(a,o,this,i,z,this.frictionEquations,f),l&&(p.narrowphase=performance.now()-e),l&&(e=performance.now());for(var g=0;this.frictionEquations.length>g;g++)h.addEquation(this.frictionEquations[g]);for(var k=i.length,j=0;j!==k;j++){var R=i[j],_=R.bi,U=R.bj;R.si,R.sj;var X;X=_.material&&U.material?this.getContactMaterial(_.material,U.material)||this.defaultContactMaterial:this.defaultContactMaterial;var W=X.friction;if(_.material&&U.material&&(_.material.friction>=0&&U.material.friction>=0&&(W=_.material.friction*U.material.friction),_.material.restitution>=0&&U.material.restitution>=0&&(R.restitution=_.material.restitution*U.material.restitution)),h.addEquation(R),_.allowSleep&&_.type===u.DYNAMIC&&_.sleepState===u.SLEEPING&&U.sleepState===u.AWAKE&&U.type!==u.STATIC){var q=U.velocity.norm2()+U.angularVelocity.norm2(),Y=Math.pow(U.sleepSpeedLimit,2);q>=2*Y&&(_._wakeUpAfterNarrowphase=!0)}if(U.allowSleep&&U.type===u.DYNAMIC&&U.sleepState===u.SLEEPING&&_.sleepState===u.AWAKE&&_.type!==u.STATIC){var G=_.velocity.norm2()+_.angularVelocity.norm2(),H=Math.pow(_.sleepSpeedLimit,2);G>=2*H&&(U._wakeUpAfterNarrowphase=!0)}this.collisionMatrix.set(_,U,!0),this.collisionMatrixPrevious.get(_,U)||(b.body=U,b.contact=R,_.dispatchEvent(b),b.body=_,U.dispatchEvent(b))}for(l&&(p.makeContactConstraints=performance.now()-e,e=performance.now()),g=0;g!==r;g++){var _=s[g];_._wakeUpAfterNarrowphase&&(_.wakeUp(),_._wakeUpAfterNarrowphase=!1)}var V=m.length;for(g=0;g!==V;g++){var R=m[g];R.update();for(var L=0,Z=R.equations.length;L!==Z;L++){var K=R.equations[L];h.addEquation(K)}}h.solve(t,this),l&&(p.solve=performance.now()-e),h.removeAllEquations();var Q=Math.pow;for(g=0;g!==r;g++){var _=s[g];if(_.type&d){var J=Q(1-_.linearDamping,t),$=_.velocity;$.mult(J,$);var te=_.angularVelocity;if(te){var ee=Q(1-_.angularDamping,t);te.mult(ee,te)}}}for(this.dispatchEvent(w),g=0;g!==r;g++){var _=s[g];_.preStep&&_.preStep.call(_)}l&&(e=performance.now());var ie=A,ne=I,ae=this.stepnumber,oe=u.DYNAMIC|u.KINEMATIC,re=0===ae%(this.quatNormalizeSkip+1),se=this.quatNormalizeFast,he=.5*t;for(n.types.PLANE,n.types.CONVEXPOLYHEDRON,g=0;g!==r;g++){var ce=s[g],le=ce.force,pe=ce.torque;if(ce.type&oe&&ce.sleepState!==u.SLEEPING){var ue=ce.velocity,de=ce.angularVelocity,me=ce.position,fe=ce.quaternion,ye=ce.invMass,ve=ce.invInertiaWorld;ue.x+=le.x*ye*t,ue.y+=le.y*ye*t,ue.z+=le.z*ye*t,ce.angularVelocity&&(ve.vmult(pe,E),E.mult(t,E),E.vadd(de,de)),me.x+=ue.x*t,me.y+=ue.y*t,me.z+=ue.z*t,ce.angularVelocity&&(ie.set(de.x,de.y,de.z,0),ie.mult(fe,ne),fe.x+=he*ne.x,fe.y+=he*ne.y,fe.z+=he*ne.z,fe.w+=he*ne.w,re&&(se?fe.normalizeFast():fe.normalize())),ce.aabb&&(ce.aabbNeedsUpdate=!0),ce.updateInertiaWorld&&ce.updateInertiaWorld()}}for(this.clearForces(),this.broadphase.dirty=!0,l&&(p.integrate=performance.now()-e),this.time+=t,this.stepnumber+=1,this.dispatchEvent(D),g=0;g!==r;g++){var _=s[g],xe=_.postStep;xe&&xe.call(_)}if(this.allowSleep)for(g=0;g!==r;g++)s[g].sleepTick(this.time)},i.prototype.clearForces=function(){for(var t=this.bodies,e=t.length,i=0;i!==e;i++){var n=t[i];n.force,n.torque,n.force.set(0,0,0),n.torque.set(0,0,0)}}},{"../collision/AABB":3,"../collision/ArrayCollisionMatrix":4,"../collision/NaiveBroadphase":7,"../collision/Ray":9,"../collision/RaycastResult":10,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../material/ContactMaterial":24,"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Shape":43,"../solver/GSSolver":46,"../utils/EventTarget":49,"../utils/TupleDictionary":52,"../utils/Vec3Pool":54,"./Narrowphase":55}]},{},[2])(2)});var Physics=function(){function t(){}return t.creatWorld=function(){t.world=new CANNON.World,t.setGravity(t.world,new Vector3D(0,-980,0)),this.worldMaterial=new CANNON.Material,this.worldMaterial.friction=.1,this.worldMaterial.restitution=.1,this.dynamicMaterial=new CANNON.Material,this.dynamicMaterial.friction=10,this.dynamicMaterial.restitution=0,this.materialDic={},this.dynamicBodyList=[]},t.makeGround=function(e){var i=new CANNON.Body({mass:0});0==Scene_data.user&&(i.material=this.worldMaterial,i.collisionFilterGroup=this.GROUP1,i.collisionFilterMask=this.GROUP2),t.bodyAddShape(i,new CANNON.Plane,e),t.world.addBody(i)},t.setGravity=function(t,e){t.gravity.set(e.x,e.z,e.y)},t.bodyAddShape=function(t,e,i,n){void 0===i&&(i=null),void 0===n&&(n=null);var a=new CANNON.Quaternion(0,0,0,1),o=new CANNON.Vec3(0,0,0);n&&(a.x=n.x,a.y=n.z,a.z=n.y,a.w=n.w),i&&(o.x=i.x,o.y=i.z,o.z=i.y),t.addShape(e,o,a)},t.getPhysicsV3D=function(t){return new CANNON.Vec3(t.x,t.z,t.y)},t.getV3D=function(t){return new Vector3D(t.x,t.z,t.y)},t.H5ToCollisionQuaternion=function(t){return new CANNON.Quaternion(t.x,t.z,t.y,t.w)},t.setMatrix3DToBody=function(t,e){var i=new Quaternion;i.fromMatrix(e),t.quaternion=this.H5ToCollisionQuaternion(i)},t.CollistionToH5BodyMatrix3D=function(e,i){void 0===i&&(i=null),i||(i=new Matrix3D),i.identity();var n=t.getV3D(e.position),a=t.CollistionToH5QuaternionToEuler(e.quaternion);return i.appendRotation(180*-a.x/Math.PI,Vector3D.X_AXIS),i.appendRotation(180*-a.y/Math.PI,Vector3D.Y_AXIS),i.appendRotation(180*-a.z/Math.PI,Vector3D.Z_AXIS),i.appendTranslation(n.x,n.y,n.z),i},t.H5ToCollisionQuaternionSet=function(t,e,i,n,a){t.set(e,n,i,a)},t.QuaternionCollisionToH5=function(t){return new Quaternion(t.x,t.z,t.y,t.w)},t.CollistionToH5QuaternionToEuler=function(t){var e=new Vector3D;return t.toEuler(e),new Vector3D(e.x,e.z,e.y)},t.makePolyhedronShape=function(e,i){for(var n=e.vertices,a=e.indexs,o=[],r=[],s=t.getPhysicsV3D(i),h=0;n.length>h;h+=3)o.push(new CANNON.Vec3(n[h+0]*s.x,n[h+2]*s.y,n[h+1]*s.z));for(var h=0;a.length>h;h+=3)r.push([a[h+0],a[h+1],a[h+2]]);var c=new CANNON.ConvexPolyhedron(o,r);return c},t.makeBoxShape=function(e){return new CANNON.Box(t.getPhysicsV3D(e))},t.makeSphereShape=function(t){return new CANNON.Sphere(t)},t.makeCylinderShape=function(t,e,i){return void 0===i&&(i=10),new CANNON.Cylinder(t,t,e,i)},t.getBodyMesh=function(e,i){var n=new CANNON.Body({mass:i,position:t.getPhysicsV3D(e)});return t.world.addBody(n),n},t.addDynamicCapsulePhysics=function(e,i){var n=t.getBodyMesh(e,100),a=t.makeSphereShape(i);return t.bodyAddShape(n,a,new Vector3D(0,i,0)),n.material=this.dynamicMaterial,n.type=CANNON.Body.DYNAMIC,n.name="role",n.gameType=this.bodyGameRoleType,n.fixedRotation=!0,n.updateMassProperties(),n.collisionFilterGroup=this.GROUP2,n.collisionFilterMask=this.GROUP1,t.world.addBody(n),this.dynamicBodyList.push(n),n},t.addStaticPhysics=function(e,i){var n,a=t.makeBuildBodyMesh(e,i),o=float2int(100*i.friction)+"";if(this.materialDic[o])n=this.materialDic[o];else{n=new CANNON.Material,n.friction=.001*i.friction,n.restitution=i.restitution;var r=new CANNON.ContactMaterial(this.dynamicMaterial,n,{friction:i.friction,restitution:i.restitution,contactEquationStiffness:1e7,contactEquationRelaxation:500,frictionEquationStiffness:1e7,frictionEquationRelaxation:3});this.world.addContactMaterial(r),this.materialDic[o]=n}return a.material=n,a.type=CANNON.Body.KINEMATIC,t.world.addBody(a),a},t.removePhysics=function(e){t.world.removeBody(e)},t.removeAll=function(){for(var t=this.world.bodies,e=0;t.length>e;e++)this.removePhysics(t[e])},t.makeBuildBodyMesh=function(e,i){var n=t.getBodyMesh(new Vector3D(e.x,e.y,e.z),100),a=new Matrix3D;a.appendRotation(-e.rotationZ,Vector3D.Z_AXIS),a.appendRotation(-e.rotationY,Vector3D.Y_AXIS),a.appendRotation(-e.rotationX,Vector3D.X_AXIS);var o=new Quaternion;o.fromMatrix(a),t.H5ToCollisionQuaternionSet(n.quaternion,o.x,o.y,o.z,o.w),n.type=CANNON.Body.KINEMATIC;for(var r=0;i.collisionItem.length>r;r++){var s=i.collisionItem[r],h=new Vector3D(s.x*e.scaleX,s.y*e.scaleY,s.z*e.scaleZ),c=new Matrix3D;c.appendRotation(-s.rotationZ,Vector3D.Z_AXIS),c.appendRotation(-s.rotationY,Vector3D.Y_AXIS),c.appendRotation(-s.rotationX,Vector3D.X_AXIS);var l=new Quaternion;switch(l.fromMatrix(c),s.type){case CollisionType.BOX:var p=new Vector3D;p.x=100*s.scaleX*e.scaleX,p.y=100*s.scaleY*e.scaleY,p.z=100*s.scaleZ*e.scaleZ,t.bodyAddShape(n,t.makeBoxShape(p),h,l);break;case CollisionType.BALL:var u=(e.scaleX+e.scaleY+e.scaleZ)/3;u*=s.radius,t.bodyAddShape(n,t.makeSphereShape(u),h,l);break;case CollisionType.Polygon:var d=new Vector3D(e.scaleX*s.scaleX,e.scaleY*s.scaleY,e.scaleZ*s.scaleZ),m=t.makePolyhedronShape(s.data,d);t.bodyAddShape(n,m,h,l);break;default:}}return n},t.makeSceneCollision=function(e){for(var i=[],n=0;e.length>n;n++){var a=t.getBodyMesh(new Vector3D,100);i.push(a);var o,r=float2int(100*Number(e[n].friction))+"";if(this.materialDic[r])o=this.materialDic[r];else{o=new CANNON.Material,o.friction=.001*Number(e[n].friction),o.restitution=Number(e[n].restitution);var s=new CANNON.ContactMaterial(this.dynamicMaterial,o,{friction:Number(e[n].friction),restitution:Number(e[n].restitution),contactEquationStiffness:1e7,contactEquationRelaxation:500,frictionEquationStiffness:1e7,frictionEquationRelaxation:3});this.world.addContactMaterial(s),this.materialDic[r]=o}a.material=o,a.collisionFilterGroup=this.GROUP1,a.collisionFilterMask=this.GROUP2,a.type=CANNON.Body.KINEMATIC;var h={};h.x=Number(e[n].x),h.y=Number(e[n].y),h.z=Number(e[n].z),h.scaleX=Number(e[n].scale_x),h.scaleY=Number(e[n].scale_y),h.scaleZ=Number(e[n].scale_z),h.rotationX=Number(e[n].rotationX),h.rotationY=Number(e[n].rotationY),h.rotationZ=Number(e[n].rotationZ),h.posMatrix=new Matrix3D,h.posMatrix.appendScale(h.scaleX,h.scaleY,h.scaleZ),h.posMatrix.appendRotation(h.rotationX,Vector3D.X_AXIS),h.posMatrix.appendRotation(h.rotationY,Vector3D.Y_AXIS),h.posMatrix.appendRotation(h.rotationZ,Vector3D.Z_AXIS),h.posMatrix.appendTranslation(h.x,h.y,h.z);var c=e[n].collisionVo,l=new CollisionVo;l.x=Number(c.x),l.y=Number(c.y),l.z=Number(c.z),l.scaleX=Number(c.scale_x),l.scaleY=Number(c.scale_y),l.scaleZ=Number(c.scale_z),l.rotationX=Number(c.rotationX),l.rotationY=Number(c.rotationY),l.rotationZ=Number(c.rotationZ),l.type=Number(c.type);var p=new Matrix3D;p.appendRotation(-l.rotationZ,Vector3D.Z_AXIS),p.appendRotation(-l.rotationY,Vector3D.Y_AXIS),p.appendRotation(-l.rotationX,Vector3D.X_AXIS),p.appendRotation(-h.rotationZ,Vector3D.Z_AXIS),p.appendRotation(-h.rotationY,Vector3D.Y_AXIS),p.appendRotation(-h.rotationX,Vector3D.X_AXIS);var u=new Quaternion;u.fromMatrix(p);var d=h.posMatrix.transformVector(new Vector3D(l.x,l.y,l.z));switch(l.type){case CollisionType.BOX:var m=new Vector3D;m.x=100*h.scaleX*l.scaleX,m.y=100*h.scaleY*l.scaleY,m.z=100*h.scaleZ*l.scaleZ,t.bodyAddShape(a,t.makeBoxShape(m),d,u);break;case CollisionType.BALL:l.radius=c.radius;var f=(h.scaleX+h.scaleY+h.scaleZ)/3;f*=l.radius,t.bodyAddShape(a,t.makeSphereShape(f),d,u);break;case CollisionType.Cylinder:t.bodyAddShape(a,t.makeCylinderShape(100*l.scaleX*h.scaleX,100*l.scaleY*h.scaleY),d,u);break;case CollisionType.Cone:break;case CollisionType.Polygon:l.data=c.data;var y=new Vector3D(l.scaleX*h.scaleX,l.scaleY*h.scaleY,l.scaleZ*h.scaleZ),v=t.makePolyhedronShape(l.data,y);t.bodyAddShape(a,v,d,u);break;default:}}return i},t.makeFieldForArr=function(e,i){var n,a=e.length,o=e[0].length,r=i,s=new CANNON.Heightfield(e,{elementSize:r}),h=new CANNON.Body({mass:0}),c=new Vector3D(-(a*r/2),0,-(o*r/2));n=new CANNON.Material,n.friction=0,n.restitution=0;var l=new CANNON.ContactMaterial(this.dynamicMaterial,n,{friction:0,restitution:0,contactEquationStiffness:1e7,contactEquationRelaxation:500,frictionEquationStiffness:1e7,frictionEquationRelaxation:3});this.world.addContactMaterial(l),h.material=n,h.collisionFilterGroup=this.GROUP1,h.collisionFilterMask=this.GROUP2,h.gameType=this.bodyGameGroundType,h.type=CANNON.Body.KINEMATIC,t.bodyAddShape(h,s,c),t.world.addBody(h)},t.update=function(){if(this.world&&this.ready){var e=new Date,i=e.getTime()-this.cannonLast,n=i/1e3,a=1;t.world.step(1/60,n,a),this.cannonLast=e.getTime()}},t.updateDynamic=function(){},t.cannonLast=0,t.GROUP0=0,t.GROUP1=1,t.GROUP2=2,t.bodyGameRoleType=1,t.bodyGameGroundType=2,t.ready=!1,t}(),CollisionWorker=function(){function t(){var t=this;this.spriteItem||(this.spriteItem=[]),this.connonWorker=new Worker("libs/cannon/worker/WorkerTask.js"),this.connonWorker.addEventListener("message",function(e){t.workerBack(e)})}return t.getInstance=function(){return this._instance||(this._instance=new t),this._instance},t.prototype.workerBack=function(t){var e=t.data;switch(Number(e.type)){case 0:break;case CollisionWorkerType.ReturnPosition:var i=e.data.id;this.spriteItem[i]&&(this.spriteItem[i].posMatrixData=e.data.m);break;default:}},t.prototype.makeSceneCollision=function(e){var i={};i.type=CollisionWorkerType.makeSceneCollision,i.data=e,t.getInstance().connonWorker.postMessage(i),this.makeSceneCollisionLine(e)},t.prototype.makeSceneCollisionLine=function(t){for(var e=0;t.length>e;e++){var i={};i.x=Number(t[e].x),i.y=Number(t[e].y),i.z=Number(t[e].z),i.scaleX=Number(t[e].scale_x),i.scaleY=Number(t[e].scale_y),i.scaleZ=Number(t[e].scale_z),i.rotationX=Number(t[e].rotationX),i.rotationY=Number(t[e].rotationY),i.rotationZ=Number(t[e].rotationZ),i.posMatrix=new Matrix3D,i.posMatrix.appendScale(i.scaleX,i.scaleY,i.scaleZ),i.posMatrix.appendRotation(i.rotationX,Vector3D.X_AXIS),i.posMatrix.appendRotation(i.rotationY,Vector3D.Y_AXIS),i.posMatrix.appendRotation(i.rotationZ,Vector3D.Z_AXIS),i.posMatrix.appendTranslation(i.x,i.y,i.z);var n=t[e].collisionVo,a=new CollisionVo;a.x=Number(n.x),a.y=Number(n.y),a.z=Number(n.z),a.scaleX=Number(n.scale_x),a.scaleY=Number(n.scale_y),a.scaleZ=Number(n.scale_z),a.rotationX=Number(n.rotationX),a.rotationY=Number(n.rotationY),a.rotationZ=Number(n.rotationZ),a.type=Number(n.type);var o=new Matrix3D;switch(a.type){case CollisionType.BOX:o.appendScale(a.scaleX,a.scaleY,a.scaleZ);break;case CollisionType.BALL:a.radius=Number(n.radius),o.appendScale(a.scaleX*a.radius/100,a.scaleY*a.radius/100,a.scaleZ*a.radius/100);break;case CollisionType.Cylinder:o.appendScale(a.scaleX,a.scaleY,a.scaleX);break;case CollisionType.Cone:o.appendScale(a.scaleX,a.scaleY,a.scaleX);break;case CollisionType.Polygon:o.appendScale(a.scaleX,a.scaleY,a.scaleZ),a.data=n.data;break;default:}o.appendRotation(a.rotationX,Vector3D.X_AXIS),o.appendRotation(a.rotationY,Vector3D.Y_AXIS),o.appendRotation(a.rotationZ,Vector3D.Z_AXIS),o.appendTranslation(a.x,a.y,a.z);var r=new CollisionDispaly3DSprite;r.setCollsionType(a),r.posMatrix=i.posMatrix.clone(),r.posMatrix.prepend(o);var s=new CollistionDisplay;s.collisionDisplay=r,this.spriteItem.push(s),SceneManager.getInstance().addDisplay(r)}},t.prototype.addDisplayToWorld=function(t,e){this.addBallToWorld(t,e)},t.prototype.addRaycastToWorld=function(){var e={};e.type=CollisionWorkerType.addRaycast,e.data={},e.data.x=0,e.data.y=100,e.data.z=0,e.data.scaleX=1,e.data.scaleY=1,e.data.scaleZ=1,t.getInstance().connonWorker.postMessage(e)},t.prototype.addBoxToWorld=function(e){var i=new CollisionDispaly3DSprite;i.visible=!1,SceneManager.getInstance().addDisplay(i);var n=new CollisionVo;n.type=CollisionType.BOX,i.setCollsionType(n);var a=new CollistionDisplay;a.collisionDisplay=i,a.sprite=e,this.spriteItem.push(a);var o={};o.type=CollisionWorkerType.addTextBox,o.data={},o.data.x=e.x,o.data.y=e.y,o.data.z=e.z,o.data.scaleX=e.scaleX,o.data.scaleY=e.scaleY,o.data.scaleZ=e.scaleZ,t.getInstance().connonWorker.postMessage(o)},t.prototype.addCylinderToWorld=function(e){var i=new CollisionDispaly3DSprite;i.visible=!1,SceneManager.getInstance().addDisplay(i);var n=new CollisionVo;n.type=CollisionType.Cylinder,i.setCollsionType(n);var a=new CollistionDisplay;a.collisionDisplay=i,a.sprite=e,this.spriteItem.push(a);var o={};o.type=CollisionWorkerType.addTextCylinder,o.data={},o.data.x=e.x,o.data.y=e.y,o.data.z=e.z,o.data.scaleX=e.scaleX,o.data.scaleY=e.scaleY,t.getInstance().connonWorker.postMessage(o)},t.prototype.addBallToWorld=function(e,i){var n=new CollisionDispaly3DSprite;n.visible=!1,SceneManager.getInstance().addDisplay(n);var a=new CollisionVo;a.type=CollisionType.BALL,n.setCollsionType(a);var o=new CollistionDisplay;o.collisionDisplay=n,o.sprite=e,this.spriteItem.push(o);var r={};r.type=CollisionWorkerType.addTextBall,r.data={},r.data.x=e.x,r.data.y=e.y,r.data.z=e.z,r.data.radius=i*(e.scaleX+e.scaleY+e.scaleZ)/3,t.getInstance().connonWorker.postMessage(r)},t.prototype.changeBodyBySprite=function(e,i){for(var n=0;this.spriteItem.length>n;n++)if(this.spriteItem[n].sprite!=e);else{var a={};a.type=CollisionWorkerType.SETvelocity,a.data={},a.data.id=n,a.data.x=100*i.x,a.data.y=-10,a.data.z=100*i.z,t.getInstance().connonWorker.postMessage(a)}},t}(),CollistionDisplay=function(){function t(){}return Object.defineProperty(t.prototype,"posMatrixData",{set:function(t){this.sprite&&(this.sprite.posMatrix.m=t,this.sprite.posMatrix.prependScale(this.sprite.scaleX,this.sprite.scaleY,this.sprite.scaleZ)),this.collisionDisplay&&(this.collisionDisplay.posMatrix.m=t,this.collisionDisplay.visible=!0)},enumerable:!0,configurable:!0}),t}(),CollisionWorkerType=function(){function t(){}return t.makeSceneCollision=1001,t.addTextBall=1002,t.addTextBox=1003,t.addTextCylinder=1004,t.addRaycast=1005,t.ReturnPosition=2001,t.SETvelocity=3001,t}(),frist=!0,baseNum=199,posMatrix,moveBodyItem;onmessage=function(t){var e=t.data;if(frist){var i="../../../";importScripts(i+"engine/events/Event.js"),importScripts(i+"engine/events/EventDispatcher.js"),importScripts(i+"libs/cannon/cannon.js"),importScripts(i+"libs/cannon/cannon.js"),importScripts(i+"libs/cannon/Physics.js"),importScripts(i+"engine/math/Matrix3D.js"),importScripts(i+"engine/math/Quaternion.js"),importScripts(i+"engine/math/Vector3D.js"),importScripts(i+"engine/base/Object3D.js"),importScripts(i+"engine/utils/Util.js"),importScripts(i+"engine/vo/collistion/CollisionVo.js"),importScripts(i+"libs/cannon/worker/CollisionWorkerType.js"),frist=!1,Physics.creatWorld(),Physics.makeGround(new Vector3D(0,0,0)),Physics.ready=!0,moveBodyItem=[],posMatrix=new Matrix3D,setInterval(function(){Physics.update();for(var t=0;moveBodyItem.length>t;t++){var e=moveBodyItem[t];e.type==CANNON.Body.DYNAMIC&&(Physics.CollistionToH5BodyMatrix3D(e,posMatrix),this.postMessage({type:CollisionWorkerType.ReturnPosition,data:{id:t,m:posMatrix.m}}))}},1e3/60)}switch(Number(e.type)){case 0:break;case CollisionWorkerType.SETvelocity:moveBodyItem[e.data.id]&&moveBodyItem[e.data.id].velocity.set(e.data.x,e.data.z,e.data.y);break;case CollisionWorkerType.makeSceneCollision:var n=Physics.makeSceneCollision(e.data);moveBodyItem=moveBodyItem.concat(n);break;case CollisionWorkerType.addTextBall:addBall(e.data);break;case CollisionWorkerType.addTextBox:addBox(e.data);break;case CollisionWorkerType.addTextCylinder:addCylinder(e.data);break;case CollisionWorkerType.addRaycast:addRaycast(e.data);break;default:}};var __extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},CollisionDispaly3DSprite=function(t){function e(){t.call(this),this.visible=!0,this.changeBodyPosion=!1,e.ballLineSprite||this.mathBallSptre(),e.boxLineSprite||this.mathBoxSprite(),e.cylinderLineSprite||this.mathCylinderSprite(),e.coneLineSprite||this.mathConeSprite()}return __extends(e,t),e.prototype.mathConeSprite=function(){var t=new LineDisplaySprite;t.clear(),t.baseColor=new Vector3D(1,0,1,1);var i=100,n=100;this.clear();var a,o,r=12;for(o=0;r>o;o++){var s=new Vector3D(i,-n/2,0),h=new Matrix3D;h.appendRotation(o*(360/r),Vector3D.Y_AXIS);var c=h.transformVector(s);t.makeLineMode(c,new Vector3D(0,-n/2,0)),t.makeLineMode(c,new Vector3D(0,+n/2,0)),o==r-1&&t.makeLineMode(c,s),a&&t.makeLineMode(c,a),a=c.clone()}t.upToGpu(),e.coneLineSprite=t},e.prototype.mathCylinderSprite=function(){var t=new LineDisplaySprite;t.clear(),t.baseColor=new Vector3D(0,0,1,1);var i,n,a,o=100,r=100,s=12;for(a=0;s>a;a++){var h=new Vector3D(o,-r/2,0),c=new Vector3D(o,+r/2,0),l=new Matrix3D;l.appendRotation(a*(360/s),Vector3D.Y_AXIS);var p=l.transformVector(h),u=l.transformVector(c);t.makeLineMode(p,u),t.makeLineMode(p,new Vector3D(0,-r/2,0)),t.makeLineMode(u,new Vector3D(0,+r/2,0)),a==s-1&&(t.makeLineMode(p,h),t.makeLineMode(u,c)),(i||n)&&(t.makeLineMode(p,i),t.makeLineMode(u,n)),i=p.clone(),n=u.clone()}t.upToGpu(),e.cylinderLineSprite=t},e.prototype.mathBoxSprite=function(){var t=new LineDisplaySprite;t.clear(),t.baseColor=new Vector3D(0,1,0,1);var i=new Vector3D(100,100,100);t.makeLineMode(new Vector3D(-i.x,-i.y,-i.z),new Vector3D(+i.x,-i.y,-i.z)),t.makeLineMode(new Vector3D(+i.x,-i.y,-i.z),new Vector3D(+i.x,-i.y,+i.z)),t.makeLineMode(new Vector3D(+i.x,-i.y,+i.z),new Vector3D(-i.x,-i.y,+i.z)),t.makeLineMode(new Vector3D(-i.x,-i.y,+i.z),new Vector3D(-i.x,-i.y,-i.z)),t.makeLineMode(new Vector3D(-i.x,+i.y,-i.z),new Vector3D(+i.x,+i.y,-i.z)),t.makeLineMode(new Vector3D(+i.x,+i.y,-i.z),new Vector3D(+i.x,+i.y,+i.z)),t.makeLineMode(new Vector3D(+i.x,+i.y,+i.z),new Vector3D(-i.x,+i.y,+i.z)),t.makeLineMode(new Vector3D(-i.x,+i.y,+i.z),new Vector3D(-i.x,+i.y,-i.z)),t.makeLineMode(new Vector3D(-i.x,-i.y,-i.z),new Vector3D(-i.x,+i.y,-i.z)),t.makeLineMode(new Vector3D(+i.x,-i.y,-i.z),new Vector3D(+i.x,+i.y,-i.z)),t.makeLineMode(new Vector3D(+i.x,-i.y,+i.z),new Vector3D(+i.x,+i.y,+i.z)),t.makeLineMode(new Vector3D(-i.x,-i.y,+i.z),new Vector3D(-i.x,+i.y,+i.z)),t.upToGpu(),e.boxLineSprite=t},e.prototype.mathBallSptre=function(){var t=new LineDisplaySprite,i=100;t.clear(),t.baseColor=new Vector3D(1,0,0,1);var n,a,o,r,s,h,c,l=12;for(s=0;l>=s;s++)for(o=null,r=0;l>r;r++)n=new Vector3D(i,0,0),a=new Matrix3D,a.appendRotation(360/l*r,Vector3D.Z_AXIS),n=a.transformVector(n),h=new Matrix3D,h.appendRotation(360/l*s,Vector3D.Y_AXIS),n=h.transformVector(n),o&&t.makeLineMode(o,n),o=n.clone();for(s=0;4>=s;s++)for(h=new Matrix3D,h.appendRotation(20*s,Vector3D.Z_AXIS),c=h.transformVector(new Vector3D(i,0,0)),o=null,r=0;l>r;r++)n=c.clone(),a=new Matrix3D,a.appendRotation(360/l*r,Vector3D.Y_AXIS),n=a.transformVector(n),o&&t.makeLineMode(o,n),r==l-1&&t.makeLineMode(c,n),o=n.clone();for(s=1;4>=s;s++)for(h=new Matrix3D,h.appendRotation(-20*s,Vector3D.Z_AXIS),c=h.transformVector(new Vector3D(i,0,0)),o=null,r=0;l>r;r++)n=c.clone(),a=new Matrix3D,a.appendRotation(360/l*r,Vector3D.Y_AXIS),n=a.transformVector(n),o&&t.makeLineMode(o,n),r==l-1&&t.makeLineMode(c,n),o=n.clone();t.upToGpu(),e.ballLineSprite=t},e.prototype.setCollsionType=function(t){switch(t.type){case CollisionType.BOX:this.objData=e.boxLineSprite.objData;break;case CollisionType.BALL:this.objData=e.ballLineSprite.objData;break;case CollisionType.Cylinder:this.objData=e.cylinderLineSprite.objData;break;case CollisionType.Cone:this.objData=e.coneLineSprite.objData;break;case CollisionType.Polygon:this.objData=this.makePolygonObjData(t.data);break;default:}},e.prototype.update=function(){if(this.visible&&e.showCollisionLine&&(t.prototype.update.call(this),this.body)){var i=new Matrix3D;Physics.CollistionToH5BodyMatrix3D(this.body,i),this.posMatrix.m=i.m,this.posMatrix.prependScale(this.scaleX,this.scaleY,this.scaleZ)}},e.prototype.makePolygonObjData=function(t){var e=new LineDisplaySprite;e.clear(),e.baseColor=new Vector3D(0,1,1,1);for(var i,n,a,o,r,s,h=0;t.indexs.length/3>h;h++)i=t.indexs[3*h+0],n=t.indexs[3*h+1],a=t.indexs[3*h+2],o=new Vector3D(t.vertices[3*i+0],t.vertices[3*i+1],t.vertices[3*i+2]),r=new Vector3D(t.vertices[3*n+0],t.vertices[3*n+1],t.vertices[3*n+2]),s=new Vector3D(t.vertices[3*a+0],t.vertices[3*a+1],t.vertices[3*a+2]),e.makeLineMode(o,r),e.makeLineMode(r,s),e.makeLineMode(s,o);return e.upToGpu(),e.objData},e.prototype.setBody=function(t){this.changeBodyPosion=!0,this.body=t;var e=this;e.clear();for(var i=0;t.shapes.length>i;i++){var n=Physics.getV3D(t.shapeOffsets[i]),a=Physics.QuaternionCollisionToH5(t.shapeOrientations[i]);switch(t.shapes[i].type){case 1:var o=t.shapes[i];this.drawSphereConvexPolyh(o.radius,n,a);break;case 4:var r=t.shapes[i],s=Physics.getV3D(r.halfExtents);this.drawBoxConvexPolyh(s,n,a);break;case 16:var h=t.shapes[i];this.drawCylinderConvexPolyh(h,n,a);break;default:alert(t.shapes[i].type)}}e.upToGpu()},e.prototype.drawCylinderConvexPolyh=function(t,e,i){var n=this,a=new Matrix3D;i.toMatrix3D(a),a.appendTranslation(e.x,e.y,e.z);for(var o=0;t.faces.length>o;o++){var r=t.faces[o][0],s=t.faces[o][1],h=t.faces[o][2],c=t.faces[o][3],l=Physics.getV3D(t.vertices[r]),p=Physics.getV3D(t.vertices[s]),u=Physics.getV3D(t.vertices[h]),d=Physics.getV3D(t.vertices[c]);l=a.transformVector(l),p=a.transformVector(p),u=a.transformVector(u),d=a.transformVector(d),n.makeLineMode(l,p),n.makeLineMode(l,d),n.makeLineMode(u,p),n.makeLineMode(u,d)}t.vertices},e.prototype.drawSphereConvexPolyh=function(t,i,n){var a=this,o=new Matrix3D;n.toMatrix3D(o),o.appendTranslation(i.x,i.y,i.z);
for(var r=e.ballLineSprite,s=0;r.lineVecPos.length/6>s;s++){var h=new Vector3D(r.lineVecPos[6*s+0],r.lineVecPos[6*s+1],r.lineVecPos[6*s+2]),c=new Vector3D(r.lineVecPos[6*s+3],r.lineVecPos[6*s+4],r.lineVecPos[6*s+5]);h.scaleBy(t/100),c.scaleBy(t/100),h=o.transformVector(h),c=o.transformVector(c),a.makeLineMode(h,c)}},e.prototype.drawBoxConvexPolyh=function(t,i,n){var a=this,o=new Matrix3D;n.toMatrix3D(o),o.appendTranslation(i.x,i.y,i.z);for(var r=e.boxLineSprite,s=0;r.lineVecPos.length/6>s;s++){var h=new Vector3D(r.lineVecPos[6*s+0],r.lineVecPos[6*s+1],r.lineVecPos[6*s+2]),c=new Vector3D(r.lineVecPos[6*s+3],r.lineVecPos[6*s+4],r.lineVecPos[6*s+5]);h.x=h.x*t.x/100,h.y=h.y*t.y/100,h.z=h.z*t.z/100,c.x=c.x*t.x/100,c.y=c.y*t.y/100,c.z=c.z*t.z/100,h=o.transformVector(h),c=o.transformVector(c),a.makeLineMode(h,c)}},e.showCollisionLine=!0,e}(LineDisplaySprite),Server=function(){function t(){this._serverScenePoint=new ServerScenePoint,this._charList=[]}return t.prototype.onMessage=function(t){if(1==t.id){for(var e=this._serverScenePoint.getPointAry(t.data),i=[],n=0;e.length>n;n++){var a=new ServerChar;a.server=this,a.id=n,a.setPoint(e[n]),a.url="role/gou/gou.txt",a.standurl="role/gou/act/stand.txt",a.attackurl="role/gou/act/attack.txt",a.deathurl="role/gou/act/death.txt",this._charList.push(a),i.push(a.getObj())}var o={};o.id=2,o.data=i,this.postMessage(o)}else 3==t.id?this.processAttack(t.data):0==t.id&&this.processMainChar(t.data)},t.prototype.processMainChar=function(t){for(var e=0;this._charList.length>e;e++)this._charList[e].resetAttack(t),this._charList[e].update()},t.prototype.processAttack=function(t){for(var e=t.type,i=0;this._charList.length>i;i++){var n=this._charList[i].testAttack(t);0==e||1==e?60>=n&&this._charList[i].beAttack(30):2==e?30>=n&&this._charList[i].beAttack(120):3==e&&90>=n&&this._charList[i].beAttack(55)}},t.prototype.postMessage=function(t){this.worker.postMessage(t)},t}(),ServerChar=function(){function t(){this.x=0,this.y=0,this.z=0,this.id=0,this.hp=100,this.state=0,this.deathTime=0}return t.prototype.setPoint=function(t){this.x=t.x,this.y=t.y,this.z=t.z},t.prototype.update=function(){2==this.state&&(this.deathTime++,this.deathTime>=10&&(this.sendDefault(),this.state=1,this.hp=100,this.deathTime=0))},t.prototype.resetAttack=function(t){1==this.state&&this.getDistance(t)>50&&(this.sendDefault(),this.state=0)},t.prototype.getDistance=function(t){var e=this.x-t.x,i=this.z-t.z;return Math.sqrt(e*e+i*i)},t.prototype.beAttack=function(t){this.hp-=t,0>this.hp?(this.sendDeath(),this.state=2):1!=this.state&&(this.sendAttack(),this.state=1)},t.prototype.sendAttack=function(){var t={};t.id=4,t.data={id:this.id,state:1},server.postMessage(t)},t.prototype.sendDefault=function(){var t={};t.id=4,t.data={id:this.id,state:0},server.postMessage(t)},t.prototype.sendDeath=function(){var t={};t.id=4,t.data={id:this.id,state:2},server.postMessage(t)},t.prototype.testAttack=function(t){var e=t.pos,i=this.x-e.x,n=this.z-e.z,a=Math.sqrt(i*i+n*n);if(50>a){i/=a,n/=a;var o=180*(Math.asin(i)/Math.PI);0>=n&&(o=180-o);var r=t.rotation;r=(r%360+360)%360,o=(o%360+360)%360;var s=Math.abs(r-o);return s>180&&(s=360-s),s}return 180},t.prototype.getObj=function(){var t={};return t.id=this.id,t.x=this.x,t.y=this.y,t.z=this.z,t.url=this.url,t.standurl=this.standurl,t.attackurl=this.attackurl,t.deathurl=this.deathurl,t},t}(),ServerScenePoint=function(){function t(){this.mapDic={},this.init()}return t.prototype.init=function(){this.init1(),this.init2()},t.prototype.init1=function(){var t=[];t.push({x:0,z:0,y:0}),t.push({x:-26,z:-43,y:0}),t.push({x:72,z:30,y:0}),this.mapDic["1.txt"]=t},t.prototype.init2=function(){var t=[];this.mapDic["mobile_00.txt"]=t},t.prototype.getPointAry=function(t){return this.mapDic[t]},t}(),server;onmessage=function(t){var e=t.data;server||init(),server.onMessage(e)};var ServerManager=function(){function t(){this.enable=!1}return t.getInstance=function(){return this._instance||(this._instance=new t),this._instance},t.prototype.init=function(){var t=this;this.enable&&(this._serverWorker=new Worker("server/ServerWorker.js"),this._serverWorker.addEventListener("message",function(e){t.workerBack(e)}),setInterval(function(){var e={};e.id=0,e.data={x:GameInstance.mainChar.x,y:GameInstance.mainChar.y,z:GameInstance.mainChar.z},t.postMessage(e)},1e3))},t.prototype.postMessage=function(t){this.enable&&this._serverWorker.postMessage(t)},t.prototype.workerBack=function(t){var e=t.data;NetManager.getInstance().onMessage(e)},t}(),CharAction=function(){function t(){}return t.STANAD="stand",t.WALK="walk",t.DEATH="death",t.ATTACK_01="attack_01",t.ATTACK_02="attack_02",t.ATTACK_03="attack_03",t.ATTACK_04="attack_04",t.ATTACK_05="attack_05",t.ATTACK_06="attack_06",t}(),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},EngineEvent=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.CREAT_SCENE_EVENT="creat_scene_event",e.CREAT_MAINCHAR_EVENT="creat_mainchar_event",e}(BaseEvent),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},LoginEvent=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.CREAT_LOGIN_UI_EVENT="creat_login_ui_event",e.REMOVE_LOGIN_UI_EVENT="remove_login_ui_event",e}(BaseEvent),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},MainUIEvent=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.CREAT_MAINUI_EVENT="creat_mainui_event",e.SHOW_MAINUI_EVENT="show_mainui_event",e}(BaseEvent),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},SceneLoadEvent=function(t){function e(){t.apply(this,arguments),this.progress=0}return __extends(e,t),e.SHOW_LOAD_EVENT="show_load_event",e.REMOVE_LOAD_EVENT="remove_load_event",e.PROGRESS_LOAD_EVENT="progress_load_event",e.ANALYSIS_LOAD_EVENT="analysis_load_event",e}(BaseEvent),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},BaseProcessor=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.sendToServer=function(t){NetManager.getInstance().sendToServer(t)},e}(Processor),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},SceneChar=function(t){function e(){t.call(this),this.shadow=!0}return __extends(e,t),Object.defineProperty(e.prototype,"speedDirect",{set:function(t){this._speedDirect=t},enumerable:!0,configurable:!0}),e.prototype.startMove=function(t){this._speedDirect=t,this._speedDirect.scaleBy(100),this.play(CharAction.WALK),this._enablePhysics&&(this._physicsBody.velocity=Physics.getPhysicsV3D(this._speedDirect))},e.prototype.stopMove=function(){this._speedDirect=null,this.play(CharAction.STANAD),this._enablePhysics&&(this._physicsBody.velocity=Physics.getPhysicsV3D(new Vector3D(0,0,0)))},e.prototype.update=function(){t.prototype.update.call(this),this._enablePhysics&&this.setPos(Physics.getV3D(this._physicsBody.position))},e.prototype.watch=function(t){var e=t.x-this.x,i=t.z-this.z,n=Math.sqrt(e*e+i*i);e/=n,i/=n;var a=180*(Math.asin(e)/Math.PI);0>=i&&(a=180-a),this.rotationY=a},e}(Display3dMovie),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},Net2C=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.NET_EVENT="net_event",e}(BaseEvent),Net2S=function(){function t(){}return t.prototype.getData=function(){return this.data},t}(),GameData=function(){function t(){}return t.needCreatChar=!0,t}(),GameInstance=function(){function t(){}return t.init=function(){if(GameData.needCreatChar){var t=new LoginEvent(LoginEvent.CREAT_LOGIN_UI_EVENT);ModuleEventManager.dispatchEvent(t)}else this.initMainScene()},t.addSceneChar=function(t){this.roleList.push(t),SceneManager.getInstance().addMovieDisplay(t)},t.getSceneCharByID=function(t){for(var e=0;this.roleList.length>e;e++)if(this.roleList[e].id==t)return this.roleList[e];return null},t.initMainScene=function(){Scene_data.focus3D.rotationY=135,Scene_data.focus3D.rotationX=-45,Scene_data.focus3D.y=0,Scene_data.cam3D.distance=500,t.mapName="map00.txt";var e=new EngineEvent(EngineEvent.CREAT_SCENE_EVENT);e.sceneName=t.mapName,e.sceneLoadcomplteFun=t.mainSceneComplete,e.sceneAnylsizFun=t.mainSceneAnalysisComplete,e.sceneProgressFun=t.mainSceneProgress,ModuleEventManager.dispatchEvent(e);var i=new EngineEvent(EngineEvent.CREAT_MAINCHAR_EVENT);ModuleEventManager.dispatchEvent(i);var n=new MainUIEvent(MainUIEvent.CREAT_MAINUI_EVENT);ModuleEventManager.dispatchEvent(n);var a=new SceneLoadEvent(SceneLoadEvent.SHOW_LOAD_EVENT);ModuleEventManager.dispatchEvent(a),Scene_data.cam3D.lookAt(t._mainChar)},t.mainSceneAnalysisComplete=function(){var e=new MainUIEvent(MainUIEvent.SHOW_MAINUI_EVENT);ModuleEventManager.dispatchEvent(e);var i=new SceneLoadEvent(SceneLoadEvent.REMOVE_LOAD_EVENT);ModuleEventManager.dispatchEvent(i);var n=new Net2S,a={};a.id=1,a.data=t.mapName,n.data=a,NetManager.getInstance().sendToServer(n)},t.mainSceneComplete=function(){var t=new SceneLoadEvent(SceneLoadEvent.ANALYSIS_LOAD_EVENT);ModuleEventManager.dispatchEvent(t)},t.mainSceneProgress=function(t){var e=new SceneLoadEvent(SceneLoadEvent.PROGRESS_LOAD_EVENT);e.progress=t,ModuleEventManager.dispatchEvent(e)},Object.defineProperty(t,"mainChar",{get:function(){return t._mainChar||(t._mainChar=new SceneChar,t._mainChar.y=-20),t._mainChar},enumerable:!0,configurable:!0}),t.roleList=[],t}(),GameControlManager=function(){function t(){this._lastMousePos=new Vector3D,this._lastFocus=new Vector3D,this._isMouseDown=!1,this._lock=!1}return t.getInstance=function(){return this._instance||(this._instance=new t),this._instance},t.prototype.init=function(){var t=this;1!=Scene_data.user&&(Scene_data.uiBlankStage.addEventListener(InteractiveEvent.Down,this.onMouseDown,this),Scene_data.uiBlankStage.addEventListener(InteractiveEvent.Up,this.onMouseUp,this),Scene_data.uiBlankStage.addEventListener(InteractiveEvent.Move,this.onMouseMove,this),document.addEventListener(MouseType.MouseWheel,function(e){t.onMouseWheel(e)}),document.addEventListener(MouseType.KeyDown,function(e){t.onKeyDown(e)}),document.addEventListener(MouseType.KeyUp,function(e){t.onKeyUp(e)}))},t.prototype.onMouseWheel=function(t){Scene_data.cam3D.distance+=t.wheelDelta/10},t.prototype.onMouseMove=function(t){this._isMouseDown&&(Scene_data.focus3D.rotationY=this._lastFocus.y-(t.x-this._lastMousePos.x)/10)},t.prototype.onMouseDown=function(t){this._lastMousePos.x=t.x,this._lastFocus.y=Scene_data.focus3D.rotationY,this._isMouseDown=!0},t.prototype.onMouseUp=function(){this._isMouseDown=!1},t.prototype.onKeyDown=function(t){if(!this._lock){var e=new Matrix3D;e.appendRotation(-Scene_data.focus3D.rotationY,Vector3D.Y_AXIS),87==t.keyCode?(GameInstance.mainChar.startMove(e.transformVector(new Vector3D(0,0,1))),GameInstance.mainChar.rotationY=-Scene_data.focus3D.rotationY):83==t.keyCode?(GameInstance.mainChar.startMove(e.transformVector(new Vector3D(0,0,-1))),GameInstance.mainChar.rotationY=-Scene_data.focus3D.rotationY+180):65==t.keyCode?(GameInstance.mainChar.startMove(e.transformVector(new Vector3D(-1,0,0))),GameInstance.mainChar.rotationY=-Scene_data.focus3D.rotationY-90):68==t.keyCode?(GameInstance.mainChar.startMove(e.transformVector(new Vector3D(1,0,0))),GameInstance.mainChar.rotationY=-Scene_data.focus3D.rotationY+90):32==t.keyCode&&ViewMatrx3DSprite.getInstance().drawCircle(200)}},t.prototype.onKeyUp=function(){GameInstance.mainChar.stopMove()},t}(),NetManager=function(){function t(){}return t.getInstance=function(){return this._instance||(this._instance=new t),this._instance},t.prototype.sendToServer=function(t){ServerManager.getInstance().postMessage(t.data)},t.prototype.onMessage=function(t){var e=new Net2C(Net2C.NET_EVENT);e.id=t.id,e.data=t,ModuleEventManager.dispatchEvent(e)},t}(),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},EngineModule=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.getModuleName=function(){return"EngineModule"},e.prototype.listProcessors=function(){return[new EngineProcessor]},e}(Module),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},EngineProcessor=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.getName=function(){return"EngineProcessor"},e.prototype.receivedModuleEvent=function(t){if(0==Scene_data.user){if(t instanceof Net2C)return this.receiveNet(t.data),void 0;var e=t;e.type==EngineEvent.CREAT_SCENE_EVENT?SceneManager.getInstance().loadScene(e.sceneName,e.sceneLoadcomplteFun,e.sceneProgressFun,e.sceneAnylsizFun,{url:"ui/b.jpg",width:1024,height:512}):e.type==EngineEvent.CREAT_MAINCHAR_EVENT&&(GameInstance.mainChar.id=-1,GameInstance.mainChar.setMeshUrl("role/niumo/niumo.txt"),GameInstance.mainChar.addAction(CharAction.WALK,"role/niumo/act/walk.txt",!0),GameInstance.mainChar.addAction(CharAction.STANAD,"role/niumo/act/stand.txt"),GameInstance.mainChar.addAction(CharAction.ATTACK_01,"role/niumo/act/attack_01.txt",!0),GameInstance.mainChar.addAction(CharAction.ATTACK_02,"role/niumo/act/attack_02.txt",!0),GameInstance.mainChar.addAction(CharAction.ATTACK_03,"role/niumo/act/attack_03.txt",!0),GameInstance.mainChar.addAction(CharAction.ATTACK_04,"role/niumo/act/attack_04.txt",!0),GameInstance.mainChar.addAction(CharAction.ATTACK_05,"role/niumo/act/attack_05.txt",!0),GameInstance.mainChar.addPart("wq","Bone_weapon_01_socket_1","role/bj/t3.txt"),GameInstance.mainChar.x=-90,GameInstance.mainChar.y=200,GameInstance.mainChar.z=200,GameInstance.mainChar.setCollision(10,20),SceneManager.getInstance().addMovieDisplay(GameInstance.mainChar))}},e.prototype.receiveNet=function(t){if(2==t.id)for(var e=t.data,i=0;e.length>i;i++){var n=new SceneChar;n.id=e[i].id,n.setMeshUrl(e[i].url),n.x=e[i].x,n.y=e[i].y,n.z=e[i].z,n.rotationY=360*Math.random(),n.setCollision(10,20),n.addAction(CharAction.STANAD,e[i].standurl),n.addAction(CharAction.ATTACK_01,e[i].attackurl,!0),n.addAction(CharAction.DEATH,e[i].deathurl,!0),GameInstance.addSceneChar(n)}else if(4==t.id){var n=GameInstance.getSceneCharByID(t.data.id);n&&(1==t.data.state?(n.play(CharAction.ATTACK_01),n.watch(GameInstance.mainChar)):0==t.data.state?n.play(CharAction.STANAD):2==t.data.state&&n.play(CharAction.DEATH,1))}},e.prototype.loadSecenCom=function(){console.log("over")},e.prototype.loadProgress=function(t){console.log("loading "+float2int(100*t)+"%")},e.prototype.listenModuleEvents=function(){return[new EngineEvent(EngineEvent.CREAT_SCENE_EVENT),new EngineEvent(EngineEvent.CREAT_MAINCHAR_EVENT),new Net2C(Net2C.NET_EVENT)]},e}(BaseProcessor),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},LoginPanel=function(t){function e(){t.call(this),this.init()}return __extends(e,t),e.prototype.init=function(){this.enterBtn=this.creatComponent(0,0,1,1),this.enterBtn.x=0,this.enterBtn.y=0,this.enterBtn.width=128,this.enterBtn.height=64,this.enterBtn.addEventListener(InteractiveEvent.Down,this.enterDown,this),this.container.addChild(this.enterBtn),this.container.width=128,this.container.height=64,this.container.center=0,this.container.bottom=30,this.setImgUrl("ui/login.png")},e.prototype.enterDown=function(){this.processor.removeUI(),GameInstance.initMainScene()},e}(UIRenderComponent),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},LoginProcessor=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.getName=function(){return"LoginProcessor"},e.prototype.receivedModuleEvent=function(t){var e=this;if(1!=Scene_data.user){var i=t;if(i.type==LoginEvent.CREAT_LOGIN_UI_EVENT){this.initUI(),Scene_data.focus3D.rotationY=0,Scene_data.focus3D.rotationX=-15,Scene_data.focus3D.y=130,Scene_data.cam3D.distance=1540;var n=new EngineEvent(EngineEvent.CREAT_SCENE_EVENT);n.sceneName="characters.txt",n.sceneLoadcomplteFun=function(){e.loadSceneCom()},n.sceneProgressFun=function(t){e.loadProgress(t)},n.sceneAnylsizFun=function(){e.addUI()},ModuleEventManager.dispatchEvent(n);var a=new SceneLoadEvent(SceneLoadEvent.SHOW_LOAD_EVENT);ModuleEventManager.dispatchEvent(a)}}},e.prototype.loadSceneCom=function(){var t=new SceneLoadEvent(SceneLoadEvent.ANALYSIS_LOAD_EVENT);ModuleEventManager.dispatchEvent(t)},e.prototype.initUI=function(){this._loginPanel=new LoginPanel,this._loginPanel.processor=this},e.prototype.addUI=function(){UIManager.getInstance().addUI(this._loginPanel);var t=new SceneLoadEvent(SceneLoadEvent.REMOVE_LOAD_EVENT);ModuleEventManager.dispatchEvent(t)},e.prototype.loadProgress=function(t){var e=new SceneLoadEvent(SceneLoadEvent.PROGRESS_LOAD_EVENT);e.progress=t,ModuleEventManager.dispatchEvent(e)},e.prototype.removeUI=function(){UIManager.getInstance().removeUI(this._loginPanel)},e.prototype.listenModuleEvents=function(){return[new LoginEvent(LoginEvent.CREAT_LOGIN_UI_EVENT)]},e}(BaseProcessor),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},LoginModule=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.getModuleName=function(){return"LoginModule"},e.prototype.listProcessors=function(){return[new LoginProcessor]},e}(Module),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},SceneLoadView=function(t){function e(){t.call(this),this.init()}return __extends(e,t),e.prototype.init=function(){this.barbgLeft=this.creatComponent(.0234375,.03515625,.046875,.046875),this.barbgLeft.x=0,this.barbgLeft.y=0,this.barbgLeft.width=12,this.barbgLeft.height=12,this.container.addChild(this.barbgLeft),this.barbgCenter=this.creatComponent(.108984375,.03515625,.046875,.046875),this.barbgCenter.x=10,this.barbgCenter.y=0,this.barbgCenter.width=380,this.barbgCenter.height=12,this.container.addChild(this.barbgCenter),this.barbgRight=this.creatComponent(.193359375,.034765625,.046875,.046875),this.barbgRight.x=390,this.barbgRight.y=0,this.barbgRight.width=12,this.barbgRight.height=12,this.container.addChild(this.barbgRight),this.txt1=this.creatComponent(.0283203125,.341015625,.90234375,.09375),this.txt1.x=0,this.txt1.y=2e3,this.txt1.width=231,this.txt1.height=24,this.container.addChild(this.txt1),this.txt2=this.creatComponent(.0318359375,.213671875,.71484375,.09375),this.txt2.x=0,this.txt2.y=2e3,this.txt2.width=183,this.txt2.height=24,this.container.addChild(this.txt2),this.container.width=400,this.container.height=50,this.container.center=0,this.container.bottom=60,this.setImgUrl("ui/loding.png")},e.prototype.showTxt=function(t){1==t?(this.txt1.y=15,this.txt2.y=2e3):2==t&&(this.txt1.y=2e3,this.txt2.y=15)},e}(UIRenderComponent),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},SceneLoadBar=function(t){function e(){t.call(this),this.init()}return __extends(e,t),e.prototype.init=function(){this.progressBar=this.creatComponent(.07421875,.132421875,.046875,.046875),this.progressBar.x=0,this.progressBar.y=0,this.progressBar.width=1,this.progressBar.height=12,this.container.addChild(this.progressBar),this.container.width=400,this.container.height=50,this.container.center=0,this.container.bottom=60,this.setImgUrl("ui/loding.png")},e.prototype.setProgress=function(t){this.progressBar.width=400*t},e}(UIRenderComponent),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},SceneLoadProcessor=function(t){function e(){t.apply(this,arguments),this._tempNum=0}return __extends(e,t),e.prototype.getName=function(){return"SceneLoadProcessor"},e.prototype.receivedModuleEvent=function(t){if(1!=Scene_data.user){var e=t;e.type==SceneLoadEvent.SHOW_LOAD_EVENT?this.addUI():e.type==SceneLoadEvent.REMOVE_LOAD_EVENT?this.removeUI():e.type==SceneLoadEvent.PROGRESS_LOAD_EVENT?this._loadingBar.setProgress(e.progress):e.type==SceneLoadEvent.ANALYSIS_LOAD_EVENT&&this._loadingPanel.showTxt(2)}},e.prototype.addUI=function(){this._baImg?this._baImg.resize():(this._baImg=new UIBackImg,this._baImg.setImgInfo("ui/bj.jpg",1024,512)),UIManager.getInstance().addUI(this._baImg),this._loadingPanel||(this._loadingPanel=new SceneLoadView),UIManager.getInstance().addUI(this._loadingPanel),this._loadingPanel.showTxt(1),this._loadingBar?this._loadingBar.setProgress(0):this._loadingBar=new SceneLoadBar,UIManager.getInstance().addUI(this._loadingBar)},e.prototype.removeUI=function(){UIManager.getInstance().removeUI(this._baImg),UIManager.getInstance().removeUI(this._loadingPanel),UIManager.getInstance().removeUI(this._loadingBar)},e.prototype.listenModuleEvents=function(){return[new SceneLoadEvent(SceneLoadEvent.SHOW_LOAD_EVENT),new SceneLoadEvent(SceneLoadEvent.REMOVE_LOAD_EVENT),new SceneLoadEvent(SceneLoadEvent.PROGRESS_LOAD_EVENT),new SceneLoadEvent(SceneLoadEvent.ANALYSIS_LOAD_EVENT)]},e}(BaseProcessor),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},SceneLoadModule=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.getModuleName=function(){return"SceneLoadModule"},e.prototype.listProcessors=function(){return[new SceneLoadProcessor]},e}(Module),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},MainUIModule=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.getModuleName=function(){return"MainUIModule"},e.prototype.listProcessors=function(){return[new MainUIProcessor]},e}(Module),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},MainUIProcessor=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.getName=function(){return"MainUIProcessor"},e.prototype.receivedModuleEvent=function(t){var e=t;e.type==MainUIEvent.CREAT_MAINUI_EVENT?this.initUI():e.type==MainUIEvent.SHOW_MAINUI_EVENT&&this.addMainUI()},e.prototype.initUI=function(){this._joystic=new Joystick,this._skillPanel=new SkillPanel},e.prototype.addMainUI=function(){UIManager.getInstance().addUI(this._joystic),UIManager.getInstance().addUI(this._skillPanel)},e.prototype.listenModuleEvents=function(){return[new MainUIEvent(MainUIEvent.CREAT_MAINUI_EVENT),new MainUIEvent(MainUIEvent.SHOW_MAINUI_EVENT)]},e}(BaseProcessor),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},Joystick=function(t){function e(){t.call(this),this.init()}return __extends(e,t),e.prototype.init=function(){this._btn=this.creatComponent(0,0,.25,.25),this._btn.x=0,this._btn.y=0,this._btn.width=128,this._btn.height=128,this._btn.z=0,this.container.addChild(this._btn),this._btn.addEventListener(InteractiveEvent.Down,this.onDown,this),this._bg=this.creatComponent(.25,0,.25,.25),this._bg.x=0,this._bg.y=0,this._bg.width=128,this._bg.height=128,this._bg.z=1,this.container.addChild(this._bg),this.container.left=10,this.container.bottom=30,this.setImgUrl("ui/001.png")},e.prototype.onDown=function(){Scene_data.uiStage.addEventListener(InteractiveEvent.Move,this.onStageMove,this),Scene_data.uiStage.addEventListener(InteractiveEvent.Up,this.onStageUp,this)},e.prototype.onStageMove=function(t){var e=new Vector2D(t.x-this._bg.absoluteX-64*UIData.Scale,t.y-this._bg.absoluteY-64*UIData.Scale);e.normalize(),this._btn.x=20*e.x,this._btn.y=20*e.y;var i=new Matrix3D;i.appendRotation(-Scene_data.focus3D.rotationY,Vector3D.Y_AXIS),GameInstance.mainChar.startMove(i.transformVector(new Vector3D(e.x,0,-e.y)));var n=180*(Math.asin(e.x)/Math.PI);GameInstance.mainChar.rotationY=0>e.y?-Scene_data.focus3D.rotationY+n:-Scene_data.focus3D.rotationY+180-n},e.prototype.onStageUp=function(){this._btn.x=0,this._btn.y=0,Scene_data.uiStage.removeEventListener(InteractiveEvent.Move,this.onStageMove,this),Scene_data.uiStage.removeEventListener(InteractiveEvent.Up,this.onStageUp,this),GameInstance.mainChar.stopMove()},e}(UIRenderComponent),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},SkillPanel=function(t){function e(){t.call(this),this._lock=!1,this.init()}return __extends(e,t),e.prototype.init=function(){SkillManager.getInstance().preLoadSkill("skill/s1.txt",["attack_01","attack_02","attack_03","attack_04"]),this.attackBtn=this.creatComponent(.5,0,.25,.25),this.attackBtn.x=80,this.attackBtn.y=80,this.attackBtn.width=128,this.attackBtn.height=128,this.attackBtn.addEventListener(InteractiveEvent.Down,this.attckDown,this),this.attackBtn.addEventListener(InteractiveEvent.Down,this.attckDown,this),this.container.addChild(this.attackBtn),this.attack1Btn=this.creatComponent(0,.25,.125,.125),this.attack1Btn.x=20,this.attack1Btn.y=130,this.attack1Btn.width=64,this.attack1Btn.height=64,this.attack1Btn.addEventListener(InteractiveEvent.Down,this.attckDown1,this),this.attack1Btn.addEventListener(InteractiveEvent.Down,this.attckDown1,this),this.container.addChild(this.attack1Btn),this.attack2Btn=this.creatComponent(.25,.25,.125,.125),this.attack2Btn.x=40,this.attack2Btn.y=40,this.attack2Btn.width=64,this.attack2Btn.height=64,this.attack2Btn.addEventListener(InteractiveEvent.Down,this.attckDown2,this),this.attack2Btn.addEventListener(InteractiveEvent.Down,this.attckDown2,this),this.container.addChild(this.attack2Btn),this.attack3Btn=this.creatComponent(.5,.25,.125,.125),this.attack3Btn.x=120,this.attack3Btn.y=20,this.attack3Btn.width=64,this.attack3Btn.height=64,this.attack3Btn.addEventListener(InteractiveEvent.Down,this.attckDown3,this),this.attack3Btn.addEventListener(InteractiveEvent.Down,this.attckDown3,this),this.container.addChild(this.attack3Btn),this.container.width=200,this.container.height=200,this.container.right=10,this.container.bottom=30,this.setImgUrl("ui/001.png")},e.prototype.attckDown=function(){var t=this;if(!this._lock){var e=SkillManager.getInstance().getSkill("skill/s1.txt","attack_01");e.configFixEffect(GameInstance.mainChar,function(){t._lock=!1}),SkillManager.getInstance().playSkill(e),this._lock=!0,setTimeout(function(){t.sendAttack(0)},300)}},e.prototype.sendAttack=function(t){var e=new Net2S,i={};i.id=3;var n={};n.pos={x:GameInstance.mainChar.x,z:GameInstance.mainChar.z},n.type=t,n.rotation=GameInstance.mainChar.rotationY,i.data=n,e.data=i,NetManager.getInstance().sendToServer(e)},e.prototype.attckDown1=function(){var t=this;if(!this._lock){var e=SkillManager.getInstance().getSkill("skill/s1.txt","attack_02");e.configFixEffect(GameInstance.mainChar,function(){t._lock=!1}),SkillManager.getInstance().playSkill(e),this._lock=!0,setTimeout(function(){t.sendAttack(1)},300)}},e.prototype.attckDown2=function(){var t=this;if(!this._lock){var e=SkillManager.getInstance().getSkill("skill/s1.txt","attack_03");e.configFixEffect(GameInstance.mainChar,function(){t._lock=!1}),SkillManager.getInstance().playSkill(e),this._lock=!0,setTimeout(function(){t.sendAttack(2)},300)}},e.prototype.attckDown3=function(){var t=this;if(!this._lock){var e=SkillManager.getInstance().getSkill("skill/s1.txt","attack_04");e.configFixEffect(GameInstance.mainChar,function(){t._lock=!1}),SkillManager.getInstance().playSkill(e),this._lock=!0,setTimeout(function(){t.sendAttack(3)},700)}},e}(UIRenderComponent),ModuleList=function(){function t(){}return t.getModuleList=function(){return[new EngineModule,new MainUIModule,new LoginModule,new SceneLoadModule]},t.startup=function(){for(var e=t.getModuleList(),i=0;e.length>i;i++)Module.registerModule(e[i])},t}(),GameStart=function(){function t(){}return t.prototype.init=function(){Physics.creatWorld(),ModuleList.startup(),GameInstance.init(),GameControlManager.getInstance().init()},t}();